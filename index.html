<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GovFlow AI - Government Workflow & Security Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        :root {
            --primary-blue: #1e40af;
            --secondary-blue: #3b82f6;
            --accent-purple: #8b5cf6;
            --success-green: #10b981;
            --warning-yellow: #f59e0b;
            --danger-red: #ef4444;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            min-height: 100vh;
        }
        
        .sidebar {
            background: linear-gradient(180deg, #1e40af 0%, #3730a3 100%);
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.3);
            border-right: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .glass-dark {
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .nav-item {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }
        
        .nav-item.active {
            background: rgba(255, 255, 255, 0.25);
            border-right: 3px solid #ffffff;
        }
        
        .workflow-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        
        .workflow-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
        }
        
        .workflow-card.selected {
            background: rgba(59, 130, 246, 0.3);
            border-color: #3b82f6;
            box-shadow: 0 0 25px rgba(59, 130, 246, 0.5);
        }
        
        .security-alert {
            animation: pulse-glow 2s infinite;
        }
        
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 10px rgba(239, 68, 68, 0.5); }
            50% { box-shadow: 0 0 20px rgba(239, 68, 68, 0.8); }
        }
        
        .typing {
            border-right: 2px solid var(--success-green);
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { border-color: transparent; }
            51%, 100% { border-color: var(--success-green); }
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .threat-indicator {
            animation: blink-red 1.5s infinite;
        }
        
        @keyframes blink-red {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Added 2024-10-05: Drag and Drop Workflow Builder Styles */
        .workflow-step {
            cursor: grab;
            transition: all 0.3s ease;
        }

        .workflow-step:active {
            cursor: grabbing;
        }

        .workflow-step.dragging {
            opacity: 0.5;
        }

        .drop-zone {
            min-height: 400px;
            transition: all 0.3s ease;
        }

        .drop-zone.drag-over {
            background: rgba(59, 130, 246, 0.1);
            border-color: #3b82f6;
        }

        .saved-workflow-card {
            transition: all 0.3s ease;
        }

        /* Custom scrollbar - Blue Ocean theme */
        .scrollbar-thin::-webkit-scrollbar {
            width: 8px;
        }

        .scrollbar-thin::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #3b82f6, #1e40af);
            border-radius: 10px;
        }

        .scrollbar-thin::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #60a5fa, #3b82f6);
        }

        /* Predictive Analytics Dashboard Styles - Added 2024-12-09 */
        .forecast-bar {
            animation: growBar 1s ease-out forwards;
            transform-origin: bottom;
        }

        @keyframes growBar {
            from { transform: scaleY(0); opacity: 0; }
            to { transform: scaleY(1); opacity: 1; }
        }

        .confidence-ring {
            animation: drawRing 1.5s ease-out forwards;
        }

        @keyframes drawRing {
            from { stroke-dashoffset: 251.2; }
            to { stroke-dashoffset: 0; }
        }

        .anomaly-pulse {
            animation: anomalyPulse 2s ease-in-out infinite;
        }

        @keyframes anomalyPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        #predictiveTooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1000;
            border: 1px solid rgba(59, 130, 246, 0.5);
            backdrop-filter: blur(10px);
        }

        #predictiveTooltip.show {
            opacity: 1;
        }

        /* Regulation Assistant Styles - Added 2025-10-07 */
        .regulation-chat-bubble-user {
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
            border-radius: 18px 18px 4px 18px;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .regulation-chat-bubble-assistant {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 18px 18px 18px 4px;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.2);
        }

        .regulation-typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #8b5cf6;
            border-radius: 50%;
            margin: 0 2px;
            animation: regulation-typing 1.4s infinite;
        }

        .regulation-typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .regulation-typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes regulation-typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.7;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        .regulation-sample-question {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 12px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .regulation-sample-question:hover {
            background: rgba(139, 92, 246, 0.2);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.3);
            transform: translateY(-2px);
            border-color: rgba(139, 92, 246, 0.5);
        }

        .regulation-indicator-allowed {
            color: #10b981;
            font-weight: 600;
        }

        .regulation-indicator-not-allowed {
            color: #ef4444;
            font-weight: 600;
        }

        .regulation-indicator-permit {
            color: #f59e0b;
            font-weight: 600;
        }

        .regulation-info-card {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
        }

        .regulation-contact-card {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
        }

        .regulation-link-button {
            display: inline-block;
            background: linear-gradient(135deg, #3b82f6, #1e40af);
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            text-decoration: none;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-top: 8px;
        }

        .regulation-link-button:hover {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
            transform: translateY(-2px);
        }

        .regulation-scroll-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(59, 130, 246, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(59, 130, 246, 0.5);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .regulation-scroll-btn:hover {
            background: rgba(59, 130, 246, 1);
            box-shadow: 0 6px 25px rgba(59, 130, 246, 0.5);
            transform: translateY(-50%) scale(1.1);
        }

        .regulation-scroll-btn-left {
            left: 8px;
        }

        .regulation-scroll-btn-right {
            right: 8px;
        }

        .regulation-scroll-btn.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .regulation-questions-container {
            position: relative;
        }

        .regulation-questions-scroll {
            scroll-behavior: smooth;
        }

        .regulation-chat-container {
            scroll-behavior: smooth;
        }

        .regulation-chat-container::-webkit-scrollbar {
            width: 8px;
        }

        .regulation-chat-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .regulation-chat-container::-webkit-scrollbar-thumb {
            background: rgba(139, 92, 246, 0.5);
            border-radius: 4px;
        }

        /* Policy Intelligence Center Styles - Added 2025-10-07 */
        .policy-citation-federal {
            color: #8b5cf6;
            font-weight: 600;
            cursor: pointer;
            text-decoration: underline;
        }

        .policy-citation-federal:hover {
            color: #a78bfa;
        }

        .policy-citation-state {
            color: #10b981;
            font-weight: 600;
            cursor: pointer;
            text-decoration: underline;
        }

        .policy-citation-state:hover {
            color: #34d399;
        }

        .policy-citation-municipal {
            color: #3b82f6;
            font-weight: 600;
            cursor: pointer;
            text-decoration: underline;
        }

        .policy-citation-municipal:hover {
            color: #60a5fa;
        }

        .policy-confidence-meter {
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }

        .policy-confidence-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 1.5s ease;
            position: relative;
            overflow: hidden;
        }

        .policy-confidence-high {
            background: linear-gradient(90deg, #10b981, #34d399);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.6);
        }

        .policy-confidence-medium {
            background: linear-gradient(90deg, #f59e0b, #fbbf24);
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.6);
        }

        .policy-confidence-low {
            background: linear-gradient(90deg, #ef4444, #f87171);
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.6);
        }

        .policy-status-compliant {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid rgba(16, 185, 129, 0.4);
            color: #34d399;
        }

        .policy-status-needs-review {
            background: rgba(245, 158, 11, 0.2);
            border: 1px solid rgba(245, 158, 11, 0.4);
            color: #fbbf24;
        }

        .policy-status-non-compliant {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.4);
            color: #f87171;
        }

        .policy-status-unclear {
            background: rgba(139, 92, 246, 0.2);
            border: 1px solid rgba(139, 92, 246, 0.4);
            color: #a78bfa;
        }

        .policy-conflict-critical {
            border-left: 4px solid #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .policy-conflict-moderate {
            border-left: 4px solid #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }

        .policy-conflict-minor {
            border-left: 4px solid #10b981;
            background: rgba(16, 185, 129, 0.1);
        }

        .policy-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .policy-table th {
            background: rgba(59, 130, 246, 0.2);
            color: white;
            font-weight: 600;
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid rgba(59, 130, 246, 0.4);
        }

        .policy-table td {
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.9);
        }

        .policy-table tr:hover {
            background: rgba(59, 130, 246, 0.1);
        }

        /* Quantum-Ready Security Module Styles - Added 2025-10-07 */
        .quantum-particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: radial-gradient(circle, #8b5cf6, transparent);
            border-radius: 50%;
            animation: quantumFloat 3s ease-in-out infinite;
        }

        @keyframes quantumFloat {
            0%, 100% { transform: translateY(0) translateX(0); opacity: 0.3; }
            50% { transform: translateY(-20px) translateX(10px); opacity: 0.7; }
        }

        .quantum-strength-bar {
            height: 24px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            overflow: hidden;
            position: relative;
        }

        .quantum-strength-fill {
            height: 100%;
            transition: width 1s ease-out;
            position: relative;
            overflow: hidden;
        }

        .quantum-strength-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        @keyframes quantumThreatPulse {
            0%, 100% { box-shadow: 0 0 20px rgba(239, 68, 68, 0.5); }
            50% { box-shadow: 0 0 40px rgba(239, 68, 68, 0.8); }
        }

        .quantum-threat-indicator {
            animation: quantumThreatPulse 2s ease-in-out infinite;
        }

        .quantum-timeline-point {
            position: relative;
        }

        .quantum-timeline-point::before {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            background: #8b5cf6;
            border-radius: 50%;
            left: -8px;
            top: 50%;
            transform: translateY(-50%);
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.6);
        }

        .quantum-encryption-demo {
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
        }

        @keyframes quantumEncryptionFlow {
            0% { opacity: 0; transform: translateX(-20px); }
            50% { opacity: 1; }
            100% { opacity: 0; transform: translateX(20px); }
        }

        .quantum-encryption-flow {
            animation: quantumEncryptionFlow 2s ease-in-out infinite;
        }

        .quantum-cert-badge {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }

        .quantum-decision-node {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quantum-decision-node:hover {
            transform: scale(1.05);
            background: rgba(139, 92, 246, 0.2);
        }

        .quantum-vs-divider {
            position: relative;
        }

        .quantum-vs-divider::after {
            content: 'VS';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #8b5cf6, #3b82f6);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.5);
        }

        /* Blockchain Audit Trail Styles - Added 2024-12-09 */
        .blockchain-block {
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .blockchain-block:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(59, 130, 246, 0.4);
        }

        .blockchain-block::after {
            content: '';
            position: absolute;
            right: -40px;
            top: 50%;
            width: 40px;
            height: 2px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.8);
        }

        .blockchain-block:last-child::after {
            display: none;
        }

        .neon-blue {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.6), 0 0 40px rgba(59, 130, 246, 0.3);
        }

        .neon-purple {
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.6), 0 0 40px rgba(139, 92, 246, 0.3);
        }

        .neon-green {
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.6), 0 0 40px rgba(16, 185, 129, 0.3);
        }

        .neon-red {
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.6), 0 0 40px rgba(239, 68, 68, 0.3);
        }

        .neon-yellow {
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.6), 0 0 40px rgba(245, 158, 11, 0.3);
        }

        @keyframes blockCreate {
            0% {
                opacity: 0;
                transform: scale(0.8) translateY(-20px);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .block-creating {
            animation: blockCreate 0.6s ease-out;
        }

        @keyframes hashPulse {
            0%, 100% {
                box-shadow: 0 0 10px rgba(16, 185, 129, 0.4);
            }
            50% {
                box-shadow: 0 0 25px rgba(16, 185, 129, 0.8);
            }
        }

        .hash-verified {
            animation: hashPulse 2s ease-in-out infinite;
        }

        .timeline-line {
            position: absolute;
            left: 20px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(180deg, #3b82f6, #8b5cf6);
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }

        .timeline-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.8);
            position: absolute;
            left: 15px;
            z-index: 10;
        }

        #blockchainTooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1000;
            border: 1px solid rgba(59, 130, 246, 0.5);
            backdrop-filter: blur(10px);
            max-width: 300px;
        }

        #blockchainTooltip.show {
            opacity: 1;
        }

        .contract-status {
            position: relative;
            overflow: hidden;
        }

        .contract-status::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .contract-status:hover::before {
            left: 100%;
        }

        @keyframes copySuccess {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); color: #10b981; }
            100% { transform: scale(1); }
        }

        .copy-success {
            animation: copySuccess 0.3s ease;
        }

        /* Document Processing Center Styles - Added 2025-10-18 */
        .cjis-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            font-size: 0.75rem;
            font-weight: 700;
            padding: 6px 12px;
            border-radius: 9999px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        .cjis-badge::before {
            content: '🔒';
            font-size: 0.875rem;
        }

        .doc-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            transition: all 0.3s ease;
        }

        .doc-card:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .confidence-bar {
            height: 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            transition: width 0.3s ease;
        }

        .field-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .field-approved {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .field-rejected {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .field-pending {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
    </style>
</head>
<body class="gradient-bg text-white overflow-hidden">
    <!-- Tooltip for Predictive Analytics -->
    <div id="predictiveTooltip" class="tooltip"></div>

    <!-- Tooltip for Blockchain -->
    <div id="blockchainTooltip" class="tooltip"></div>

    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="sidebar w-64 flex-shrink-0">
            <div class="p-6">
                <div class="flex items-center space-x-3 mb-8">
                    <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                        <i class="fas fa-shield-alt text-white text-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-white">GovFlow AI</h1>
                        <p class="text-xs text-blue-200">Security & Workflow Platform</p>
                    </div>
                </div>
                
                <nav class="space-y-2">
                    <div class="nav-item active p-3 rounded-lg" onclick="switchTab('dashboard')">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-tachometer-alt text-white"></i>
                            <span class="text-white font-medium">Admin Dashboard</span>
                        </div>
                    </div>
                    
                    <div class="nav-item p-3 rounded-lg" onclick="switchTab('citizen')">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-users text-white"></i>
                            <span class="text-white font-medium">Citizen Portal</span>
                            <div class="ml-auto">
                                <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="nav-item p-3 rounded-lg" onclick="switchTab('workflows')">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-sitemap text-white"></i>
                            <span class="text-white font-medium">Workflows</span>
                        </div>
                    </div>
                    
                    <div class="nav-item p-3 rounded-lg" onclick="switchTab('security')">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-shield-alt text-white"></i>
                            <span class="text-white font-medium">Security Analysis</span>
                            <div class="ml-auto">
                                <div class="w-2 h-2 bg-red-400 rounded-full threat-indicator"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="nav-item p-3 rounded-lg" onclick="switchTab('analytics')">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-chart-line text-white"></i>
                            <span class="text-white font-medium">Analytics</span>
                        </div>
                    </div>
                    
                    <div class="nav-item p-3 rounded-lg" onclick="switchTab('compliance')">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-clipboard-check text-white"></i>
                            <span class="text-white font-medium">Compliance</span>
                        </div>
                    </div>
                    
                    <div class="nav-item p-3 rounded-lg" onclick="switchTab('grants')">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-dollar-sign text-white"></i>
                            <span class="text-white font-medium">Grant Management</span>
                            <div class="ml-auto">
                                <div class="w-2 h-2 bg-purple-400 rounded-full animate-pulse"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="nav-item p-3 rounded-lg" onclick="switchTab('crm')">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-users text-white"></i>
                            <span class="text-white font-medium">CRM</span>
                            <div class="ml-auto">
                                <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="nav-item p-3 rounded-lg" onclick="switchTab('settings')">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-cog text-white"></i>
                            <span class="text-white font-medium">Settings</span>
                        </div>
                    </div>
                </nav>
                
                <!-- System Status -->
                <div class="mt-8 p-4 glass-dark rounded-lg">
                    <h4 class="text-sm font-semibold text-white mb-3">System Status</h4>
                    <div class="space-y-2">
                        <div class="flex items-center justify-between text-xs">
                            <span class="text-white/70">AI Engine</span>
                            <div class="flex items-center">
                                <div class="w-2 h-2 bg-green-400 rounded-full mr-1"></div>
                                <span class="text-green-300">Online</span>
                            </div>
                        </div>
                        <div class="flex items-center justify-between text-xs">
                            <span class="text-white/70">Security</span>
                            <div class="flex items-center">
                                <div class="w-2 h-2 bg-yellow-400 rounded-full mr-1"></div>
                                <span class="text-yellow-300">Monitoring</span>
                            </div>
                        </div>
                        <div class="flex items-center justify-between text-xs">
                            <span class="text-white/70">Workflows</span>
                            <div class="flex items-center">
                                <div class="w-2 h-2 bg-green-400 rounded-full mr-1"></div>
                                <span class="text-green-300">28 Active</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Header -->
            <header class="glass-dark border-b border-white/10 p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 id="pageTitle" class="text-2xl font-bold text-white">City Services Portal</h2>
                        <p id="pageSubtitle" class="text-sm text-white/70">Submit requests, track applications, and access city services</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="glass rounded-lg px-3 py-2">
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-shield-alt text-green-400"></i>
                                <span class="text-sm text-white">Secure</span>
                            </div>
                        </div>
                        <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                            <i class="fas fa-user text-white text-sm"></i>
                        </div>
                    </div>
                </div>
            </header>
            
            <!-- Content Area -->
            <div class="flex-1 overflow-y-auto p-6">
                <!-- Admin Dashboard Tab -->
                <div id="dashboard-content" class="tab-content">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <!-- Quick Stats -->
                        <div class="glass rounded-xl p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-white">Active Workflows</h3>
                                <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-play text-white text-sm"></i>
                                </div>
                            </div>
                            <div class="text-3xl font-bold text-blue-400 mb-2">28</div>
                            <div class="text-sm text-white/70">↑ 12% from last week</div>
                        </div>
                        
                        <div class="glass rounded-xl p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-white">Security Alerts</h3>
                                <div class="w-8 h-8 bg-red-500 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-exclamation-triangle text-white text-sm"></i>
                                </div>
                            </div>
                            <div class="text-3xl font-bold text-red-400 mb-2">3</div>
                            <div class="text-sm text-white/70">↓ 67% from yesterday</div>
                        </div>
                        
                        <div class="glass rounded-xl p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-white">Processing Efficiency</h3>
                                <div class="w-8 h-8 bg-green-500 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-chart-line text-white text-sm"></i>
                                </div>
                            </div>
                            <div class="text-3xl font-bold text-green-400 mb-2">96%</div>
                            <div class="text-sm text-white/70">↑ 4% improvement</div>
                        </div>
                    </div>
                    
                    <!-- Advanced AI Assistant -->
                    <div class="glass rounded-xl p-6 mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center mr-3">
                                    <i class="fas fa-brain text-white"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-white">GovFlow AI Assistant Pro</h3>
                                    <p class="text-sm text-white/70">Advanced automation & intelligent operations</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                                <span class="text-xs text-white/60">Active</span>
                            </div>
                        </div>

                        <!-- Quick Action Buttons -->
                        <div class="grid grid-cols-3 gap-2 mb-4">
                            <button onclick="executeQuickAction('analyze')" class="bg-gradient-to-r from-blue-500/20 to-blue-600/20 border border-blue-500/30 rounded-lg p-3 text-xs text-white hover:bg-blue-500/30 transition-all">
                                <i class="fas fa-chart-line mb-1"></i>
                                <div>Analyze System</div>
                            </button>
                            <button onclick="executeQuickAction('optimize')" class="bg-gradient-to-r from-green-500/20 to-green-600/20 border border-green-500/30 rounded-lg p-3 text-xs text-white hover:bg-green-500/30 transition-all">
                                <i class="fas fa-cogs mb-1"></i>
                                <div>Auto-Optimize</div>
                            </button>
                            <button onclick="executeQuickAction('secure')" class="bg-gradient-to-r from-red-500/20 to-red-600/20 border border-red-500/30 rounded-lg p-3 text-xs text-white hover:bg-red-500/30 transition-all">
                                <i class="fas fa-shield-alt mb-1"></i>
                                <div>Security Scan</div>
                            </button>
                        </div>
                        
                        <div class="bg-black/20 rounded-lg p-4 mb-4 h-40 overflow-y-auto" id="adminChatHistory">
                            <div class="text-green-300 mb-2">
                                <i class="fas fa-brain mr-2"></i>
                                <span class="font-semibold text-blue-300">AI Pro:</span>
                                <span>Advanced automation engine online. 28 workflows optimized, 3 security protocols enhanced. Ready for complex operations and intelligent automation.</span>
                            </div>
                        </div>

                        <!-- Advanced Command Interface -->
                        <div class="space-y-3">
                            <div class="flex space-x-2">
                                <select id="commandType" class="bg-white/10 border border-white/20 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="natural">Natural Language</option>
                                    <option value="automation">Automation Script</option>
                                    <option value="workflow">Workflow Command</option>
                                    <option value="security">Security Analysis</option>
                                    <option value="optimization">System Optimization</option>
                                </select>
                                <button onclick="toggleAdvancedMode()" id="advancedModeBtn" class="bg-purple-600/20 border border-purple-500/30 px-3 py-2 rounded-lg text-white text-sm hover:bg-purple-600/30 transition-colors">
                                    <i class="fas fa-magic mr-1"></i>Advanced
                                </button>
                            </div>
                            
                            <div class="flex space-x-2">
                                <input type="text" id="adminUserInput" placeholder="Enter command, automation script, or natural language query..."
                                       class="flex-1 bg-white/10 border border-white/20 rounded-lg px-4 py-2 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <button onclick="sendAdvancedAdminMessage()" class="bg-gradient-to-r from-blue-600 to-purple-600 px-4 py-2 rounded-lg hover:from-blue-700 hover:to-purple-700 transition-all">
                                    <i class="fas fa-paper-plane text-white"></i>
                                </button>
                            </div>

                            <!-- Advanced Mode Panel -->
                            <div id="advancedPanel" class="hidden bg-black/30 rounded-lg p-4 space-y-3">
                                <div class="text-white text-sm font-medium mb-2">Advanced Automation Controls</div>
                                <div class="grid grid-cols-2 gap-3">
                                    <button onclick="insertTemplate('workflow')" class="bg-blue-600/20 border border-blue-500/30 rounded-lg p-2 text-xs text-white hover:bg-blue-600/30 transition-all">
                                        <i class="fas fa-sitemap mr-1"></i>Workflow Template
                                    </button>
                                    <button onclick="insertTemplate('security')" class="bg-red-600/20 border border-red-500/30 rounded-lg p-2 text-xs text-white hover:bg-red-600/30 transition-all">
                                        <i class="fas fa-lock mr-1"></i>Security Script
                                    </button>
                                    <button onclick="insertTemplate('automation')" class="bg-green-600/20 border border-green-500/30 rounded-lg p-2 text-xs text-white hover:bg-green-600/30 transition-all">
                                        <i class="fas fa-robot mr-1"></i>Auto Script
                                    </button>
                                    <button onclick="insertTemplate('api')" class="bg-purple-600/20 border border-purple-500/30 rounded-lg p-2 text-xs text-white hover:bg-purple-600/30 transition-all">
                                        <i class="fas fa-code mr-1"></i>API Command
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Document Processing Center - Added 2025-10-18 -->
                    <div class="glass rounded-xl p-6 mb-6">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-file-medical text-orange-400 text-2xl"></i>
                                <div>
                                    <h3 class="text-xl font-bold text-white">Document Processing Center</h3>
                                    <p class="text-sm text-white/70">AI-powered document review queue with intelligent field extraction</p>
                                </div>
                            </div>
                            <span class="cjis-badge">CJIS COMPLIANT</span>
                        </div>

                        <!-- Key Metrics -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <div class="bg-white/5 rounded-lg p-4 border border-white/10">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="text-sm text-white/70">Processed This Month</div>
                                    <i class="fas fa-file-check text-blue-400"></i>
                                </div>
                                <div class="text-2xl font-bold text-blue-400">2,847</div>
                                <div class="text-xs text-white/50 mt-1">+23% vs last month</div>
                            </div>

                            <div class="bg-white/5 rounded-lg p-4 border border-white/10">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="text-sm text-white/70">Accuracy Rate</div>
                                    <i class="fas fa-bullseye text-green-400"></i>
                                </div>
                                <div class="text-2xl font-bold text-green-400">94.7%</div>
                                <div class="text-xs text-white/50 mt-1">+2.3% improvement</div>
                            </div>

                            <div class="bg-white/5 rounded-lg p-4 border border-white/10">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="text-sm text-white/70">Avg Processing Time</div>
                                    <i class="fas fa-clock text-purple-400"></i>
                                </div>
                                <div class="text-2xl font-bold text-purple-400">2.3s</div>
                                <div class="text-xs text-white/50 mt-1">-0.8s faster</div>
                            </div>

                            <div class="bg-white/5 rounded-lg p-4 border border-white/10">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="text-sm text-white/70">Staff Time Saved</div>
                                    <i class="fas fa-user-clock text-yellow-400"></i>
                                </div>
                                <div class="text-2xl font-bold text-yellow-400">142hrs</div>
                                <div class="text-xs text-white/50 mt-1">This week</div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex flex-wrap gap-3 mb-6">
                            <button onclick="showBatchUpload()" class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-4 py-2 rounded-lg font-semibold hover:shadow-lg transition-all" aria-label="Upload multiple documents for batch processing">
                                <i class="fas fa-upload mr-2"></i>Batch Upload
                            </button>
                            <button onclick="exportDocProcessingReport()" class="bg-white/10 border border-white/20 text-white px-4 py-2 rounded-lg font-semibold hover:bg-white/20 transition-all" aria-label="Export processing report">
                                <i class="fas fa-download mr-2"></i>Export Report
                            </button>
                            <button onclick="configureDocProcessing()" class="bg-white/10 border border-white/20 text-white px-4 py-2 rounded-lg font-semibold hover:bg-white/20 transition-all" aria-label="Configure document processing settings">
                                <i class="fas fa-cog mr-2"></i>Configure Settings
                            </button>
                            <button onclick="enterDocTrainingMode()" class="bg-white/10 border border-white/20 text-white px-4 py-2 rounded-lg font-semibold hover:bg-white/20 transition-all" aria-label="Train AI model with new document types">
                                <i class="fas fa-brain mr-2"></i>Training Mode
                            </button>
                        </div>

                        <!-- Queue Summary -->
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                            <!-- High Priority Queue -->
                            <div class="bg-white/5 rounded-lg p-4 border border-red-500/30 cursor-pointer hover:bg-white/10 transition-all" onclick="openDocQueue('high')" role="button" tabindex="0" aria-label="Open high priority document queue">
                                <div class="flex items-center justify-between mb-3">
                                    <h4 class="text-sm font-bold text-white flex items-center gap-2">
                                        <i class="fas fa-exclamation-triangle text-red-400"></i>
                                        High Priority
                                    </h4>
                                    <span class="bg-red-500/20 text-red-400 px-3 py-1 rounded-full text-sm font-bold border border-red-500/30">23</span>
                                </div>
                                <p class="text-xs text-white/60 mb-2">Confidence &lt; 70% - Manual review required</p>
                                <div class="text-xs text-red-400">Click to review →</div>
                            </div>

                            <!-- Medium Priority Queue -->
                            <div class="bg-white/5 rounded-lg p-4 border border-yellow-500/30 cursor-pointer hover:bg-white/10 transition-all" onclick="openDocQueue('medium')" role="button" tabindex="0" aria-label="Open medium priority document queue">
                                <div class="flex items-center justify-between mb-3">
                                    <h4 class="text-sm font-bold text-white flex items-center gap-2">
                                        <i class="fas fa-flag text-yellow-400"></i>
                                        Medium Priority
                                    </h4>
                                    <span class="bg-yellow-500/20 text-yellow-400 px-3 py-1 rounded-full text-sm font-bold border border-yellow-500/30">45</span>
                                </div>
                                <p class="text-xs text-white/60 mb-2">Confidence 70-85% - Quick verification needed</p>
                                <div class="text-xs text-yellow-400">Click to review →</div>
                            </div>

                            <!-- Auto-Processed Queue -->
                            <div class="bg-white/5 rounded-lg p-4 border border-green-500/30 cursor-pointer hover:bg-white/10 transition-all" onclick="openDocQueue('auto')" role="button" tabindex="0" aria-label="Open auto-processed document queue">
                                <div class="flex items-center justify-between mb-3">
                                    <h4 class="text-sm font-bold text-white flex items-center gap-2">
                                        <i class="fas fa-check-circle text-green-400"></i>
                                        Auto-Processed
                                    </h4>
                                    <span class="bg-green-500/20 text-green-400 px-3 py-1 rounded-full text-sm font-bold border border-green-500/30">147</span>
                                </div>
                                <p class="text-xs text-white/60 mb-2">Confidence &gt; 85% - Automatically approved</p>
                                <div class="text-xs text-green-400">View history →</div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="glass rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-white mb-4">Recent Activity</h3>
                        <div class="space-y-3" id="recentActivity">
                            <!-- Activity items will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Citizen Portal Tab -->
                <div id="citizen-content" class="tab-content" style="display: none;">
                    <!-- Welcome Banner -->
                    <div class="glass rounded-xl p-6 mb-6 bg-gradient-to-r from-blue-600/20 to-purple-600/20">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="text-2xl font-bold text-white mb-2">Welcome to City Services Portal</h2>
                                <p class="text-white/80">Submit requests, track applications, and access city services 24/7</p>
                            </div>
                            <div class="hidden md:block">
                                <div class="w-16 h-16 bg-white/10 rounded-full flex items-center justify-center">
                                    <i class="fas fa-city text-white text-2xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions & Service Stats -->
                    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-6">
                        <!-- New Request -->
                        <div class="glass rounded-xl p-6 hover:scale-105 transition-transform cursor-pointer" onclick="openNewRequestModal()">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-white">New Request</h3>
                                <div class="w-8 h-8 bg-green-500 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-plus text-white text-sm"></i>
                                </div>
                            </div>
                            <p class="text-sm text-white/70 mb-4">Submit a new service request or application</p>
                            <div class="text-green-400 text-sm font-medium">Click to start →</div>
                        </div>
                        
                        <!-- My Requests -->
                        <div class="glass rounded-xl p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-white">My Requests</h3>
                                <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-list text-white text-sm"></i>
                                </div>
                            </div>
                            <div class="text-3xl font-bold text-blue-400 mb-2" id="userRequestCountCitizen">5</div>
                            <div class="text-sm text-white/70">2 pending review</div>
                        </div>
                        
                        <!-- Average Response -->
                        <div class="glass rounded-xl p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-white">Avg Response</h3>
                                <div class="w-8 h-8 bg-purple-500 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-clock text-white text-sm"></i>
                                </div>
                            </div>
                            <div class="text-3xl font-bold text-purple-400 mb-2">2.3</div>
                            <div class="text-sm text-white/70">business days</div>
                        </div>

                        <!-- Service Status -->
                        <div class="glass rounded-xl p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-white">Service Status</h3>
                                <div class="w-8 h-8 bg-green-500 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-check-circle text-white text-sm"></i>
                                </div>
                            </div>
                            <div class="text-lg font-bold text-green-400 mb-2">All Systems</div>
                            <div class="text-sm text-white/70">Operational</div>
                        </div>
                    </div>
                    
                    <!-- My Recent Requests -->
                    <div class="glass rounded-xl p-6 mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-white">My Recent Requests</h3>
                            <button onclick="viewAllRequests()" class="text-blue-400 hover:text-blue-300 text-sm">
                                View All <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                        
                        <div class="space-y-3" id="recentRequestsListCitizen">
                            <!-- Recent requests will be populated here -->
                        </div>
                    </div>

                    <!-- Regulation Assistant - Added 2025-10-07 -->
                    <div id="regulationAssistant" class="mb-6">
                        <!-- Content will be injected by JavaScript -->
                    </div>

                    <!-- Popular Services -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="glass rounded-xl p-6 hover:scale-105 transition-transform cursor-pointer" onclick="quickRequest('building_permit')">
                            <div class="flex items-center space-x-3 mb-3">
                                <div class="w-10 h-10 bg-orange-500 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-hammer text-white"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-white">Building Permits</h4>
                                    <p class="text-xs text-white/70">Construction & renovation</p>
                                </div>
                            </div>
                            <p class="text-sm text-white/80">Apply for building permits and inspections</p>
                        </div>

                        <div class="glass rounded-xl p-6 hover:scale-105 transition-transform cursor-pointer" onclick="quickRequest('business_license')">
                            <div class="flex items-center space-x-3 mb-3">
                                <div class="w-10 h-10 bg-green-500 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-store text-white"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-white">Business License</h4>
                                    <p class="text-xs text-white/70">Start your business</p>
                                </div>
                            </div>
                            <p class="text-sm text-white/80">Register and license your business</p>
                        </div>

                        <div class="glass rounded-xl p-6 hover:scale-105 transition-transform cursor-pointer" onclick="quickRequest('report_issue')">
                            <div class="flex items-center space-x-3 mb-3">
                                <div class="w-10 h-10 bg-red-500 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-exclamation-triangle text-white"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-white">Report Issue</h4>
                                    <p class="text-xs text-white/70">City services & problems</p>
                                </div>
                            </div>
                            <p class="text-sm text-white/80">Report potholes, streetlight issues, etc.</p>
                        </div>
                    </div>

                    <!-- AI Service Assistant -->
                    <div class="glass rounded-xl p-6 mb-6">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 bg-gradient-to-r from-green-500 to-blue-600 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-robot text-white"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-white">City Services AI Assistant</h3>
                                <p class="text-sm text-white/70">Get help finding the right service or department</p>
                            </div>
                        </div>
                        
                        <div class="bg-black/20 rounded-lg p-4 mb-4 h-32 overflow-y-auto" id="citizenChatHistory">
                            <div class="text-green-300 mb-2">
                                <i class="fas fa-robot mr-2"></i>
                                <span class="font-semibold text-blue-300">Assistant:</span>
                                <span id="citizenWelcomeMessage" class="typing">Hello! I'm here to help you find the right city service. What can I help you with today?</span>
                            </div>
                        </div>
                        
                        <div class="flex space-x-2">
                            <input type="text" id="citizenUserInput" placeholder="Ask about permits, licenses, reporting issues, or any city service..."
                                   class="flex-1 bg-white/10 border border-white/20 rounded-lg px-4 py-2 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button onclick="sendCitizenMessage()" class="bg-green-600 px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                <i class="fas fa-paper-plane text-white"></i>
                            </button>
                        </div>
                        
                        <!-- Quick Service Suggestions -->
                        <div class="flex flex-wrap gap-2 mt-3">
                            <button onclick="quickCitizenChat('building permit')" class="text-xs bg-white/10 text-white px-3 py-1 rounded-full hover:bg-white/20 transition-colors">
                                Building Permit
                            </button>
                            <button onclick="quickCitizenChat('business license')" class="text-xs bg-white/10 text-white px-3 py-1 rounded-full hover:bg-white/20 transition-colors">
                                Business License
                            </button>
                            <button onclick="quickCitizenChat('property taxes')" class="text-xs bg-white/10 text-white px-3 py-1 rounded-full hover:bg-white/20 transition-colors">
                                Property Taxes
                            </button>
                            <button onclick="quickCitizenChat('trash pickup')" class="text-xs bg-white/10 text-white px-3 py-1 rounded-full hover:bg-white/20 transition-colors">
                                Trash Pickup
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Workflows Tab -->
                <div id="workflows-content" class="tab-content" style="display: none;">
                    <!-- Workflow Mode Toggle -->
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-3">
                            <h2 class="text-2xl font-bold text-white">Workflows</h2>
                            <div class="glass rounded-lg p-1 flex gap-1">
                                <button id="simpleWorkflowBtn" onclick="switchWorkflowMode('simple')" class="px-4 py-2 rounded-lg text-sm font-medium transition-all bg-gradient-to-r from-blue-500 to-purple-600 text-white">
                                    <i class="fas fa-magic mr-2"></i>Simple Mode
                                </button>
                                <button id="advancedWorkflowBtn" onclick="switchWorkflowMode('advanced')" class="px-4 py-2 rounded-lg text-sm font-medium transition-all text-white/70 hover:text-white">
                                    <i class="fas fa-project-diagram mr-2"></i>Advanced Canvas
                                </button>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 text-white/60 text-sm">
                            <i class="fas fa-info-circle"></i>
                            <span id="workflowModeDescription">Use AI to describe your workflow</span>
                        </div>
                    </div>

                    <!-- Simple Workflow Mode -->
                    <div id="simpleWorkflowMode">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <!-- Left: AI Agent Input -->
                            <div class="lg:col-span-2">
                                <!-- AI Agent Section -->
                                <div class="glass rounded-xl p-6 mb-6">
                                <div class="flex items-center mb-4">
                                    <div class="w-10 h-10 rounded-full bg-gradient-to-r from-purple-500 to-pink-600 flex items-center justify-center mr-3">
                                        <i class="fas fa-robot text-white"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-white">AI Workflow Assistant</h3>
                                        <p class="text-sm text-white/70">Describe your workflow in plain language</p>
                                    </div>
                                </div>

                                <textarea
                                    id="aiWorkflowInput"
                                    rows="3"
                                    placeholder="Example: Create a permit approval workflow with document validation, supervisor review, and email notifications..."
                                    class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-3 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent mb-3"
                                    aria-label="Describe your workflow"></textarea>

                                <div class="flex justify-between items-center">
                                    <div class="flex gap-2">
                                        <button class="text-sm px-3 py-1 bg-purple-500/20 rounded-lg text-purple-300 hover:bg-purple-500/30 transition-all"
                                                aria-label="Example: Permit workflow">
                                            Permit Example
                                        </button>
                                        <button class="text-sm px-3 py-1 bg-blue-500/20 rounded-lg text-blue-300 hover:bg-blue-500/30 transition-all"
                                                aria-label="Example: Approval workflow">
                                            Approval Example
                                        </button>
                                    </div>
                                    <button
                                        id="generateBtn"
                                        class="bg-gradient-to-r from-blue-500 to-purple-600 px-6 py-2 rounded-lg hover:shadow-lg transition-all font-medium"
                                        aria-label="Generate workflow with AI">
                                        <i class="fas fa-magic mr-2"></i>Generate Workflow
                                    </button>
                                </div>

                                <!-- Loading/Error/Success States -->
                                <div id="aiStatus" class="mt-4 hidden"></div>
                            </div>

                            <!-- Drop Zone -->
                            <div class="glass rounded-xl p-6">
                                <h3 class="font-bold text-white mb-4">Workflow Canvas</h3>
                                <div
                                    id="dropZone"
                                    class="drop-zone glass rounded-lg border-2 border-dashed border-white/30 p-6"
                                    role="region"
                                    aria-label="Workflow drop zone">
                                    <div id="emptyState" class="text-center py-12">
                                        <i class="fas fa-layer-group text-6xl text-white/30 mb-4"></i>
                                        <p class="text-white/50">Drag steps here or use AI to generate</p>
                                    </div>
                                    <div id="workflowStepsCanvas" class="space-y-3"></div>
                                </div>

                                <div class="flex justify-end gap-3 mt-4">
                                    <button
                                        id="clearBtn"
                                        class="px-4 py-2 bg-white/10 rounded-lg hover:bg-white/20 transition-all"
                                        aria-label="Clear workflow">
                                        <i class="fas fa-trash mr-2"></i>Clear
                                    </button>
                                    <button
                                        id="saveBtn"
                                        class="px-6 py-2 bg-gradient-to-r from-green-500 to-blue-600 rounded-lg hover:shadow-lg transition-all font-medium"
                                        aria-label="Save workflow">
                                        <i class="fas fa-save mr-2"></i>Save Workflow
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Right: Step Library & Saved Workflows -->
                        <div>
                            <!-- Step Library -->
                            <div class="glass rounded-xl p-6 mb-6">
                                <h3 class="font-bold text-white mb-4 flex items-center gap-2">
                                    <i class="fas fa-toolbox text-blue-400"></i>
                                    Step Library
                                    <span class="ml-auto text-xs text-white/50 bg-blue-500/20 px-2 py-1 rounded-full">40+ Steps</span>
                                </h3>
                                <div id="stepLibrary" class="space-y-2 max-h-[600px] overflow-y-auto pr-2 scrollbar-thin scrollbar-thumb-blue-500/50 scrollbar-track-white/10">
                                    <!-- Steps will be populated by JS -->
                                </div>
                            </div>

                            <!-- Saved Workflows -->
                            <div class="glass rounded-xl p-6">
                                <h3 class="font-bold text-white mb-4 flex items-center gap-2">
                                    <i class="fas fa-bookmark text-purple-400"></i>
                                    Saved Workflows
                                </h3>
                                <div id="savedWorkflows" class="space-y-2 max-h-[300px] overflow-y-auto pr-2">
                                    <div class="text-white/50 text-sm text-center py-4">
                                        No saved workflows yet
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>

                    <!-- Advanced Workflow Canvas Mode -->
                    <div id="advancedWorkflowMode" style="display: none;">
                        <!-- Canvas content will be inserted here -->
                    </div>
                </div>

                <!-- Save Workflow Modal -->
                <div id="saveModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50" role="dialog" aria-labelledby="saveModalTitle">
                    <div class="glass rounded-xl p-6 max-w-md w-full mx-4">
                        <h3 id="saveModalTitle" class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                            <i class="fas fa-save text-green-400"></i>
                            Save Workflow
                        </h3>
                        <div class="mb-6">
                            <label for="workflowName" class="block text-white/70 text-sm mb-2">Workflow Name</label>
                            <input
                                type="text"
                                id="workflowName"
                                class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-2 text-white placeholder-white/30 focus:outline-none focus:border-blue-400 transition-all"
                                placeholder="e.g., Permit Application Process"
                                aria-label="Enter workflow name">
                        </div>
                        <div class="flex gap-3">
                            <button
                                id="cancelSave"
                                class="flex-1 px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-white transition-all"
                                aria-label="Cancel">
                                Cancel
                            </button>
                            <button
                                id="confirmSave"
                                class="flex-1 px-4 py-2 bg-gradient-to-r from-green-500 to-blue-600 rounded-lg text-white hover:shadow-lg transition-all font-medium"
                                aria-label="Confirm save">
                                <i class="fas fa-check mr-2"></i>Save
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Security Analysis Tab -->
                <div id="security-content" class="tab-content" style="display: none;">
                    <!-- Quantum-Ready Security Module - Added 2025-10-07 -->
                    <div id="quantumSecurityModule">
                        <!-- Quantum Security content will be injected here by JavaScript -->
                    </div>

                    <!-- Security Action Bar -->
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center space-x-4">
                            <button onclick="runSecurityScan()" class="bg-gradient-to-r from-red-500 to-red-600 px-4 py-2 rounded-lg hover:shadow-lg transition-all text-white">
                                <i class="fas fa-search mr-2"></i>Run Full Scan
                            </button>
                            <button onclick="generateSecurityReport()" class="bg-gradient-to-r from-blue-500 to-blue-600 px-4 py-2 rounded-lg hover:shadow-lg transition-all text-white">
                                <i class="fas fa-file-alt mr-2"></i>Generate Report
                            </button>
                            <button onclick="openDiagnostics()" class="bg-gradient-to-r from-purple-500 to-purple-600 px-4 py-2 rounded-lg hover:shadow-lg transition-all text-white">
                                <i class="fas fa-stethoscope mr-2"></i>Diagnostics
                            </button>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                            <span class="text-green-300 text-sm font-medium">Real-time Monitoring Active</span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <!-- Threat Detection -->
                        <div class="lg:col-span-2 glass rounded-xl p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-white">Real-Time Threat Detection</h3>
                                <div class="flex items-center space-x-2">
                                    <div class="w-2 h-2 bg-red-400 rounded-full threat-indicator"></div>
                                    <span class="text-red-300 text-sm font-medium">3 Active Threats</span>
                                    <button onclick="refreshThreats()" class="ml-2 text-white/60 hover:text-white">
                                        <i class="fas fa-sync-alt text-sm"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="space-y-3" id="threatsList">
                                <div class="security-alert bg-red-500/20 border border-red-500/50 rounded-lg p-4 hover:bg-red-500/30 transition-colors cursor-pointer" onclick="showThreatDetails('threat1')">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center space-x-2">
                                            <i class="fas fa-exclamation-triangle text-red-400"></i>
                                            <span class="text-red-300 font-medium">Suspicious Login Attempts</span>
                                        </div>
                                        <span class="text-xs bg-red-500 text-white px-2 py-1 rounded">CRITICAL</span>
                                    </div>
                                    <p class="text-sm text-white/70 mb-2">Multiple failed login attempts from IP 192.168.1.100</p>
                                    <div class="flex items-center justify-between">
                                        <div class="text-xs text-red-300">2 minutes ago • 15 attempts</div>
                                        <div class="flex space-x-2">
                                            <button onclick="blockIP('192.168.1.100')" class="text-xs bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700">Block IP</button>
                                            <button onclick="investigateThreat('threat1')" class="text-xs bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700">Investigate</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-yellow-500/20 border border-yellow-500/50 rounded-lg p-4 hover:bg-yellow-500/30 transition-colors cursor-pointer" onclick="showThreatDetails('threat2')">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center space-x-2">
                                            <i class="fas fa-clock text-yellow-400"></i>
                                            <span class="text-yellow-300 font-medium">Unusual Data Access</span>
                                        </div>
                                        <span class="text-xs bg-yellow-500 text-white px-2 py-1 rounded">MEDIUM</span>
                                    </div>
                                    <p class="text-sm text-white/70 mb-2">Tax database accessed outside normal hours</p>
                                    <div class="flex items-center justify-between">
                                        <div class="text-xs text-yellow-300">15 minutes ago • User: admin_user</div>
                                        <div class="flex space-x-2">
                                            <button onclick="auditAccess('tax_db')" class="text-xs bg-yellow-600 text-white px-2 py-1 rounded hover:bg-yellow-700">Audit Log</button>
                                            <button onclick="notifyAdmin('unusual_access')" class="text-xs bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700">Notify Admin</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-orange-500/20 border border-orange-500/50 rounded-lg p-4 hover:bg-orange-500/30 transition-colors cursor-pointer" onclick="showThreatDetails('threat3')">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center space-x-2">
                                            <i class="fas fa-tachometer-alt text-orange-400"></i>
                                            <span class="text-orange-300 font-medium">API Rate Limit Exceeded</span>
                                        </div>
                                        <span class="text-xs bg-orange-500 text-white px-2 py-1 rounded">MEDIUM</span>
                                    </div>
                                    <p class="text-sm text-white/70 mb-2">Permit API receiving 500+ req/min from 203.45.67.89</p>
                                    <div class="flex items-center justify-between">
                                        <div class="text-xs text-orange-300">1 hour ago • 2,847 requests</div>
                                        <div class="flex space-x-2">
                                            <button onclick="throttleAPI('permit_api')" class="text-xs bg-orange-600 text-white px-2 py-1 rounded hover:bg-orange-700">Apply Throttle</button>
                                            <button onclick="analyzeTraffic('permit_api')" class="text-xs bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700">Analyze</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Security Score -->
                        <div class="glass rounded-xl p-6">
                            <div class="text-center mb-6">
                                <h3 class="text-lg font-semibold text-white mb-4">Security Score</h3>
                                <div class="relative w-32 h-32 mx-auto">
                                    <svg class="w-32 h-32 transform -rotate-90" viewBox="0 0 120 120">
                                        <circle cx="60" cy="60" r="50" fill="none" stroke="rgb(75 85 99)" stroke-width="8"/>
                                        <circle cx="60" cy="60" r="50" fill="none" stroke="rgb(16 185 129)" stroke-width="8" 
                                                stroke-linecap="round" stroke-dasharray="251.2" stroke-dashoffset="62.8"/>
                                    </svg>
                                    <div class="absolute inset-0 flex items-center justify-center">
                                        <div class="text-center">
                                            <div class="text-2xl font-bold text-green-400">75</div>
                                            <div class="text-xs text-white/70">/ 100</div>
                                        </div>
                                    </div>
                                </div>
                                <p class="text-green-300 text-sm mt-2">Good Security Posture</p>
                            </div>
                            
                            <div class="space-y-3">
                                <div class="flex items-center justify-between text-sm">
                                    <span class="text-white/70">Vulnerabilities</span>
                                    <span class="text-yellow-300">2 Low</span>
                                </div>
                                <div class="flex items-center justify-between text-sm">
                                    <span class="text-white/70">Last Scan</span>
                                    <span class="text-white">2 hours ago</span>
                                </div>
                                <div class="flex items-center justify-between text-sm">
                                    <span class="text-white/70">Patches Pending</span>
                                    <span class="text-blue-300">3 Available</span>
                                </div>
                                <button onclick="viewSecurityDetails()" class="w-full mt-4 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition-colors text-sm">
                                    View Detailed Report
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Security Diagnostics & Monitoring -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <!-- Live Network Monitoring -->
                        <div class="glass rounded-xl p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-white">Network Monitoring</h3>
                                <div class="flex items-center space-x-2">
                                    <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                                    <span class="text-green-300 text-xs">Live</span>
                                </div>
                            </div>
                            
                            <div class="space-y-4">
                                <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg">
                                    <div class="flex items-center space-x-3">
                                        <i class="fas fa-globe text-blue-400"></i>
                                        <div>
                                            <p class="text-white text-sm font-medium">Inbound Traffic</p>
                                            <p class="text-white/60 text-xs">HTTP/HTTPS Requests</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-green-400 font-bold">1,247/min</p>
                                        <p class="text-green-300 text-xs">↑ 12% normal</p>
                                    </div>
                                </div>
                                
                                <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg">
                                    <div class="flex items-center space-x-3">
                                        <i class="fas fa-shield-alt text-green-400"></i>
                                        <div>
                                            <p class="text-white text-sm font-medium">Firewall Blocks</p>
                                            <p class="text-white/60 text-xs">Malicious Traffic</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-red-400 font-bold">23/min</p>
                                        <p class="text-red-300 text-xs">↓ 45% from peak</p>
                                    </div>
                                </div>
                                
                                <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg">
                                    <div class="flex items-center space-x-3">
                                        <i class="fas fa-database text-purple-400"></i>
                                        <div>
                                            <p class="text-white text-sm font-medium">Database Queries</p>
                                            <p class="text-white/60 text-xs">Active Connections</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-blue-400 font-bold">89 active</p>
                                        <p class="text-blue-300 text-xs">12ms avg response</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- System Health Diagnostics -->
                        <div class="glass rounded-xl p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-white">System Diagnostics</h3>
                                <button onclick="runDiagnostics()" class="text-blue-400 hover:text-blue-300 text-sm">
                                    <i class="fas fa-play mr-1"></i>Run Tests
                                </button>
                            </div>
                            
                            <div class="space-y-4">
                                <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg">
                                    <div class="flex items-center space-x-3">
                                        <i class="fas fa-server text-green-400"></i>
                                        <span class="text-white text-sm">Server Health</span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                                        <span class="text-green-300 text-sm">Healthy</span>
                                    </div>
                                </div>
                                
                                <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg">
                                    <div class="flex items-center space-x-3">
                                        <i class="fas fa-memory text-yellow-400"></i>
                                        <span class="text-white text-sm">Memory Usage</span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <div class="w-16 bg-white/20 rounded-full h-2">
                                            <div class="bg-yellow-400 h-2 rounded-full" style="width: 67%"></div>
                                        </div>
                                        <span class="text-yellow-300 text-sm">67%</span>
                                    </div>
                                </div>
                                
                                <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg">
                                    <div class="flex items-center space-x-3">
                                        <i class="fas fa-hdd text-blue-400"></i>
                                        <span class="text-white text-sm">Disk Space</span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <div class="w-16 bg-white/20 rounded-full h-2">
                                            <div class="bg-blue-400 h-2 rounded-full" style="width: 45%"></div>
                                        </div>
                                        <span class="text-blue-300 text-sm">45%</span>
                                    </div>
                                </div>
                                
                                <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg">
                                    <div class="flex items-center space-x-3">
                                        <i class="fas fa-microchip text-green-400"></i>
                                        <span class="text-white text-sm">CPU Load</span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <div class="w-16 bg-white/20 rounded-full h-2">
                                            <div class="bg-green-400 h-2 rounded-full" style="width: 34%"></div>
                                        </div>
                                        <span class="text-green-300 text-sm">34%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Advanced Security Tools -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <!-- Vulnerability Scanner -->
                        <div class="glass rounded-xl p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="text-lg font-semibold text-white">Vulnerability Scanner</h4>
                                <i class="fas fa-bug text-red-400"></i>
                            </div>
                            <div class="space-y-3">
                                <div class="text-sm text-white/70">Last scan: 2 hours ago</div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-white">Critical</span>
                                    <span class="text-red-400 font-bold">0</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-white">High</span>
                                    <span class="text-orange-400 font-bold">0</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-white">Medium</span>
                                    <span class="text-yellow-400 font-bold">2</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-white">Low</span>
                                    <span class="text-green-400 font-bold">5</span>
                                </div>
                                <button onclick="startVulnerabilityScan()" class="w-full mt-4 bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition-colors text-sm">
                                    <i class="fas fa-search mr-2"></i>Start New Scan
                                </button>
                            </div>
                        </div>
                        
                        <!-- Penetration Testing -->
                        <div class="glass rounded-xl p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="text-lg font-semibold text-white">Penetration Test</h4>
                                <i class="fas fa-crosshairs text-purple-400"></i>
                            </div>
                            <div class="space-y-3">
                                <div class="text-sm text-white/70">Simulated attacks to test defenses</div>
                                <div class="space-y-2">
                                    <div class="flex items-center justify-between text-sm">
                                        <span class="text-white">SQL Injection</span>
                                        <span class="text-green-400">✓ Blocked</span>
                                    </div>
                                    <div class="flex items-center justify-between text-sm">
                                        <span class="text-white">XSS Attempts</span>
                                        <span class="text-green-400">✓ Blocked</span>
                                    </div>
                                    <div class="flex items-center justify-between text-sm">
                                        <span class="text-white">Brute Force</span>
                                        <span class="text-yellow-400">⚠ Partial</span>
                                    </div>
                                </div>
                                <button onclick="startPenetrationTest()" class="w-full mt-4 bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition-colors text-sm">
                                    <i class="fas fa-shield-alt mr-2"></i>Run Pen Test
                                </button>
                            </div>
                        </div>
                        
                        <!-- Security Audit -->
                        <div class="glass rounded-xl p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="text-lg font-semibold text-white">Security Audit</h4>
                                <i class="fas fa-clipboard-check text-blue-400"></i>
                            </div>
                            <div class="space-y-3">
                                <div class="text-sm text-white/70">Compliance & policy checks</div>
                                <div class="space-y-2">
                                    <div class="flex items-center justify-between text-sm">
                                        <span class="text-white">Password Policy</span>
                                        <span class="text-green-400">✓ Compliant</span>
                                    </div>
                                    <div class="flex items-center justify-between text-sm">
                                        <span class="text-white">Data Encryption</span>
                                        <span class="text-green-400">✓ AES-256</span>
                                    </div>
                                    <div class="flex items-center justify-between text-sm">
                                        <span class="text-white">Access Controls</span>
                                        <span class="text-yellow-400">⚠ Review</span>
                                    </div>
                                </div>
                                <button onclick="generateAuditReport()" class="w-full mt-4 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm">
                                    <i class="fas fa-file-alt mr-2"></i>Generate Audit
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- AI Security Recommendations -->
                    <div class="glass rounded-xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-white">AI Security Recommendations</h3>
                            <div class="flex items-center space-x-2">
                                <div class="w-2 h-2 bg-blue-400 rounded-full animate-pulse"></div>
                                <span class="text-blue-300 text-xs">AI Analyzing</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="flex items-start space-x-3 p-4 bg-blue-500/20 rounded-lg hover:bg-blue-500/30 transition-colors">
                                <i class="fas fa-lightbulb text-blue-400 mt-1"></i>
                                <div class="flex-1">
                                    <h4 class="font-medium text-white">Implement Rate Limiting</h4>
                                    <p class="text-sm text-white/70 mt-1">Add rate limiting to permit API to prevent potential DDoS attacks</p>
                                    <div class="flex space-x-2 mt-3">
                                        <button onclick="applyRecommendation('rate_limiting')" class="text-blue-400 text-sm hover:text-blue-300">Apply →</button>
                                        <button onclick="dismissRecommendation('rate_limiting')" class="text-white/60 text-sm hover:text-white/80">Dismiss</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex items-start space-x-3 p-4 bg-green-500/20 rounded-lg hover:bg-green-500/30 transition-colors">
                                <i class="fas fa-shield-alt text-green-400 mt-1"></i>
                                <div class="flex-1">
                                    <h4 class="font-medium text-white">Enhanced Authentication</h4>
                                    <p class="text-sm text-white/70 mt-1">Enable 2FA for all administrative accounts to improve security</p>
                                    <div class="flex space-x-2 mt-3">
                                        <button onclick="applyRecommendation('2fa')" class="text-green-400 text-sm hover:text-green-300">Apply →</button>
                                        <button onclick="dismissRecommendation('2fa')" class="text-white/60 text-sm hover:text-white/80">Dismiss</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex items-start space-x-3 p-4 bg-purple-500/20 rounded-lg hover:bg-purple-500/30 transition-colors">
                                <i class="fas fa-eye text-purple-400 mt-1"></i>
                                <div class="flex-1">
                                    <h4 class="font-medium text-white">Audit Log Monitoring</h4>
                                    <p class="text-sm text-white/70 mt-1">Set up automated monitoring for unusual database access patterns</p>
                                    <div class="flex space-x-2 mt-3">
                                        <button onclick="applyRecommendation('audit_monitoring')" class="text-purple-400 text-sm hover:text-purple-300">Apply →</button>
                                        <button onclick="dismissRecommendation('audit_monitoring')" class="text-white/60 text-sm hover:text-white/80">Dismiss</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex items-start space-x-3 p-4 bg-yellow-500/20 rounded-lg hover:bg-yellow-500/30 transition-colors">
                                <i class="fas fa-key text-yellow-400 mt-1"></i>
                                <div class="flex-1">
                                    <h4 class="font-medium text-white">SSL Certificate Renewal</h4>
                                    <p class="text-sm text-white/70 mt-1">SSL certificate expires in 30 days. Set up automatic renewal</p>
                                    <div class="flex space-x-2 mt-3">
                                        <button onclick="applyRecommendation('ssl_renewal')" class="text-yellow-400 text-sm hover:text-yellow-300">Apply →</button>
                                        <button onclick="dismissRecommendation('ssl_renewal')" class="text-white/60 text-sm hover:text-white/80">Dismiss</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Federal Compliance & Enterprise Integration Dashboard -->
                    <div class="glass rounded-xl p-6">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center space-x-3">
                                <h4 class="text-xl font-semibold text-white">Enterprise Compliance Center</h4>
                                <div class="flex items-center space-x-2 bg-emerald-500/20 px-3 py-1.5 rounded-lg border border-emerald-400/30">
                                    <i class="fas fa-check-circle text-emerald-400 text-sm"></i>
                                    <span class="text-emerald-300 text-sm font-semibold">Fully Compliant</span>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button onclick="exportComplianceReport()" class="bg-emerald-600/20 hover:bg-emerald-600/30 text-emerald-300 px-4 py-2 rounded-lg transition-colors flex items-center space-x-2 border border-emerald-500/30">
                                    <i class="fas fa-file-shield text-sm"></i>
                                    <span class="font-medium">Export Report</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Compliance Grid -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                            <div class="bg-gradient-to-br from-emerald-500/20 to-green-500/20 rounded-xl p-4 border border-emerald-400/30">
                                <div class="flex items-center justify-between mb-3">
                                    <span class="text-white/70 font-medium">CJIS Compliance</span>
                                    <i class="fas fa-check-circle text-emerald-400"></i>
                                </div>
                                <div class="text-2xl font-bold text-white mb-1">100%</div>
                                <div class="text-xs text-emerald-400 font-medium">Fully Certified</div>
                                <div class="w-full bg-white/10 rounded-full h-1.5 mt-2">
                                    <div class="bg-emerald-400 h-1.5 rounded-full" style="width: 100%"></div>
                                </div>
                            </div>
                            
                            <div class="bg-gradient-to-br from-blue-500/20 to-indigo-500/20 rounded-xl p-4 border border-blue-400/30">
                                <div class="flex items-center justify-between mb-3">
                                    <span class="text-white/70 font-medium">FedRAMP High</span>
                                    <i class="fas fa-shield-alt text-blue-400"></i>
                                </div>
                                <div class="text-2xl font-bold text-white mb-1">IL5</div>
                                <div class="text-xs text-blue-400 font-medium">Impact Level 5</div>
                                <div class="w-full bg-white/10 rounded-full h-1.5 mt-2">
                                    <div class="bg-blue-400 h-1.5 rounded-full" style="width: 100%"></div>
                                </div>
                            </div>
                            
                            <div class="bg-gradient-to-br from-purple-500/20 to-pink-500/20 rounded-xl p-4 border border-purple-400/30">
                                <div class="flex items-center justify-between mb-3">
                                    <span class="text-white/70 font-medium">Quantum Encryption</span>
                                    <i class="fas fa-lock text-purple-400"></i>
                                </div>
                                <div class="text-2xl font-bold text-white mb-1">AES-256</div>
                                <div class="text-xs text-purple-400 font-medium">Post-Quantum</div>
                                <div class="w-full bg-white/10 rounded-full h-1.5 mt-2">
                                    <div class="bg-purple-400 h-1.5 rounded-full" style="width: 100%"></div>
                                </div>
                            </div>
                            
                            <div class="bg-gradient-to-br from-orange-500/20 to-red-500/20 rounded-xl p-4 border border-orange-400/30">
                                <div class="flex items-center justify-between mb-3">
                                    <span class="text-white/70 font-medium">Audit Intelligence</span>
                                    <i class="fas fa-file-alt text-orange-400"></i>
                                </div>
                                <div class="text-2xl font-bold text-white mb-1">24/7</div>
                                <div class="text-xs text-orange-400 font-medium">Real-time</div>
                                <div class="w-full bg-white/10 rounded-full h-1.5 mt-2">
                                    <div class="bg-orange-400 h-1.5 rounded-full" style="width: 100%"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Enterprise Integration Matrix -->
                        <div class="bg-black/20 rounded-xl p-6">
                            <h5 class="text-white font-semibold mb-4 flex items-center space-x-2">
                                <i class="fas fa-network-wired text-blue-400"></i>
                                <span>Enterprise Integration Matrix</span>
                            </h5>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="space-y-3">
                                    <h6 class="text-white/70 font-medium text-sm">Identity Management</h6>
                                    <div class="space-y-2">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center space-x-2">
                                                <div class="w-2 h-2 bg-emerald-400 rounded-full"></div>
                                                <span class="text-white/70 text-sm">Active Directory</span>
                                            </div>
                                            <span class="text-emerald-400 text-xs font-medium">Connected</span>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center space-x-2">
                                                <div class="w-2 h-2 bg-emerald-400 rounded-full"></div>
                                                <span class="text-white/70 text-sm">SAML 2.0</span>
                                            </div>
                                            <span class="text-emerald-400 text-xs font-medium">Active</span>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center space-x-2">
                                                <div class="w-2 h-2 bg-emerald-400 rounded-full"></div>
                                                <span class="text-white/70 text-sm">OAuth 2.1</span>
                                            </div>
                                            <span class="text-emerald-400 text-xs font-medium">Enabled</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="space-y-3">
                                    <h6 class="text-white/70 font-medium text-sm">Security Framework</h6>
                                    <div class="space-y-2">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center space-x-2">
                                                <div class="w-2 h-2 bg-blue-400 rounded-full"></div>
                                                <span class="text-white/70 text-sm">Zero Trust</span>
                                            </div>
                                            <span class="text-blue-400 text-xs font-medium">Enforced</span>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center space-x-2">
                                                <div class="w-2 h-2 bg-blue-400 rounded-full"></div>
                                                <span class="text-white/70 text-sm">MFA Required</span>
                                            </div>
                                            <span class="text-blue-400 text-xs font-medium">100%</span>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center space-x-2">
                                                <div class="w-2 h-2 bg-blue-400 rounded-full"></div>
                                                <span class="text-white/70 text-sm">RBAC</span>
                                            </div>
                                            <span class="text-blue-400 text-xs font-medium">Dynamic</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="space-y-3">
                                    <h6 class="text-white/70 font-medium text-sm">Data Intelligence</h6>
                                    <div class="space-y-2">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center space-x-2">
                                                <div class="w-2 h-2 bg-purple-400 rounded-full"></div>
                                                <span class="text-white/70 text-sm">ML Pipeline</span>
                                            </div>
                                            <span class="text-purple-400 text-xs font-medium">Running</span>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center space-x-2">
                                                <div class="w-2 h-2 bg-purple-400 rounded-full"></div>
                                                <span class="text-white/70 text-sm">Data Lake</span>
                                            </div>
                                            <span class="text-purple-400 text-xs font-medium">Synced</span>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center space-x-2">
                                                <div class="w-2 h-2 bg-purple-400 rounded-full"></div>
                                                <span class="text-white/70 text-sm">Analytics</span>
                                            </div>
                                            <span class="text-purple-400 text-xs font-medium">Real-time</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Analytics Tab -->
                <div id="analytics-content" class="tab-content" style="display: none;">
                    <!-- Analytics Header with Controls -->
                    <div class="glass rounded-xl p-6 mb-6">
                        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between">
                            <div>
                                <h2 class="text-2xl font-bold text-white mb-2">Advanced Analytics Dashboard</h2>
                                <p class="text-white/70">Real-time insights from all platform workflows and integrations</p>
                            </div>
                            <div class="mt-4 lg:mt-0 flex items-center space-x-4">
                                <div class="flex items-center space-x-2">
                                    <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
                                    <span class="text-green-400 text-sm">Live Data</span>
                                </div>
                                <select id="analyticsTimeRange" onchange="updateAnalytics()" class="bg-white/10 border border-white/20 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="24h">Last 24 Hours</option>
                                    <option value="7d" selected>Last 7 Days</option>
                                    <option value="30d">Last 30 Days</option>
                                    <option value="90d">Last 90 Days</option>
                                </select>
                                <button onclick="customizeAnalytics()" class="bg-gradient-to-r from-purple-500 to-blue-500 hover:from-purple-600 hover:to-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center space-x-2">
                                    <i class="fas fa-cog"></i>
                                    <span>Customize</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Key Performance Indicators -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <div class="glass rounded-xl p-6 hover:bg-white/10 transition-all duration-300">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-white/70 text-sm">Total Workflows</p>
                                    <p class="text-2xl font-bold text-white" id="totalWorkflows">2,847</p>
                                    <div class="flex items-center mt-2">
                                        <i class="fas fa-arrow-up text-green-400 text-xs mr-1"></i>
                                        <span class="text-green-400 text-xs">+12.5%</span>
                                        <span class="text-white/50 text-xs ml-1">vs last week</span>
                                    </div>
                                </div>
                                <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-project-diagram text-white"></i>
                                </div>
                            </div>
                        </div>

                        <div class="glass rounded-xl p-6 hover:bg-white/10 transition-all duration-300">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-white/70 text-sm">Processing Time</p>
                                    <p class="text-2xl font-bold text-white" id="avgProcessingTime">1.2s</p>
                                    <div class="flex items-center mt-2">
                                        <i class="fas fa-arrow-down text-green-400 text-xs mr-1"></i>
                                        <span class="text-green-400 text-xs">-8.3%</span>
                                        <span class="text-white/50 text-xs ml-1">improvement</span>
                                    </div>
                                </div>
                                <div class="w-12 h-12 bg-gradient-to-r from-green-500 to-teal-600 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-stopwatch text-white"></i>
                                </div>
                            </div>
                        </div>

                        <div class="glass rounded-xl p-6 hover:bg-white/10 transition-all duration-300">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-white/70 text-sm">Success Rate</p>
                                    <p class="text-2xl font-bold text-white" id="successRate">98.7%</p>
                                    <div class="flex items-center mt-2">
                                        <i class="fas fa-arrow-up text-green-400 text-xs mr-1"></i>
                                        <span class="text-green-400 text-xs">+2.1%</span>
                                        <span class="text-white/50 text-xs ml-1">this month</span>
                                    </div>
                                </div>
                                <div class="w-12 h-12 bg-gradient-to-r from-emerald-500 to-green-600 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-check-circle text-white"></i>
                                </div>
                            </div>
                        </div>

                        <div class="glass rounded-xl p-6 hover:bg-white/10 transition-all duration-300">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-white/70 text-sm">Active Users</p>
                                    <p class="text-2xl font-bold text-white" id="activeUsers">1,439</p>
                                    <div class="flex items-center mt-2">
                                        <i class="fas fa-arrow-up text-green-400 text-xs mr-1"></i>
                                        <span class="text-green-400 text-xs">+18.7%</span>
                                        <span class="text-white/50 text-xs ml-1">this week</span>
                                    </div>
                                </div>
                                <div class="w-12 h-12 bg-gradient-to-r from-orange-500 to-red-600 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-users text-white"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Main Analytics Grid -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <!-- Workflow Performance Chart -->
                        <div class="lg:col-span-2 glass rounded-xl p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-white">Workflow Performance Trends</h3>
                                <div class="flex items-center space-x-2">
                                    <button onclick="toggleChart('performance')" class="text-white/70 hover:text-white text-sm">
                                        <i class="fas fa-expand-arrows-alt"></i>
                                    </button>
                                </div>
                            </div>
                            <div id="performanceChart" class="h-80 bg-black/20 rounded-lg p-4 relative overflow-hidden">
                                <!-- Animated Chart Placeholder -->
                                <div class="absolute inset-4">
                                    <div class="flex items-end justify-between h-full">
                                        <div class="flex flex-col items-center">
                                            <div class="bg-gradient-to-t from-blue-500 to-blue-300 rounded-t w-8 animate-pulse" style="height: 60%"></div>
                                            <span class="text-white/50 text-xs mt-2">Mon</span>
                                        </div>
                                        <div class="flex flex-col items-center">
                                            <div class="bg-gradient-to-t from-purple-500 to-purple-300 rounded-t w-8 animate-pulse" style="height: 80%; animation-delay: 0.2s"></div>
                                            <span class="text-white/50 text-xs mt-2">Tue</span>
                                        </div>
                                        <div class="flex flex-col items-center">
                                            <div class="bg-gradient-to-t from-green-500 to-green-300 rounded-t w-8 animate-pulse" style="height: 45%; animation-delay: 0.4s"></div>
                                            <span class="text-white/50 text-xs mt-2">Wed</span>
                                        </div>
                                        <div class="flex flex-col items-center">
                                            <div class="bg-gradient-to-t from-yellow-500 to-yellow-300 rounded-t w-8 animate-pulse" style="height: 90%; animation-delay: 0.6s"></div>
                                            <span class="text-white/50 text-xs mt-2">Thu</span>
                                        </div>
                                        <div class="flex flex-col items-center">
                                            <div class="bg-gradient-to-t from-red-500 to-red-300 rounded-t w-8 animate-pulse" style="height: 70%; animation-delay: 0.8s"></div>
                                            <span class="text-white/50 text-xs mt-2">Fri</span>
                                        </div>
                                        <div class="flex flex-col items-center">
                                            <div class="bg-gradient-to-t from-indigo-500 to-indigo-300 rounded-t w-8 animate-pulse" style="height: 55%; animation-delay: 1s"></div>
                                            <span class="text-white/50 text-xs mt-2">Sat</span>
                                        </div>
                                        <div class="flex flex-col items-center">
                                            <div class="bg-gradient-to-t from-pink-500 to-pink-300 rounded-t w-8 animate-pulse" style="height: 85%; animation-delay: 1.2s"></div>
                                            <span class="text-white/50 text-xs mt-2">Sun</span>
                                        </div>
                                    </div>
                                </div>
                                <!-- Chart Legend -->
                                <div class="absolute top-4 right-4 space-y-2">
                                    <div class="flex items-center space-x-2">
                                        <div class="w-3 h-3 bg-blue-500 rounded"></div>
                                        <span class="text-white/70 text-xs">Workflows</span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <div class="w-3 h-3 bg-purple-500 rounded"></div>
                                        <span class="text-white/70 text-xs">Grants</span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <div class="w-3 h-3 bg-green-500 rounded"></div>
                                        <span class="text-white/70 text-xs">Security</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- System Health Monitor -->
                        <div class="glass rounded-xl p-6">
                            <h3 class="text-lg font-semibold text-white mb-4">System Health</h3>
                            <div class="space-y-4">
                                <div class="space-y-2">
                                    <div class="flex justify-between items-center">
                                        <span class="text-white/70 text-sm">CPU Usage</span>
                                        <span class="text-white text-sm" id="cpuUsage">23%</span>
                                    </div>
                                    <div class="w-full bg-white/10 rounded-full h-2">
                                        <div class="bg-gradient-to-r from-green-500 to-yellow-500 h-2 rounded-full transition-all duration-1000" style="width: 23%"></div>
                                    </div>
                                </div>

                                <div class="space-y-2">
                                    <div class="flex justify-between items-center">
                                        <span class="text-white/70 text-sm">Memory</span>
                                        <span class="text-white text-sm" id="memoryUsage">67%</span>
                                    </div>
                                    <div class="w-full bg-white/10 rounded-full h-2">
                                        <div class="bg-gradient-to-r from-blue-500 to-purple-500 h-2 rounded-full transition-all duration-1000" style="width: 67%"></div>
                                    </div>
                                </div>

                                <div class="space-y-2">
                                    <div class="flex justify-between items-center">
                                        <span class="text-white/70 text-sm">Database</span>
                                        <span class="text-white text-sm" id="databaseLoad">34%</span>
                                    </div>
                                    <div class="w-full bg-white/10 rounded-full h-2">
                                        <div class="bg-gradient-to-r from-emerald-500 to-teal-500 h-2 rounded-full transition-all duration-1000" style="width: 34%"></div>
                                    </div>
                                </div>

                                <div class="space-y-2">
                                    <div class="flex justify-between items-center">
                                        <span class="text-white/70 text-sm">Network I/O</span>
                                        <span class="text-white text-sm" id="networkIO">89%</span>
                                    </div>
                                    <div class="w-full bg-white/10 rounded-full h-2">
                                        <div class="bg-gradient-to-r from-orange-500 to-red-500 h-2 rounded-full transition-all duration-1000" style="width: 89%"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Status Indicators -->
                            <div class="mt-6 space-y-3">
                                <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                                        <span class="text-white/80 text-sm">API Gateway</span>
                                    </div>
                                    <span class="text-green-400 text-xs">Online</span>
                                </div>
                                <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                                        <span class="text-white/80 text-sm">Database Cluster</span>
                                    </div>
                                    <span class="text-green-400 text-xs">Healthy</span>
                                </div>
                                <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-2 h-2 bg-yellow-400 rounded-full animate-pulse"></div>
                                        <span class="text-white/80 text-sm">Cache Layer</span>
                                    </div>
                                    <span class="text-yellow-400 text-xs">Warning</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Secondary Analytics Grid -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <!-- Usage Distribution -->
                        <div class="glass rounded-xl p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-white">Module Usage Distribution</h3>
                                <button onclick="refreshUsageData()" class="text-white/70 hover:text-white">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-4 h-4 bg-gradient-to-r from-blue-500 to-blue-600 rounded"></div>
                                        <span class="text-white/80">Workflow Management</span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <div class="w-24 bg-white/10 rounded-full h-2">
                                            <div class="bg-gradient-to-r from-blue-500 to-blue-600 h-2 rounded-full" style="width: 85%"></div>
                                        </div>
                                        <span class="text-white text-sm w-10">85%</span>
                                    </div>
                                </div>

                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-4 h-4 bg-gradient-to-r from-purple-500 to-purple-600 rounded"></div>
                                        <span class="text-white/80">Grant Management</span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <div class="w-24 bg-white/10 rounded-full h-2">
                                            <div class="bg-gradient-to-r from-purple-500 to-purple-600 h-2 rounded-full" style="width: 72%"></div>
                                        </div>
                                        <span class="text-white text-sm w-10">72%</span>
                                    </div>
                                </div>

                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-4 h-4 bg-gradient-to-r from-green-500 to-green-600 rounded"></div>
                                        <span class="text-white/80">Security Analysis</span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <div class="w-24 bg-white/10 rounded-full h-2">
                                            <div class="bg-gradient-to-r from-green-500 to-green-600 h-2 rounded-full" style="width: 68%"></div>
                                        </div>
                                        <span class="text-white text-sm w-10">68%</span>
                                    </div>
                                </div>

                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-4 h-4 bg-gradient-to-r from-yellow-500 to-yellow-600 rounded"></div>
                                        <span class="text-white/80">Citizen Portal</span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <div class="w-24 bg-white/10 rounded-full h-2">
                                            <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 h-2 rounded-full" style="width: 54%"></div>
                                        </div>
                                        <span class="text-white text-sm w-10">54%</span>
                                    </div>
                                </div>

                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-4 h-4 bg-gradient-to-r from-red-500 to-red-600 rounded"></div>
                                        <span class="text-white/80">Compliance Monitor</span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <div class="w-24 bg-white/10 rounded-full h-2">
                                            <div class="bg-gradient-to-r from-red-500 to-red-600 h-2 rounded-full" style="width: 41%"></div>
                                        </div>
                                        <span class="text-white text-sm w-10">41%</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Pie Chart Visualization -->
                            <div class="mt-6 flex justify-center">
                                <div class="relative w-40 h-40">
                                    <svg class="w-full h-full transform -rotate-90" viewBox="0 0 100 100">
                                        <circle cx="50" cy="50" r="40" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="8"/>
                                        <!-- Workflow Management - 85% -->
                                        <circle cx="50" cy="50" r="40" fill="none" stroke="url(#gradient-blue)" stroke-width="8" 
                                                stroke-dasharray="214" stroke-dashoffset="32" class="animate-pulse"/>
                                        <!-- Grant Management - 72% -->
                                        <circle cx="50" cy="50" r="40" fill="none" stroke="url(#gradient-purple)" stroke-width="6" 
                                                stroke-dasharray="181" stroke-dashoffset="70" class="animate-pulse" style="animation-delay: 0.2s"/>
                                    </svg>
                                    <!-- Gradients for the circles -->
                                    <svg width="0" height="0">
                                        <defs>
                                            <linearGradient id="gradient-blue" x1="0%" y1="0%" x2="100%" y2="0%">
                                                <stop offset="0%" style="stop-color:#3B82F6"/>
                                                <stop offset="100%" style="stop-color:#1D4ED8"/>
                                            </linearGradient>
                                            <linearGradient id="gradient-purple" x1="0%" y1="0%" x2="100%" y2="0%">
                                                <stop offset="0%" style="stop-color:#8B5CF6"/>
                                                <stop offset="100%" style="stop-color:#5B21B6"/>
                                            </linearGradient>
                                        </defs>
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <!-- Real-Time Activity Feed -->
                        <div class="glass rounded-xl p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-white">Real-Time Activity</h3>
                                <div class="flex items-center space-x-2">
                                    <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                                    <span class="text-green-400 text-xs">Live</span>
                                </div>
                            </div>
                            <div id="activityFeed" class="space-y-3 max-h-80 overflow-y-auto custom-scrollbar">
                                <!-- Real-time activity items will be populated here -->
                            </div>
                            <div class="mt-4 text-center">
                                <button onclick="loadMoreActivity()" class="text-blue-400 hover:text-blue-300 text-sm">
                                    Load More Activity
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Metrics -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Error Rate Trends -->
                        <div class="glass rounded-xl p-6">
                            <h3 class="text-lg font-semibold text-white mb-4">Error Rate Analysis</h3>
                            <div class="space-y-4">
                                <div class="text-center">
                                    <div class="text-3xl font-bold text-green-400 mb-1">0.03%</div>
                                    <div class="text-white/60 text-sm">Current Error Rate</div>
                                </div>
                                <div class="space-y-2">
                                    <div class="flex justify-between text-sm">
                                        <span class="text-white/70">Authentication</span>
                                        <span class="text-red-400">0.01%</span>
                                    </div>
                                    <div class="flex justify-between text-sm">
                                        <span class="text-white/70">API Calls</span>
                                        <span class="text-yellow-400">0.02%</span>
                                    </div>
                                    <div class="flex justify-between text-sm">
                                        <span class="text-white/70">Database</span>
                                        <span class="text-green-400">0.00%</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Geographic Distribution -->
                        <div class="glass rounded-xl p-6">
                            <h3 class="text-lg font-semibold text-white mb-4">User Distribution</h3>
                            <div class="space-y-3">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-2">
                                        <div class="w-6 h-4 bg-blue-500 rounded-sm"></div>
                                        <span class="text-white/80 text-sm">United States</span>
                                    </div>
                                    <span class="text-white text-sm">47%</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-2">
                                        <div class="w-6 h-4 bg-green-500 rounded-sm"></div>
                                        <span class="text-white/80 text-sm">Canada</span>
                                    </div>
                                    <span class="text-white text-sm">23%</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-2">
                                        <div class="w-6 h-4 bg-yellow-500 rounded-sm"></div>
                                        <span class="text-white/80 text-sm">United Kingdom</span>
                                    </div>
                                    <span class="text-white text-sm">18%</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-2">
                                        <div class="w-6 h-4 bg-purple-500 rounded-sm"></div>
                                        <span class="text-white/80 text-sm">Australia</span>
                                    </div>
                                    <span class="text-white text-sm">12%</span>
                                </div>
                            </div>
                        </div>

                        <!-- Performance Benchmarks -->
                        <div class="glass rounded-xl p-6">
                            <h3 class="text-lg font-semibold text-white mb-4">Performance Benchmarks</h3>
                            <div class="space-y-4">
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-blue-400 mb-1">A+</div>
                                    <div class="text-white/60 text-sm">Overall Grade</div>
                                </div>
                                <div class="space-y-2">
                                    <div class="flex justify-between text-sm">
                                        <span class="text-white/70">Speed Index</span>
                                        <span class="text-green-400">1.2s</span>
                                    </div>
                                    <div class="flex justify-between text-sm">
                                        <span class="text-white/70">Time to Interactive</span>
                                        <span class="text-green-400">2.1s</span>
                                    </div>
                                    <div class="flex justify-between text-sm">
                                        <span class="text-white/70">First Paint</span>
                                        <span class="text-green-400">0.8s</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Added 2024-12-09: Predictive Analytics Dashboard -->
                    <div class="mt-6 glass rounded-xl p-6">
                        <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-3">
                            <i class="fas fa-chart-line text-purple-400"></i>
                            Predictive Analytics & Forecasting
                        </h2>

                        <!-- Row 1: Forecasting Chart + ML Confidence -->
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                            <!-- 30-Day Workload Forecast -->
                            <div class="lg:col-span-2 glass rounded-xl p-6">
                                <div class="flex items-center justify-between mb-4">
                                    <div>
                                        <h3 class="font-bold text-white mb-1">30-Day Workload Forecast</h3>
                                        <p class="text-sm text-white/70">Predicted case volume based on historical patterns</p>
                                    </div>
                                    <button
                                        id="exportForecastBtn"
                                        class="px-4 py-2 bg-blue-500/20 hover:bg-blue-500/30 rounded-lg text-blue-300 transition-all text-sm"
                                        aria-label="Export forecast data">
                                        <i class="fas fa-download mr-2"></i>Export
                                    </button>
                                </div>

                                <!-- Chart -->
                                <div class="relative h-64 flex items-end justify-between gap-1" id="forecastChart">
                                    <!-- Bars will be generated by JS -->
                                </div>

                                <!-- Legend -->
                                <div class="flex items-center justify-center gap-4 mt-4 text-sm">
                                    <div class="flex items-center gap-2">
                                        <div class="w-4 h-4 bg-gradient-to-r from-blue-400 to-cyan-500 rounded"></div>
                                        <span class="text-white/70">Historical</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="w-4 h-4 bg-gradient-to-r from-purple-400 to-pink-500 rounded"></div>
                                        <span class="text-white/70">Predicted</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="w-4 h-4 bg-gradient-to-r from-yellow-400 to-orange-500 rounded"></div>
                                        <span class="text-white/70">Anomaly</span>
                                    </div>
                                </div>
                            </div>

                            <!-- ML Confidence Scores -->
                            <div class="glass rounded-xl p-6">
                                <h3 class="font-bold text-white mb-4">ML Confidence Scores</h3>

                                <div class="space-y-4">
                                    <!-- Overall Confidence Ring -->
                                    <div class="text-center">
                                        <div class="relative w-32 h-32 mx-auto mb-3">
                                            <svg class="w-32 h-32 transform -rotate-90" viewBox="0 0 120 120">
                                                <circle cx="60" cy="60" r="50" fill="none" stroke="rgb(75 85 99)" stroke-width="8"/>
                                                <circle
                                                    cx="60" cy="60" r="50"
                                                    fill="none"
                                                    stroke="url(#gradientPredictive1)"
                                                    stroke-width="8"
                                                    stroke-linecap="round"
                                                    stroke-dasharray="314"
                                                    stroke-dashoffset="62.8"
                                                    class="confidence-ring"/>
                                                <defs>
                                                    <linearGradient id="gradientPredictive1" x1="0%" y1="0%" x2="100%" y2="100%">
                                                        <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:1" />
                                                        <stop offset="100%" style="stop-color:#8b5cf6;stop-opacity:1" />
                                                    </linearGradient>
                                                </defs>
                                            </svg>
                                            <div class="absolute inset-0 flex items-center justify-center">
                                                <div class="text-center">
                                                    <div class="text-2xl font-bold text-white">87%</div>
                                                    <div class="text-xs text-white/70">Overall</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Individual Model Scores -->
                                    <div class="space-y-3">
                                        <div>
                                            <div class="flex justify-between text-sm mb-1">
                                                <span class="text-white/70">Workload Model</span>
                                                <span class="text-green-400 font-medium">92%</span>
                                            </div>
                                            <div class="h-2 bg-white/10 rounded-full overflow-hidden">
                                                <div class="h-full bg-gradient-to-r from-green-400 to-emerald-500 rounded-full" style="width: 92%"></div>
                                            </div>
                                        </div>

                                        <div>
                                            <div class="flex justify-between text-sm mb-1">
                                                <span class="text-white/70">Resource Model</span>
                                                <span class="text-blue-400 font-medium">85%</span>
                                            </div>
                                            <div class="h-2 bg-white/10 rounded-full overflow-hidden">
                                                <div class="h-full bg-gradient-to-r from-blue-400 to-cyan-500 rounded-full" style="width: 85%"></div>
                                            </div>
                                        </div>

                                        <div>
                                            <div class="flex justify-between text-sm mb-1">
                                                <span class="text-white/70">Anomaly Detection</span>
                                                <span class="text-purple-400 font-medium">84%</span>
                                            </div>
                                            <div class="h-2 bg-white/10 rounded-full overflow-hidden">
                                                <div class="h-full bg-gradient-to-r from-purple-400 to-pink-500 rounded-full" style="width: 84%"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mt-4 p-3 bg-blue-500/10 border border-blue-500/30 rounded-lg">
                                        <p class="text-xs text-blue-300">
                                            <i class="fas fa-info-circle mr-1"></i>
                                            Models trained on 6 months of historical data
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Row 2: Resource Recommendations + Anomaly Detection -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <!-- AI Resource Allocation -->
                            <div class="glass rounded-xl p-6">
                                <h3 class="font-bold text-white mb-4 flex items-center gap-2">
                                    <i class="fas fa-users-cog text-blue-400"></i>
                                    AI Resource Recommendations
                                </h3>

                                <div class="space-y-4" id="resourceRecommendations">
                                    <!-- Generated by JS -->
                                </div>

                                <div class="mt-4 pt-4 border-t border-white/10">
                                    <button
                                        id="applyRecommendationsBtn"
                                        class="w-full px-4 py-2 bg-gradient-to-r from-green-500 to-blue-600 rounded-lg text-white font-medium hover:shadow-lg transition-all"
                                        aria-label="Apply recommendations">
                                        <i class="fas fa-check mr-2"></i>Apply Recommendations
                                    </button>
                                </div>
                            </div>

                            <!-- Anomaly Detection Alerts -->
                            <div class="glass rounded-xl p-6">
                                <h3 class="font-bold text-white mb-4 flex items-center gap-2">
                                    <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                                    Anomaly Detection Alerts
                                </h3>

                                <div class="space-y-3" id="anomalyAlerts">
                                    <!-- Generated by JS -->
                                </div>

                                <div class="mt-4 text-center">
                                    <button class="text-sm text-blue-400 hover:text-blue-300 transition-all">
                                        View All Alerts <i class="fas fa-arrow-right ml-1"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Row 3: What-If Analysis Scenario Planner -->
                        <div class="glass rounded-xl p-6">
                            <div class="flex items-center justify-between mb-6">
                                <div>
                                    <h3 class="font-bold text-white mb-1 flex items-center gap-2">
                                        <i class="fas fa-sliders-h text-purple-400"></i>
                                        What-If Analysis: Scenario Planning
                                    </h3>
                                    <p class="text-sm text-white/70">Adjust variables to test different scenarios</p>
                                </div>
                                <button
                                    id="resetScenariosBtn"
                                    class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-white text-sm transition-all"
                                    aria-label="Reset to defaults">
                                    <i class="fas fa-undo mr-2"></i>Reset
                                </button>
                            </div>

                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <!-- Scenario Controls -->
                                <div class="space-y-6">
                                    <div>
                                        <label class="text-white/70 text-sm mb-2 block">Staffing Level Adjustment</label>
                                        <input
                                            type="range"
                                            id="staffingSlider"
                                            min="50"
                                            max="150"
                                            value="100"
                                            class="w-full"
                                            aria-label="Adjust staffing level">
                                        <div class="flex justify-between text-xs text-white/50 mt-1">
                                            <span>-50%</span>
                                            <span id="staffingValue" class="text-white font-medium">100%</span>
                                            <span>+50%</span>
                                        </div>
                                    </div>

                                    <div>
                                        <label class="text-white/70 text-sm mb-2 block">Expected Case Volume Change</label>
                                        <input
                                            type="range"
                                            id="volumeSlider"
                                            min="50"
                                            max="150"
                                            value="100"
                                            class="w-full"
                                            aria-label="Adjust case volume">
                                        <div class="flex justify-between text-xs text-white/50 mt-1">
                                            <span>-50%</span>
                                            <span id="volumeValue" class="text-white font-medium">100%</span>
                                            <span>+50%</span>
                                        </div>
                                    </div>

                                    <div>
                                        <label class="text-white/70 text-sm mb-2 block">Process Efficiency</label>
                                        <input
                                            type="range"
                                            id="efficiencySlider"
                                            min="70"
                                            max="130"
                                            value="100"
                                            class="w-full"
                                            aria-label="Adjust efficiency">
                                        <div class="flex justify-between text-xs text-white/50 mt-1">
                                            <span>70%</span>
                                            <span id="efficiencyValue" class="text-white font-medium">100%</span>
                                            <span>130%</span>
                                        </div>
                                    </div>

                                    <button
                                        id="runScenarioBtn"
                                        class="w-full px-4 py-3 bg-gradient-to-r from-purple-500 to-pink-600 rounded-lg text-white font-medium hover:shadow-lg transition-all"
                                        aria-label="Run scenario analysis">
                                        <i class="fas fa-play mr-2"></i>Run Scenario Analysis
                                    </button>
                                </div>

                                <!-- Scenario Results -->
                                <div class="glass-dark rounded-lg p-6">
                                    <h4 class="text-white font-bold mb-4">Predicted Outcomes</h4>
                                    <div id="scenarioResults" class="space-y-4">
                                        <div class="flex items-center justify-between p-3 bg-blue-500/10 rounded-lg">
                                            <div>
                                                <div class="text-white/70 text-sm">Average Processing Time</div>
                                                <div class="text-2xl font-bold text-white mt-1">2.4 days</div>
                                            </div>
                                            <div class="text-green-400">
                                                <i class="fas fa-arrow-down"></i> 12%
                                            </div>
                                        </div>

                                        <div class="flex items-center justify-between p-3 bg-purple-500/10 rounded-lg">
                                            <div>
                                                <div class="text-white/70 text-sm">Capacity Utilization</div>
                                                <div class="text-2xl font-bold text-white mt-1">78%</div>
                                            </div>
                                            <div class="text-yellow-400">
                                                <i class="fas fa-minus"></i> 0%
                                            </div>
                                        </div>

                                        <div class="flex items-center justify-between p-3 bg-green-500/10 rounded-lg">
                                            <div>
                                                <div class="text-white/70 text-sm">Backlog Reduction</div>
                                                <div class="text-2xl font-bold text-white mt-1">45%</div>
                                            </div>
                                            <div class="text-green-400">
                                                <i class="fas fa-arrow-up"></i> 15%
                                            </div>
                                        </div>

                                        <div class="flex items-center justify-between p-3 bg-red-500/10 rounded-lg">
                                            <div>
                                                <div class="text-white/70 text-sm">Resource Cost Impact</div>
                                                <div class="text-2xl font-bold text-white mt-1">$0</div>
                                            </div>
                                            <div class="text-white/50">
                                                <i class="fas fa-minus"></i> 0%
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Compliance Tab -->
                <div id="compliance-content" class="tab-content" style="display: none;">
                    <!-- Compliance Badges -->
                    <div class="glass rounded-xl p-6 mb-6">
                        <h3 class="text-lg font-semibold text-white mb-4">Compliance Dashboard</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="text-center p-4 bg-green-500/20 rounded-lg">
                                <i class="fas fa-check-circle text-green-400 text-3xl mb-2"></i>
                                <h4 class="font-semibold text-white">GDPR Compliance</h4>
                                <p class="text-green-300 text-sm">Fully Compliant</p>
                            </div>

                            <div class="text-center p-4 bg-green-500/20 rounded-lg">
                                <i class="fas fa-shield-alt text-green-400 text-3xl mb-2"></i>
                                <h4 class="font-semibold text-white">SOC 2 Type II</h4>
                                <p class="text-green-300 text-sm">Certified</p>
                            </div>

                            <div class="text-center p-4 bg-yellow-500/20 rounded-lg">
                                <i class="fas fa-exclamation-triangle text-yellow-400 text-3xl mb-2"></i>
                                <h4 class="font-semibold text-white">FISMA</h4>
                                <p class="text-yellow-300 text-sm">Under Review</p>
                            </div>
                        </div>
                    </div>

                    <!-- Blockchain Audit Trail - Added 2024-12-09 -->
                    <div id="blockchainAuditTrail">
                        <!-- Blockchain content will be injected here by JavaScript -->
                    </div>

                    <!-- Policy Intelligence Center - Added 2025-10-07 -->
                    <div id="policyIntelligenceCenter">
                        <!-- Policy Intelligence content will be injected here by JavaScript -->
                    </div>
                </div>
                
                <!-- Grant Management Tab -->
                <div id="grants-content" class="tab-content" style="display: none;">
                    <!-- Header Section -->
                    <div class="glass rounded-xl p-6 mb-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="text-2xl font-bold text-white mb-2">Grant Management AI</h2>
                                <p class="text-white/70">Discover, track, and manage federal grants with cutting-edge AI assistance</p>
                            </div>
                            <div class="flex items-center space-x-3">
                                <div class="flex items-center space-x-2">
                                    <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                                    <span class="text-green-400 text-sm">AI Assistant Active</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Grant Search Assistant -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <!-- Search Interface -->
                        <div class="lg:col-span-2">
                            <div class="glass rounded-xl p-6">
                                <div class="flex items-center space-x-2 mb-4">
                                    <i class="fas fa-robot text-purple-400 text-xl"></i>
                                    <h3 class="text-lg font-semibold text-white">AI Grant Discovery Assistant</h3>
                                </div>
                                
                                <div class="space-y-4">
                                    <div class="relative">
                                        <input 
                                            type="text" 
                                            id="grant-search-input"
                                            placeholder="Describe your technology or project needs (e.g., 'AI cybersecurity tools', 'renewable energy infrastructure', 'smart city sensors')"
                                            class="w-full p-4 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/50 focus:outline-none focus:border-purple-400 focus:ring-2 focus:ring-purple-400/20"
                                        >
                                        <button 
                                            onclick="searchGrants()"
                                            class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-gradient-to-r from-purple-500 to-blue-500 hover:from-purple-600 hover:to-blue-600 text-white px-6 py-2 rounded-lg font-medium transition-all duration-200 flex items-center space-x-2"
                                        >
                                            <i class="fas fa-search"></i>
                                            <span>Search Grants</span>
                                        </button>
                                    </div>
                                    
                                    <!-- Quick Search Tags -->
                                    <div class="flex flex-wrap gap-2">
                                        <span class="text-white/70 text-sm">Quick searches:</span>
                                        <button onclick="quickSearch('cybersecurity')" class="px-3 py-1 bg-blue-500/20 text-blue-300 rounded-full text-sm hover:bg-blue-500/30 transition-colors">Cybersecurity</button>
                                        <button onclick="quickSearch('AI machine learning')" class="px-3 py-1 bg-purple-500/20 text-purple-300 rounded-full text-sm hover:bg-purple-500/30 transition-colors">AI & ML</button>
                                        <button onclick="quickSearch('infrastructure')" class="px-3 py-1 bg-green-500/20 text-green-300 rounded-full text-sm hover:bg-green-500/30 transition-colors">Infrastructure</button>
                                        <button onclick="quickSearch('research development')" class="px-3 py-1 bg-yellow-500/20 text-yellow-300 rounded-full text-sm hover:bg-yellow-500/30 transition-colors">R&D</button>
                                        <button onclick="quickSearch('emergency management')" class="px-3 py-1 bg-red-500/20 text-red-300 rounded-full text-sm hover:bg-red-500/30 transition-colors">Emergency Mgmt</button>
                                    </div>
                                </div>
                                
                                <!-- AI Search Status -->
                                <div id="search-status" class="mt-4 p-3 bg-blue-500/10 border border-blue-500/20 rounded-lg hidden">
                                    <div class="flex items-center space-x-2">
                                        <div class="w-4 h-4 border-2 border-blue-400 border-t-transparent rounded-full animate-spin"></div>
                                        <span class="text-blue-300">AI is analyzing federal grant databases...</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Grant Analytics -->
                        <div class="glass rounded-xl p-6">
                            <h3 class="text-lg font-semibold text-white mb-4">Grant Analytics</h3>
                            <div class="space-y-4">
                                <div class="bg-white/5 rounded-lg p-4">
                                    <div class="flex items-center justify-between">
                                        <span class="text-white/70">Total Available</span>
                                        <span class="text-green-400 font-semibold">$2.4B</span>
                                    </div>
                                </div>
                                <div class="bg-white/5 rounded-lg p-4">
                                    <div class="flex items-center justify-between">
                                        <span class="text-white/70">Active Opportunities</span>
                                        <span class="text-blue-400 font-semibold">1,247</span>
                                    </div>
                                </div>
                                <div class="bg-white/5 rounded-lg p-4">
                                    <div class="flex items-center justify-between">
                                        <span class="text-white/70">Closing This Month</span>
                                        <span class="text-orange-400 font-semibold">89</span>
                                    </div>
                                </div>
                                <div class="bg-white/5 rounded-lg p-4">
                                    <div class="flex items-center justify-between">
                                        <span class="text-white/70">Match Rate</span>
                                        <span class="text-purple-400 font-semibold">94%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Search Results -->
                    <div id="grant-results" class="glass rounded-xl p-6 mb-6">
                        <h3 class="text-lg font-semibold text-white mb-4">AI-Matched Grant Opportunities</h3>
                        <div id="grantSearchResults" class="space-y-4">
                            <!-- Results will be populated here -->
                        </div>
                    </div>

                    <!-- AI Insights -->
                    <div class="glass rounded-xl p-6 mb-6">
                        <h3 class="text-lg font-semibold text-white mb-4">AI Grant Insights</h3>
                        <div id="aiInsights" class="space-y-3">
                            <!-- AI insights will be populated here -->
                        </div>
                    </div>

                    <!-- Grant Pipeline Management -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Active Applications -->
                        <div class="glass rounded-xl p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-white">Active Applications</h3>
                                <button onclick="showAddGrantModal()" class="bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center space-x-2">
                                    <i class="fas fa-plus"></i>
                                    <span>Add Grant</span>
                                </button>
                            </div>
                            
                            <div id="grantPipeline" class="space-y-3">
                                <!-- Dynamic grant pipeline will be populated here by JavaScript -->
                            </div>
                                
                                <div class="bg-white/5 rounded-lg p-4 border-l-4 border-purple-400">
                                    <div class="flex items-center justify-between mb-2">
                                        <h4 class="font-semibold text-white">DOE Smart Grid Technology</h4>
                                        <span class="px-2 py-1 bg-green-500/20 text-green-300 rounded text-sm">Submitted</span>
                                    </div>
                                    <p class="text-white/70 text-sm mb-2">$750K • Submitted: Dec 1, 2023</p>
                                    <div class="w-full bg-gray-700 rounded-full h-2">
                                        <div class="bg-gradient-to-r from-purple-500 to-pink-500 h-2 rounded-full" style="width: 100%"></div>
                                    </div>
                                    <p class="text-right text-white/50 text-xs mt-1">Awaiting Review</p>
                                </div>
                            </div>
                        </div>

                        <!-- AI Insights & Recommendations -->
                        <div class="glass rounded-xl p-6">
                            <h3 class="text-lg font-semibold text-white mb-4">AI Insights & Recommendations</h3>
                            <div class="space-y-4">
                                <div class="bg-gradient-to-r from-purple-500/10 to-blue-500/10 border border-purple-500/20 rounded-lg p-4">
                                    <div class="flex items-start space-x-3">
                                        <i class="fas fa-lightbulb text-yellow-400 text-lg mt-1"></i>
                                        <div>
                                            <h4 class="font-semibold text-white mb-1">New Opportunity Alert</h4>
                                            <p class="text-white/70 text-sm">Based on your profile, DARPA just released a $50M cybersecurity grant that matches your expertise 96%.</p>
                                            <button class="mt-2 text-purple-400 hover:text-purple-300 text-sm font-medium">View Details →</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-gradient-to-r from-blue-500/10 to-green-500/10 border border-blue-500/20 rounded-lg p-4">
                                    <div class="flex items-start space-x-3">
                                        <i class="fas fa-clock text-orange-400 text-lg mt-1"></i>
                                        <div>
                                            <h4 class="font-semibold text-white mb-1">Deadline Reminder</h4>
                                            <p class="text-white/70 text-sm">DHS Cybersecurity Innovation application deadline is in 12 days. AI suggests prioritizing Section 3 completion.</p>
                                            <button class="mt-2 text-blue-400 hover:text-blue-300 text-sm font-medium">Open Application →</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-gradient-to-r from-green-500/10 to-purple-500/10 border border-green-500/20 rounded-lg p-4">
                                    <div class="flex items-start space-x-3">
                                        <i class="fas fa-chart-line text-green-400 text-lg mt-1"></i>
                                        <div>
                                            <h4 class="font-semibold text-white mb-1">Success Optimization</h4>
                                            <p class="text-white/70 text-sm">Your application success rate could increase by 23% by adding more quantitative metrics to your proposals.</p>
                                            <button class="mt-2 text-green-400 hover:text-green-300 text-sm font-medium">Get Suggestions →</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Settings Tab -->
                <div id="settings-content" class="tab-content" style="display: none;">
                    <div class="glass rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-white mb-4">System Settings</h3>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between p-4 bg-white/5 rounded-lg">
                                <div>
                                    <h4 class="font-medium text-white">Auto-Deploy Workflows</h4>
                                    <p class="text-sm text-white/70">Automatically deploy approved workflows</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                            
                            <div class="flex items-center justify-between p-4 bg-white/5 rounded-lg">
                                <div>
                                    <h4 class="font-medium text-white">Security Alerts</h4>
                                    <p class="text-sm text-white/70">Real-time security notifications</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
                
                <!-- CRM Tab -->
                <div id="crm-content" class="tab-content h-full" style="display: none;">
                    <div class="h-full flex flex-col">
                        <!-- Enterprise CRM Header with Command Center -->
                        <div class="glass rounded-xl p-6 mb-4 flex-shrink-0">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center space-x-4">
                                    <div class="w-12 h-12 bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl flex items-center justify-center">
                                        <i class="fas fa-network-wired text-white text-xl"></i>
                                    </div>
                                    <div>
                                        <h3 class="text-2xl font-bold text-white">Enterprise CRM Intelligence</h3>
                                        <p class="text-white/70 text-sm">AI-Powered Relationship Management • CJIS IL5 • Zero Trust Architecture</p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <div class="flex items-center space-x-2 bg-emerald-500/20 px-3 py-1.5 rounded-lg border border-emerald-400/30">
                                        <div class="w-2 h-2 bg-emerald-400 rounded-full animate-pulse"></div>
                                        <span class="text-emerald-300 text-xs font-semibold">FedRAMP IL5</span>
                                    </div>
                                    <div class="flex items-center space-x-2 bg-blue-500/20 px-3 py-1.5 rounded-lg border border-blue-400/30">
                                        <i class="fas fa-shield-check text-blue-400 text-xs"></i>
                                        <span class="text-blue-300 text-xs font-semibold">CJIS Certified</span>
                                    </div>
                                    <div class="flex items-center space-x-2 bg-purple-500/20 px-3 py-1.5 rounded-lg border border-purple-400/30">
                                        <i class="fas fa-brain text-purple-400 text-xs"></i>
                                        <span class="text-purple-300 text-xs font-semibold">AI Active</span>
                                    </div>
                                    <button onclick="showNewContactModal()" class="bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white px-5 py-2.5 rounded-lg transition-all duration-200 flex items-center space-x-2 shadow-lg">
                                        <i class="fas fa-plus text-sm"></i>
                                        <span class="font-medium">Add Contact</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Main CRM Content - Scrollable -->
                        <div class="flex-1 overflow-y-auto space-y-4 pr-2">
                            <!-- AI Command Center -->
                            <div class="glass rounded-xl p-6">
                                <div class="flex items-center space-x-3 mb-4">
                                    <div class="w-10 h-10 bg-gradient-to-r from-purple-500 to-pink-500 rounded-xl flex items-center justify-center">
                                        <i class="fas fa-robot text-white"></i>
                                    </div>
                                    <div>
                                        <h4 class="text-white font-semibold text-lg">CRM AI Command Center</h4>
                                        <p class="text-white/60 text-sm">Natural language relationship intelligence and automation</p>
                                    </div>
                                    <div class="ml-auto flex items-center space-x-2">
                                        <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                                        <span class="text-green-400 text-xs font-medium">Online</span>
                                    </div>
                                </div>
                                <div class="flex space-x-3">
                                    <div class="flex-1 relative">
                                        <input type="text" id="crmAiInput" placeholder="Ask: 'Show me high-value prospects from last month' or 'Schedule follow-ups for all pending deals'" 
                                               class="w-full bg-black/20 border border-white/20 rounded-xl px-4 py-4 pr-12 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all">
                                        <div class="absolute right-3 top-4 text-white/40">
                                            <i class="fas fa-microphone hover:text-purple-400 cursor-pointer transition-colors"></i>
                                        </div>
                                    </div>
                                    <button onclick="processCrmAiQuery()" class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white px-6 py-4 rounded-xl transition-all duration-200 flex items-center space-x-2 shadow-lg">
                                        <i class="fas fa-paper-plane"></i>
                                        <span class="font-medium">Execute</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Enterprise Dashboard Grid -->
                            <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
                                <!-- Real-time Metrics -->
                                <div class="glass rounded-xl p-6">
                                    <div class="flex items-center justify-between mb-4">
                                        <h4 class="text-white font-semibold">Contact Intelligence</h4>
                                        <i class="fas fa-chart-network text-blue-400"></i>
                                    </div>
                                    <div class="space-y-4">
                                        <div class="flex justify-between items-center">
                                            <span class="text-white/70 text-sm">Total Contacts</span>
                                            <span class="text-xl font-bold text-white">28,574</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-white/70 text-sm">Active Engagements</span>
                                            <span class="text-lg font-semibold text-emerald-400">1,247</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-white/70 text-sm">AI Predictions</span>
                                            <span class="text-lg font-semibold text-purple-400">94.3%</span>
                                        </div>
                                        <div class="w-full bg-white/10 rounded-full h-2">
                                            <div class="bg-gradient-to-r from-blue-500 to-purple-500 h-2 rounded-full animate-pulse" style="width: 87%"></div>
                                        </div>
                                        <p class="text-xs text-white/60">87% relationship health score</p>
                                    </div>
                                </div>

                                <!-- Security & Compliance -->
                                <div class="glass rounded-xl p-6">
                                    <div class="flex items-center justify-between mb-4">
                                        <h4 class="text-white font-semibold">Security Matrix</h4>
                                        <i class="fas fa-shield-check text-emerald-400"></i>
                                    </div>
                                    <div class="space-y-3">
                                        <div class="flex items-center justify-between">
                                            <span class="text-white/70 text-sm">Zero Trust</span>
                                            <span class="text-emerald-400 font-semibold text-sm">Active</span>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <span class="text-white/70 text-sm">Quantum Encryption</span>
                                            <span class="text-emerald-400 font-semibold text-sm">256-bit</span>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <span class="text-white/70 text-sm">Audit Trail</span>
                                            <span class="text-emerald-400 font-semibold text-sm">Real-time</span>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <span class="text-white/70 text-sm">Compliance</span>
                                            <span class="text-emerald-400 font-semibold text-sm">99.97%</span>
                                        </div>
                                        <div class="p-3 bg-emerald-500/20 rounded-lg border border-emerald-400/30">
                                            <div class="flex items-center space-x-2">
                                                <i class="fas fa-check-circle text-emerald-400 text-sm"></i>
                                                <span class="text-emerald-300 text-xs font-medium">All systems secure</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Performance Analytics -->
                                <div class="glass rounded-xl p-6">
                                    <div class="flex items-center justify-between mb-4">
                                        <h4 class="text-white font-semibold">Performance</h4>
                                        <i class="fas fa-tachometer-alt text-yellow-400"></i>
                                    </div>
                                    <div class="space-y-3">
                                        <div class="flex items-center justify-between">
                                            <span class="text-white/70 text-sm">Response Time</span>
                                            <span class="text-yellow-400 font-semibold text-sm">34ms</span>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <span class="text-white/70 text-sm">Uptime</span>
                                            <span class="text-emerald-400 font-semibold text-sm">99.99%</span>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <span class="text-white/70 text-sm">Scalability</span>
                                            <span class="text-blue-400 font-semibold text-sm">Auto</span>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <span class="text-white/70 text-sm">Load Balance</span>
                                            <span class="text-purple-400 font-semibold text-sm">Optimal</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Quick Actions Panel -->
                                <div class="glass rounded-xl p-6">
                                    <div class="flex items-center justify-between mb-4">
                                        <h4 class="text-white font-semibold">Operations</h4>
                                        <i class="fas fa-bolt text-orange-400"></i>
                                    </div>
                                    <div class="space-y-2">
                                        <button onclick="bulkImportContacts()" class="w-full bg-blue-600/20 hover:bg-blue-600/30 text-blue-300 py-2.5 rounded-lg transition-all duration-200 flex items-center justify-center space-x-2 border border-blue-500/30">
                                            <i class="fas fa-upload text-xs"></i>
                                            <span class="text-sm font-medium">Import</span>
                                        </button>
                                        <button onclick="exportContacts()" class="w-full bg-emerald-600/20 hover:bg-emerald-600/30 text-emerald-300 py-2.5 rounded-lg transition-all duration-200 flex items-center justify-center space-x-2 border border-emerald-500/30">
                                            <i class="fas fa-download text-xs"></i>
                                            <span class="text-sm font-medium">Export</span>
                                        </button>
                                        <button onclick="runComplianceAudit()" class="w-full bg-purple-600/20 hover:bg-purple-600/30 text-purple-300 py-2.5 rounded-lg transition-all duration-200 flex items-center justify-center space-x-2 border border-purple-500/30">
                                            <i class="fas fa-clipboard-check text-xs"></i>
                                            <span class="text-sm font-medium">Audit</span>
                                        </button>
                                        <button onclick="generateReport()" class="w-full bg-orange-600/20 hover:bg-orange-600/30 text-orange-300 py-2.5 rounded-lg transition-all duration-200 flex items-center justify-center space-x-2 border border-orange-500/30">
                                            <i class="fas fa-chart-bar text-xs"></i>
                                            <span class="text-sm font-medium">Reports</span>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Advanced Contact Management Interface -->
                            <div class="glass rounded-xl p-6">
                                <div class="flex items-center justify-between mb-6">
                                    <div class="flex items-center space-x-3">
                                        <h4 class="text-xl font-semibold text-white">Intelligent Contact Matrix</h4>
                                        <div class="flex items-center space-x-2 bg-blue-500/20 px-3 py-1 rounded-lg">
                                            <i class="fas fa-sync-alt text-blue-400 text-xs animate-spin"></i>
                                            <span class="text-blue-300 text-xs font-medium">Live Sync</span>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        <div class="flex items-center space-x-2">
                                            <button onclick="toggleContactView('grid')" class="p-2 bg-white/10 hover:bg-white/20 rounded-lg transition-colors">
                                                <i class="fas fa-th text-white/70 hover:text-white"></i>
                                            </button>
                                            <button onclick="toggleContactView('list')" class="p-2 bg-blue-600 rounded-lg">
                                                <i class="fas fa-list text-white"></i>
                                            </button>
                                        </div>
                                        <div class="relative">
                                            <input type="text" id="contactSearch" placeholder="Search by name, role, department..." 
                                                   class="bg-black/20 border border-white/20 rounded-lg px-4 py-2 pl-10 pr-20 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-blue-500 w-64">
                                            <i class="fas fa-search absolute left-3 top-3 text-white/50"></i>
                                            <div class="absolute right-2 top-2 flex items-center space-x-1">
                                                <button class="p-1 hover:bg-white/10 rounded">
                                                    <i class="fas fa-filter text-white/50 text-xs"></i>
                                                </button>
                                                <button class="p-1 hover:bg-white/10 rounded">
                                                    <i class="fas fa-sort text-white/50 text-xs"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <select id="contactFilter" class="bg-black/20 border border-white/20 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="all">All Contacts</option>
                                            <option value="citizens">Citizens</option>
                                            <option value="officials">Government Officials</option>
                                            <option value="vendors">Verified Vendors</option>
                                            <option value="contractors">Licensed Contractors</option>
                                            <option value="high-value">High-Value Contacts</option>
                                            <option value="recent">Recent Activity</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Enhanced Contact Table -->
                                <div class="overflow-hidden rounded-xl border border-white/10">
                                    <div class="overflow-x-auto max-h-96">
                                        <table class="w-full">
                                            <thead class="bg-black/30 sticky top-0">
                                                <tr>
                                                    <th class="text-left py-4 px-6 text-white/70 font-semibold text-sm border-b border-white/10">
                                                        <div class="flex items-center space-x-2">
                                                            <input type="checkbox" class="rounded border-white/30">
                                                            <span>Contact Profile</span>
                                                        </div>
                                                    </th>
                                                    <th class="text-left py-4 px-6 text-white/70 font-semibold text-sm border-b border-white/10">Classification</th>
                                                    <th class="text-left py-4 px-6 text-white/70 font-semibold text-sm border-b border-white/10">Department/Org</th>
                                                    <th class="text-left py-4 px-6 text-white/70 font-semibold text-sm border-b border-white/10">Engagement</th>
                                                    <th class="text-left py-4 px-6 text-white/70 font-semibold text-sm border-b border-white/10">Status</th>
                                                    <th class="text-left py-4 px-6 text-white/70 font-semibold text-sm border-b border-white/10">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="contactsTableBody" class="divide-y divide-white/5">
                                                <!-- Contacts will be populated dynamically -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    
    <!-- New Request Modal -->
    <div id="newRequestModal" class="modal">
        <div class="glass rounded-2xl p-8 max-w-3xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-bold text-white">Submit New Service Request</h3>
                <button onclick="closeNewRequestModal()" class="text-white/60 hover:text-white text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="newRequestForm" class="space-y-6">
                <!-- Service Type -->
                <div>
                    <label class="block text-sm font-medium text-white mb-2">Service Type *</label>
                    <select id="serviceType" required class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Select a service...</option>
                        <optgroup label="Permits & Licenses">
                            <option value="building_permit">Building Permit</option>
                            <option value="renovation_permit">Renovation Permit</option>
                            <option value="business_license">Business License</option>
                            <option value="event_permit">Event Permit</option>
                            <option value="sign_permit">Sign Permit</option>
                        </optgroup>
                        <optgroup label="Public Services">
                            <option value="pothole_repair">Pothole Repair</option>
                            <option value="streetlight_issue">Streetlight Issue</option>
                            <option value="tree_service">Tree Service Request</option>
                            <option value="trash_pickup">Trash/Recycling Issue</option>
                            <option value="water_sewer">Water/Sewer Issue</option>
                        </optgroup>
                        <optgroup label="Code Enforcement">
                            <option value="noise_complaint">Noise Complaint</option>
                            <option value="property_maintenance">Property Maintenance</option>
                            <option value="zoning_violation">Zoning Violation</option>
                        </optgroup>
                        <optgroup label="Other">
                            <option value="tax_inquiry">Tax Inquiry</option>
                            <option value="general_inquiry">General Inquiry</option>
                            <option value="document_request">Document Request</option>
                        </optgroup>
                    </select>
                    <div id="aiSuggestion" class="mt-2 text-sm text-blue-300 hidden">
                        <i class="fas fa-lightbulb mr-1"></i>
                        <span id="aiSuggestionText"></span>
                    </div>
                </div>

                <!-- Intelligent Document Processing - Added 2025-10-18 -->
                <div class="glass rounded-xl p-6 bg-gradient-to-r from-purple-600/10 to-blue-600/10">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h4 class="text-lg font-bold text-white flex items-center gap-2">
                                <i class="fas fa-magic text-purple-400"></i>
                                Speed Up Your Application
                            </h4>
                            <p class="text-sm text-white/70 mt-1">Upload documents to auto-fill your information with AI-powered OCR</p>
                        </div>
                    </div>

                    <!-- Document Upload Zone -->
                    <div id="docProcessingDropZone" class="border-2 border-dashed border-white/30 rounded-lg p-8 text-center cursor-pointer hover:border-blue-400 hover:bg-blue-500/5 transition-all" role="button" tabindex="0" aria-label="Upload documents for auto-fill">
                        <i class="fas fa-file-upload text-4xl text-white/30 mb-3" aria-hidden="true"></i>
                        <p class="text-white font-medium mb-2">Upload Documents to Auto-fill</p>
                        <p class="text-sm text-white/60 mb-3">Driver's License, Utility Bills, Business Cards, Tax Bills, or Previous Permits</p>
                        <div class="flex items-center justify-center gap-2 mb-3">
                            <span class="text-xs bg-blue-500/20 text-blue-300 px-2 py-1 rounded-full">PDF</span>
                            <span class="text-xs bg-green-500/20 text-green-300 px-2 py-1 rounded-full">JPG</span>
                            <span class="text-xs bg-purple-500/20 text-purple-300 px-2 py-1 rounded-full">PNG</span>
                        </div>
                        <button type="button" class="bg-gradient-to-r from-blue-500 to-purple-600 px-4 py-2 rounded-lg text-white text-sm hover:shadow-lg transition-all" aria-label="Take photo with camera">
                            <i class="fas fa-camera mr-2" aria-hidden="true"></i>Take Photo
                        </button>
                        <input type="file" id="docProcessingFileInput" class="hidden" accept=".pdf,.jpg,.jpeg,.png" multiple aria-label="Select documents to upload">
                    </div>

                    <!-- Processing Status -->
                    <div id="docProcessingStatus" class="mt-4 hidden">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="animate-spin">
                                <i class="fas fa-spinner text-blue-400 text-xl"></i>
                            </div>
                            <div>
                                <h5 class="text-sm font-bold text-white">Analyzing Document...</h5>
                                <p class="text-xs text-white/60">Extracting text and data</p>
                            </div>
                        </div>
                        <div class="w-full bg-white/10 rounded-full h-2 overflow-hidden">
                            <div id="docProcessingProgressBar" class="bg-gradient-to-r from-blue-500 to-purple-600 h-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <p id="docProcessingProgressText" class="text-xs text-white/50 mt-2">Initializing...</p>
                    </div>

                    <!-- Extracted Data Review -->
                    <div id="docProcessingExtractedPanel" class="mt-4 hidden">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-check-circle text-green-400"></i>
                                <span class="text-sm font-bold text-white">Data Extracted</span>
                                <span id="docProcessingConfidence" class="text-xs"></span>
                            </div>
                            <button type="button" onclick="autoFillFromDocument()" class="text-sm bg-blue-500/20 text-blue-300 px-3 py-1 rounded-lg hover:bg-blue-500/30 transition-all" aria-label="Auto-fill form with extracted data">
                                <i class="fas fa-bolt mr-1" aria-hidden="true"></i>Auto-fill (<span id="docProcessingFieldCount">0</span> fields)
                            </button>
                        </div>
                        <div id="docProcessingFields" class="text-xs text-white/70 bg-white/5 rounded-lg p-3 max-h-32 overflow-y-auto">
                            <!-- Extracted fields preview -->
                        </div>
                    </div>
                </div>

                <!-- Personal Information -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-white mb-2">First Name *</label>
                        <input type="text" id="firstName" required class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-3 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter first name">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-white mb-2">Last Name *</label>
                        <input type="text" id="lastName" required class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-3 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter last name">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-white mb-2">Email Address *</label>
                        <input type="email" id="email" required class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-3 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="your@email.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-white mb-2">Phone Number</label>
                        <input type="tel" id="phone" class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-3 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="(555) 123-4567">
                    </div>
                </div>

                <!-- Address -->
                <div>
                    <label class="block text-sm font-medium text-white mb-2">Property/Service Address</label>
                    <input type="text" id="address" class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-3 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="123 Main Street, City, State ZIP">
                </div>

                <!-- Description -->
                <div>
                    <label class="block text-sm font-medium text-white mb-2">Description *</label>
                    <textarea id="description" required rows="4" class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-3 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Please describe your request in detail..."></textarea>
                    <div class="text-xs text-white/60 mt-1">
                        <span id="charCount">0</span>/500 characters
                    </div>
                </div>

                <!-- Urgency -->
                <div>
                    <label class="block text-sm font-medium text-white mb-2">Priority Level</label>
                    <div class="grid grid-cols-3 gap-3">
                        <label class="flex items-center p-3 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10 transition-colors">
                            <input type="radio" name="priority" value="low" class="mr-2" checked>
                            <div>
                                <div class="text-green-400 font-medium">Low</div>
                                <div class="text-xs text-white/70">Standard processing</div>
                            </div>
                        </label>
                        <label class="flex items-center p-3 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10 transition-colors">
                            <input type="radio" name="priority" value="medium" class="mr-2">
                            <div>
                                <div class="text-yellow-400 font-medium">Medium</div>
                                <div class="text-xs text-white/70">Expedited review</div>
                            </div>
                        </label>
                        <label class="flex items-center p-3 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10 transition-colors">
                            <input type="radio" name="priority" value="high" class="mr-2">
                            <div>
                                <div class="text-red-400 font-medium">High</div>
                                <div class="text-xs text-white/70">Urgent attention</div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- File Upload -->
                <div>
                    <label class="block text-sm font-medium text-white mb-2">Attachments</label>
                    <div class="border-2 border-dashed border-white/20 rounded-lg p-6 text-center hover:border-white/40 transition-colors">
                        <i class="fas fa-cloud-upload-alt text-3xl text-white/40 mb-2"></i>
                        <p class="text-white/70 mb-2">Drag and drop files here, or click to browse</p>
                        <p class="text-xs text-white/50">Maximum 5 files, 10MB each. PDF, JPG, PNG, DOC supported.</p>
                        <input type="file" id="fileUpload" multiple class="hidden" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
                        <button type="button" onclick="document.getElementById('fileUpload').click()" class="mt-3 bg-white/10 text-white px-4 py-2 rounded-lg hover:bg-white/20 transition-colors">
                            Choose Files
                        </button>
                    </div>
                    <div id="fileList" class="mt-3 space-y-2"></div>
                </div>

                <!-- AI Routing Preview -->
                <div id="routingPreview" class="bg-gradient-to-r from-blue-500/20 to-green-500/20 rounded-lg p-4 hidden">
                    <div class="flex items-center space-x-2 mb-2">
                        <i class="fas fa-robot text-blue-400"></i>
                        <span class="text-white font-medium">AI Routing Suggestion</span>
                    </div>
                    <div id="routingInfo" class="text-sm text-white/80"></div>
                </div>

                <!-- Submit Buttons -->
                <div class="flex justify-end space-x-4 pt-4 border-t border-white/20">
                    <button type="button" onclick="closeNewRequestModal()" class="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" class="px-6 py-3 bg-gradient-to-r from-green-500 to-blue-600 text-white rounded-lg hover:shadow-lg transition-all">
                        <i class="fas fa-paper-plane mr-2"></i>Submit Request
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Enhanced Workflow Builder Modal -->
    <div id="workflowModal" class="modal">
        <div class="glass rounded-2xl p-8 max-w-6xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-r from-purple-500 to-blue-600 rounded-full flex items-center justify-center">
                        <i class="fas fa-magic text-white"></i>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-white">AI-Powered Workflow Builder</h3>
                        <p class="text-sm text-white/70">Create intelligent, automated government processes</p>
                    </div>
                </div>
                <button onclick="closeModal()" class="text-white/60 hover:text-white text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- AI Assistant Section -->
            <div class="bg-gradient-to-r from-blue-500/20 to-purple-500/20 rounded-xl p-4 mb-6">
                <div class="flex items-center space-x-3 mb-3">
                    <i class="fas fa-robot text-blue-400"></i>
                    <span class="text-white font-medium">AI Workflow Assistant</span>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <button onclick="generateWorkflowSuggestion('approval')" class="text-left p-3 bg-white/10 rounded-lg hover:bg-white/20 transition-colors">
                        <div class="text-sm font-medium text-white">Smart Approval Chain</div>
                        <div class="text-xs text-white/70">Auto-route based on amount/type</div>
                    </button>
                    <button onclick="generateWorkflowSuggestion('notification')" class="text-left p-3 bg-white/10 rounded-lg hover:bg-white/20 transition-colors">
                        <div class="text-sm font-medium text-white">Intelligent Notifications</div>
                        <div class="text-xs text-white/70">Multi-channel alerts & reminders</div>
                    </button>
                    <button onclick="generateWorkflowSuggestion('escalation')" class="text-left p-3 bg-white/10 rounded-lg hover:bg-white/20 transition-colors">
                        <div class="text-sm font-medium text-white">Auto-Escalation</div>
                        <div class="text-xs text-white/70">Time-based priority handling</div>
                    </button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Configuration Panel -->
                <div>
                    <h4 class="text-lg font-semibold text-white mb-4">Workflow Configuration</h4>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-white mb-2">Workflow Name *</label>
                            <input type="text" id="workflowName" placeholder="Enter descriptive workflow name"
                                   class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-2 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <div class="text-xs text-white/60 mt-1">Use clear, descriptive names (e.g., "Building Permit Review Process")</div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-white mb-2">Department *</label>
                            <select id="department" onchange="updateDepartmentTemplates()" class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Select Department</option>
                                <option value="permits">Building & Permits</option>
                                <option value="tax">Tax & Finance</option>
                                <option value="public_works">Public Works</option>
                                <option value="health">Health Department</option>
                                <option value="planning">Planning & Zoning</option>
                                <option value="legal">Legal Department</option>
                                <option value="hr">Human Resources</option>
                                <option value="it">IT Services</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-white mb-2">Workflow Type</label>
                            <select id="workflowType" onchange="updateWorkflowSuggestions()" class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Select Type</option>
                                <option value="approval">Approval Process</option>
                                <option value="review">Review & Inspection</option>
                                <option value="application">Application Processing</option>
                                <option value="complaint">Complaint Handling</option>
                                <option value="maintenance">Maintenance Request</option>
                                <option value="compliance">Compliance Check</option>
                                <option value="emergency">Emergency Response</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-white mb-2">Priority Level</label>
                            <div class="grid grid-cols-3 gap-2">
                                <label class="flex items-center p-2 bg-white/5 rounded cursor-pointer hover:bg-white/10">
                                    <input type="radio" name="priority" value="low" class="mr-2 text-blue-500" checked>
                                    <span class="text-white text-sm">Low</span>
                                </label>
                                <label class="flex items-center p-2 bg-white/5 rounded cursor-pointer hover:bg-white/10">
                                    <input type="radio" name="priority" value="medium" class="mr-2 text-blue-500">
                                    <span class="text-white text-sm">Medium</span>
                                </label>
                                <label class="flex items-center p-2 bg-white/5 rounded cursor-pointer hover:bg-white/10">
                                    <input type="radio" name="priority" value="high" class="mr-2 text-blue-500">
                                    <span class="text-white text-sm">High</span>
                                </label>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-white mb-2">SLA (Service Level Agreement)</label>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="number" id="slaHours" placeholder="Hours" min="1" max="168" 
                                       class="bg-white/10 border border-white/20 rounded-lg px-3 py-2 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <select id="slaUnit" class="bg-white/10 border border-white/20 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="hours">Hours</option>
                                    <option value="days">Business Days</option>
                                    <option value="weeks">Weeks</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- AI Optimization Suggestions -->
                    <div id="aiSuggestions" class="mt-6 p-4 bg-green-500/20 rounded-lg hidden">
                        <div class="flex items-center space-x-2 mb-3">
                            <i class="fas fa-lightbulb text-green-400"></i>
                            <span class="text-green-300 font-medium">AI Optimization Suggestions</span>
                        </div>
                        <div id="suggestionsList" class="space-y-2 text-sm text-white/80">
                            <!-- Suggestions will be populated here -->
                        </div>
                    </div>
                </div>
                
                <!-- Workflow Steps Builder -->
                <div>
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-lg font-semibold text-white">Workflow Steps</h4>
                        <div class="flex space-x-2">
                            <button onclick="showStepLibrary()" class="text-xs bg-purple-600 text-white px-3 py-1 rounded-lg hover:bg-purple-700 transition-colors">
                                <i class="fas fa-book mr-1"></i>Step Library
                            </button>
                            <button onclick="optimizeWorkflow()" class="text-xs bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700 transition-colors">
                                <i class="fas fa-magic mr-1"></i>AI Optimize
                            </button>
                        </div>
                    </div>
                    
                    <div id="workflowStepsBuilder" class="space-y-3 max-h-80 overflow-y-auto mb-4">
                        <!-- Steps will be added dynamically -->
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="addWorkflowStep()" class="bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-plus mr-2"></i>Add Step
                        </button>
                        <button onclick="addConditionalStep()" class="bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition-colors">
                            <i class="fas fa-code-branch mr-2"></i>Add Condition
                        </button>
                    </div>

                    <!-- Workflow Validation -->
                    <div id="workflowValidation" class="mt-4 p-3 bg-yellow-500/20 rounded-lg hidden">
                        <div class="flex items-center space-x-2 mb-2">
                            <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                            <span class="text-yellow-300 font-medium">Workflow Validation</span>
                        </div>
                        <div id="validationIssues" class="text-sm text-white/80">
                            <!-- Validation issues will be shown here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Workflow Preview & Testing -->
            <div class="mt-8 p-6 bg-black/20 rounded-xl">
                <div class="flex items-center justify-between mb-4">
                    <h4 class="text-lg font-semibold text-white">Workflow Preview</h4>
                    <div class="flex space-x-2">
                        <button onclick="testWorkflow()" class="text-sm bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition-colors">
                            <i class="fas fa-play mr-2"></i>Test Run
                        </button>
                        <button onclick="exportWorkflow()" class="text-sm bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                            <i class="fas fa-download mr-2"></i>Export
                        </button>
                    </div>
                </div>
                <div id="workflowPreviewCanvas" class="min-h-[200px] bg-white/5 rounded-lg flex items-center justify-center">
                    <div class="text-white/60 text-center">
                        <i class="fas fa-sitemap text-4xl mb-4"></i>
                        <p>Add workflow steps to see preview</p>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end space-x-4 mt-8 pt-4 border-t border-white/20">
                <button onclick="closeModal()" class="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                    Cancel
                </button>
                <button onclick="saveWorkflowDraft()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    Save Draft
                </button>
                <button onclick="saveWorkflow()" class="px-6 py-2 bg-gradient-to-r from-green-500 to-blue-600 text-white rounded-lg hover:shadow-lg transition-all">
                    <i class="fas fa-rocket mr-2"></i>Deploy Workflow
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // Global state
        let selectedWorkflow = null;
        let workflowStepCount = 0;
        let currentWorkflowSteps = [];
        
        // CRM Data
        let crmContacts = [
            {
                id: 1,
                name: "Sarah Johnson",
                email: "sarah.johnson@citymail.gov",
                type: "citizen",
                department: "Public Works",
                lastContact: "2024-01-15",
                status: "active",
                phone: "(555) 123-4567",
                address: "123 Oak Street, Downtown",
                notes: "Regular participant in town halls, environmental advocate"
            },
            {
                id: 2,
                name: "Detective Michael Chen",
                email: "m.chen@police.gov",
                type: "official",
                department: "Police Department",
                lastContact: "2024-01-18",
                status: "active",
                phone: "(555) 234-5678",
                address: "Police Headquarters",
                notes: "Lead investigator for fraud cases, CJIS certified"
            },
            {
                id: 3,
                name: "TechCorp Solutions",
                email: "contracts@techcorp.com",
                type: "vendor",
                department: "IT Services",
                lastContact: "2024-01-12",
                status: "active",
                phone: "(555) 345-6789",
                address: "456 Business Blvd",
                notes: "Primary IT contractor, FedRAMP High certified"
            },
            {
                id: 4,
                name: "Jennifer Martinez",
                email: "j.martinez@contractor.com",
                type: "contractor",
                department: "Infrastructure",
                lastContact: "2024-01-10",
                status: "inactive",
                phone: "(555) 456-7890",
                address: "789 Construction Way",
                notes: "Civil engineer, infrastructure planning specialist"
            },
            {
                id: 5,
                name: "Robert Wilson",
                email: "robert.wilson@residents.gov",
                type: "citizen",
                department: "Community Services",
                lastContact: "2024-01-17",
                status: "active",
                phone: "(555) 567-8901",
                address: "321 Maple Avenue",
                notes: "Community volunteer, frequent service requests"
            }
        ];
        let workflowLibrary = {
            stepTypes: {
                'input': { name: 'Data Input', icon: 'fas fa-keyboard', description: 'Collect information from forms or APIs' },
                'validation': { name: 'Validation', icon: 'fas fa-check-circle', description: 'Verify data accuracy and completeness' },
                'approval': { name: 'Approval', icon: 'fas fa-user-check', description: 'Route for human or automated approval' },
                'notification': { name: 'Notification', icon: 'fas fa-bell', description: 'Send alerts via email, SMS, or system' },
                'decision': { name: 'Decision Point', icon: 'fas fa-code-branch', description: 'Conditional logic based on criteria' },
                'assignment': { name: 'Task Assignment', icon: 'fas fa-user-tag', description: 'Assign work to specific users or roles' },
                'calculation': { name: 'Calculation', icon: 'fas fa-calculator', description: 'Perform mathematical or logical operations' },
                'integration': { name: 'System Integration', icon: 'fas fa-link', description: 'Connect with external systems or databases' },
                'document': { name: 'Document Generation', icon: 'fas fa-file-alt', description: 'Create reports, certificates, or forms' },
                'doc_processing': { name: 'Document Processing (AI)', icon: 'fas fa-magic', description: 'AI-powered OCR extraction and auto-fill (CJIS Compliant)' },
                'escalation': { name: 'Escalation', icon: 'fas fa-exclamation-triangle', description: 'Auto-escalate based on time or conditions' },
                'archive': { name: 'Archive/Store', icon: 'fas fa-archive', description: 'Store completed work or documents' },
                'completion': { name: 'Completion', icon: 'fas fa-flag-checkered', description: 'Final step and closure notifications' }
            },
            bestPractices: {
                'approval': [
                    'Add timeout escalation for approvals',
                    'Include delegation when approvers are unavailable',
                    'Send reminder notifications before deadline',
                    'Log all approval decisions with timestamps'
                ],
                'notification': [
                    'Use multiple channels for critical notifications',
                    'Include relevant case information in messages',
                    'Set delivery confirmation requirements',
                    'Personalize messages with recipient names'
                ],
                'escalation': [
                    'Define clear escalation criteria and timeframes',
                    'Notify all relevant parties of escalations',
                    'Include escalation history in case records',
                    'Set automatic supervisor notifications'
                ],
                'doc_processing': [
                    'Set confidence thresholds (High: >85%, Medium: 70-85%, Low: <70%)',
                    'Route low-confidence extractions for manual review',
                    'Enable PII detection and masking for sensitive documents',
                    'Configure document type templates for common forms',
                    'Set up CJIS-compliant audit logging for all document access',
                    'Enable duplicate detection to prevent reprocessing',
                    'Test OCR accuracy with sample documents before deployment'
                ]
            }
        };
        let userRequests = [
            {
                id: 'REQ-2024-001',
                type: 'Building Permit',
                description: 'Deck addition to rear of property',
                status: 'Under Review',
                statusColor: 'yellow',
                date: '2024-01-15',
                department: 'Building & Safety',
                priority: 'medium'
            },
            {
                id: 'REQ-2024-002',
                type: 'Business License',
                description: 'New restaurant license application',
                status: 'Approved',
                statusColor: 'green',
                date: '2024-01-10',
                department: 'Business Licensing',
                priority: 'low'
            },
            {
                id: 'REQ-2024-003',
                type: 'Pothole Repair',
                description: 'Large pothole on Oak Street near 5th Ave',
                status: 'In Progress',
                statusColor: 'blue',
                date: '2024-01-20',
                department: 'Public Works',
                priority: 'high'
            },
            {
                id: 'REQ-2024-004',
                type: 'Tree Service',
                description: 'Dead tree removal from front yard',
                status: 'Pending',
                statusColor: 'gray',
                date: '2024-01-22',
                department: 'Parks & Recreation',
                priority: 'low'
            },
            {
                id: 'REQ-2024-005',
                type: 'Noise Complaint',
                description: 'Loud construction work after hours',
                status: 'Resolved',
                statusColor: 'green',
                date: '2024-01-18',
                department: 'Code Enforcement',
                priority: 'medium'
            }
        ];
        
        // Workflow templates
        const workflowTemplates = [
            {
                id: 'permit',
                name: 'Permit Processing',
                icon: 'fas fa-file-signature',
                color: 'from-blue-500 to-cyan-500',
                description: 'Automate permit applications and approvals',
                steps: [
                    'Receive permit application',
                    'Validate required documents',
                    'Route to appropriate department',
                    'Conduct automated compliance checks',
                    'Schedule inspections if needed',
                    'Generate approval/denial notification',
                    'Update public records'
                ]
            },
            {
                id: 'tax',
                name: 'Tax Assessment',
                icon: 'fas fa-calculator',
                color: 'from-green-500 to-teal-500',
                description: 'Streamline tax calculation and collection',
                steps: [
                    'Import property data',
                    'Calculate assessed values',
                    'Apply tax rates and exemptions',
                    'Generate tax bills',
                    'Send notifications to taxpayers',
                    'Process payments',
                    'Handle appeals if necessary'
                ]
            },
            {
                id: 'complaint',
                name: 'Complaint Handling',
                icon: 'fas fa-exclamation-triangle',
                color: 'from-yellow-500 to-orange-500',
                description: 'Manage and resolve citizen complaints',
                steps: [
                    'Log complaint details',
                    'Categorize by department and priority',
                    'Assign to appropriate staff',
                    'Send acknowledgment to citizen',
                    'Track resolution progress',
                    'Notify citizen of resolution',
                    'Close case and update records'
                ]
            },
            {
                id: 'license',
                name: 'Business Licensing',
                icon: 'fas fa-certificate',
                color: 'from-purple-500 to-indigo-500',
                description: 'Process business license applications',
                steps: [
                    'Receive license application',
                    'Verify business information',
                    'Check zoning compliance',
                    'Process fee payments',
                    'Conduct background checks',
                    'Issue license or request corrections',
                    'Schedule renewal reminders'
                ]
            }
        ];
        
        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            initializeWorkflowTemplates();
            populateRecentActivity();
            populateRecentRequests();
            populateCitizenRequests();
            startTypingAnimation();
            initializeNewRequestForm();
            updateCitizenCounter();
            initializeDocumentProcessing(); // Added 2025-10-18: Intelligent Document Processing
        });

        function updateCitizenCounter() {
            document.getElementById('userRequestCountCitizen').textContent = userRequests.length;
        }
        
        // Tab switching
        function switchTab(tabName) {
            // Update nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.nav-item').classList.add('active');
            
            // Hide all content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            // Show selected content
            document.getElementById(tabName + '-content').style.display = 'block';
            
            // Update header
            const titles = {
                dashboard: { title: 'Admin Dashboard', subtitle: 'System monitoring and workflow management' },
                citizen: { title: 'Citizen Portal', subtitle: 'Submit requests, track applications, and access city services' },
                workflows: { title: 'Workflow Management', subtitle: 'Create and manage automated processes' },
                security: { title: 'Security Analysis', subtitle: 'Threat detection and vulnerability assessment' },
                analytics: { title: 'System Analytics', subtitle: 'Performance metrics and insights' },
                compliance: { title: 'Compliance Monitor', subtitle: 'Regulatory compliance tracking' },
                grants: { title: 'Grant Management', subtitle: 'AI-powered federal grant discovery and workflow management' },
                crm: { title: 'CRM Management', subtitle: 'AI-powered customer relationship management with CJIS compliance' },
                settings: { title: 'System Settings', subtitle: 'Configure platform preferences' }
            };
            
            document.getElementById('pageTitle').textContent = titles[tabName].title;
            document.getElementById('pageSubtitle').textContent = titles[tabName].subtitle;
            
            // Initialize specific tab functionality
            if (tabName === 'analytics' && document.getElementById('activityFeed')) {
                initializeAnalytics();
            }
            if (tabName === 'crm' && document.getElementById('contactsTableBody')) {
                initializeCRM();
            }
            if (tabName === 'compliance' && document.getElementById('blockchainAuditTrail')) {
                initializeBlockchain();
            }
            if (tabName === 'compliance' && document.getElementById('policyIntelligenceCenter')) {
                initializePolicyIntelligence();
            }
            if (tabName === 'citizen' && document.getElementById('regulationAssistant')) {
                initializeRegulationAssistant();
            }
            if (tabName === 'security' && document.getElementById('quantumSecurityModule')) {
                initializeQuantumSecurity();
            }
        }
        
        // Initialize workflow templates
        function initializeWorkflowTemplates() {
            const container = document.getElementById('workflowTemplates');
            if (!container) return;
            
            container.innerHTML = workflowTemplates.map(template => `
                <div class="workflow-card glass rounded-xl p-6 text-center" onclick="selectWorkflow('${template.id}')">
                    <div class="w-16 h-16 bg-gradient-to-r ${template.color} rounded-xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                        <i class="${template.icon} text-2xl text-white"></i>
                    </div>
                    <h4 class="font-bold text-lg mb-2 text-white">${template.name}</h4>
                    <p class="text-sm text-white/70 mb-4">${template.description}</p>
                    <div class="text-xs text-blue-300">
                        <i class="fas fa-list mr-1"></i>${template.steps.length} automated steps
                    </div>
                </div>
            `).join('');
        }
        
        // Select workflow
        function selectWorkflow(workflowId) {
            document.querySelectorAll('.workflow-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            event.target.closest('.workflow-card').classList.add('selected');
            selectedWorkflow = workflowTemplates.find(w => w.id === workflowId);
            
            showWorkflowPreview(selectedWorkflow);
        }
        
        // Show workflow preview
        function showWorkflowPreview(workflow) {
            const preview = document.getElementById('workflowPreview');
            const stepsContainer = document.getElementById('workflowSteps');
            
            stepsContainer.innerHTML = workflow.steps.map((step, index) => `
                <div class="flex items-center p-3 bg-white/5 rounded-lg mb-2">
                    <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-sm mr-3">
                        ${index + 1}
                    </div>
                    <span class="text-white">${step}</span>
                </div>
            `).join('');
            
            preview.style.display = 'block';
            preview.scrollIntoView({ behavior: 'smooth' });
        }
        
        // Clear selection
        function clearSelection() {
            document.querySelectorAll('.workflow-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById('workflowPreview').style.display = 'none';
            selectedWorkflow = null;
        }
        
        // Deploy workflow
        function deployWorkflow() {
            if (!selectedWorkflow) return;
            
            addChatMessage(`🚀 Deploying "${selectedWorkflow.name}" workflow... Setting up ${selectedWorkflow.steps.length} automated steps.`, 'ai');
            
            setTimeout(() => {
                addChatMessage(`✅ Workflow "${selectedWorkflow.name}" deployed successfully! Now monitoring for new requests.`, 'ai');
                clearSelection();
            }, 2000);
        }
        
        // Modal functions
        function openWorkflowBuilder() {
            document.getElementById('workflowModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function closeModal() {
            document.getElementById('workflowModal').classList.remove('active');
            document.body.style.overflow = 'auto';
        }
        
        // Enhanced Workflow Builder Functions
        function addWorkflowStep(stepType = null) {
            workflowStepCount++;
            const stepsContainer = document.getElementById('workflowStepsBuilder');
            const stepDiv = document.createElement('div');
            stepDiv.className = 'workflow-step p-4 bg-white/5 rounded-lg border border-white/10 hover:bg-white/10 transition-colors';
            stepDiv.dataset.stepId = `step-${workflowStepCount}`;
            
            const stepTypeOptions = Object.keys(workflowLibrary.stepTypes).map(type => 
                `<option value="${type}" ${stepType === type ? 'selected' : ''}>${workflowLibrary.stepTypes[type].name}</option>`
            ).join('');
            
            stepDiv.innerHTML = `
                <div class="flex items-start space-x-3">
                    <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white text-sm font-bold flex-shrink-0">
                        ${workflowStepCount}
                    </div>
                    <div class="flex-1 space-y-3">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-medium text-white/80 mb-1">Step Type</label>
                                <select onchange="updateStepType(this)" class="w-full bg-white/10 border border-white/20 rounded px-3 py-2 text-sm text-white focus:outline-none focus:ring-1 focus:ring-blue-500">
                                    <option value="">Select Type</option>
                                    ${stepTypeOptions}
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-white/80 mb-1">Assigned To</label>
                                <select class="w-full bg-white/10 border border-white/20 rounded px-3 py-2 text-sm text-white focus:outline-none focus:ring-1 focus:ring-blue-500">
                                    <option value="">Auto-assign</option>
                                    <option value="dept_head">Department Head</option>
                                    <option value="specialist">Subject Matter Expert</option>
                                    <option value="admin">System Administrator</option>
                                    <option value="external">External Reviewer</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-white/80 mb-1">Step Description</label>
                            <input type="text" placeholder="Describe what happens in this step..."
                                   class="w-full bg-white/10 border border-white/20 rounded px-3 py-2 text-sm text-white placeholder-white/60 focus:outline-none focus:ring-1 focus:ring-blue-500">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-medium text-white/80 mb-1">Time Limit</label>
                                <div class="flex space-x-1">
                                    <input type="number" placeholder="24" min="1" max="168" 
                                           class="flex-1 bg-white/10 border border-white/20 rounded px-2 py-1 text-xs text-white placeholder-white/60">
                                    <select class="bg-white/10 border border-white/20 rounded px-2 py-1 text-xs text-white">
                                        <option value="hours">hrs</option>
                                        <option value="days">days</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-white/80 mb-1">On Timeout</label>
                                <select class="w-full bg-white/10 border border-white/20 rounded px-2 py-1 text-xs text-white">
                                    <option value="escalate">Escalate</option>
                                    <option value="auto_approve">Auto-approve</option>
                                    <option value="notify">Notify only</option>
                                    <option value="reassign">Reassign</option>
                                </select>
                            </div>
                        </div>
                        <div class="step-conditions hidden bg-black/20 rounded p-3">
                            <label class="block text-xs font-medium text-white/80 mb-2">Conditions (if applicable)</label>
                            <textarea placeholder="Define conditions for this step (e.g., if amount > 1000, route to supervisor)"
                                      class="w-full bg-white/10 border border-white/20 rounded px-3 py-2 text-xs text-white placeholder-white/60 h-16"></textarea>
                        </div>
                    </div>
                    <div class="flex flex-col space-y-2">
                        <button onclick="duplicateStep(this)" class="text-blue-400 hover:text-blue-300 text-sm" title="Duplicate">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button onclick="moveStepUp(this)" class="text-green-400 hover:text-green-300 text-sm" title="Move Up">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button onclick="moveStepDown(this)" class="text-green-400 hover:text-green-300 text-sm" title="Move Down">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                        <button onclick="removeStep(this)" class="text-red-400 hover:text-red-300 text-sm" title="Remove">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            
            stepsContainer.appendChild(stepDiv);
            updateWorkflowPreview();
            
            // If stepType was provided, trigger the change event to load suggestions
            if (stepType) {
                const select = stepDiv.querySelector('select');
                updateStepType(select);
            }
        }

        function addConditionalStep() {
            addWorkflowStep('decision');
        }

        function updateStepType(selectElement) {
            const stepDiv = selectElement.closest('.workflow-step');
            const stepType = selectElement.value;
            const conditionsDiv = stepDiv.querySelector('.step-conditions');
            
            if (stepType === 'decision' || stepType === 'escalation') {
                conditionsDiv.classList.remove('hidden');
            } else {
                conditionsDiv.classList.add('hidden');
            }
            
            // Show AI suggestions for this step type
            if (stepType && workflowLibrary.bestPractices[stepType]) {
                showStepSuggestions(stepType, stepDiv);
            }
            
            updateWorkflowPreview();
        }

        function showStepSuggestions(stepType, stepDiv) {
            const suggestions = workflowLibrary.bestPractices[stepType];
            if (suggestions && suggestions.length > 0) {
                // Create or update suggestions tooltip
                let tooltip = stepDiv.querySelector('.step-suggestions');
                if (!tooltip) {
                    tooltip = document.createElement('div');
                    tooltip.className = 'step-suggestions absolute z-10 bg-blue-600 text-white text-xs rounded p-2 mt-1 max-w-xs shadow-lg';
                    tooltip.innerHTML = `
                        <div class="font-medium mb-1">💡 Best Practices:</div>
                        <ul class="list-disc list-inside space-y-1">
                            ${suggestions.map(s => `<li>${s}</li>`).join('')}
                        </ul>
                    `;
                    stepDiv.style.position = 'relative';
                    stepDiv.appendChild(tooltip);
                    
                    // Auto-hide after 5 seconds
                    setTimeout(() => {
                        if (tooltip.parentNode) {
                            tooltip.remove();
                        }
                    }, 5000);
                }
            }
        }

        function duplicateStep(button) {
            const stepDiv = button.closest('.workflow-step');
            const newStep = stepDiv.cloneNode(true);
            workflowStepCount++;
            
            // Update step number
            const stepNumber = newStep.querySelector('.bg-gradient-to-r');
            stepNumber.textContent = workflowStepCount;
            newStep.dataset.stepId = `step-${workflowStepCount}`;
            
            stepDiv.parentNode.insertBefore(newStep, stepDiv.nextSibling);
            updateWorkflowPreview();
        }

        function moveStepUp(button) {
            const stepDiv = button.closest('.workflow-step');
            const prevStep = stepDiv.previousElementSibling;
            if (prevStep) {
                stepDiv.parentNode.insertBefore(stepDiv, prevStep);
                renumberSteps();
                updateWorkflowPreview();
            }
        }

        function moveStepDown(button) {
            const stepDiv = button.closest('.workflow-step');
            const nextStep = stepDiv.nextElementSibling;
            if (nextStep) {
                stepDiv.parentNode.insertBefore(nextStep, stepDiv);
                renumberSteps();
                updateWorkflowPreview();
            }
        }

        function removeStep(button) {
            const stepDiv = button.closest('.workflow-step');
            stepDiv.remove();
            renumberSteps();
            updateWorkflowPreview();
        }

        function renumberSteps() {
            const steps = document.querySelectorAll('.workflow-step');
            steps.forEach((step, index) => {
                const stepNumber = step.querySelector('.bg-gradient-to-r');
                stepNumber.textContent = index + 1;
                step.dataset.stepId = `step-${index + 1}`;
            });
            workflowStepCount = steps.length;
        }
        
        // AI-Powered Workflow Functions
        function generateWorkflowSuggestion(suggestionType) {
            const department = document.getElementById('department').value;
            const workflowType = document.getElementById('workflowType').value;
            
            const suggestions = {
                'approval': {
                    name: 'Smart Approval Chain',
                    steps: [
                        { type: 'input', description: 'Receive request with automated data validation' },
                        { type: 'decision', description: 'Route based on amount, type, and urgency' },
                        { type: 'approval', description: 'Supervisor approval with 24hr timeout' },
                        { type: 'escalation', description: 'Auto-escalate to department head if needed' },
                        { type: 'notification', description: 'Multi-channel approval notification' },
                        { type: 'completion', description: 'Archive and close with analytics' }
                    ]
                },
                'notification': {
                    name: 'Intelligent Notification System',
                    steps: [
                        { type: 'input', description: 'Trigger event detection' },
                        { type: 'decision', description: 'Determine notification priority and channels' },
                        { type: 'notification', description: 'Send personalized alerts (email, SMS, app)' },
                        { type: 'validation', description: 'Confirm delivery and read receipts' },
                        { type: 'escalation', description: 'Retry with alternative channels if undelivered' },
                        { type: 'archive', description: 'Log communication history' }
                    ]
                },
                'escalation': {
                    name: 'Auto-Escalation Framework',
                    steps: [
                        { type: 'input', description: 'Monitor workflow progress and SLA compliance' },
                        { type: 'decision', description: 'Check if deadlines are approaching or missed' },
                        { type: 'escalation', description: 'Automatic escalation to next level' },
                        { type: 'assignment', description: 'Reassign to backup personnel if needed' },
                        { type: 'notification', description: 'Alert all stakeholders of escalation' },
                        { type: 'completion', description: 'Update escalation metrics and reports' }
                    ]
                }
            };
            
            if (suggestions[suggestionType]) {
                const suggestion = suggestions[suggestionType];
                
                // Clear existing steps
                document.getElementById('workflowStepsBuilder').innerHTML = '';
                workflowStepCount = 0;
                
                // Add suggested steps
                suggestion.steps.forEach(step => {
                    addWorkflowStep(step.type);
                    
                    // Fill in the description
                    const lastStep = document.querySelector('.workflow-step:last-child');
                    const descInput = lastStep.querySelector('input[placeholder*="Describe what happens"]');
                    if (descInput) {
                        descInput.value = step.description;
                    }
                });
                
                // Update workflow name
                const nameInput = document.getElementById('workflowName');
                if (!nameInput.value.trim()) {
                    nameInput.value = suggestion.name;
                }
                
                showAISuggestions([
                    `✨ Generated ${suggestion.name} with ${suggestion.steps.length} optimized steps`,
                    '🎯 Includes best practices for government workflows',
                    '⚡ Built-in escalation and notification handling',
                    '📊 Ready for compliance and audit tracking'
                ]);
            }
        }

        function updateDepartmentTemplates() {
            const department = document.getElementById('department').value;
            const departmentTemplates = {
                'permits': ['Application Processing', 'Review & Inspection', 'Approval Process'],
                'tax': ['Assessment Review', 'Appeal Handling', 'Payment Processing'],
                'public_works': ['Maintenance Request', 'Emergency Response', 'Project Approval'],
                'health': ['Inspection Process', 'Permit Review', 'Compliance Check']
            };
            
            if (departmentTemplates[department]) {
                showAISuggestions([
                    `📋 Common ${department} workflows:`,
                    ...departmentTemplates[department].map(t => `• ${t}`),
                    '🤖 Click "AI Optimize" for department-specific suggestions'
                ]);
            }
        }

        function updateWorkflowSuggestions() {
            const workflowType = document.getElementById('workflowType').value;
            const typeOptimizations = {
                'approval': ['Add parallel approval for faster processing', 'Include backup approvers', 'Set escalation timeouts'],
                'review': ['Use checklists for consistency', 'Include photo/document requirements', 'Add quality control step'],
                'application': ['Auto-validate common fields', 'Pre-populate known data', 'Include status tracking'],
                'complaint': ['Prioritize by severity', 'Include acknowledgment step', 'Add follow-up reminders'],
                'maintenance': ['Include location mapping', 'Add contractor assignment', 'Include completion photos']
            };
            
            if (typeOptimizations[workflowType]) {
                showAISuggestions(typeOptimizations[workflowType]);
            }
        }

        function optimizeWorkflow() {
            const steps = document.querySelectorAll('.workflow-step');
            if (steps.length === 0) {
                showAISuggestions(['⚠️ Add some workflow steps first, then I can optimize them!']);
                return;
            }
            
            const optimizations = [
                '⚡ Consider adding parallel processing where possible',
                '🔔 Include automated reminders before deadlines',
                '📊 Add data validation steps to prevent errors',
                '🔄 Include feedback loops for continuous improvement',
                '📱 Enable mobile notifications for urgent items',
                '🤖 Use AI to auto-categorize and route requests',
                '📈 Add analytics tracking for performance metrics',
                '🔒 Include security checkpoints for sensitive data'
            ];
            
            const randomOptimizations = optimizations.sort(() => 0.5 - Math.random()).slice(0, 4);
            showAISuggestions(randomOptimizations);
            
            // Simulate AI analysis
            setTimeout(() => {
                validateWorkflow();
            }, 1000);
        }

        function showStepLibrary() {
            const stepTypes = Object.entries(workflowLibrary.stepTypes);
            const libraryHtml = stepTypes.map(([key, step]) => 
                `<button onclick="addWorkflowStep('${key}')" class="text-left p-3 bg-white/10 rounded-lg hover:bg-white/20 transition-colors w-full">
                    <div class="flex items-center space-x-3">
                        <i class="${step.icon} text-blue-400"></i>
                        <div>
                            <div class="text-sm font-medium text-white">${step.name}</div>
                            <div class="text-xs text-white/70">${step.description}</div>
                        </div>
                    </div>
                </button>`
            ).join('');
            
            // Create modal or popup for step library
            showAISuggestions([
                '📚 Step Library - Click to add:',
                libraryHtml
            ]);
        }

        function showAISuggestions(suggestions) {
            const aiSuggestions = document.getElementById('aiSuggestions');
            const suggestionsList = document.getElementById('suggestionsList');
            
            suggestionsList.innerHTML = suggestions.map(s => 
                s.includes('<button') ? s : `<div class="flex items-start space-x-2"><span>•</span><span>${s}</span></div>`
            ).join('');
            
            aiSuggestions.classList.remove('hidden');
            
            // Auto-hide after 15 seconds unless it contains interactive elements
            if (!suggestions.some(s => s.includes('<button'))) {
                setTimeout(() => {
                    aiSuggestions.classList.add('hidden');
                }, 15000);
            }
        }

        function validateWorkflow() {
            const steps = document.querySelectorAll('.workflow-step');
            const issues = [];
            
            if (steps.length === 0) {
                issues.push('Workflow must have at least one step');
            }
            
            if (steps.length === 1) {
                issues.push('Consider adding more steps for a complete workflow');
            }
            
            // Check for missing step types
            let hasApproval = false;
            let hasCompletion = false;
            let hasNotification = false;
            
            steps.forEach(step => {
                const stepType = step.querySelector('select').value;
                if (stepType === 'approval') hasApproval = true;
                if (stepType === 'completion') hasCompletion = true;
                if (stepType === 'notification') hasNotification = true;
                
                const description = step.querySelector('input[placeholder*="Describe"]').value;
                if (!description.trim()) {
                    issues.push(`Step ${step.querySelector('.bg-gradient-to-r').textContent} needs a description`);
                }
            });
            
            if (steps.length > 2 && !hasCompletion) {
                issues.push('Consider adding a completion step to properly close the workflow');
            }
            
            if (steps.length > 3 && !hasNotification) {
                issues.push('Add notification steps to keep stakeholders informed');
            }
            
            const validation = document.getElementById('workflowValidation');
            const validationIssues = document.getElementById('validationIssues');
            
            if (issues.length > 0) {
                validationIssues.innerHTML = issues.map(issue => 
                    `<div class="flex items-start space-x-2 mb-1"><i class="fas fa-exclamation-triangle text-yellow-400 mt-0.5"></i><span>${issue}</span></div>`
                ).join('');
                validation.classList.remove('hidden');
            } else {
                validation.classList.add('hidden');
                showAISuggestions(['✅ Workflow validation passed! Ready for deployment.']);
            }
        }

        function updateWorkflowPreview() {
            const steps = document.querySelectorAll('.workflow-step');
            const canvas = document.getElementById('workflowPreviewCanvas');
            
            if (steps.length === 0) {
                canvas.innerHTML = `
                    <div class="text-white/60 text-center">
                        <i class="fas fa-sitemap text-4xl mb-4"></i>
                        <p>Add workflow steps to see preview</p>
                    </div>
                `;
                return;
            }
            
            const previewHtml = Array.from(steps).map((step, index) => {
                const stepType = step.querySelector('select').value;
                const description = step.querySelector('input[placeholder*="Describe"]').value;
                const icon = stepType && workflowLibrary.stepTypes[stepType] ? workflowLibrary.stepTypes[stepType].icon : 'fas fa-circle';
                
                return `
                    <div class="flex items-center ${index < steps.length - 1 ? 'mb-4' : ''}">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white text-sm font-bold">
                                ${index + 1}
                            </div>
                            <div class="flex items-center space-x-2">
                                <i class="${icon} text-blue-400"></i>
                                <span class="text-white text-sm">${description || 'Untitled Step'}</span>
                            </div>
                        </div>
                        ${index < steps.length - 1 ? '<div class="ml-4 w-px h-6 bg-white/20"></div>' : ''}
                    </div>
                `;
            }).join('');
            
            canvas.innerHTML = `<div class="p-4">${previewHtml}</div>`;
        }

        function testWorkflow() {
            const steps = document.querySelectorAll('.workflow-step');
            if (steps.length === 0) {
                showAISuggestions(['⚠️ Add workflow steps before testing']);
                return;
            }
            
            showAISuggestions([
                '🧪 Running workflow simulation...',
                '✅ All steps executed successfully',
                '⏱️ Estimated completion time: 2.5 business days',
                '📊 No bottlenecks detected',
                '🎯 Ready for production deployment'
            ]);
        }

        function exportWorkflow() {
            const workflowName = document.getElementById('workflowName').value || 'Untitled Workflow';
            const department = document.getElementById('department').value;
            const workflowData = {
                name: workflowName,
                department: department,
                steps: Array.from(document.querySelectorAll('.workflow-step')).map((step, index) => ({
                    id: index + 1,
                    type: step.querySelector('select').value,
                    description: step.querySelector('input[placeholder*="Describe"]').value,
                    assignedTo: step.querySelectorAll('select')[1]?.value,
                    timeLimit: step.querySelector('input[type="number"]')?.value,
                    conditions: step.querySelector('textarea')?.value
                }))
            };
            
            // Create downloadable JSON
            const blob = new Blob([JSON.stringify(workflowData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${workflowName.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_workflow.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function saveWorkflowDraft() {
            const workflowName = document.getElementById('workflowName').value;
            if (!workflowName.trim()) {
                showAISuggestions(['⚠️ Please enter a workflow name before saving draft']);
                return;
            }
            
            showAISuggestions([`💾 Draft "${workflowName}" saved successfully`, '📝 You can continue editing later']);
        }

        function saveWorkflow() {
            const workflowName = document.getElementById('workflowName').value;
            const department = document.getElementById('department').value;
            const steps = document.querySelectorAll('.workflow-step');
            
            if (!workflowName.trim()) {
                showAISuggestions(['⚠️ Please enter a workflow name']);
                return;
            }
            
            if (!department) {
                showAISuggestions(['⚠️ Please select a department']);
                return;
            }
            
            if (steps.length === 0) {
                showAISuggestions(['⚠️ Please add at least one workflow step']);
                return;
            }
            
            // Validate workflow before deploying
            validateWorkflow();
            
            // Simulate deployment
            setTimeout(() => {
                addAdminChatMessage(`🚀 Workflow "${workflowName}" deployed successfully! Now processing requests automatically.`, 'ai');
                closeModal();
                
                // Reset form
                document.getElementById('workflowName').value = '';
                document.getElementById('department').value = '';
                document.getElementById('workflowStepsBuilder').innerHTML = '';
                workflowStepCount = 0;
                
                // Update dashboard stats
                const activeWorkflows = document.querySelector('#dashboard-content .text-3xl');
                if (activeWorkflows) {
                    const current = parseInt(activeWorkflows.textContent);
                    activeWorkflows.textContent = current + 1;
                }
            }, 1500);
        }
        
        // Chat functions
        function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            if (!message) return;
            
            addChatMessage(message, 'user');
            input.value = '';
            
            setTimeout(() => {
                // Smart responses based on message content
                const lowerMessage = message.toLowerCase();
                let response = '';
                
                if (lowerMessage.includes('permit') || lowerMessage.includes('building')) {
                    response = "For building permits, you'll need property surveys, construction plans, and a licensed contractor. Would you like me to open the building permit form for you?";
                } else if (lowerMessage.includes('license') || lowerMessage.includes('business')) {
                    response = "Business licenses typically require your business registration, zoning approval, and tax ID. Processing usually takes 3-5 business days. Shall I help you start the application?";
                } else if (lowerMessage.includes('pothole') || lowerMessage.includes('road') || lowerMessage.includes('street')) {
                    response = "For road issues like potholes, please provide the exact location and photos if possible. Our Public Works team responds within 1-3 business days. Would you like to submit a repair request?";
                } else if (lowerMessage.includes('tax') || lowerMessage.includes('property tax')) {
                    response = "For tax inquiries, I can connect you with the Finance Department. They handle property assessments, payment plans, and exemptions. What specific tax issue can I help with?";
                } else if (lowerMessage.includes('tree') || lowerMessage.includes('park')) {
                    response = "Tree services and park maintenance are handled by Parks & Recreation. For tree removal, you'll need property ownership verification. Would you like me to start that request?";
                } else if (lowerMessage.includes('noise') || lowerMessage.includes('complaint')) {
                    response = "For noise complaints, please provide specific times, dates, and any evidence. Code Enforcement typically responds within 1-2 business days. Should I open a complaint form?";
                } else if (lowerMessage.includes('trash') || lowerMessage.includes('garbage') || lowerMessage.includes('recycling')) {
                    response = "For trash and recycling issues, I can help you contact Sanitation Services. They handle missed pickups, damaged bins, and schedule changes. What's the specific issue?";
                } else {
                    const genericResponses = [
                        "I can help you find the right city service! Try asking about permits, licenses, road repairs, or reporting issues.",
                        "What service are you looking for? I can help with building permits, business licenses, reporting problems, or connecting you with the right department.",
                        "I'm here to help you navigate city services. You can ask about permits, file complaints, request services, or get information about any department.",
                        "Need help with city services? I can assist with applications, direct you to the right department, or help you submit requests quickly."
                    ];
                    response = genericResponses[Math.floor(Math.random() * genericResponses.length)];
                }
                
                addChatMessage(response, 'ai');
            }, 800);
        }
        
        function addChatMessage(message, sender) {
            const chatHistory = document.getElementById('chatHistory');
            const messageDiv = document.createElement('div');
            messageDiv.className = sender === 'user' ? 'text-blue-300 mb-2' : 'text-green-300 mb-2';
            
            const icon = sender === 'user' ? 'fas fa-user' : 'fas fa-brain';
            const senderName = sender === 'user' ? 'You' : 'AI';
            const senderClass = sender === 'user' ? '' : 'text-blue-300';
            
            messageDiv.innerHTML = `
                <i class="${icon} mr-2"></i>
                <span class="font-semibold ${senderClass}">${senderName}:</span>
                <span>${message}</span>
            `;
            
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        
        function startTypingAnimation() {
            const element = document.getElementById('welcomeMessage');
            const text = "Hello! I'm here to help you find the right city service. What can I help you with today?";
            
            element.innerHTML = '';
            element.classList.add('typing');
            let i = 0;
            
            function type() {
                if (i < text.length) {
                    element.innerHTML += text.charAt(i);
                    i++;
                    setTimeout(type, 30);
                } else {
                    element.classList.remove('typing');
                }
            }
            type();
        }

        // Citizen Portal Functions
        function openNewRequestModal() {
            document.getElementById('newRequestModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeNewRequestModal() {
            document.getElementById('newRequestModal').classList.remove('active');
            document.body.style.overflow = 'auto';
            document.getElementById('newRequestForm').reset();
            document.getElementById('charCount').textContent = '0';
            document.getElementById('routingPreview').classList.add('hidden');
            document.getElementById('aiSuggestion').classList.add('hidden');
        }

        function quickRequest(serviceType) {
            openNewRequestModal();
            document.getElementById('serviceType').value = serviceType;
            updateAIRouting();
        }

        function populateRecentRequests() {
            const container = document.getElementById('recentRequestsList');
            if (!container) return;

            const recentRequests = userRequests.slice(0, 3);

            container.innerHTML = recentRequests.map(request => `
                <div class="flex items-center justify-between p-4 bg-white/5 rounded-lg hover:bg-white/10 transition-colors cursor-pointer" onclick="viewRequestDetails('${request.id}')">
                    <div class="flex-1">
                        <div class="flex items-center space-x-3 mb-2">
                            <span class="text-white font-medium">${request.type}</span>
                            <span class="text-xs px-2 py-1 rounded-full bg-${request.statusColor}-500/20 text-${request.statusColor}-300">${request.status}</span>
                        </div>
                        <p class="text-sm text-white/70">${request.description}</p>
                        <div class="flex items-center space-x-4 mt-2 text-xs text-white/60">
                            <span><i class="fas fa-calendar mr-1"></i>${new Date(request.date).toLocaleDateString()}</span>
                            <span><i class="fas fa-building mr-1"></i>${request.department}</span>
                        </div>
                    </div>
                    <div class="text-white/60">
                        <i class="fas fa-chevron-right"></i>
                    </div>
                </div>
            `).join('');
        }

        function viewAllRequests() {
            // This would open a modal or navigate to a requests page
            alert('Opening full request history...');
        }

        function viewRequestDetails(requestId) {
            const request = userRequests.find(r => r.id === requestId);
            if (request) {
                alert(`Request Details:\n\nID: ${request.id}\nType: ${request.type}\nStatus: ${request.status}\nDepartment: ${request.department}\nDescription: ${request.description}`);
            }
        }

        function initializeNewRequestForm() {
            const form = document.getElementById('newRequestForm');
            const serviceType = document.getElementById('serviceType');
            const description = document.getElementById('description');
            const charCount = document.getElementById('charCount');

            // Character counter
            description.addEventListener('input', function() {
                const count = this.value.length;
                charCount.textContent = count;
                if (count > 500) {
                    charCount.style.color = '#ef4444';
                } else {
                    charCount.style.color = '';
                }
            });

            // Service type change - AI routing
            serviceType.addEventListener('change', updateAIRouting);

            // Form submission
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                submitNewRequest();
            });

            // File upload handling
            const fileUpload = document.getElementById('fileUpload');
            fileUpload.addEventListener('change', handleFileUpload);
        }

        function updateAIRouting() {
            const serviceType = document.getElementById('serviceType').value;
            const routingPreview = document.getElementById('routingPreview');
            const routingInfo = document.getElementById('routingInfo');
            const aiSuggestion = document.getElementById('aiSuggestion');
            const aiSuggestionText = document.getElementById('aiSuggestionText');

            const routingMap = {
                'building_permit': {
                    department: 'Building & Safety Department',
                    estimatedTime: '5-7 business days',
                    requirements: 'Property survey, construction plans, contractor license',
                    color: 'orange'
                },
                'business_license': {
                    department: 'Business Licensing Office',
                    estimatedTime: '3-5 business days',
                    requirements: 'Business registration, zoning approval, tax ID',
                    color: 'green'
                },
                'pothole_repair': {
                    department: 'Public Works Department',
                    estimatedTime: '1-3 business days',
                    requirements: 'Location details, photos recommended',
                    color: 'blue'
                },
                'tree_service': {
                    department: 'Parks & Recreation',
                    estimatedTime: '7-10 business days',
                    requirements: 'Property ownership verification, photos',
                    color: 'green'
                },
                'noise_complaint': {
                    department: 'Code Enforcement',
                    estimatedTime: '1-2 business days',
                    requirements: 'Specific times, dates, evidence if available',
                    color: 'yellow'
                }
            };

            if (serviceType && routingMap[serviceType]) {
                const routing = routingMap[serviceType];
                routingInfo.innerHTML = `
                    <div class="space-y-2">
                        <div><strong>Routed to:</strong> ${routing.department}</div>
                        <div><strong>Est. Processing Time:</strong> ${routing.estimatedTime}</div>
                        <div><strong>Required Information:</strong> ${routing.requirements}</div>
                    </div>
                `;
                routingPreview.classList.remove('hidden');

                // AI suggestion
                aiSuggestionText.textContent = `Based on your selection, I recommend including ${routing.requirements.toLowerCase()} to expedite processing.`;
                aiSuggestion.classList.remove('hidden');
            } else {
                routingPreview.classList.add('hidden');
                aiSuggestion.classList.add('hidden');
            }
        }

        function handleFileUpload(event) {
            const files = event.target.files;
            const fileList = document.getElementById('fileList');
            
            fileList.innerHTML = '';
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileDiv = document.createElement('div');
                fileDiv.className = 'flex items-center justify-between p-2 bg-white/5 rounded text-sm';
                fileDiv.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-file text-blue-400"></i>
                        <span class="text-white">${file.name}</span>
                        <span class="text-white/60">(${(file.size / 1024 / 1024).toFixed(2)} MB)</span>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-red-400 hover:text-red-300">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                fileList.appendChild(fileDiv);
            }
        }

        function submitNewRequest() {
            const formData = new FormData(document.getElementById('newRequestForm'));
            const serviceType = document.getElementById('serviceType').value;
            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            const email = document.getElementById('email').value;
            const description = document.getElementById('description').value;
            const priority = document.querySelector('input[name="priority"]:checked').value;

            // Generate new request ID
            const newId = `REQ-2024-${String(userRequests.length + 1).padStart(3, '0')}`;
            
            // Create new request object
            const newRequest = {
                id: newId,
                type: document.querySelector(`#serviceType option[value="${serviceType}"]`).textContent,
                description: description,
                status: 'Submitted',
                statusColor: 'blue',
                date: new Date().toISOString().split('T')[0],
                department: getServiceDepartment(serviceType),
                priority: priority,
                submitter: `${firstName} ${lastName}`,
                email: email
            };

            // Add to requests array
            userRequests.unshift(newRequest);

            // Update UI
            populateRecentRequests();
            document.getElementById('userRequestCount').textContent = userRequests.length;

            // Show success message
            addChatMessage(`✅ Request submitted successfully! Your request ID is ${newId}. You'll receive updates via email at ${email}.`, 'ai');

            // Close modal
            closeNewRequestModal();

            // Switch to dashboard to show the new request
            switchTab('dashboard');
        }

        function getServiceDepartment(serviceType) {
            const departmentMap = {
                'building_permit': 'Building & Safety',
                'renovation_permit': 'Building & Safety',
                'business_license': 'Business Licensing',
                'event_permit': 'Special Events',
                'sign_permit': 'Planning Department',
                'pothole_repair': 'Public Works',
                'streetlight_issue': 'Public Works',
                'tree_service': 'Parks & Recreation',
                'trash_pickup': 'Sanitation',
                'water_sewer': 'Public Utilities',
                'noise_complaint': 'Code Enforcement',
                'property_maintenance': 'Code Enforcement',
                'zoning_violation': 'Planning Department',
                'tax_inquiry': 'Finance Department',
                'general_inquiry': 'City Clerk',
                'document_request': 'City Clerk'
            };
            return departmentMap[serviceType] || 'General Services';
        }

        function quickChat(topic) {
            document.getElementById('userInput').value = `I need help with ${topic}`;
            sendMessage();
        }

        // Regulation Assistant Functions - Added 2025-10-07
        // MOCK DATA - Replace in production
        // TODO: Connect to city regulations API endpoint

        let regulationConversationHistory = [];

        const regulationDatabase = {
            'fence': {
                question: 'Do I need a permit to build a fence?',
                answer: `Great question! Here's what you need to know about building a fence:\n\n<strong>⚠️ Permit Required</strong> for fences over 6 feet tall\n\n<strong>✓ No Permit Needed</strong> for fences 6 feet or shorter\n\n<strong>Important Rules:</strong>\n• Front yard fences: Maximum 4 feet tall\n• Side/back yard fences: Maximum 8 feet tall\n• Must be 2 feet from property line (unless on the line with neighbor's agreement)\n• Corner lots: Special visibility requirements apply\n• HOA approval may be required in some neighborhoods\n\n<strong>Estimated Timeline:</strong> Permit approval takes 5-7 business days`,
                department: 'Building & Safety Department',
                phone: '(555) 123-4567',
                email: 'building@cityname.gov',
                forms: ['Fence Permit Application', 'Property Survey'],
                citation: 'City Code § 18.42.090 - Fence Regulations'
            },
            'home business': {
                question: 'How do I start a home business?',
                answer: `Starting a home business is easier than you think! Here's what you need:\n\n<strong>✓ Home Occupation Permit</strong> (Required for all home businesses)\n\n<strong>Requirements:</strong>\n• Business must be conducted entirely indoors\n• No employees visiting your home (family members OK)\n• No signs visible from the street\n• No increased traffic or parking issues\n• Business activities shouldn't disturb neighbors\n\n<strong>⚠️ Also Need:</strong>\n• Business license ($50-$200 depending on business type)\n• Zoning clearance (free, usually approved same day)\n• Sales tax permit (if selling goods)\n\n<strong>Not Allowed from Home:</strong>\n✗ Auto repair shops\n✗ Restaurants or food service\n✗ Retail stores with foot traffic\n\n<strong>Processing Time:</strong> 2-3 weeks for full approval`,
                department: 'Economic Development Office',
                phone: '(555) 234-5678',
                email: 'business@cityname.gov',
                forms: ['Home Occupation Permit Application', 'Business License Application'],
                citation: 'City Code § 17.228.330 - Home Occupations'
            },
            'chickens': {
                question: 'What are the rules for keeping chickens?',
                answer: `You can keep chickens in the city! Here are the rules:\n\n<strong>✓ Allowed</strong> - Hens only (up to 6)\n\n<strong>✗ Not Allowed</strong> - Roosters (due to noise)\n\n<strong>Requirements:</strong>\n• Maximum 6 hens per property\n• Coop must be at least 20 feet from any neighboring home\n• Coop must be clean, sanitary, and secure from predators\n• Lot size must be at least 6,000 square feet\n• Free-range chickens OK, but must stay on your property\n\n<strong>⚠️ Permit Required:</strong>\n• Urban Chicken Permit (one-time fee: $35)\n• Annual inspection may be required\n\n<strong>Good to Know:</strong>\n• Chickens are quiet and make great pets\n• Fresh eggs daily!\n• Many neighbors won't even notice\n\n<strong>Processing Time:</strong> Permit issued same day if requirements met`,
                department: 'Animal Control Services',
                phone: '(555) 345-6789',
                email: 'animals@cityname.gov',
                forms: ['Urban Chicken Permit Application', 'Coop Specifications Form'],
                citation: 'Municipal Code § 6.04.115 - Keeping of Chickens'
            },
            'deck': {
                question: 'Do I need a permit to add a deck?',
                answer: `Yes, most decks require a permit. Here's the breakdown:\n\n<strong>⚠️ Permit Required</strong> for decks that are:\n• More than 30 inches above ground\n• Attached to your house\n• Larger than 200 square feet\n\n<strong>✓ No Permit Needed</strong> for:\n• Ground-level decks (less than 30 inches high)\n• Smaller than 200 square feet\n• Not attached to house\n\n<strong>What You'll Need:</strong>\n• Site plan showing deck location\n• Deck design drawings with dimensions\n• Foundation details\n• Railing plans (required for decks over 30" high)\n\n<strong>Important:</strong>\n• Inspections required during construction\n• Must meet current building codes\n• Setback requirements apply (usually 5 feet from property line)\n\n<strong>Processing Time:</strong> 7-10 business days\n<strong>Permit Cost:</strong> $150-$400 (based on deck size)`,
                department: 'Building & Safety Department',
                phone: '(555) 123-4567',
                email: 'building@cityname.gov',
                forms: ['Building Permit Application', 'Deck Plan Requirements'],
                citation: 'Building Code § 105.2 - Deck Construction Permits'
            },
            'business license': {
                question: 'How do I get a business license?',
                answer: `Getting a business license is straightforward! Here's the process:\n\n<strong>Step 1: Determine Your Business Type</strong>\nDifferent businesses have different fees ($50-$500 annually)\n\n<strong>Step 2: Gather Documents</strong>\n• Valid ID or driver's license\n• Business name and address\n• Owner's Social Security Number or Federal EIN\n• Zoning clearance (for physical locations)\n\n<strong>Step 3: Apply</strong>\n• Online: cityname.gov/business-license (fastest!)\n• In-person: City Hall, 2nd floor\n• By mail: Business License Office, 123 Main St.\n\n<strong>⚠️ Additional Requirements May Include:</strong>\n• Sellers permit (for retail)\n• Health permit (for food businesses)\n• Professional licenses (contractors, etc.)\n• Fire inspection (for restaurants, retail)\n\n<strong>Processing Time:</strong>\n• Online: 1-2 business days\n• In-person: Same day\n• Mail: 5-7 business days\n\n<strong>Good to Know:</strong> Licenses renew annually every January`,
                department: 'City Clerk\'s Office',
                phone: '(555) 456-7890',
                email: 'clerk@cityname.gov',
                forms: ['Business License Application', 'Zoning Clearance Form'],
                citation: 'Municipal Code § 5.02 - Business Licenses'
            },
            'rv parking': {
                question: 'Can I park an RV in my driveway?',
                answer: `The rules for RV parking depend on how long you plan to keep it there:\n\n<strong>✓ Allowed (Short-term):</strong>\n• Park in your driveway for up to 72 hours for loading/unloading\n• Must be actively preparing for a trip or just returned\n\n<strong>⚠️ Long-term Storage Rules:</strong>\n• RVs cannot be parked on street for more than 72 consecutive hours\n• Driveway storage OK if:\n  - Vehicle is fully on your property (not blocking sidewalk)\n  - Not being used as living space\n  - Properly registered and operational\n\n<strong>✗ Not Allowed:</strong>\n• Living in an RV on residential property\n• Parking on front lawn\n• Blocking sidewalk or street access\n• Commercial RV storage on residential property\n\n<strong>Alternative:</strong>\nMany homeowners use side yards (if wide enough) or rent storage spaces at RV facilities.\n\n<strong>⚠️ Violation Fine:</strong> $100 for first offense\n\n<strong>Good to Know:</strong> HOA rules may be stricter than city rules`,
                department: 'Code Enforcement',
                phone: '(555) 567-8901',
                email: 'code@cityname.gov',
                forms: ['RV Parking Appeal Form'],
                citation: 'Zoning Code § 20.48.060 - Vehicle Parking Standards'
            },
            'block party': {
                question: 'What permits do I need for a block party?',
                answer: `Block parties are a great way to build community! Here's what you need:\n\n<strong>⚠️ Required Permits:</strong>\n\n<strong>1. Street Closure Permit (Free!)</strong>\n• Apply at least 14 days before event\n• Requires signatures from 75% of affected residents\n• Usually approved for 4-6 hours\n\n<strong>2. Special Event Permit</strong>\n• Free for non-commercial neighborhood events\n• Required if you're:\n  - Using amplified music\n  - Setting up tents or structures\n  - Expecting more than 100 people\n\n<strong>✓ No Permit Needed for:</strong>\n• Small gatherings (under 25 people) in yards or parks\n• Events that don't block streets\n\n<strong>What the City Provides:</strong>\n• Barricades and "Street Closed" signs\n• Help with traffic routing\n• Police notification (for safety)\n\n<strong>Your Responsibilities:</strong>\n• Keep emergency access clear\n• Clean up after event\n• Respect noise curfew (10 PM weekdays, 11 PM weekends)\n\n<strong>Processing Time:</strong> 7-10 business days\n<strong>Pro Tip:</strong> Apply early during summer - permits go fast!`,
                department: 'Special Events Office',
                phone: '(555) 678-9012',
                email: 'events@cityname.gov',
                forms: ['Street Closure Application', 'Neighborhood Signature Sheet'],
                citation: 'Municipal Code § 12.32 - Street Closures for Events'
            },
            'tree': {
                question: 'Can I cut down a tree on my property?',
                answer: `Tree removal rules protect our urban forest. Here's what you need to know:\n\n<strong>⚠️ Permit Required</strong> for removing:\n• Trees with trunk diameter over 8 inches (measured 4.5 feet from ground)\n• Any heritage trees (over 50 years old)\n• Trees in protected areas\n\n<strong>✓ No Permit Needed</strong> for:\n• Small trees (trunk under 8 inches diameter)\n• Dead or dangerous trees posing immediate hazard\n• Trimming and pruning (within reason)\n\n<strong>Application Process:</strong>\n• Submit photos of tree from 4 angles\n• Arborist report (required for trees over 24" diameter)\n• Reason for removal\n• Replacement tree plan (usually 2 new trees required)\n\n<strong>Valid Reasons for Removal:</strong>\n• Tree is diseased or dying\n• Causing structural damage to home\n• Creating safety hazard\n• Interfering with approved construction\n\n<strong>✗ Not Valid Reasons:</strong>\n• "Too many leaves"\n• Blocking view\n• Don't like it\n\n<strong>Processing Time:</strong> 15-30 days\n<strong>Permit Cost:</strong> $75-$250\n<strong>Emergency Removals:</strong> Call 24/7 hotline for dangerous trees`,
                department: 'Urban Forestry Division',
                phone: '(555) 789-0123',
                email: 'trees@cityname.gov',
                forms: ['Tree Removal Permit Application', 'Arborist Report Template'],
                citation: 'Tree Protection Ordinance § 12.36.080'
            },
            'short-term rental': {
                question: 'What are the rules for short-term rentals?',
                answer: `Short-term rentals (like Airbnb) are regulated to balance tourism and neighborhood quality. Here's what's allowed:\n\n<strong>⚠️ Permit Required</strong> - Short-Term Rental License ($500/year)\n\n<strong>✓ Allowed (with permit):</strong>\n• Renting your primary residence while you're away\n• Renting a room while you're home (home-share)\n• Maximum 180 days per year (for full-unit rentals)\n\n<strong>Requirements:</strong>\n• Must be your primary residence (live there 275+ days/year)\n• Register with city and pay TOT tax (12%)\n• $1 million liability insurance required\n• Post emergency contact info for guests\n• Respond to complaints within 60 minutes\n• Maximum 2 guests per bedroom + 2\n\n<strong>✗ Not Allowed:</strong>\n• Converting apartments/condos to hotels\n• Renting out investment properties short-term\n• Operating multiple short-term rentals\n\n<strong>Good Neighbor Rules:</strong>\n• No parties or events\n• Quiet hours 10 PM - 8 AM\n• Provide parking for guests\n• Keep accurate guest records\n\n<strong>Penalties:</strong>\n• Operating without permit: $1,000/day fine\n• Repeat violations: License revocation\n\n<strong>Processing Time:</strong> 3-4 weeks`,
                department: 'Planning & Zoning',
                phone: '(555) 890-1234',
                email: 'planning@cityname.gov',
                forms: ['Short-Term Rental Application', 'Good Neighbor Agreement'],
                citation: 'Zoning Ordinance § 5.35 - Short-Term Residential Occupancy'
            },
            'garage sale': {
                question: 'Do I need a permit for a garage sale?',
                answer: `Good news - garage sales are easy!\n\n<strong>✓ No Permit Required!</strong>\n\nYou can have a garage sale without a permit, but there are some rules:\n\n<strong>Rules:</strong>\n• Maximum 3 garage sales per year at your home\n• Each sale can last up to 3 consecutive days\n• Hours: 7 AM - 7 PM only\n• Must be at your residence (items from your home)\n\n<strong>✓ Allowed:</strong>\n• Yard signs on your property\n• One temporary sign at nearest intersection (remove after sale)\n• Selling personal household items\n• Multi-family sales with neighbors\n\n<strong>✗ Not Allowed:</strong>\n• Selling new merchandise\n• Operating as a business (buying items to resell)\n• Signs on utility poles or public property\n• Blocking sidewalks or streets\n\n<strong>Signs:</strong>\n• Must be removed within 24 hours after sale\n• Maximum size: 6 square feet\n• Must be secured (can't blow away)\n\n<strong>Pro Tips:</strong>\n• Advertise on free community boards online\n• Team up with neighbors for more traffic\n• Price items to sell (remember, people are looking for deals!)\n• Have small bills for change\n\n<strong>⚠️ What if I want more than 3 sales per year?</strong>\nYou'd need a business license (then it becomes a business, not a garage sale).`,
                department: 'Code Enforcement',
                phone: '(555) 567-8901',
                email: 'code@cityname.gov',
                forms: ['No forms needed!'],
                citation: 'Municipal Code § 5.80.020 - Garage Sales'
            }
        };

        function initializeRegulationAssistant() {
            const container = document.getElementById('regulationAssistant');
            if (!container) return;

            container.innerHTML = `
                <!-- Compact Header Card -->
                <div class="glass rounded-xl p-5 mb-4">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center flex-shrink-0">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <h2 class="text-xl font-bold text-white">Ask About City Regulations</h2>
                            <p class="text-white/70 text-sm">Get instant answers about permits and city requirements</p>
                        </div>
                    </div>
                </div>

                <!-- Compact Sample Questions (horizontal scroll) -->
                <div class="glass rounded-xl p-4 mb-4">
                    <p class="text-white/70 text-xs mb-2 font-semibold">Popular Questions:</p>
                    <div class="regulation-questions-container">
                        <!-- Left scroll button -->
                        <button id="regScrollLeft" class="regulation-scroll-btn regulation-scroll-btn-left hidden" onclick="scrollRegulationQuestions('left')" aria-label="Scroll left">
                            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                            </svg>
                        </button>

                        <!-- Right scroll button -->
                        <button id="regScrollRight" class="regulation-scroll-btn regulation-scroll-btn-right" onclick="scrollRegulationQuestions('right')" aria-label="Scroll right">
                            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </button>

                        <div id="regQuestionsScroll" class="regulation-questions-scroll flex gap-2 overflow-x-auto pb-2 pr-2" style="scrollbar-width: thin; -webkit-overflow-scrolling: touch;">
                            <button class="regulation-sample-question whitespace-nowrap flex-shrink-0 text-xs px-3 py-2" onclick="askRegulationQuestion('Do I need a permit to build a fence?')">
                                🏡 Fence Permit?
                            </button>
                            <button class="regulation-sample-question whitespace-nowrap flex-shrink-0 text-xs px-3 py-2" onclick="askRegulationQuestion('How do I start a home business?')">
                                💼 Home Business?
                            </button>
                            <button class="regulation-sample-question whitespace-nowrap flex-shrink-0 text-xs px-3 py-2" onclick="askRegulationQuestion('What are the rules for keeping chickens?')">
                                🐔 Keeping Chickens?
                            </button>
                            <button class="regulation-sample-question whitespace-nowrap flex-shrink-0 text-xs px-3 py-2" onclick="askRegulationQuestion('Do I need a permit to add a deck?')">
                                🔨 Deck Permit?
                            </button>
                            <button class="regulation-sample-question whitespace-nowrap flex-shrink-0 text-xs px-3 py-2" onclick="askRegulationQuestion('How do I get a business license?')">
                                📋 Business License?
                            </button>
                            <button class="regulation-sample-question whitespace-nowrap flex-shrink-0 text-xs px-3 py-2" onclick="askRegulationQuestion('Can I park an RV in my driveway?')">
                                🚐 RV Parking?
                            </button>
                            <button class="regulation-sample-question whitespace-nowrap flex-shrink-0 text-xs px-3 py-2" onclick="askRegulationQuestion('What permits do I need for a block party?')">
                                🎉 Block Party?
                            </button>
                            <button class="regulation-sample-question whitespace-nowrap flex-shrink-0 text-xs px-3 py-2" onclick="askRegulationQuestion('Can I cut down a tree on my property?')">
                                🌲 Tree Removal?
                            </button>
                            <button class="regulation-sample-question whitespace-nowrap flex-shrink-0 text-xs px-3 py-2" onclick="askRegulationQuestion('What are the rules for short-term rentals?')">
                                🏠 Airbnb Rules?
                            </button>
                            <button class="regulation-sample-question whitespace-nowrap flex-shrink-0 text-xs px-3 py-2" onclick="askRegulationQuestion('Do I need a permit for a garage sale?')">
                                🛒 Garage Sale?
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Compact Chat Interface -->
                <div class="glass rounded-xl p-4 mb-4 h-[400px] overflow-y-auto regulation-chat-container" id="regChatContainer">
                    <div id="regChatMessages">
                        <!-- Welcome message -->
                        <div class="flex items-start mb-4">
                            <div class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center mr-2 flex-shrink-0">
                                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>
                            </div>
                            <div class="regulation-chat-bubble-assistant p-3 max-w-[85%]">
                                <p class="text-white font-semibold mb-1 text-sm">👋 Hi! I'm your Regulation Assistant</p>
                                <p class="text-white/90 text-sm">Ask me about permits, licenses, property rules, or click a question above!</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Compact Input Area -->
                <div class="glass rounded-xl p-3">
                    <div class="flex gap-2">
                        <input
                            type="text"
                            id="regQuestionInput"
                            class="flex-1 px-3 py-2 rounded-lg bg-white/10 border border-white/20 text-white text-sm placeholder-white/50 focus:outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-500/50"
                            placeholder="Ask your question here..."
                            onkeypress="if(event.key === 'Enter') sendRegulationMessage()"
                            aria-label="Question input"
                        >
                        <button onclick="sendRegulationMessage()" class="px-4 py-2 rounded-lg bg-gradient-to-r from-purple-500 to-blue-500 text-white text-sm font-semibold hover:shadow-lg hover:shadow-purple-500/50 transition-all" aria-label="Send message">
                            Send
                        </button>
                    </div>
                </div>
            `;

            // Initialize scroll buttons after DOM is created
            setTimeout(updateRegulationScrollButtons, 100);
        }

        function findRegulation(question) {
            const lowerQuestion = question.toLowerCase();

            if (lowerQuestion.includes('fence')) return regulationDatabase['fence'];
            if (lowerQuestion.includes('home business') || lowerQuestion.includes('work from home')) return regulationDatabase['home business'];
            if (lowerQuestion.includes('chicken') || lowerQuestion.includes('poultry')) return regulationDatabase['chickens'];
            if (lowerQuestion.includes('deck') || lowerQuestion.includes('patio')) return regulationDatabase['deck'];
            if (lowerQuestion.includes('business license')) return regulationDatabase['business license'];
            if (lowerQuestion.includes('rv') || lowerQuestion.includes('motor home') || lowerQuestion.includes('park')) return regulationDatabase['rv parking'];
            if (lowerQuestion.includes('block party') || lowerQuestion.includes('street party') || lowerQuestion.includes('event permit')) return regulationDatabase['block party'];
            if (lowerQuestion.includes('tree') || lowerQuestion.includes('cut down')) return regulationDatabase['tree'];
            if (lowerQuestion.includes('short-term rental') || lowerQuestion.includes('airbnb') || lowerQuestion.includes('vrbo')) return regulationDatabase['short-term rental'];
            if (lowerQuestion.includes('garage sale') || lowerQuestion.includes('yard sale')) return regulationDatabase['garage sale'];

            return {
                question: question,
                answer: `I'd be happy to help you with that question! While I don't have specific information about that topic in my database yet, here's what I can do:\n\n<strong>I can help you with questions about:</strong>\n• Building permits (fences, decks, additions)\n• Business licenses and home businesses\n• Property regulations (trees, parking, structures)\n• Pet ownership rules (chickens, dogs, etc.)\n• Event permits (block parties, garage sales)\n• Zoning questions (short-term rentals, home businesses)\n\nPlease try asking one of the sample questions above, or rephrase your question to match one of these topics!`,
                department: 'City Information Desk',
                phone: '(555) 311-CITY',
                email: 'info@cityname.gov',
                forms: [],
                citation: 'For specific regulations, please contact the appropriate department'
            };
        }

        function askRegulationQuestion(question) {
            document.getElementById('regQuestionInput').value = question;
            sendRegulationMessage();
        }

        function sendRegulationMessage() {
            const input = document.getElementById('regQuestionInput');
            const question = input.value.trim();

            if (!question) return;

            addRegulationUserMessage(question);
            input.value = '';

            showRegulationTypingIndicator();

            setTimeout(() => {
                hideRegulationTypingIndicator();
                const regulation = findRegulation(question);
                addRegulationAssistantMessage(regulation);
            }, 400 + Math.random() * 300);
        }

        function addRegulationUserMessage(text) {
            const chatMessages = document.getElementById('regChatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex items-start mb-4 justify-end';
            messageDiv.innerHTML = `
                <div class="regulation-chat-bubble-user p-3 max-w-[85%]">
                    <p class="text-white text-sm">${text}</p>
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            scrollRegulationToBottom();

            regulationConversationHistory.push({
                role: 'user',
                content: text,
                timestamp: new Date().toISOString()
            });
        }

        function addRegulationAssistantMessage(regulation) {
            const chatMessages = document.getElementById('regChatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex items-start mb-4';

            const formattedAnswer = regulation.answer
                .replace(/✓/g, '<span class="regulation-indicator-allowed">✓</span>')
                .replace(/✗/g, '<span class="regulation-indicator-not-allowed">✗</span>')
                .replace(/⚠️/g, '<span class="regulation-indicator-permit">⚠️</span>');

            const formsHTML = regulation.forms && regulation.forms.length > 0
                ? `<div class="regulation-info-card">
                    <p class="text-blue-300 font-semibold text-xs mb-1">📋 Required Forms:</p>
                    ${regulation.forms.map(form => `<p class="text-white/80 text-xs">• ${form}</p>`).join('')}
                    <a href="#" class="regulation-link-button text-xs px-3 py-1 mt-2">Download Forms</a>
                </div>`
                : '';

            messageDiv.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center mr-2 flex-shrink-0">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                </div>
                <div class="regulation-chat-bubble-assistant p-3 max-w-[85%]">
                    <div class="text-white/90 text-sm leading-relaxed mb-3 whitespace-pre-line">${formattedAnswer}</div>

                    ${formsHTML}

                    <div class="regulation-contact-card">
                        <p class="text-purple-300 font-semibold text-xs mb-1">📞 Need Help?</p>
                        <p class="text-white/90 text-xs font-semibold">${regulation.department}</p>
                        <p class="text-white/70 text-xs">${regulation.phone} • ${regulation.email}</p>
                    </div>

                    ${regulation.citation ? `
                        <div class="mt-2 text-white/50 text-xs">
                            📖 ${regulation.citation}
                        </div>
                    ` : ''}
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            scrollRegulationToBottom();

            regulationConversationHistory.push({
                role: 'assistant',
                content: regulation.answer,
                department: regulation.department,
                timestamp: new Date().toISOString()
            });
        }

        function showRegulationTypingIndicator() {
            const chatMessages = document.getElementById('regChatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'regTypingIndicator';
            typingDiv.className = 'flex items-start mb-4';
            typingDiv.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center mr-2 flex-shrink-0">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                </div>
                <div class="regulation-chat-bubble-assistant p-3">
                    <div class="regulation-typing-indicator">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            chatMessages.appendChild(typingDiv);
            scrollRegulationToBottom();
        }

        function hideRegulationTypingIndicator() {
            const indicator = document.getElementById('regTypingIndicator');
            if (indicator) indicator.remove();
        }

        function scrollRegulationToBottom() {
            const container = document.getElementById('regChatContainer');
            container.scrollTop = container.scrollHeight;
        }

        function scrollRegulationQuestions(direction) {
            const container = document.getElementById('regQuestionsScroll');
            const scrollAmount = 300;

            if (direction === 'left') {
                container.scrollLeft -= scrollAmount;
            } else {
                container.scrollLeft += scrollAmount;
            }

            setTimeout(updateRegulationScrollButtons, 100);
        }

        function updateRegulationScrollButtons() {
            const container = document.getElementById('regQuestionsScroll');
            const leftBtn = document.getElementById('regScrollLeft');
            const rightBtn = document.getElementById('regScrollRight');

            if (!container || !leftBtn || !rightBtn) return;

            if (container.scrollLeft <= 10) {
                leftBtn.classList.add('hidden');
            } else {
                leftBtn.classList.remove('hidden');
            }

            const maxScroll = container.scrollWidth - container.clientWidth;
            if (container.scrollLeft >= maxScroll - 10) {
                rightBtn.classList.add('hidden');
            } else {
                rightBtn.classList.remove('hidden');
            }
        }

        // Policy Intelligence Center Functions - Added 2025-10-07
        // MOCK DATA - Replace in production
        // TODO: Connect to legal database API
        // TODO: Implement real NLP model for policy analysis
        // TODO: Add authentication for legal team access only
        // TODO: Integrate with document management system

        const policyDatabase = [
            // Federal (15)
            { id: 1, title: 'Americans with Disabilities Act (ADA) - Title II Public Services', jurisdiction: 'Federal', department: 'Civil Rights', effectiveDate: '1990-07-26', lastAmended: '2010-03-15', status: 'Active', citation: '42 U.S.C. § 12101', category: 'accessibility' },
            { id: 2, title: 'Occupational Safety and Health Act (OSHA) - Workplace Safety Standards', jurisdiction: 'Federal', department: 'Labor', effectiveDate: '1970-12-29', lastAmended: '2023-01-15', status: 'Active', citation: '29 CFR § 1910', category: 'safety' },
            { id: 3, title: 'Fair Labor Standards Act (FLSA) - Wage and Hour Division', jurisdiction: 'Federal', department: 'Labor', effectiveDate: '1938-06-25', lastAmended: '2024-01-01', status: 'Active', citation: '29 U.S.C. § 201', category: 'employment' },
            { id: 4, title: 'Family and Medical Leave Act (FMLA) - Employee Leave Requirements', jurisdiction: 'Federal', department: 'Labor', effectiveDate: '1993-02-05', lastAmended: '2023-08-12', status: 'Active', citation: '29 U.S.C. § 2601', category: 'employment' },
            { id: 5, title: 'Clean Air Act (CAA) - EPA Emissions Standards', jurisdiction: 'Federal', department: 'EPA', effectiveDate: '1963-12-17', lastAmended: '2023-06-20', status: 'Active', citation: '42 U.S.C. § 7401', category: 'environmental' },
            { id: 6, title: 'Clean Water Act (CWA) - Water Quality Regulations', jurisdiction: 'Federal', department: 'EPA', effectiveDate: '1972-10-18', lastAmended: '2024-03-10', status: 'Active', citation: '33 U.S.C. § 1251', category: 'environmental' },
            { id: 7, title: 'Resource Conservation and Recovery Act (RCRA) - Waste Management', jurisdiction: 'Federal', department: 'EPA', effectiveDate: '1976-10-21', lastAmended: '2023-11-05', status: 'Active', citation: '42 U.S.C. § 6901', category: 'environmental' },
            { id: 8, title: 'National Environmental Policy Act (NEPA) - Environmental Reviews', jurisdiction: 'Federal', department: 'EPA', effectiveDate: '1970-01-01', lastAmended: '2023-04-25', status: 'Active', citation: '42 U.S.C. § 4321', category: 'environmental' },
            { id: 9, title: 'Federal Acquisition Regulation (FAR) - Government Procurement', jurisdiction: 'Federal', department: 'GSA', effectiveDate: '1984-04-01', lastAmended: '2024-01-15', status: 'Active', citation: '48 CFR Chapter 1', category: 'procurement' },
            { id: 10, title: 'Privacy Act - Personal Information Protection', jurisdiction: 'Federal', department: 'Justice', effectiveDate: '1974-12-31', lastAmended: '2023-09-18', status: 'Active', citation: '5 U.S.C. § 552a', category: 'privacy' },
            { id: 11, title: 'Freedom of Information Act (FOIA) - Public Records Access', jurisdiction: 'Federal', department: 'Justice', effectiveDate: '1967-07-04', lastAmended: '2023-12-08', status: 'Active', citation: '5 U.S.C. § 552', category: 'transparency' },
            { id: 12, title: 'Equal Employment Opportunity (EEO) - Non-Discrimination', jurisdiction: 'Federal', department: 'EEOC', effectiveDate: '1964-07-02', lastAmended: '2023-07-22', status: 'Active', citation: '42 U.S.C. § 2000e', category: 'employment' },
            { id: 13, title: 'Uniformed Services Employment and Reemployment Rights Act (USERRA)', jurisdiction: 'Federal', department: 'Labor', effectiveDate: '1994-10-13', lastAmended: '2023-05-14', status: 'Active', citation: '38 U.S.C. § 4301', category: 'employment' },
            { id: 14, title: 'Section 508 - Electronic Accessibility Requirements', jurisdiction: 'Federal', department: 'GSA', effectiveDate: '1998-08-07', lastAmended: '2023-10-30', status: 'Active', citation: '29 U.S.C. § 794d', category: 'accessibility' },
            { id: 15, title: 'Davis-Bacon Act - Prevailing Wage Requirements', jurisdiction: 'Federal', department: 'Labor', effectiveDate: '1931-03-03', lastAmended: '2024-02-01', status: 'Active', citation: '40 U.S.C. § 3141', category: 'employment' },
            // State (10)
            { id: 16, title: 'State Building Code - Chapter 34: Structural Standards', jurisdiction: 'State', department: 'Building', effectiveDate: '2015-01-01', lastAmended: '2024-01-01', status: 'Active', citation: 'SBC Ch. 34', category: 'safety' },
            { id: 17, title: 'Environmental Quality Act - Section 15: Impact Assessments', jurisdiction: 'State', department: 'Environment', effectiveDate: '1970-01-01', lastAmended: '2023-06-15', status: 'Active', citation: 'EQA § 15', category: 'environmental' },
            { id: 18, title: 'Public Records Law - Chapter 66: Document Retention', jurisdiction: 'State', department: 'Secretary of State', effectiveDate: '1963-01-01', lastAmended: '2023-09-01', status: 'Active', citation: 'PRL Ch. 66', category: 'transparency' },
            { id: 19, title: 'Civil Service Law - Article 5: Personnel Management', jurisdiction: 'State', department: 'HR', effectiveDate: '1884-05-04', lastAmended: '2023-12-20', status: 'Active', citation: 'CSL Art. 5', category: 'employment' },
            { id: 20, title: 'Workers Compensation Law - Title 2: Injury Claims', jurisdiction: 'State', department: 'Labor', effectiveDate: '1914-07-01', lastAmended: '2024-01-01', status: 'Active', citation: 'WCL Title 2', category: 'employment' },
            { id: 21, title: 'State Fire Code - Chapter 9: Fire Safety Requirements', jurisdiction: 'State', department: 'Fire Marshal', effectiveDate: '1975-01-01', lastAmended: '2023-11-10', status: 'Active', citation: 'SFC Ch. 9', category: 'safety' },
            { id: 22, title: 'Zoning Enabling Act - Article 7: Land Use Planning', jurisdiction: 'State', department: 'Planning', effectiveDate: '1926-01-01', lastAmended: '2023-08-25', status: 'Active', citation: 'ZEA Art. 7', category: 'zoning' },
            { id: 23, title: 'Public Health Law - Title 4: Health and Safety Standards', jurisdiction: 'State', department: 'Health', effectiveDate: '1909-01-01', lastAmended: '2024-02-15', status: 'Active', citation: 'PHL Title 4', category: 'safety' },
            { id: 24, title: 'Motor Vehicle Code - Chapter 90: Traffic Regulations', jurisdiction: 'State', department: 'Transportation', effectiveDate: '1903-01-01', lastAmended: '2023-10-05', status: 'Active', citation: 'MVC Ch. 90', category: 'safety' },
            { id: 25, title: 'Open Meeting Law - Chapter 30A: Public Access to Government', jurisdiction: 'State', department: 'Attorney General', effectiveDate: '1975-07-01', lastAmended: '2023-07-30', status: 'Active', citation: 'OML Ch. 30A', category: 'transparency' },
            // Municipal (15)
            { id: 26, title: 'Zoning Ordinance §12.34 - Residential Height Restrictions', jurisdiction: 'Municipal', department: 'Planning', effectiveDate: '2010-03-15', lastAmended: '2025-10-05', status: 'Active', citation: 'MCC §12.34', category: 'zoning' },
            { id: 27, title: 'Building Code §45.67 - Permit Requirements', jurisdiction: 'Municipal', department: 'Building', effectiveDate: '2008-06-01', lastAmended: '2023-12-10', status: 'Active', citation: 'MCC §45.67', category: 'safety' },
            { id: 28, title: 'Business License Ordinance §23.45', jurisdiction: 'Municipal', department: 'Finance', effectiveDate: '2005-01-01', lastAmended: '2024-01-01', status: 'Active', citation: 'MCC §23.45', category: 'business' },
            { id: 29, title: 'Noise Control Ordinance §67.89', jurisdiction: 'Municipal', department: 'Police', effectiveDate: '2012-08-20', lastAmended: '2023-06-15', status: 'Active', citation: 'MCC §67.89', category: 'safety' },
            { id: 30, title: 'Sign Regulations §34.56', jurisdiction: 'Municipal', department: 'Planning', effectiveDate: '2015-04-01', lastAmended: '2023-11-20', status: 'Active', citation: 'MCC §34.56', category: 'zoning' },
            { id: 31, title: 'Parking Regulations §78.90', jurisdiction: 'Municipal', department: 'Planning', effectiveDate: '2010-05-15', lastAmended: '2024-02-28', status: 'Active', citation: 'MCC §78.90', category: 'zoning' },
            { id: 32, title: 'Tree Protection Ordinance §56.78', jurisdiction: 'Municipal', department: 'Parks', effectiveDate: '2018-09-10', lastAmended: '2023-08-05', status: 'Active', citation: 'MCC §56.78', category: 'environmental' },
            { id: 33, title: 'Home Occupation Permit §89.01', jurisdiction: 'Municipal', department: 'Planning', effectiveDate: '2013-02-20', lastAmended: '2023-10-12', status: 'Active', citation: 'MCC §89.01', category: 'business' },
            { id: 34, title: 'Fence Ordinance §12.23', jurisdiction: 'Municipal', department: 'Building', effectiveDate: '2011-07-01', lastAmended: '2023-09-18', status: 'Active', citation: 'MCC §12.23', category: 'zoning' },
            { id: 35, title: 'Sidewalk Café Permit §45.67', jurisdiction: 'Municipal', department: 'Health', effectiveDate: '2016-05-10', lastAmended: '2024-01-05', status: 'Active', citation: 'MCC §45.67', category: 'business' },
            { id: 36, title: 'Special Event Permit §23.78', jurisdiction: 'Municipal', department: 'Recreation', effectiveDate: '2014-03-25', lastAmended: '2023-07-22', status: 'Active', citation: 'MCC §23.78', category: 'events' },
            { id: 37, title: 'Alcoholic Beverage License §67.12', jurisdiction: 'Municipal', department: 'Licensing', effectiveDate: '2009-11-15', lastAmended: '2023-12-01', status: 'Active', citation: 'MCC §67.12', category: 'business' },
            { id: 38, title: 'Rental Property Registration §34.89', jurisdiction: 'Municipal', department: 'Housing', effectiveDate: '2017-06-01', lastAmended: '2024-01-15', status: 'Active', citation: 'MCC §34.89', category: 'housing' },
            { id: 39, title: 'Stormwater Management §90.12', jurisdiction: 'Municipal', department: 'Public Works', effectiveDate: '2019-04-10', lastAmended: '2023-11-30', status: 'Active', citation: 'MCC §90.12', category: 'environmental' },
            { id: 40, title: 'Historic Preservation §56.34', jurisdiction: 'Municipal', department: 'Planning', effectiveDate: '2020-08-05', lastAmended: '2023-10-20', status: 'Active', citation: 'MCC §56.34', category: 'preservation' }
        ];

        const policySampleResponses = {
            'parking ada': {
                confidence: 87,
                status: 'needs-review',
                analysis: `The proposed parking ordinance shows partial compliance with ADA Standards (2010). Accessible parking space requirements meet federal standards (§208.2), but van-accessible space width (96 inches) falls short of required 132 inches. Signage specifications comply with §502.6.`,
                plainEnglish: `Your parking plan mostly follows ADA rules, but van-accessible spaces need to be wider. Regular accessible spaces are correct, but you need to add 36 more inches to the van spaces. The signs meet requirements.`,
                citations: ['28 CFR §35.151', 'ADA Standards §208.2', 'ADA Standards §502.3', 'MCC §78.90'],
                recommendations: ['Increase van-accessible space width from 96" to 132"', 'Ensure 5-foot access aisle adjacent to each accessible space', 'Verify signage height and reflectivity comply with §502.6', 'Update site plan drawings to reflect changes'],
                relatedPolicies: ['Municipal Parking Code §78.90', 'State Accessibility Standards', 'Federal ADA §208']
            },
            'building height': {
                confidence: 94,
                status: 'compliant',
                analysis: `Found 8 regulations governing building heights. Municipal Zoning Ordinance §12.34 sets residential height limit at 35 feet. Downtown Overlay §12.45 permits 65 feet for commercial buildings. State Building Code Chapter 34 addresses structural requirements for tall buildings. FAA Part 77 applies near airports. No conflicts detected between regulations.`,
                plainEnglish: `There are clear height rules for buildings. Homes can be up to 35 feet tall. Downtown commercial buildings can go up to 65 feet. If you're near an airport, FAA rules also apply. All these rules work together without conflicts.`,
                citations: ['MCC §12.34', 'MCC §12.45', 'SBC Ch. 34', 'FAA Part 77'],
                recommendations: ['Verify exact zone classification for property', 'Check distance from airport if within 10 miles', 'Review State structural requirements for buildings over 3 stories', 'Consult planning department for overlay district applicability'],
                relatedPolicies: ['Zoning Map', 'Downtown Overlay District', 'Airport Height Zoning']
            },
            'work from home': {
                confidence: 92,
                status: 'compliant',
                analysis: `Remote work is permitted under Personnel Policy §4.56, subject to department head approval and completion of ergonomic assessment. OSHA regulations require employers to ensure home workspaces meet safety standards. Municipal union contract Article 12.3 addresses telework equipment reimbursement up to $500 annually.`,
                plainEnglish: `Employees can work from home with their manager's approval. The city must make sure the home workspace is safe and ergonomic. Employees can get up to $500 per year for equipment like chairs and monitors. Some training is required before starting.`,
                citations: ['Personnel Policy §4.56', 'OSHA Guidelines 3990', 'Collective Bargaining Agreement Art. 12.3'],
                recommendations: ['Complete manager approval form (Form HR-205)', 'Schedule ergonomic assessment within 30 days', 'Submit equipment inventory to IT department', 'Complete data security training module online'],
                relatedPolicies: ['IT Security Policy', 'Workers Compensation Coverage', 'Equipment Policy']
            }
        };

        let policyRecentQueries = ['Does this policy comply with ADA requirements?', 'Find all regulations about building heights', 'Can employees work from home under current policies?', 'What are OSHA requirements for new construction?', 'Environmental review requirements for development'];

        function initializePolicyIntelligence() {
            const container = document.getElementById('policyIntelligenceCenter');
            if (!container) return;

            container.innerHTML = getPolicyIntelligenceHTML();
            populatePolicyTable();
            updatePolicyRecentQueries();
        }

        function getPolicyIntelligenceHTML() {
            return `
                <div class="glass rounded-xl p-6 mb-6" style="animation: fadeIn 0.5s ease;">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h2 class="text-3xl font-bold text-white mb-2">
                                <i class="fas fa-brain text-purple-400 mr-3"></i>
                                AI-Powered Policy Intelligence Center
                            </h2>
                            <p class="text-white/70">Natural language policy analysis, compliance checking, and regulatory intelligence</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <div class="glass-dark rounded-lg p-4">
                            <div class="text-white/60 text-xs mb-1">Policy Database</div>
                            <div class="text-white text-2xl font-bold">28,547</div>
                            <div class="text-white/50 text-xs">regulations indexed</div>
                        </div>
                        <div class="glass-dark rounded-lg p-4">
                            <div class="text-white/60 text-xs mb-1">Last Updated</div>
                            <div class="text-white text-2xl font-bold">Today</div>
                            <div class="text-white/50 text-xs">${new Date().toLocaleTimeString()}</div>
                        </div>
                        <div class="glass-dark rounded-lg p-4">
                            <div class="text-white/60 text-xs mb-1">AI Confidence</div>
                            <div class="text-green-400 text-2xl font-bold">94.2%</div>
                            <div class="text-white/50 text-xs">average accuracy</div>
                        </div>
                        <div class="glass-dark rounded-lg p-4">
                            <div class="text-white/60 text-xs mb-1">Queries Today</div>
                            <div class="text-white text-2xl font-bold">1,247</div>
                            <div class="text-white/50 text-xs">+18% vs yesterday</div>
                        </div>
                    </div>

                    <div class="flex flex-wrap gap-2">
                        <button onclick="showNewPolicyAnalysis()" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold transition-all">
                            <i class="fas fa-plus mr-2"></i>New Analysis
                        </button>
                        <button onclick="showPolicySearch()" class="px-4 py-2 rounded-lg bg-purple-600 hover:bg-purple-700 text-white font-semibold transition-all">
                            <i class="fas fa-search mr-2"></i>Policy Search
                        </button>
                        <button onclick="showPolicyConflictScan()" class="px-4 py-2 rounded-lg bg-yellow-600 hover:bg-yellow-700 text-white font-semibold transition-all">
                            <i class="fas fa-exclamation-triangle mr-2"></i>Conflict Scan
                        </button>
                        <button onclick="exportPolicyReport()" class="px-4 py-2 rounded-lg bg-green-600 hover:bg-green-700 text-white font-semibold transition-all">
                            <i class="fas fa-file-export mr-2"></i>Export Report
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="glass rounded-xl p-6">
                        <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                            <i class="fas fa-comments text-blue-400 mr-2"></i>
                            Natural Language Query
                        </h3>

                        <div class="mb-4">
                            <div class="flex gap-2 mb-3">
                                <input
                                    type="text"
                                    id="policyQuery"
                                    class="flex-1 px-4 py-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-white/50 focus:outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-500/50"
                                    placeholder="Ask: 'Does this policy comply with ADA requirements?' or 'Find all regulations about building heights'"
                                    onkeypress="if(event.key==='Enter') analyzePolicyQuery()"
                                >
                                <button onclick="togglePolicyVoiceInput()" class="px-4 py-3 rounded-lg bg-red-500/20 border border-red-500/40 text-red-400 hover:bg-red-500/30 transition-all" title="Voice input">
                                    <i class="fas fa-microphone"></i>
                                </button>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                                <select id="policyQueryType" class="px-4 py-2 rounded-lg bg-white/10 border border-white/20 text-white focus:outline-none focus:border-purple-500">
                                    <option value="general">General Inquiry</option>
                                    <option value="compliance">Compliance Check</option>
                                    <option value="conflict">Conflict Detection</option>
                                    <option value="citation">Citation Search</option>
                                    <option value="drafting">Policy Drafting</option>
                                </select>

                                <select id="policyDepartment" class="px-4 py-2 rounded-lg bg-white/10 border border-white/20 text-white focus:outline-none focus:border-purple-500">
                                    <option value="">All Departments</option>
                                    <option value="building">Building & Safety</option>
                                    <option value="planning">Planning & Zoning</option>
                                    <option value="health">Public Health</option>
                                    <option value="hr">Human Resources</option>
                                    <option value="finance">Finance</option>
                                </select>
                            </div>

                            <button onclick="analyzePolicyQuery()" class="w-full px-6 py-3 rounded-lg bg-gradient-to-r from-blue-600 to-purple-600 text-white font-bold hover:shadow-lg hover:shadow-blue-500/50 transition-all">
                                <i class="fas fa-search-plus mr-2"></i>Analyze Policy
                            </button>
                        </div>

                        <div class="glass-dark rounded-lg p-4">
                            <h4 class="text-white font-semibold mb-3 text-sm">Recent Queries</h4>
                            <div class="space-y-2" id="policyRecentQueries"></div>
                        </div>
                    </div>

                    <div class="glass rounded-xl p-6" id="policyAnalysisPanel" style="display: none;">
                        <h3 class="text-xl font-bold text-white mb-4 flex items-center justify-between">
                            <span>
                                <i class="fas fa-brain text-purple-400 mr-2"></i>
                                AI Analysis
                            </span>
                            <button onclick="closePolicyAnalysis()" class="text-white/60 hover:text-white">
                                <i class="fas fa-times"></i>
                            </button>
                        </h3>

                        <div id="policyAnalysisContent"></div>
                    </div>
                </div>

                <div class="glass rounded-xl p-6 mb-6" id="policyConflictDetector" style="display: none;">
                    <h3 class="text-xl font-bold text-white mb-4">
                        <i class="fas fa-exclamation-triangle text-yellow-400 mr-2"></i>
                        Policy Conflict Detector
                    </h3>
                    <div id="policyConflictContent"></div>
                </div>

                <div class="glass rounded-xl p-6 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-white">
                            <i class="fas fa-database text-blue-400 mr-2"></i>
                            Regulatory Database
                        </h3>
                        <div class="flex gap-2">
                            <input
                                type="text"
                                id="policyTableSearch"
                                placeholder="Search policies..."
                                class="px-3 py-2 rounded-lg bg-white/10 border border-white/20 text-white text-sm placeholder-white/50 focus:outline-none focus:border-purple-500"
                                oninput="filterPolicyTable()"
                            >
                            <select id="policyTableFilter" onchange="filterPolicyTable()" class="px-3 py-2 rounded-lg bg-white/10 border border-white/20 text-white text-sm focus:outline-none focus:border-purple-500">
                                <option value="">All Jurisdictions</option>
                                <option value="Federal">Federal</option>
                                <option value="State">State</option>
                                <option value="Municipal">Municipal</option>
                            </select>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="policy-table" id="policyTableMain">
                            <thead>
                                <tr>
                                    <th>Policy Title</th>
                                    <th>Jurisdiction</th>
                                    <th>Department</th>
                                    <th>Effective Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="policyTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="glass rounded-xl p-6">
                        <h4 class="text-white font-semibold mb-3">Top Searched Policies</h4>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center">
                                <span class="text-white/80 text-sm">ADA Compliance</span>
                                <span class="text-blue-400 font-semibold">847</span>
                            </div>
                            <div class="w-full bg-white/10 rounded-full h-2">
                                <div class="bg-blue-500 h-2 rounded-full" style="width: 85%"></div>
                            </div>

                            <div class="flex justify-between items-center">
                                <span class="text-white/80 text-sm">Building Heights</span>
                                <span class="text-blue-400 font-semibold">632</span>
                            </div>
                            <div class="w-full bg-white/10 rounded-full h-2">
                                <div class="bg-blue-500 h-2 rounded-full" style="width: 64%"></div>
                            </div>

                            <div class="flex justify-between items-center">
                                <span class="text-white/80 text-sm">Parking Requirements</span>
                                <span class="text-blue-400 font-semibold">521</span>
                            </div>
                            <div class="w-full bg-white/10 rounded-full h-2">
                                <div class="bg-blue-500 h-2 rounded-full" style="width: 52%"></div>
                            </div>
                        </div>
                    </div>

                    <div class="glass rounded-xl p-6">
                        <h4 class="text-white font-semibold mb-3">Compliance Score</h4>
                        <div class="text-center">
                            <div class="text-5xl font-bold text-green-400 mb-2">92%</div>
                            <div class="text-white/60 text-sm mb-4">Overall Compliance</div>
                            <div class="policy-confidence-meter">
                                <div class="policy-confidence-fill policy-confidence-high" style="width: 92%"></div>
                            </div>
                            <div class="text-white/50 text-xs mt-2">+3% from last month</div>
                        </div>
                    </div>

                    <div class="glass rounded-xl p-6">
                        <h4 class="text-white font-semibold mb-3">Recent Changes</h4>
                        <div class="space-y-3">
                            <div class="flex items-start">
                                <div class="w-2 h-2 rounded-full bg-green-400 mt-2 mr-3"></div>
                                <div>
                                    <div class="text-white/90 text-sm">Zoning §12.34 Updated</div>
                                    <div class="text-white/50 text-xs">2 days ago</div>
                                </div>
                            </div>
                            <div class="flex items-start">
                                <div class="w-2 h-2 rounded-full bg-blue-400 mt-2 mr-3"></div>
                                <div>
                                    <div class="text-white/90 text-sm">New OSHA Standard</div>
                                    <div class="text-white/50 text-xs">1 week ago</div>
                                </div>
                            </div>
                            <div class="flex items-start">
                                <div class="w-2 h-2 rounded-full bg-purple-400 mt-2 mr-3"></div>
                                <div>
                                    <div class="text-white/90 text-sm">ADA Guidelines Revised</div>
                                    <div class="text-white/50 text-xs">2 weeks ago</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="glass rounded-xl p-6">
                        <h4 class="text-white font-semibold mb-3">Query Activity</h4>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-white/70 text-sm">Building & Safety</span>
                                <span class="text-white font-semibold">42%</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-white/70 text-sm">Planning & Zoning</span>
                                <span class="text-white font-semibold">28%</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-white/70 text-sm">Public Health</span>
                                <span class="text-white font-semibold">18%</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-white/70 text-sm">Human Resources</span>
                                <span class="text-white font-semibold">12%</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function populatePolicyTable() {
            const tbody = document.getElementById('policyTableBody');
            if (!tbody) return;

            tbody.innerHTML = '';

            policyDatabase.forEach(policy => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${policy.title}</td>
                    <td><span class="px-2 py-1 rounded text-xs ${getPolicyJurisdictionClass(policy.jurisdiction)}">${policy.jurisdiction}</span></td>
                    <td>${policy.department}</td>
                    <td>${new Date(policy.effectiveDate).toLocaleDateString()}</td>
                    <td><span class="px-2 py-1 rounded text-xs policy-status-compliant">Active</span></td>
                    <td>
                        <button class="text-blue-400 hover:text-blue-300 mr-2" title="View">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="text-purple-400 hover:text-purple-300 mr-2" title="Analyze">
                            <i class="fas fa-search-plus"></i>
                        </button>
                        <button class="text-green-400 hover:text-green-300" title="Compare">
                            <i class="fas fa-code-compare"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function getPolicyJurisdictionClass(jurisdiction) {
            switch(jurisdiction) {
                case 'Federal': return 'bg-purple-500/20 text-purple-300 border border-purple-500/40';
                case 'State': return 'bg-green-500/20 text-green-300 border border-green-500/40';
                case 'Municipal': return 'bg-blue-500/20 text-blue-300 border border-blue-500/40';
                default: return '';
            }
        }

        function updatePolicyRecentQueries() {
            const container = document.getElementById('policyRecentQueries');
            if (!container) return;

            container.innerHTML = policyRecentQueries.slice(0, 5).map(query => `
                <div class="flex items-center justify-between p-2 rounded hover:bg-white/10 cursor-pointer transition-all" onclick="runRecentPolicyQuery('${query}')">
                    <span class="text-white/70 text-sm flex-1">${query}</span>
                    <button class="text-blue-400 hover:text-blue-300 text-xs">
                        <i class="fas fa-redo"></i>
                    </button>
                </div>
            `).join('');
        }

        function analyzePolicyQuery() {
            const query = document.getElementById('policyQuery').value.trim();
            if (!query) return;

            if (!policyRecentQueries.includes(query)) {
                policyRecentQueries.unshift(query);
                if (policyRecentQueries.length > 5) policyRecentQueries.pop();
                updatePolicyRecentQueries();
            }

            const panel = document.getElementById('policyAnalysisPanel');
            panel.style.display = 'block';

            let response;
            const lowerQuery = query.toLowerCase();

            if (lowerQuery.includes('parking') && lowerQuery.includes('ada')) {
                response = policySampleResponses['parking ada'];
            } else if (lowerQuery.includes('height') || lowerQuery.includes('building')) {
                response = policySampleResponses['building height'];
            } else if (lowerQuery.includes('work from home') || lowerQuery.includes('remote') || lowerQuery.includes('telework')) {
                response = policySampleResponses['work from home'];
            } else {
                response = {
                    confidence: 85,
                    status: 'compliant',
                    analysis: `Based on analysis of relevant regulations, your query appears to align with current policies. However, specific implementation details should be reviewed by the legal department.`,
                    plainEnglish: `Your question relates to established regulations that are generally permissive. For specific guidance tailored to your situation, please consult with the appropriate department.`,
                    citations: ['Various Municipal Codes', 'State Regulations', 'Federal Guidelines'],
                    recommendations: ['Review specific department policies', 'Consult with legal counsel for detailed interpretation', 'Check for recent regulatory updates', 'Document compliance procedures'],
                    relatedPolicies: ['See regulatory database for related policies']
                };
            }

            displayPolicyAnalysis(response, query);
        }

        function displayPolicyAnalysis(response, query) {
            const content = document.getElementById('policyAnalysisContent');
            if (!content) return;

            const confidenceClass = response.confidence >= 90 ? 'policy-confidence-high' :
                                   response.confidence >= 70 ? 'policy-confidence-medium' : 'policy-confidence-low';

            const statusClass = `policy-status-${response.status}`;
            const statusText = response.status.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
            const statusIcon = response.status === 'compliant' ? '✓' :
                             response.status === 'needs-review' ? '⚠️' :
                             response.status === 'non-compliant' ? '✗' : '?';

            content.innerHTML = `
                <div class="mb-4">
                    <div class="text-white/60 text-sm mb-2">Query:</div>
                    <div class="glass-dark p-3 rounded-lg text-white">${query}</div>
                </div>

                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-white/60 text-sm">AI Confidence</span>
                        <span class="text-white font-bold">${response.confidence}%</span>
                    </div>
                    <div class="policy-confidence-meter">
                        <div class="policy-confidence-fill ${confidenceClass}" style="width: ${response.confidence}%"></div>
                    </div>
                </div>

                <div class="mb-4">
                    <div class="text-white/60 text-sm mb-2">Compliance Status</div>
                    <span class="px-4 py-2 rounded-lg ${statusClass} font-semibold inline-block">
                        ${statusIcon} ${statusText}
                    </span>
                </div>

                <div class="mb-4">
                    <div class="text-white/60 text-sm mb-2">Professional Analysis</div>
                    <div class="glass-dark p-4 rounded-lg text-white/90 leading-relaxed">
                        ${response.analysis}
                    </div>
                </div>

                <details class="mb-4">
                    <summary class="cursor-pointer text-white font-semibold mb-2 hover:text-blue-400">
                        <i class="fas fa-chevron-right mr-2"></i>Plain English Summary
                    </summary>
                    <div class="glass-dark p-4 rounded-lg text-white/90 leading-relaxed ml-6">
                        ${response.plainEnglish}
                    </div>
                </details>

                <div class="mb-4">
                    <div class="text-white/60 text-sm mb-2">Relevant Citations</div>
                    <div class="flex flex-wrap gap-2">
                        ${response.citations.map(cit => {
                            const citClass = cit.includes('CFR') || cit.includes('U.S.C') ? 'policy-citation-federal' :
                                           cit.includes('SBC') || cit.includes('Ch.') ? 'policy-citation-state' : 'policy-citation-municipal';
                            return `<span class="${citClass}">${cit}</span>`;
                        }).join(' ')}
                    </div>
                </div>

                <div class="mb-4">
                    <div class="text-white/60 text-sm mb-2">Recommendations</div>
                    <div class="glass-dark p-4 rounded-lg">
                        <ul class="space-y-2">
                            ${response.recommendations.map(rec => `
                                <li class="text-white/90 flex items-start">
                                    <i class="fas fa-check-circle text-green-400 mr-2 mt-1"></i>
                                    <span>${rec}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button onclick="exportPolicyAnalysis()" class="px-4 py-2 rounded-lg bg-green-600 hover:bg-green-700 text-white font-semibold transition-all flex items-center">
                        <i class="fas fa-file-pdf mr-2"></i>Export PDF
                    </button>
                    <button onclick="emailPolicyAnalysis()" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold transition-all flex items-center">
                        <i class="fas fa-envelope mr-2"></i>Email Summary
                    </button>
                </div>
            `;
        }

        function closePolicyAnalysis() {
            document.getElementById('policyAnalysisPanel').style.display = 'none';
        }

        function runRecentPolicyQuery(query) {
            document.getElementById('policyQuery').value = query;
            analyzePolicyQuery();
        }

        function filterPolicyTable() {
            const searchTerm = document.getElementById('policyTableSearch').value.toLowerCase();
            const filter = document.getElementById('policyTableFilter').value;
            const rows = document.querySelectorAll('#policyTableBody tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const jurisdiction = row.children[1].textContent;

                const matchesSearch = text.includes(searchTerm);
                const matchesFilter = !filter || jurisdiction === filter;

                row.style.display = (matchesSearch && matchesFilter) ? '' : 'none';
            });
        }

        function togglePolicyVoiceInput() {
            alert('Voice input simulation: "Does this policy comply with ADA requirements?"');
            document.getElementById('policyQuery').value = 'Does this policy comply with ADA requirements?';
        }

        function showNewPolicyAnalysis() {
            document.getElementById('policyQuery').focus();
        }

        function showPolicySearch() {
            document.getElementById('policyTableSearch').focus();
        }

        function showPolicyConflictScan() {
            const detector = document.getElementById('policyConflictDetector');
            if (!detector) return;

            detector.style.display = 'block';

            const content = document.getElementById('policyConflictContent');
            content.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="glass-dark rounded-lg p-4 policy-conflict-critical">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-red-400 font-bold">Critical Conflicts</span>
                            <span class="text-2xl font-bold text-red-400">2</span>
                        </div>
                        <div class="text-white/70 text-sm">Require immediate resolution</div>
                    </div>
                    <div class="glass-dark rounded-lg p-4 policy-conflict-moderate">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-yellow-400 font-bold">Moderate Conflicts</span>
                            <span class="text-2xl font-bold text-yellow-400">5</span>
                        </div>
                        <div class="text-white/70 text-sm">Should be reviewed soon</div>
                    </div>
                    <div class="glass-dark rounded-lg p-4 policy-conflict-minor">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-green-400 font-bold">Minor Conflicts</span>
                            <span class="text-2xl font-bold text-green-400">8</span>
                        </div>
                        <div class="text-white/70 text-sm">Low priority items</div>
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="glass-dark rounded-lg p-4 policy-conflict-critical">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="text-white font-semibold">Parking Space Width Discrepancy</h4>
                            <span class="px-3 py-1 rounded-full bg-red-500/20 text-red-300 text-xs border border-red-500/40">Critical</span>
                        </div>
                        <div class="text-white/80 text-sm mb-3">
                            Municipal Code §78.90 specifies 96-inch van-accessible spaces, conflicting with ADA Standards §502.3 requiring 132 inches.
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-blue-500/10 p-3 rounded border border-blue-500/30">
                                <div class="text-blue-400 text-xs mb-1">Municipal Code</div>
                                <div class="text-white text-sm">96 inches wide</div>
                            </div>
                            <div class="bg-purple-500/10 p-3 rounded border border-purple-500/30">
                                <div class="text-purple-400 text-xs mb-1">Federal ADA</div>
                                <div class="text-white text-sm">132 inches wide</div>
                            </div>
                        </div>
                    </div>

                    <div class="glass-dark rounded-lg p-4 policy-conflict-moderate">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="text-white font-semibold">Building Height Measurement Baseline</h4>
                            <span class="px-3 py-1 rounded-full bg-yellow-500/20 text-yellow-300 text-xs border border-yellow-500/40">Moderate</span>
                        </div>
                        <div class="text-white/80 text-sm mb-3">
                            State Building Code measures from average grade, while Municipal Zoning §12.34 measures from lowest point.
                        </div>
                    </div>
                </div>
            `;
        }

        function exportPolicyReport() {
            alert('Exporting comprehensive policy analysis report...\n\nMOCK: This would generate a PDF report with all current analysis, compliance scores, and regulatory information.');
        }

        function exportPolicyAnalysis() {
            alert('Exporting analysis as PDF legal memo...\n\nMOCK: This would create a formatted PDF with the complete analysis.');
        }

        function emailPolicyAnalysis() {
            alert('Email summary functionality\n\nMOCK: This would send the analysis summary to specified recipients.');
        }

        // Citizen Portal specific functions
        function sendCitizenMessage() {
            const input = document.getElementById('citizenUserInput');
            const message = input.value.trim();
            if (!message) return;
            
            addCitizenChatMessage(message, 'user');
            input.value = '';
            
            setTimeout(() => {
                // Smart responses based on message content
                const lowerMessage = message.toLowerCase();
                let response = '';
                
                if (lowerMessage.includes('permit') || lowerMessage.includes('building')) {
                    response = "For building permits, you'll need property surveys, construction plans, and a licensed contractor. Would you like me to open the building permit form for you?";
                } else if (lowerMessage.includes('license') || lowerMessage.includes('business')) {
                    response = "Business licenses typically require your business registration, zoning approval, and tax ID. Processing usually takes 3-5 business days. Shall I help you start the application?";
                } else if (lowerMessage.includes('pothole') || lowerMessage.includes('road') || lowerMessage.includes('street')) {
                    response = "For road issues like potholes, please provide the exact location and photos if possible. Our Public Works team responds within 1-3 business days. Would you like to submit a repair request?";
                } else if (lowerMessage.includes('tax') || lowerMessage.includes('property tax')) {
                    response = "For tax inquiries, I can connect you with the Finance Department. They handle property assessments, payment plans, and exemptions. What specific tax issue can I help with?";
                } else if (lowerMessage.includes('tree') || lowerMessage.includes('park')) {
                    response = "Tree services and park maintenance are handled by Parks & Recreation. For tree removal, you'll need property ownership verification. Would you like me to start that request?";
                } else if (lowerMessage.includes('noise') || lowerMessage.includes('complaint')) {
                    response = "For noise complaints, please provide specific times, dates, and any evidence. Code Enforcement typically responds within 1-2 business days. Should I open a complaint form?";
                } else if (lowerMessage.includes('trash') || lowerMessage.includes('garbage') || lowerMessage.includes('recycling')) {
                    response = "For trash and recycling issues, I can help you contact Sanitation Services. They handle missed pickups, damaged bins, and schedule changes. What's the specific issue?";
                } else {
                    const genericResponses = [
                        "I can help you find the right city service! Try asking about permits, licenses, road repairs, or reporting issues.",
                        "What service are you looking for? I can help with building permits, business licenses, reporting problems, or connecting you with the right department.",
                        "I'm here to help you navigate city services. You can ask about permits, file complaints, request services, or get information about any department.",
                        "Need help with city services? I can assist with applications, direct you to the right department, or help you submit requests quickly."
                    ];
                    response = genericResponses[Math.floor(Math.random() * genericResponses.length)];
                }
                
                addCitizenChatMessage(response, 'ai');
            }, 800);
        }

        function addCitizenChatMessage(message, sender) {
            const chatHistory = document.getElementById('citizenChatHistory');
            const messageDiv = document.createElement('div');
            messageDiv.className = sender === 'user' ? 'text-blue-300 mb-2' : 'text-green-300 mb-2';
            
            const icon = sender === 'user' ? 'fas fa-user' : 'fas fa-robot';
            const senderName = sender === 'user' ? 'You' : 'Assistant';
            const senderClass = sender === 'user' ? '' : 'text-blue-300';
            
            messageDiv.innerHTML = `
                <i class="${icon} mr-2"></i>
                <span class="font-semibold ${senderClass}">${senderName}:</span>
                <span>${message}</span>
            `;
            
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        function quickCitizenChat(topic) {
            document.getElementById('citizenUserInput').value = `I need help with ${topic}`;
            sendCitizenMessage();
        }

        // ===== INTELLIGENT DOCUMENT PROCESSING - Added 2025-10-18 =====
        // MOCK DATA - Replace in production
        // TODO: Connect to OCR service (Tesseract, Google Vision, AWS Textract)
        // TODO: Implement document classification ML model
        // TODO: Add secure document storage with encryption
        // TODO: Integrate with form auto-fill API
        // TODO: Add audit logging for all extractions
        // TODO: Implement user correction feedback loop for ML improvement

        const DOC_PROCESSING_TEMPLATES = {
            drivers_license: {
                name: "Driver's License",
                fields: { firstName: 0.98, lastName: 0.97, address: 0.89, city: 0.95, state: 0.99, zip: 0.96, phone: 0.92 },
                sampleData: { firstName: "John", lastName: "Smith", address: "123 Oak Street", city: "Springfield", state: "IL", zip: "62701", phone: "(555) 555-5555" }
            },
            utility_bill: {
                name: "Utility Bill",
                fields: { firstName: 0.91, lastName: 0.93, address: 0.96, city: 0.94, state: 0.97, zip: 0.95 },
                sampleData: { firstName: "Sarah", lastName: "Johnson", address: "456 Maple Avenue", city: "Springfield", state: "IL", zip: "62702" }
            },
            business_card: {
                name: "Business Card",
                fields: { firstName: 0.88, lastName: 0.90, email: 0.95, phone: 0.87 },
                sampleData: { firstName: "Mike", lastName: "Chen", email: "mike@example.com", phone: "(555) 123-4567" }
            }
        };

        let currentDocProcessingData = null;

        // Setup document processing drag and drop
        function initializeDocumentProcessing() {
            const dropZone = document.getElementById('docProcessingDropZone');
            const fileInput = document.getElementById('docProcessingFileInput');

            if (!dropZone || !fileInput) return;

            dropZone.addEventListener('click', () => fileInput.click());

            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = '#3b82f6';
                dropZone.style.backgroundColor = 'rgba(59, 130, 246, 0.1)';
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.style.borderColor = '';
                dropZone.style.backgroundColor = '';
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = '';
                dropZone.style.backgroundColor = '';
                handleDocProcessingFiles(e.dataTransfer.files);
            });

            fileInput.addEventListener('change', (e) => {
                handleDocProcessingFiles(e.target.files);
            });

            // Keyboard accessibility
            dropZone.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    fileInput.click();
                }
            });
        }

        async function handleDocProcessingFiles(files) {
            if (files.length === 0) return;

            // Validate file
            const file = files[0];
            const maxSize = 10 * 1024 * 1024;
            const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];

            if (!allowedTypes.includes(file.type)) {
                alert(`❌ Invalid file type: ${file.name}\n\nPlease upload PDF, JPG, or PNG files only.`);
                return;
            }

            if (file.size > maxSize) {
                alert(`❌ File too large: ${file.name}\n\nMaximum file size is 10MB.`);
                return;
            }

            await processDocumentForAutoFill(file);
        }

        async function processDocumentForAutoFill(file) {
            // Show processing status
            const statusEl = document.getElementById('docProcessingStatus');
            const progressBar = document.getElementById('docProcessingProgressBar');
            const progressText = document.getElementById('docProcessingProgressText');

            statusEl.classList.remove('hidden');

            // Simulate processing
            const steps = [
                { progress: 20, text: 'Detecting document type...' },
                { progress: 40, text: 'Extracting text...' },
                { progress: 60, text: 'Analyzing fields...' },
                { progress: 80, text: 'Validating data...' },
                { progress: 100, text: 'Complete!' }
            ];

            for (let step of steps) {
                await new Promise(resolve => setTimeout(resolve, 300));
                progressBar.style.width = step.progress + '%';
                progressText.textContent = step.text;
            }

            // Randomly select a document type for demo
            const types = Object.keys(DOC_PROCESSING_TEMPLATES);
            const randomType = types[Math.floor(Math.random() * types.length)];
            const template = DOC_PROCESSING_TEMPLATES[randomType];

            // Create extracted data
            currentDocProcessingData = {
                documentType: randomType,
                fileName: file.name,
                template: template,
                fields: {}
            };

            Object.keys(template.fields).forEach(fieldKey => {
                currentDocProcessingData.fields[fieldKey] = {
                    value: template.sampleData[fieldKey] || '',
                    confidence: template.fields[fieldKey]
                };
            });

            // Hide processing, show results
            statusEl.classList.add('hidden');
            displayDocProcessingResults(currentDocProcessingData);
        }

        function displayDocProcessingResults(data) {
            const panel = document.getElementById('docProcessingExtractedPanel');
            const fieldsPreview = document.getElementById('docProcessingFields');
            const confidenceEl = document.getElementById('docProcessingConfidence');
            const fieldCountEl = document.getElementById('docProcessingFieldCount');

            panel.classList.remove('hidden');

            // Calculate overall confidence
            const confidences = Object.values(data.fields).map(f => f.confidence);
            const avgConfidence = (confidences.reduce((a, b) => a + b, 0) / confidences.length) * 100;

            const confidenceClass = avgConfidence >= 90 ? 'text-green-400' : avgConfidence >= 70 ? 'text-yellow-400' : 'text-red-400';
            confidenceEl.className = `text-xs font-bold ${confidenceClass}`;
            confidenceEl.textContent = `${avgConfidence.toFixed(0)}% Confidence`;

            // Display fields preview
            const fieldNames = Object.keys(data.fields).map(key => {
                const label = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                return label;
            });
            fieldsPreview.innerHTML = `<strong>${data.template.name} detected:</strong> ${fieldNames.join(', ')}`;

            fieldCountEl.textContent = Object.keys(data.fields).length;
        }

        function autoFillFromDocument() {
            if (!currentDocProcessingData) return;

            let filledCount = 0;

            // Fill form fields
            Object.keys(currentDocProcessingData.fields).forEach(fieldKey => {
                const field = currentDocProcessingData.fields[fieldKey];
                const input = document.getElementById(fieldKey);
                if (input && field.value) {
                    input.value = field.value;

                    // Add visual feedback
                    input.style.borderColor = '#3b82f6';
                    input.style.backgroundColor = 'rgba(59, 130, 246, 0.1)';

                    setTimeout(() => {
                        input.style.borderColor = '';
                        input.style.backgroundColor = '';
                    }, 2000);

                    filledCount++;
                }
            });

            // Show success message
            if (filledCount > 0) {
                alert(`✨ Auto-filled ${filledCount} fields from ${currentDocProcessingData.template.name}!\n\nPlease review the information and complete any remaining fields.`);
            }
        }
        // ===== END INTELLIGENT DOCUMENT PROCESSING =====

        // Advanced AI Assistant with sophisticated prompting
        function sendAdvancedAdminMessage() {
            const input = document.getElementById('adminUserInput');
            const commandType = document.getElementById('commandType').value;
            const message = input.value.trim();
            if (!message) return;
            
            addAdminChatMessage(message, 'user');
            input.value = '';
            
            // Show typing indicator
            addTypingIndicator();
            
            setTimeout(() => {
                removeTypingIndicator();
                const response = processAdvancedCommand(message, commandType);
                addAdminChatMessage(response, 'ai');
                
                // Execute any automation if triggered
                executeAutomation(message, commandType);
            }, 1200);
        }

        function processAdvancedCommand(message, type) {
            const prompts = {
                natural: processNaturalLanguage(message),
                automation: processAutomationScript(message),
                workflow: processWorkflowCommand(message),
                security: processSecurityAnalysis(message),
                optimization: processOptimizationCommand(message)
            };
            
            return prompts[type] || prompts.natural;
        }

        function processNaturalLanguage(message) {
            const lowerMessage = message.toLowerCase();
            
            // Intent recognition with sophisticated responses
            if (lowerMessage.includes('analyze') || lowerMessage.includes('report')) {
                return generateAnalysisResponse(message);
            } else if (lowerMessage.includes('automate') || lowerMessage.includes('script')) {
                return generateAutomationResponse(message);
            } else if (lowerMessage.includes('security') || lowerMessage.includes('protect')) {
                return generateSecurityResponse(message);
            } else if (lowerMessage.includes('optimize') || lowerMessage.includes('improve')) {
                return generateOptimizationResponse(message);
            } else if (lowerMessage.includes('workflow')) {
                return generateWorkflowResponse(message);
            } else {
                return generateContextualResponse(message);
            }
        }

        function processAutomationScript(message) {
            if (message.startsWith('auto:')) {
                return `🤖 Parsing automation script: "${message.substr(5)}"\n\n✅ Script validated\n✅ Dependencies checked\n✅ Security scan passed\n\n🚀 Automation queued for execution. Estimated completion: 2-5 minutes.`;
            }
            
            return `🔧 Creating automation for: "${message}"\n\n📋 Suggested automation steps:\n1. Input validation and sanitization\n2. Process orchestration with error handling\n3. Real-time monitoring and logging\n4. Completion notification and reporting\n\nReady to implement? Reply 'execute' to proceed.`;
        }

        function processWorkflowCommand(message) {
            const workflows = {
                'create': 'Initiating workflow creation wizard. Define triggers, actions, and conditions.',
                'optimize': 'Analyzing current workflows for optimization opportunities...',
                'deploy': 'Preparing workflow deployment with validation checks...',
                'monitor': 'Activating real-time workflow monitoring and alerting...'
            };
            
            for (const [key, response] of Object.entries(workflows)) {
                if (message.toLowerCase().includes(key)) {
                    return `🔄 ${response}\n\n🎯 Advanced features available:\n• Multi-stage approval chains\n• Conditional branching logic\n• Real-time data integration\n• Automated escalation protocols`;
                }
            }
            
            return `⚡ Workflow Command Center ready. Available commands:\n• create [name] - New workflow\n• optimize [workflow] - Performance tuning\n• deploy [workflow] - Production deployment\n• monitor [workflow] - Real-time tracking`;
        }

        function processSecurityAnalysis(message) {
            return `🛡️ Advanced Security Analysis Initiated\n\n🔍 Scanning for:\n• Vulnerability patterns\n• Access control anomalies\n• Data flow security\n• Compliance violations\n\n📊 Results: 97% security score\n⚠️ 3 minor recommendations identified\n🔒 All critical systems secure\n\nDetailed report available in Security Dashboard.`;
        }

        function processOptimizationCommand(message) {
            return `⚡ System Optimization Engine Activated\n\n🎯 Performance analysis:\n• Resource utilization: 72% (optimal)\n• Response times: <200ms average\n• Throughput: 15,000 req/min\n• Error rate: 0.02%\n\n💡 Optimization opportunities:\n• Cache optimization (+15% speed)\n• Database indexing (+8% efficiency)\n• Load balancing refinement\n\nImplement recommendations? Reply 'optimize now'.`;
        }

        // Context-aware response generators
        function generateAnalysisResponse(message) {
            const analyses = [
                `📊 Deep Analysis Complete\n\n🔍 Key findings:\n• System efficiency: 94.2%\n• Security posture: Excellent\n• User satisfaction: 4.8/5\n• Cost optimization: 23% savings identified\n\n📈 Trending metrics show consistent improvement across all KPIs.`,
                `🧠 Intelligent Analysis Results\n\n💡 Insights discovered:\n• Peak usage patterns identified\n• Bottleneck predictions available\n• Resource allocation optimized\n• Predictive scaling configured\n\n🎯 Next steps: Implement automated scaling policies?`,
                `🔬 Advanced Analytics Summary\n\n📋 Multi-dimensional analysis:\n• Performance vectors: All green\n• Risk assessment: Low\n• Compliance status: 100%\n• Innovation index: High\n\n🚀 System performing at 98% of theoretical maximum.`
            ];
            
            return analyses[Math.floor(Math.random() * analyses.length)];
        }

        function generateAutomationResponse(message) {
            return `🤖 Automation Framework Engaged\n\n⚙️ Building intelligent automation:\n• Natural language processing\n• Machine learning integration\n• Adaptive workflow generation\n• Real-time performance optimization\n\n🎯 Target efficiency gain: 45-60%\n⏱️ Implementation time: 30 minutes\n\nShall I proceed with automation deployment?`;
        }

        function generateSecurityResponse(message) {
            return `🔐 Advanced Security Protocol Active\n\n🛡️ Multi-layer protection:\n• Zero-trust architecture verified\n• AI-powered threat detection online\n• Quantum-resistant encryption enabled\n• Behavioral analysis monitoring\n\n✅ Current threat level: GREEN\n🔍 Continuous monitoring active\n📱 Mobile security optimized`;
        }

        function generateOptimizationResponse(message) {
            return `⚡ Performance Optimization Suite\n\n🚀 Enhancement protocols:\n• AI-driven resource allocation\n• Predictive load balancing\n• Self-healing infrastructure\n• Continuous performance tuning\n\n📈 Expected improvements:\n• 40% faster response times\n• 30% cost reduction\n• 99.99% uptime guarantee`;
        }

        function generateWorkflowResponse(message) {
            return `🔄 Intelligent Workflow Engine\n\n✨ Advanced capabilities:\n• Self-optimizing processes\n• Dynamic adaptation to load\n• Intelligent error recovery\n• Predictive maintenance\n\n🎯 Current workflows: 28 active\n⚡ Average completion: 3.2 minutes\n📊 Success rate: 99.7%`;
        }

        function generateContextualResponse(message) {
            const responses = [
                `🧠 AI Assistant Pro analyzing request...\n\n💡 Contextual understanding:\n• Intent: ${detectIntent(message)}\n• Complexity: ${assessComplexity(message)}\n• Priority: ${determinePriority(message)}\n\nHow can I help you achieve this goal?`,
                `🎯 Intelligent Response System\n\n🔍 I understand you're looking for guidance on "${message}"\n\n📋 Available options:\n• Automated solution development\n• Step-by-step guidance\n• Resource recommendations\n• Expert consultation\n\nWhich approach would you prefer?`,
                `⚡ Advanced AI Processing\n\n🤖 Your request has been analyzed using:\n• Natural language understanding\n• Context awareness algorithms\n• Predictive modeling\n• Optimization protocols\n\nReady to provide intelligent assistance. Please specify your preferred solution approach.`
            ];
            
            return responses[Math.floor(Math.random() * responses.length)];
        }

        // Utility functions for contextual analysis
        function detectIntent(message) {
            if (message.includes('help') || message.includes('how')) return 'Assistance Seeking';
            if (message.includes('create') || message.includes('build')) return 'Creation';
            if (message.includes('fix') || message.includes('solve')) return 'Problem Solving';
            return 'Information Seeking';
        }

        function assessComplexity(message) {
            const words = message.split(' ').length;
            if (words > 15) return 'High';
            if (words > 8) return 'Medium';
            return 'Low';
        }

        function determinePriority(message) {
            if (message.includes('urgent') || message.includes('critical')) return 'High';
            if (message.includes('soon') || message.includes('important')) return 'Medium';
            return 'Normal';
        }

        // Legacy function kept for compatibility
        function sendAdminMessage() {
            sendAdvancedAdminMessage();
        }


        function populateCitizenRequests() {
            const container = document.getElementById('recentRequestsListCitizen');
            const recentRequests = userRequests.slice(0, 3);
            
            container.innerHTML = recentRequests.map(request => `
                <div class="flex items-center justify-between p-4 bg-white/5 rounded-lg hover:bg-white/10 transition-colors cursor-pointer" onclick="viewRequestDetails('${request.id}')">
                    <div class="flex-1">
                        <div class="flex items-center space-x-3 mb-2">
                            <span class="text-white font-medium">${request.type}</span>
                            <span class="text-xs px-2 py-1 rounded-full bg-${request.statusColor}-500/20 text-${request.statusColor}-300">${request.status}</span>
                        </div>
                        <p class="text-sm text-white/70">${request.description}</p>
                        <div class="flex items-center space-x-4 mt-2 text-xs text-white/60">
                            <span><i class="fas fa-calendar mr-1"></i>${new Date(request.date).toLocaleDateString()}</span>
                            <span><i class="fas fa-building mr-1"></i>${request.department}</span>
                        </div>
                    </div>
                    <div class="text-white/60">
                        <i class="fas fa-chevron-right"></i>
                    </div>
                </div>
            `).join('');
        }
        
        function populateRecentActivity() {
            const container = document.getElementById('recentActivity');
            const activities = [
                { icon: 'fas fa-check', text: 'Permit #2847 approved automatically', time: '2 minutes ago', color: 'green' },
                { icon: 'fas fa-exclamation-triangle', text: 'Security alert: Suspicious login detected', time: '5 minutes ago', color: 'red' },
                { icon: 'fas fa-cog', text: 'Tax assessment workflow deployed', time: '12 minutes ago', color: 'blue' },
                { icon: 'fas fa-user-plus', text: 'New user registered in system', time: '15 minutes ago', color: 'purple' }
            ];
            
            container.innerHTML = activities.map(activity => `
                <div class="flex items-center space-x-3 p-3 bg-white/5 rounded-lg">
                    <div class="w-8 h-8 bg-${activity.color}-500 rounded-lg flex items-center justify-center">
                        <i class="${activity.icon} text-white text-sm"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-white text-sm">${activity.text}</p>
                        <p class="text-white/60 text-xs">${activity.time}</p>
                    </div>
                </div>
            `).join('');
        }

        // Advanced AI Assistant Supporting Functions
        function executeQuickAction(action) {
            addAdminChatMessage(`Quick Action: ${action}`, 'user');
            addTypingIndicator();
            
            setTimeout(() => {
                removeTypingIndicator();
                let response = '';
                
                switch(action) {
                    case 'analyze':
                        response = `🔍 System Analysis Complete\n\n✅ Performance: 94.7% optimal\n✅ Security: All green\n✅ Workflows: 28 active, 0 errors\n✅ Resources: 72% utilization\n\n💡 Recommendations:\n• Implement caching for 15% speed boost\n• Schedule maintenance window\n• Review user access permissions`;
                        break;
                    case 'optimize':
                        response = `⚡ Auto-Optimization Initiated\n\n🚀 Implementing:\n• Database query optimization\n• Cache warm-up procedures\n• Load balancer fine-tuning\n• Memory allocation adjustment\n\n📊 Expected improvements:\n• 23% faster response times\n• 18% lower resource usage\n• Enhanced user experience\n\nOptimization completed successfully!`;
                        break;
                    case 'secure':
                        response = `🛡️ Security Scan Complete\n\n🔒 Security Status: EXCELLENT\n\n✅ Vulnerabilities: None detected\n✅ Access controls: Properly configured\n✅ Encryption: AES-256 active\n✅ Firewall: All rules optimized\n✅ Monitoring: Real-time protection active\n\n🎯 Security score: 98/100\n📝 Full report generated`;
                        break;
                }
                
                addAdminChatMessage(response, 'ai');
            }, 1500);
        }

        function toggleAdvancedMode() {
            const panel = document.getElementById('advancedPanel');
            const btn = document.getElementById('advancedModeBtn');
            
            if (panel.classList.contains('hidden')) {
                panel.classList.remove('hidden');
                btn.innerHTML = '<i class="fas fa-magic mr-1"></i>Basic';
                btn.classList.add('bg-purple-600/40');
            } else {
                panel.classList.add('hidden');
                btn.innerHTML = '<i class="fas fa-magic mr-1"></i>Advanced';
                btn.classList.remove('bg-purple-600/40');
            }
        }

        function insertTemplate(type) {
            const input = document.getElementById('adminUserInput');
            const templates = {
                workflow: 'create workflow "Emergency Response" with triggers [citizen_request] actions [notify_department, assign_priority, track_progress] conditions [urgency_level > 3]',
                security: 'security scan --deep --check-vulnerabilities --audit-permissions --generate-report',
                automation: 'auto: optimize_database_queries() && clear_cache() && restart_services() if performance < 90%',
                api: 'api call POST /workflows/deploy {name: "new_process", enabled: true, priority: "high"}'
            };
            
            input.value = templates[type] || '';
            input.focus();
        }

        function addTypingIndicator() {
            const chatHistory = document.getElementById('adminChatHistory');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'text-green-300 mb-2 typing-indicator';
            typingDiv.innerHTML = `
                <i class="fas fa-brain mr-2"></i>
                <span class="font-semibold text-blue-300">AI Pro:</span>
                <span class="typing">Processing advanced request...</span>
            `;
            
            chatHistory.appendChild(typingDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        function removeTypingIndicator() {
            const indicator = document.querySelector('.typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        function executeAutomation(message, commandType) {
            // Simulate automation execution based on command type and content
            if (commandType === 'automation' && message.includes('execute')) {
                setTimeout(() => {
                    addAdminChatMessage(`🚀 Automation Executed Successfully\n\n✅ All systems updated\n✅ Performance optimized\n✅ Security protocols refreshed\n\n📊 Results:\n• Processing time: 45 seconds\n• Success rate: 100%\n• Error rate: 0%\n\nAutomation completed without issues.`, 'ai');
                }, 3000);
            } else if (message.toLowerCase().includes('optimize now')) {
                setTimeout(() => {
                    addAdminChatMessage(`⚡ System Optimization Complete\n\n🎯 Optimization Results:\n• Cache hit ratio: 95% (+12%)\n• Database queries: 340ms avg (-67ms)\n• Memory usage: 68% (-8%)\n• CPU utilization: 45% (-15%)\n\n✨ System is now running at peak efficiency!`, 'ai');
                }, 2500);
            }
        }

        // Enhanced chat message function with better formatting
        function addAdminChatMessage(message, sender) {
            const chatHistory = document.getElementById('adminChatHistory');
            const messageDiv = document.createElement('div');
            messageDiv.className = sender === 'user' ? 'text-blue-300 mb-3' : 'text-green-300 mb-3';
            
            const icon = sender === 'user' ? 'fas fa-user' : 'fas fa-brain';
            const senderName = sender === 'user' ? 'You' : 'AI Pro';
            const senderClass = sender === 'user' ? '' : 'text-blue-300';
            
            // Format message with proper line breaks and styling
            const formattedMessage = message.replace(/\n/g, '<br>').replace(/•/g, '<span class="text-yellow-300">•</span>');
            
            messageDiv.innerHTML = `
                <div class="flex items-start space-x-2">
                    <i class="${icon} mt-1"></i>
                    <div class="flex-1">
                        <span class="font-semibold ${senderClass}">${senderName}:</span>
                        <div class="mt-1">${formattedMessage}</div>
                    </div>
                </div>
            `;
            
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        
        // Handle Enter key
        const userInput = document.getElementById('userInput');
        if (userInput) {
            userInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        }

        // Handle Enter key for admin chat
        const adminUserInput = document.getElementById('adminUserInput');
        if (adminUserInput) {
            adminUserInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendAdminMessage();
                }
            });
        }

        // Handle Enter key for citizen chat
        const citizenUserInput = document.getElementById('citizenUserInput');
        if (citizenUserInput) {
            citizenUserInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendCitizenMessage();
                }
            });
        }
        
        // Grant Management Functions
        let grantSearchResults = [];
        let activeGrants = [
            {
                id: 1,
                title: "SBIR Phase II - Advanced Cybersecurity Solutions",
                agency: "Department of Defense",
                amount: "$750,000",
                deadline: "2024-12-15",
                status: "Application Submitted",
                progress: 85,
                lastUpdate: "2024-10-01"
            },
            {
                id: 2,
                title: "NSF Innovation Corps - AI Healthcare Platform",
                agency: "National Science Foundation",
                amount: "$50,000",
                deadline: "2024-11-30",
                status: "Draft in Progress",
                progress: 45,
                lastUpdate: "2024-09-28"
            },
            {
                id: 3,
                title: "EPA SBIR - Environmental Monitoring Tech",
                agency: "Environmental Protection Agency",
                amount: "$300,000",
                deadline: "2025-01-20",
                status: "Research Phase",
                progress: 25,
                lastUpdate: "2024-09-25"
            }
        ];

        // AI Grant Search Function with Enhanced Mock Data (Browser-Compatible)
        async function searchGrants() {
            const query = document.getElementById('grant-search-input').value.trim();
            if (!query) {
                alert('Please enter a search term to find federal grants.');
                return;
            }

            console.log('Starting grant search for:', query);

            // Show loading state
            const searchButton = document.querySelector('#grant-search-input').nextElementSibling;
            const originalText = searchButton.innerHTML;
            searchButton.innerHTML = '<i class="fas fa-spinner animate-spin mr-2"></i>Searching Federal Grants...';
            searchButton.disabled = true;

            try {
                // Simulate AI search delay for realism
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // Use enhanced mock data with real grant information
                const mockResults = generateRealisticGrantResults(query);
                console.log('Generated results:', mockResults);
                
                displayGrantResults(mockResults);
                showAIGrantInsights(query, mockResults, mockResults.length);
                
                console.log('Search completed successfully');
                
            } catch (error) {
                console.error('Grant search error:', error);
                alert('Search encountered an error. Please try again.');
            } finally {
                // Reset button
                searchButton.innerHTML = originalText;
                searchButton.disabled = false;
            }
        }

        // Note: Direct grants.gov API calls are disabled due to CORS restrictions in browsers
        // Using enhanced realistic mock data based on actual federal grants instead

        // Note: RAG processing functions removed - using realistic mock data instead

        // AI-powered match scoring algorithm
        function calculateAIMatchScore(grant, queryTerms, originalQuery) {
            let score = 0;
            const title = grant.title.toLowerCase();
            const agency = grant.agency.toLowerCase();
            
            // Exact keyword matches in title (highest weight)
            queryTerms.forEach(term => {
                if (title.includes(term)) {
                    score += 30;
                }
                if (agency.includes(term)) {
                    score += 15;
                }
            });
            
            // Technology-specific bonus scoring
            const techKeywords = {
                'cybersecurity': ['security', 'cyber', 'defense', 'protection', 'infrastructure'],
                'ai': ['artificial', 'intelligence', 'machine', 'learning', 'neural', 'deep'],
                'quantum': ['quantum', 'computing', 'cryptography', 'physics'],
                'biotech': ['bio', 'medical', 'health', 'pharmaceutical', 'genetic'],
                'energy': ['energy', 'renewable', 'solar', 'battery', 'grid', 'power'],
                'climate': ['climate', 'environmental', 'carbon', 'emission', 'sustainability']
            };
            
            Object.entries(techKeywords).forEach(([field, keywords]) => {
                if (originalQuery.toLowerCase().includes(field)) {
                    keywords.forEach(keyword => {
                        if (title.includes(keyword)) {
                            score += 20;
                        }
                    });
                }
            });
            
            // Agency reputation bonus
            const prestigiousAgencies = ['NSF', 'NIH', 'DOE', 'DARPA', 'NASA'];
            if (prestigiousAgencies.some(agency => grant.agencyCode.includes(agency))) {
                score += 10;
            }
            
            // Status bonus (posted grants are more valuable)
            if (grant.oppStatus === 'posted') {
                score += 15;
            }
            
            // Cap at 100 and ensure minimum of 60 for any match
            return Math.min(100, Math.max(60, score));
        }

        // Estimate grant funding amount based on agency and type
        function estimateGrantAmount(grant) {
            // Agency-based estimates (in thousands)
            const agencyEstimates = {
                'NSF': [50, 500, 2000],      // Small, Medium, Large
                'NIH': [100, 1000, 5000],
                'DOE': [75, 750, 3000],
                'DARPA': [200, 1500, 10000],
                'EPA': [25, 250, 1000],
                'DOD': [150, 1000, 5000],
                'NASA': [100, 800, 4000]
            };
            
            // Find matching agency
            let estimates = [50, 500, 2000]; // Default
            Object.keys(agencyEstimates).forEach(agency => {
                if (grant.agencyCode.includes(agency)) {
                    estimates = agencyEstimates[agency];
                }
            });
            
            // Select estimate based on title keywords
            let amount = estimates[1]; // Default to medium
            const title = grant.title.toLowerCase();
            
            if (title.includes('phase i') || title.includes('small') || title.includes('pilot')) {
                amount = estimates[0];
            } else if (title.includes('phase ii') || title.includes('large') || title.includes('center')) {
                amount = estimates[2];
            }
            
            return `$${amount.toLocaleString()},000`;
        }

        // Format grant deadline
        function formatGrantDeadline(closeDate) {
            if (!closeDate) return 'Open-ended';
            
            // Handle MM/DD/YYYY format
            const date = new Date(closeDate);
            if (isNaN(date.getTime())) return closeDate;
            
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: '2-digit', 
                day: '2-digit'
            });
        }

        // Generate AI-enhanced grant description
        function generateGrantDescription(grant) {
            const templates = {
                'research': `Advanced research initiative focusing on ${grant.title.toLowerCase()} with potential applications in cutting-edge technology development and innovation.`,
                'development': `Technology development program aimed at creating breakthrough solutions in ${grant.title.toLowerCase().replace(/[^a-z\s]/g, '')} sector.`,
                'education': `Educational excellence program supporting ${grant.title.toLowerCase()} through comprehensive training and development initiatives.`,
                'infrastructure': `Infrastructure modernization project targeting ${grant.title.toLowerCase()} to enhance national capabilities and competitiveness.`,
                'default': `Federal funding opportunity supporting innovative approaches to ${grant.title.toLowerCase()} with significant impact potential.`
            };
            
            const title = grant.title.toLowerCase();
            if (title.includes('research') || title.includes('r&d')) return templates.research;
            if (title.includes('development') || title.includes('innovation')) return templates.development;
            if (title.includes('education') || title.includes('training')) return templates.education;
            if (title.includes('infrastructure') || title.includes('modernization')) return templates.infrastructure;
            
            return templates.default;
        }

        // Determine eligibility requirements
        function determineEligibility(grant) {
            const eligibilityMap = {
                'NSF': 'Universities, research institutions, and qualified organizations',
                'NIH': 'Medical institutions, research universities, and healthcare organizations',
                'DOE': 'Energy sector organizations, research labs, and qualified institutions',
                'DARPA': 'Defense contractors, research institutions, and technology companies',
                'EPA': 'Environmental organizations, state agencies, and research institutions',
                'DOD': 'Defense contractors, military research organizations, and qualified entities',
                'NASA': 'Aerospace organizations, research institutions, and technology companies'
            };
            
            // Find matching agency
            for (const [agency, description] of Object.entries(eligibilityMap)) {
                if (grant.agencyCode.includes(agency)) {
                    return description;
                }
            }
            
            return 'Qualified organizations meeting federal grant requirements';
        }

        // Generate realistic grant results based on real federal grant data
        function generateRealisticGrantResults(query) {
            const realGrantDatabase = {
                'cybersecurity': [
                    {
                        title: "CyberCorps® Scholarship for Service",
                        agency: "U.S. National Science Foundation",
                        agencyCode: "NSF",
                        amount: "$275,000",
                        deadline: "07/15/2026",
                        matchScore: 95,
                        description: "Federal cybersecurity scholarship program supporting students pursuing cybersecurity degrees in exchange for federal service commitment.",
                        eligibility: "Universities with approved cybersecurity programs",
                        number: "23-574"
                    },
                    {
                        title: "Security, Privacy, and Trust in Cyberspace",
                        agency: "U.S. National Science Foundation",
                        agencyCode: "NSF",
                        amount: "$500,000",
                        deadline: "09/29/2025",
                        matchScore: 92,
                        description: "Research initiative focusing on foundational cybersecurity, privacy protection, and establishing trust in digital systems.",
                        eligibility: "Research institutions and universities",
                        number: "25-515"
                    },
                    {
                        title: "DHS SBIR - Cybersecurity Solutions",
                        agency: "Department of Homeland Security",
                        agencyCode: "DHS",
                        amount: "$750,000",
                        deadline: "12/20/2024",
                        matchScore: 88,
                        description: "Small business innovation research for advanced cybersecurity technologies protecting critical infrastructure.",
                        eligibility: "Small businesses with cybersecurity expertise",
                        number: "DHS-SBIR-24-01"
                    }
                ],
                'ai': [
                    {
                        title: "NSF CAREER - Advanced AI Research",
                        agency: "U.S. National Science Foundation",
                        agencyCode: "NSF",
                        amount: "$500,000",
                        deadline: "11/15/2024",
                        matchScore: 94,
                        description: "Early-career faculty development program for breakthrough artificial intelligence and machine learning research.",
                        eligibility: "Academic institutions with AI research programs",
                        number: "NSF-CAREER-AI-24"
                    },
                    {
                        title: "DARPA - Artificial Intelligence Exploration",
                        agency: "Defense Advanced Research Projects Agency",
                        agencyCode: "DARPA",
                        amount: "$1,500,000",
                        deadline: "01/30/2025",
                        matchScore: 91,
                        description: "High-risk, high-reward AI research exploring novel approaches to artificial general intelligence.",
                        eligibility: "Defense contractors and research institutions",
                        number: "HR001125A0001"
                    }
                ],
                'quantum': [
                    {
                        title: "DOE Quantum Information Science Research",
                        agency: "Department of Energy",
                        agencyCode: "DOE",
                        amount: "$2,000,000",
                        deadline: "03/15/2025",
                        matchScore: 96,
                        description: "Quantum computing and quantum information science research for next-generation computing systems.",
                        eligibility: "National laboratories and research universities",
                        number: "DE-FOA-QIS-25"
                    }
                ],
                'infrastructure': [
                    {
                        title: "Infrastructure Resilience and Sustainability Program",
                        agency: "Environmental Protection Agency",
                        agencyCode: "EPA",
                        amount: "$1,000,000",
                        deadline: "10/06/2025",
                        matchScore: 85,
                        description: "Large-scale infrastructure modernization program focusing on resilience and environmental sustainability.",
                        eligibility: "State and local governments, water utilities",
                        number: "EPA-OW-OGWDW-25-01"
                    }
                ],
                'energy': [
                    {
                        title: "Advanced Research Projects Agency Energy SBIR/STTR",
                        agency: "Advanced Research Projects Agency Energy",
                        agencyCode: "DOE-ARPAE",
                        amount: "$1,500,000",
                        deadline: "09/25/2025",
                        matchScore: 89,
                        description: "Revolutionary energy technology development through small business innovation research programs.",
                        eligibility: "Small businesses and research institutions",
                        number: "DE-FOA-0003593"
                    }
                ]
            };

            // Find matching grants based on query
            let results = [];
            const queryLower = query.toLowerCase();
            
            // Direct keyword matches
            Object.keys(realGrantDatabase).forEach(keyword => {
                if (queryLower.includes(keyword)) {
                    results = results.concat(realGrantDatabase[keyword]);
                }
            });

            // If no direct matches, search across all grants
            if (results.length === 0) {
                Object.values(realGrantDatabase).forEach(categoryGrants => {
                    categoryGrants.forEach(grant => {
                        if (grant.title.toLowerCase().includes(queryLower) || 
                            grant.description.toLowerCase().includes(queryLower)) {
                            results.push(grant);
                        }
                    });
                });
            }

            // Add some general grants if still no results
            if (results.length === 0) {
                results = [
                    {
                        title: "Microsystems Technology Office Research",
                        agency: "DARPA - Microsystems Technology Office",
                        agencyCode: "DOD-DARPA-MTO",
                        amount: "$800,000",
                        deadline: "12/01/2025",
                        matchScore: 75,
                        description: `Research opportunity in ${query} with applications to advanced technology development and innovation.`,
                        eligibility: "Research institutions and technology companies",
                        number: "HR001124S0028"
                    },
                    {
                        title: "Small Business Innovation Research Program",
                        agency: "U.S. National Science Foundation",
                        agencyCode: "NSF",
                        amount: "$400,000",
                        deadline: "02/15/2025",
                        matchScore: 70,
                        description: `Innovation research program supporting ${query} technology development for small businesses.`,
                        eligibility: "Small businesses with relevant expertise",
                        number: "NSF-SBIR-25"
                    }
                ];
            }

            return results.slice(0, 10); // Limit to 10 results
        }

        // Quick search function
        function quickSearch(tech) {
            document.getElementById('grant-search-input').value = tech;
            searchGrants();
        }

        // Generate mock grant results based on search query
        function generateMockGrantResults(query) {
            const baseGrants = [
                {
                    title: "SBIR Phase I - Quantum Computing Infrastructure",
                    agency: "Department of Energy",
                    amount: "$275,000",
                    deadline: "2024-12-31",
                    matchScore: 95,
                    description: "Development of quantum computing solutions for energy grid optimization and security applications.",
                    eligibility: "Small business with quantum research capabilities"
                },
                {
                    title: "NSF CAREER - Advanced AI Research",
                    agency: "National Science Foundation",
                    amount: "$500,000",
                    deadline: "2024-11-15",
                    matchScore: 88,
                    description: "Research grant for early-career faculty developing breakthrough AI technologies.",
                    eligibility: "Academic institutions with AI research programs"
                },
                {
                    title: "NIH R01 - Medical Device Innovation",
                    agency: "National Institutes of Health",
                    amount: "$1,200,000",
                    deadline: "2025-02-28",
                    matchScore: 82,
                    description: "Development of innovative medical devices using cutting-edge technology.",
                    eligibility: "Research institutions and medical device companies"
                },
                {
                    title: "DHS SBIR - Cybersecurity Solutions",
                    agency: "Department of Homeland Security",
                    amount: "$750,000",
                    deadline: "2024-12-20",
                    matchScore: 90,
                    description: "Advanced cybersecurity technologies for critical infrastructure protection.",
                    eligibility: "Small businesses with cybersecurity expertise"
                }
            ];

            // Filter and sort based on query relevance
            return baseGrants.filter(grant => 
                grant.title.toLowerCase().includes(query.toLowerCase()) ||
                grant.description.toLowerCase().includes(query.toLowerCase())
            ).sort((a, b) => b.matchScore - a.matchScore);
        }

        // Display grant search results
        function displayGrantResults(results) {
            const container = document.getElementById('grantSearchResults');
            
            if (results.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-search text-4xl text-white/30 mb-4"></i>
                        <p class="text-white/60">No grants found matching your search criteria.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = results.map(grant => `
                <div class="glass rounded-xl p-6 hover:bg-white/10 transition-all duration-300 border border-white/10">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <h4 class="font-bold text-lg text-white mb-2">${grant.title}</h4>
                            <div class="flex items-center space-x-4 text-sm text-white/70 mb-3">
                                <span><i class="fas fa-building mr-1"></i>${grant.agency}</span>
                                <span><i class="fas fa-dollar-sign mr-1"></i>${grant.amount}</span>
                                <span><i class="fas fa-calendar mr-1"></i>${grant.deadline}</span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="px-3 py-1 bg-gradient-to-r from-green-500/20 to-blue-500/20 rounded-full text-xs text-green-300">
                                ${grant.matchScore}% Match
                            </div>
                        </div>
                    </div>
                    <p class="text-white/80 text-sm mb-4">${grant.description}</p>
                    <div class="flex justify-between items-center">
                        <div class="text-xs text-white/60">
                            <i class="fas fa-check-circle mr-1"></i>
                            ${grant.eligibility}
                        </div>
                        <div class="space-x-2">
                            <button onclick="viewGrantDetails('${grant.title}')" class="px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg text-white text-sm hover:from-blue-600 hover:to-purple-700 transition-all">
                                View Details
                            </button>
                            <button onclick="addToWorkflow('${grant.title}')" class="px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-600 rounded-lg text-white text-sm hover:from-purple-600 hover:to-pink-700 transition-all">
                                Add to Workflow
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Show AI insights based on search
        // Enhanced AI Grant Insights with RAG Intelligence
        function showAIGrantInsights(query, results, totalHits) {
            const container = document.getElementById('aiInsights');
            
            if (!results || results.length === 0) {
                container.innerHTML = `
                    <div class="flex items-center space-x-3 p-3 bg-white/5 rounded-lg">
                        <div class="w-2 h-2 bg-red-400 rounded-full animate-pulse"></div>
                        <span class="text-white/90 text-sm">🔍 No matching grants found for "${query}". Try different keywords.</span>
                    </div>
                `;
                return;
            }

            // Calculate sophisticated metrics
            const avgMatchScore = Math.round(results.reduce((sum, r) => sum + r.matchScore, 0) / results.length);
            const topAgencies = [...new Set(results.slice(0, 5).map(r => r.agencyCode))].join(', ');
            
            // Calculate total funding potential
            let totalFunding = 0;
            results.forEach(grant => {
                const amount = grant.amount.replace(/[$,]/g, '');
                const numAmount = parseInt(amount) || 0;
                totalFunding += numAmount;
            });

            // Find upcoming deadlines
            const upcomingDeadlines = results.filter(g => {
                if (g.deadline === 'Open-ended') return false;
                const deadline = new Date(g.deadline);
                const thirtyDaysFromNow = new Date(Date.now() + 30*24*60*60*1000);
                return deadline < thirtyDaysFromNow && deadline > new Date();
            });

            // Generate intelligent insights based on query and results
            const insights = generateRAGInsights(query, results, totalHits, avgMatchScore, topAgencies, totalFunding, upcomingDeadlines);

            container.innerHTML = insights.map(insight => `
                <div class="flex items-center space-x-3 p-3 bg-white/5 rounded-lg hover:bg-white/10 transition-all">
                    <div class="w-2 h-2 ${insight.color} rounded-full animate-pulse"></div>
                    <span class="text-white/90 text-sm">${insight.text}</span>
                </div>
            `).join('');
        }

        // Generate RAG-powered insights
        function generateRAGInsights(query, results, totalHits, avgMatchScore, topAgencies, totalFunding, upcomingDeadlines) {
            const insights = [];

            // Search results overview
            const hitText = totalHits ? `${totalHits} total grants` : `${results.length} grants`;
            insights.push({
                text: `🎯 Found ${hitText} matching "${query}" with ${avgMatchScore}% average compatibility`,
                color: 'bg-blue-400'
            });

            // Best match insight
            if (results[0]) {
                insights.push({
                    text: `💡 Top recommendation: ${results[0].title} (${results[0].matchScore}% match) from ${results[0].agency}`,
                    color: 'bg-green-400'
                });
            }

            // Funding potential
            if (totalFunding > 0) {
                insights.push({
                    text: `💰 Combined funding potential: $${totalFunding.toLocaleString()} across displayed opportunities`,
                    color: 'bg-purple-400'
                });
            }

            // Agency diversity
            if (topAgencies) {
                insights.push({
                    text: `🏛️ Key funding agencies: ${topAgencies}`,
                    color: 'bg-indigo-400'
                });
            }

            // Deadline urgency
            if (upcomingDeadlines.length > 0) {
                const nextDeadline = upcomingDeadlines.sort((a, b) => new Date(a.deadline) - new Date(b.deadline))[0];
                insights.push({
                    text: `⏰ Urgent: ${upcomingDeadlines.length} applications due within 30 days (next: ${nextDeadline.deadline})`,
                    color: 'bg-red-400'
                });
            } else {
                insights.push({
                    text: `📅 Good news: No immediate deadlines, allowing time for thorough application preparation`,
                    color: 'bg-cyan-400'
                });
            }

            // Technology-specific insights
            const techInsight = generateTechnologyInsights(query, results);
            if (techInsight) {
                insights.push({
                    text: techInsight,
                    color: 'bg-yellow-400'
                });
            }

            return insights;
        }

        // Generate technology-specific RAG insights
        function generateTechnologyInsights(query, results) {
            const queryLower = query.toLowerCase();
            
            if (queryLower.includes('cyber') || queryLower.includes('security')) {
                const securityGrants = results.filter(g => g.title.toLowerCase().includes('security') || g.title.toLowerCase().includes('cyber'));
                return `🔐 Cybersecurity focus: ${securityGrants.length} specialized security grants available`;
            }
            
            if (queryLower.includes('ai') || queryLower.includes('artificial') || queryLower.includes('machine learning')) {
                const aiGrants = results.filter(g => g.title.toLowerCase().includes('ai') || g.title.toLowerCase().includes('intelligence'));
                return `🤖 AI/ML opportunities: ${aiGrants.length} grants supporting artificial intelligence research`;
            }
            
            if (queryLower.includes('quantum')) {
                const quantumGrants = results.filter(g => g.title.toLowerCase().includes('quantum'));
                return `⚛️ Quantum computing: ${quantumGrants.length} cutting-edge quantum technology grants`;
            }
            
            if (queryLower.includes('climate') || queryLower.includes('environmental')) {
                const climateGrants = results.filter(g => g.title.toLowerCase().includes('climate') || g.title.toLowerCase().includes('environment'));
                return `🌱 Climate focus: ${climateGrants.length} grants targeting environmental solutions`;
            }
            
            return null;
        }

        // View grant details (placeholder)
        function viewGrantDetails(grantTitle) {
            alert(`Viewing details for: ${grantTitle}\n\nThis would open a detailed modal with full grant information, requirements, and application guidelines.`);
        }

        // Add grant to workflow
        function addToWorkflow(grantTitle) {
            const newGrant = {
                id: activeGrants.length + 1,
                title: grantTitle,
                agency: "Federal Agency",
                amount: "$500,000",
                deadline: "2025-03-15",
                status: "Research Phase",
                progress: 10,
                lastUpdate: new Date().toISOString().split('T')[0]
            };
            
            activeGrants.unshift(newGrant);
            updateGrantPipeline();
            
            // Show success message
            alert(`✅ "${grantTitle}" has been added to your grant workflow!`);
        }

        // Update grant pipeline display
        function updateGrantPipeline() {
            const container = document.getElementById('grantPipeline');
            container.innerHTML = activeGrants.map(grant => `
                <div class="grant-card glass rounded-xl p-4 border border-white/10 hover:bg-white/10 transition-all">
                    <div class="flex justify-between items-start mb-3">
                        <h4 class="font-semibold text-white text-sm">${grant.title}</h4>
                        <span class="text-xs px-2 py-1 rounded-full ${getStatusColor(grant.status)} text-white/90">
                            ${grant.status}
                        </span>
                    </div>
                    <div class="space-y-2 text-xs text-white/70">
                        <div class="flex justify-between">
                            <span>${grant.agency}</span>
                            <span>${grant.amount}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Deadline: ${grant.deadline}</span>
                            <span>Updated: ${grant.lastUpdate}</span>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs text-white/60">Progress</span>
                            <span class="text-xs text-white/80">${grant.progress}%</span>
                        </div>
                        <div class="w-full bg-white/10 rounded-full h-2">
                            <div class="bg-gradient-to-r from-blue-500 to-purple-600 h-2 rounded-full transition-all duration-500" style="width: ${grant.progress}%"></div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Get status color for grant cards
        function getStatusColor(status) {
            const colors = {
                'Research Phase': 'bg-yellow-500/20',
                'Draft in Progress': 'bg-orange-500/20',
                'Application Submitted': 'bg-blue-500/20',
                'Under Review': 'bg-purple-500/20',
                'Approved': 'bg-green-500/20',
                'Rejected': 'bg-red-500/20'
            };
            return colors[status] || 'bg-gray-500/20';
        }

        // Show add grant modal (placeholder)
        function showAddGrantModal() {
            alert('Add New Grant Modal\n\nThis would open a modal allowing users to manually add grants to their workflow with custom details and tracking.');
        }

        // Initialize grant management when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Update grant pipeline on page load
            if (document.getElementById('grantPipeline')) {
                updateGrantPipeline();
            }
            
            // Add Enter key support for search
            const searchInput = document.getElementById('grant-search-input');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchGrants();
                    }
                });
            }
        });

        // Analytics Dashboard Functions
        let analyticsData = {
            activities: [],
            currentTimeRange: '7d',
            lastUpdate: Date.now()
        };

        // Initialize Analytics Dashboard
        function initializeAnalytics() {
            generateActivityFeed();
            startRealTimeUpdates();
            populateSystemMetrics();

            // Initialize Predictive Analytics Dashboard
            if (document.getElementById('forecastChart')) {
                console.log('Analytics tab clicked, initializing predictive analytics...');
                initializePredictiveAnalytics();
            }
        }

        // Update Analytics based on time range
        function updateAnalytics() {
            const timeRange = document.getElementById('analyticsTimeRange').value;
            analyticsData.currentTimeRange = timeRange;
            
            // Update KPIs based on time range
            updateKPIs(timeRange);
            
            // Update charts
            updatePerformanceChart(timeRange);
            
            // Refresh activity feed
            generateActivityFeed();
        }

        // Update Key Performance Indicators
        function updateKPIs(timeRange) {
            const ranges = {
                '24h': { workflows: 847, processing: '0.8s', success: '99.2%', users: 439 },
                '7d': { workflows: 2847, processing: '1.2s', success: '98.7%', users: 1439 },
                '30d': { workflows: 12847, processing: '1.5s', success: '98.3%', users: 4839 },
                '90d': { workflows: 38247, processing: '1.8s', success: '97.9%', users: 12439 }
            };
            
            const data = ranges[timeRange];
            document.getElementById('totalWorkflows').textContent = data.workflows.toLocaleString();
            document.getElementById('avgProcessingTime').textContent = data.processing;
            document.getElementById('successRate').textContent = data.success;
            document.getElementById('activeUsers').textContent = data.users.toLocaleString();
        }

        // Update Performance Chart
        function updatePerformanceChart(timeRange) {
            // Simulate chart update with animation
            const bars = document.querySelectorAll('#performanceChart .animate-pulse');
            bars.forEach((bar, index) => {
                setTimeout(() => {
                    const newHeight = Math.random() * 60 + 30;
                    bar.style.height = newHeight + '%';
                }, index * 100);
            });
        }

        // Generate Real-time Activity Feed
        function generateActivityFeed() {
            const activities = [
                { type: 'workflow', action: 'deployed', item: 'Emergency Response Workflow', time: '2 minutes ago', status: 'success' },
                { type: 'grant', action: 'discovered', item: 'NSF CAREER Grant - AI Research', time: '5 minutes ago', status: 'info' },
                { type: 'security', action: 'detected', item: 'Potential threat blocked', time: '8 minutes ago', status: 'warning' },
                { type: 'user', action: 'logged in', item: 'Admin user from City Hall', time: '12 minutes ago', status: 'info' },
                { type: 'workflow', action: 'completed', item: 'Building Permit Process', time: '15 minutes ago', status: 'success' },
                { type: 'grant', action: 'applied', item: 'DHS Cybersecurity Innovation', time: '18 minutes ago', status: 'success' },
                { type: 'security', action: 'updated', item: 'Firewall rules modified', time: '22 minutes ago', status: 'info' },
                { type: 'compliance', action: 'verified', item: 'GDPR compliance check', time: '25 minutes ago', status: 'success' },
                { type: 'user', action: 'requested', item: 'New citizen service inquiry', time: '28 minutes ago', status: 'info' },
                { type: 'workflow', action: 'optimized', item: 'Tax Processing Pipeline', time: '32 minutes ago', status: 'success' }
            ];

            const container = document.getElementById('activityFeed');
            if (!container) return;

            container.innerHTML = activities.slice(0, 8).map(activity => {
                const icons = {
                    workflow: 'fa-project-diagram',
                    grant: 'fa-dollar-sign',
                    security: 'fa-shield-alt',
                    user: 'fa-user',
                    compliance: 'fa-check-circle'
                };

                const colors = {
                    success: 'text-green-400',
                    warning: 'text-yellow-400',
                    info: 'text-blue-400',
                    error: 'text-red-400'
                };

                return `
                    <div class="flex items-center space-x-3 p-3 bg-white/5 rounded-lg hover:bg-white/10 transition-all duration-200">
                        <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg flex items-center justify-center flex-shrink-0">
                            <i class="fas ${icons[activity.type]} text-white text-sm"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-white/90 text-sm">
                                <span class="font-medium">${activity.item}</span>
                                <span class="text-white/70">was ${activity.action}</span>
                            </p>
                            <p class="text-white/50 text-xs">${activity.time}</p>
                        </div>
                        <div class="flex-shrink-0">
                            <div class="w-2 h-2 ${colors[activity.status]} rounded-full animate-pulse"></div>
                        </div>
                    </div>
                `;
            }).join('');

            analyticsData.activities = activities;
        }

        // Load More Activity (pagination simulation)
        function loadMoreActivity() {
            const moreActivities = [
                { type: 'workflow', action: 'created', item: 'Public Records Request Process', time: '35 minutes ago', status: 'info' },
                { type: 'grant', action: 'reviewed', item: 'EPA Environmental Grant', time: '38 minutes ago', status: 'warning' },
                { type: 'security', action: 'scanned', item: 'Daily vulnerability scan', time: '42 minutes ago', status: 'success' },
                { type: 'user', action: 'updated', item: 'Department profile changes', time: '45 minutes ago', status: 'info' }
            ];

            const container = document.getElementById('activityFeed');
            const currentActivities = analyticsData.activities;
            analyticsData.activities = [...currentActivities, ...moreActivities];
            
            // Re-render with more items
            generateActivityFeed();
        }

        // Refresh Usage Data
        function refreshUsageData() {
            // Simulate data refresh with random variations
            const usageElements = document.querySelectorAll('[style*="width:"]');
            usageElements.forEach(element => {
                setTimeout(() => {
                    const currentWidth = parseInt(element.style.width);
                    const variation = (Math.random() - 0.5) * 10; // ±5% variation
                    const newWidth = Math.max(20, Math.min(95, currentWidth + variation));
                    element.style.width = newWidth + '%';
                }, Math.random() * 1000);
            });

            // Show feedback
            const button = event.target;
            const originalIcon = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner animate-spin"></i>';
            
            setTimeout(() => {
                button.innerHTML = originalIcon;
            }, 1000);
        }

        // Populate System Metrics
        function populateSystemMetrics() {
            // Simulate real-time system metrics
            const metrics = {
                cpu: Math.floor(Math.random() * 40) + 20,
                memory: Math.floor(Math.random() * 30) + 50,
                database: Math.floor(Math.random() * 25) + 25,
                network: Math.floor(Math.random() * 20) + 70
            };

            document.getElementById('cpuUsage').textContent = metrics.cpu + '%';
            document.getElementById('memoryUsage').textContent = metrics.memory + '%';
            document.getElementById('databaseLoad').textContent = metrics.database + '%';
            document.getElementById('networkIO').textContent = metrics.network + '%';

            // Update progress bars
            document.querySelector('[style*="width: 23%"]').style.width = metrics.cpu + '%';
            document.querySelector('[style*="width: 67%"]').style.width = metrics.memory + '%';
            document.querySelector('[style*="width: 34%"]').style.width = metrics.database + '%';
            document.querySelector('[style*="width: 89%"]').style.width = metrics.network + '%';
        }

        // Start Real-time Updates
        function startRealTimeUpdates() {
            // Update system metrics every 5 seconds
            setInterval(() => {
                populateSystemMetrics();
            }, 5000);

            // Add new activity every 30 seconds
            setInterval(() => {
                addRandomActivity();
            }, 30000);

            // Update timestamps every minute
            setInterval(() => {
                updateActivityTimestamps();
            }, 60000);
        }

        // Add Random Activity
        function addRandomActivity() {
            const randomActivities = [
                { type: 'workflow', action: 'executed', item: 'Automated Data Backup', time: 'Just now', status: 'success' },
                { type: 'grant', action: 'matched', item: 'DOE Energy Innovation Grant', time: 'Just now', status: 'info' },
                { type: 'security', action: 'monitored', item: 'Network traffic analysis', time: 'Just now', status: 'info' },
                { type: 'user', action: 'accessed', item: 'Citizen portal dashboard', time: 'Just now', status: 'info' },
                { type: 'compliance', action: 'audited', item: 'Data retention policies', time: 'Just now', status: 'success' }
            ];

            const newActivity = randomActivities[Math.floor(Math.random() * randomActivities.length)];
            analyticsData.activities.unshift(newActivity);
            
            // Re-generate feed with new activity
            generateActivityFeed();
        }

        // Update Activity Timestamps
        function updateActivityTimestamps() {
            analyticsData.activities = analyticsData.activities.map(activity => {
                let timeText = activity.time;
                if (timeText.includes('minutes ago')) {
                    const minutes = parseInt(timeText) + 1;
                    timeText = minutes + ' minutes ago';
                } else if (timeText === 'Just now') {
                    timeText = '1 minute ago';
                }
                return { ...activity, time: timeText };
            });
            
            generateActivityFeed();
        }

        // Toggle Chart View
        function toggleChart(chartType) {
            const chart = document.getElementById(chartType + 'Chart');
            if (chart.classList.contains('h-80')) {
                chart.classList.remove('h-80');
                chart.classList.add('h-96');
            } else {
                chart.classList.remove('h-96');
                chart.classList.add('h-80');
            }
        }

        // Customize Analytics (placeholder)
        function customizeAnalytics() {
            alert('Analytics Customization\n\nThis would open a modal allowing users to:\n• Choose which metrics to display\n• Set custom alert thresholds\n• Configure refresh intervals\n• Export data in various formats\n• Create custom dashboards');
        }

        // Add Custom Scrollbar Styles
        const customScrollbarCSS = `
            <style>
                .custom-scrollbar::-webkit-scrollbar {
                    width: 4px;
                }
                .custom-scrollbar::-webkit-scrollbar-track {
                    background: rgba(255, 255, 255, 0.1);
                    border-radius: 2px;
                }
                .custom-scrollbar::-webkit-scrollbar-thumb {
                    background: rgba(255, 255, 255, 0.3);
                    border-radius: 2px;
                }
                .custom-scrollbar::-webkit-scrollbar-thumb:hover {
                    background: rgba(255, 255, 255, 0.5);
                }
            </style>
        `;
        document.head.insertAdjacentHTML('beforeend', customScrollbarCSS);

        // Initialize analytics when analytics tab is shown
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize analytics if the elements exist
            if (document.getElementById('activityFeed')) {
                initializeAnalytics();
            }
            // Initialize CRM if the elements exist
            if (document.getElementById('contactsTableBody')) {
                initializeCRM();
            }
        });

        // CRM Functions

        function initializeCRM() {
            populateContactsTable();
            setupContactSearch();
            updateCRMAnalytics();
        }

        function populateContactsTable(contacts = crmContacts) {
            const tableBody = document.getElementById('contactsTableBody');
            if (!tableBody) return;

            tableBody.innerHTML = '';
            contacts.forEach(contact => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-white/5 transition-all duration-200 border-b border-white/5';
                
                const statusClass = contact.status === 'active' ? 'text-emerald-400' : 'text-gray-400';
                const typeConfig = {
                    'citizen': { color: 'text-blue-400', bg: 'bg-blue-500/20', border: 'border-blue-400/30', icon: 'fas fa-user' },
                    'official': { color: 'text-purple-400', bg: 'bg-purple-500/20', border: 'border-purple-400/30', icon: 'fas fa-user-tie' },
                    'vendor': { color: 'text-emerald-400', bg: 'bg-emerald-500/20', border: 'border-emerald-400/30', icon: 'fas fa-building' },
                    'contractor': { color: 'text-orange-400', bg: 'bg-orange-500/20', border: 'border-orange-400/30', icon: 'fas fa-hard-hat' }
                };
                
                const typeInfo = typeConfig[contact.type] || { color: 'text-white', bg: 'bg-gray-500/20', border: 'border-gray-400/30', icon: 'fas fa-user' };
                
                // Calculate engagement score (simulated)
                const engagementScore = Math.floor(Math.random() * 40) + 60;
                const engagementColor = engagementScore > 85 ? 'text-emerald-400' : engagementScore > 70 ? 'text-yellow-400' : 'text-orange-400';

                row.innerHTML = `
                    <td class="py-4 px-6">
                        <div class="flex items-center space-x-4">
                            <input type="checkbox" class="rounded border-white/30 bg-white/10">
                            <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-500 rounded-xl flex items-center justify-center">
                                <span class="text-white font-semibold">${contact.name[0]}</span>
                            </div>
                            <div class="flex-1">
                                <div class="text-white font-semibold">${contact.name}</div>
                                <div class="text-white/60 text-sm">${contact.email}</div>
                                <div class="text-white/40 text-xs">${contact.phone}</div>
                            </div>
                        </div>
                    </td>
                    <td class="py-4 px-6">
                        <div class="flex items-center space-x-2">
                            <div class="${typeInfo.bg} ${typeInfo.border} border rounded-lg px-3 py-1.5 flex items-center space-x-2">
                                <i class="${typeInfo.icon} ${typeInfo.color} text-xs"></i>
                                <span class="${typeInfo.color} font-medium text-sm capitalize">${contact.type}</span>
                            </div>
                        </div>
                    </td>
                    <td class="py-4 px-6">
                        <div class="text-white/80 font-medium">${contact.department}</div>
                        <div class="text-white/50 text-sm">${contact.address}</div>
                    </td>
                    <td class="py-4 px-6">
                        <div class="text-white/80">${contact.lastContact}</div>
                        <div class="flex items-center space-x-2 mt-1">
                            <div class="w-2 h-2 ${engagementColor.replace('text-', 'bg-')} rounded-full"></div>
                            <span class="${engagementColor} text-sm font-medium">${engagementScore}% engaged</span>
                        </div>
                    </td>
                    <td class="py-4 px-6">
                        <div class="flex items-center space-x-2">
                            <div class="w-2 h-2 ${statusClass.replace('text-', 'bg-')} rounded-full animate-pulse"></div>
                            <span class="${statusClass} font-medium capitalize">${contact.status}</span>
                        </div>
                    </td>
                    <td class="py-4 px-6">
                        <div class="flex items-center space-x-2">
                            <button onclick="viewContact(${contact.id})" class="p-2 bg-blue-600/20 hover:bg-blue-600/40 text-blue-300 rounded-lg transition-all duration-200 border border-blue-500/30">
                                <i class="fas fa-eye text-xs"></i>
                            </button>
                            <button onclick="editContact(${contact.id})" class="p-2 bg-emerald-600/20 hover:bg-emerald-600/40 text-emerald-300 rounded-lg transition-all duration-200 border border-emerald-500/30">
                                <i class="fas fa-edit text-xs"></i>
                            </button>
                            <button onclick="scheduleFollowUp(${contact.id})" class="p-2 bg-purple-600/20 hover:bg-purple-600/40 text-purple-300 rounded-lg transition-all duration-200 border border-purple-500/30">
                                <i class="fas fa-calendar text-xs"></i>
                            </button>
                            <button onclick="deleteContact(${contact.id})" class="p-2 bg-red-600/20 hover:bg-red-600/40 text-red-300 rounded-lg transition-all duration-200 border border-red-500/30">
                                <i class="fas fa-trash text-xs"></i>
                            </button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function setupContactSearch() {
            const searchInput = document.getElementById('contactSearch');
            const filterSelect = document.getElementById('contactFilter');

            if (searchInput) {
                searchInput.addEventListener('input', filterContacts);
            }
            if (filterSelect) {
                filterSelect.addEventListener('change', filterContacts);
            }
        }

        function filterContacts() {
            const searchTerm = document.getElementById('contactSearch')?.value.toLowerCase() || '';
            const filterType = document.getElementById('contactFilter')?.value || 'all';

            let filteredContacts = crmContacts.filter(contact => {
                const matchesSearch = contact.name.toLowerCase().includes(searchTerm) ||
                                    contact.email.toLowerCase().includes(searchTerm) ||
                                    contact.department.toLowerCase().includes(searchTerm);
                const matchesFilter = filterType === 'all' || contact.type === filterType;
                return matchesSearch && matchesFilter;
            });

            populateContactsTable(filteredContacts);
        }

        function updateCRMAnalytics() {
            // Update real-time contact analytics
            const totalContacts = crmContacts.length;
            const activeContacts = crmContacts.filter(c => c.status === 'active').length;
            const recentContacts = crmContacts.filter(c => {
                const contactDate = new Date(c.lastContact);
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                return contactDate >= weekAgo;
            }).length;

            // These would update the analytics display if the elements exist
            console.log(`CRM Analytics: ${totalContacts} total, ${activeContacts} active, ${recentContacts} recent`);
        }

        function processCrmAiQuery() {
            const input = document.getElementById('crmAiInput');
            if (!input) return;

            const query = input.value.trim();
            if (!query) return;

            // Simulate AI processing
            setTimeout(() => {
                const responses = [
                    "I found 3 contacts matching your query. Sarah Johnson has the most recent activity.",
                    "Based on contact patterns, I recommend following up with TechCorp Solutions this week.",
                    "Detective Chen has been flagged for a compliance review due to recent case activities.",
                    "I've identified 5 contacts that may need CJIS recertification this quarter.",
                    "Contact analytics show 78% engagement rate with recent outreach campaigns."
                ];
                
                const response = responses[Math.floor(Math.random() * responses.length)];
                
                // Create AI response element
                const responseDiv = document.createElement('div');
                responseDiv.className = 'mt-3 p-3 bg-purple-500/20 rounded-lg border border-purple-400/30';
                responseDiv.innerHTML = `
                    <div class="flex items-start space-x-2">
                        <i class="fas fa-robot text-purple-400 mt-1"></i>
                        <div class="text-purple-200 text-sm">${response}</div>
                    </div>
                `;
                
                // Add response after the input
                const container = input.closest('.bg-black\\/30') || input.closest('[class*="bg-black/30"]');
                if (container) {
                    // Remove any existing response
                    const existingResponse = container.querySelector('.bg-purple-500\\/20') || container.querySelector('[class*="bg-purple-500/20"]');
                    if (existingResponse) {
                        existingResponse.remove();
                    }
                    container.appendChild(responseDiv);
                    
                    // Auto-remove after 5 seconds
                    setTimeout(() => {
                        responseDiv.remove();
                    }, 5000);
                }
                
                input.value = '';
            }, 1000);
        }

        function showNewContactModal() {
            alert('New Contact Modal - Coming Soon! This would open a secure CJIS-compliant contact creation form.');
        }

        function viewContact(contactId) {
            const contact = crmContacts.find(c => c.id === contactId);
            if (contact) {
                alert(`Contact Details:\\nName: ${contact.name}\\nEmail: ${contact.email}\\nPhone: ${contact.phone}\\nDepartment: ${contact.department}\\nNotes: ${contact.notes}`);
            }
        }

        function editContact(contactId) {
            alert(`Edit Contact ${contactId} - This would open a secure editing form with audit logging.`);
        }

        function deleteContact(contactId) {
            if (confirm('Are you sure you want to delete this contact? This action will be logged for compliance.')) {
                crmContacts = crmContacts.filter(c => c.id !== contactId);
                populateContactsTable();
                updateCRMAnalytics();
                alert('Contact deleted. Action logged for CJIS compliance.');
            }
        }

        function bulkImportContacts() {
            alert('Bulk Import - This would open a secure import interface with encryption validation and audit logging.');
        }

        function exportContacts() {
            alert('Export Contacts - This would generate an encrypted export with audit trail for compliance.');
        }

        function runComplianceAudit() {
            alert('Running CJIS Compliance Audit...\\n\\n✓ Data encryption verified\\n✓ Access controls validated\\n✓ Audit trails complete\\n✓ No violations found\\n\\nCompliance Score: 99.8%');
        }

        function generateReport() {
            alert('Generating CRM Report...\\n\\nReport will include:\\n• Contact analytics\\n• Engagement metrics\\n• Compliance status\\n• Security assessment\\n\\nReport will be encrypted and audit-logged.');
        }

        // New Enterprise CRM Functions
        function toggleContactView(viewType) {
            // Toggle between grid and list view
            const buttons = document.querySelectorAll('[onclick^="toggleContactView"]');
            buttons.forEach(btn => {
                btn.classList.remove('bg-blue-600');
                btn.classList.add('bg-white/10');
            });
            event.target.closest('button').classList.add('bg-blue-600');
            event.target.closest('button').classList.remove('bg-white/10');
            
            // TODO: Implement actual view switching logic
            console.log(`Switched to ${viewType} view`);
        }

        function scheduleFollowUp(contactId) {
            const contact = crmContacts.find(c => c.id === contactId);
            if (contact) {
                alert(`Schedule Follow-up for ${contact.name}\\n\\nThis would open an AI-powered scheduling interface with:\\n• Smart time suggestions\\n• Integration with calendar systems\\n• Automated reminder setup\\n• Compliance logging`);
            }
        }

        function exportComplianceReport() {
            alert('Exporting Compliance Report...\\n\\n🔒 Generating encrypted compliance report\\n📊 Including all audit trails\\n🛡️ CJIS & FedRAMP compliance verified\\n📄 Report will be available in secure download');
        }

        function processCrmAiQuery() {
            const input = document.getElementById('crmAiInput');
            if (!input) return;

            const query = input.value.trim();
            if (!query) return;

            // Enhanced AI responses for enterprise features
            setTimeout(() => {
                const responses = [
                    "🎯 Identified 12 high-value prospects from last month with 94% conversion probability",
                    "📅 Scheduled 8 follow-up meetings automatically based on engagement patterns",
                    "🔍 Found 3 compliance risks requiring immediate attention in vendor relationships", 
                    "📈 Predictive analytics show 23% increase in citizen engagement opportunity",
                    "🤖 AI recommends focusing on 5 key relationships for maximum ROI this quarter",
                    "🔐 Security scan complete: All contact data properly encrypted and audit-logged",
                    "💡 Smart insight: Contact Jennifer Martinez shows highest contractor performance metrics",
                    "⚡ Real-time sync complete: All enterprise systems updated with latest contact data"
                ];
                
                const response = responses[Math.floor(Math.random() * responses.length)];
                
                // Create enhanced AI response element
                const responseDiv = document.createElement('div');
                responseDiv.className = 'mt-4 p-4 bg-gradient-to-r from-purple-500/20 to-pink-500/20 rounded-xl border border-purple-400/30';
                responseDiv.innerHTML = `
                    <div class="flex items-start space-x-3">
                        <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-pink-500 rounded-lg flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-brain text-white text-sm"></i>
                        </div>
                        <div class="flex-1">
                            <div class="text-purple-200 font-medium text-sm mb-1">CRM AI Assistant</div>
                            <div class="text-white text-sm leading-relaxed">${response}</div>
                            <div class="flex items-center space-x-4 mt-3 text-xs text-purple-300">
                                <span>🕒 Processed in 0.3s</span>
                                <span>🔒 Secure</span>
                                <span>📊 Confidence: 96%</span>
                            </div>
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" class="text-purple-300 hover:text-white transition-colors">
                            <i class="fas fa-times text-xs"></i>
                        </button>
                    </div>
                `;
                
                // Add response after the input container
                const container = input.closest('.glass');
                if (container) {
                    // Remove any existing response
                    const existingResponse = container.querySelector('.bg-gradient-to-r.from-purple-500\\/20');
                    if (existingResponse) {
                        existingResponse.remove();
                    }
                    container.appendChild(responseDiv);
                }
                
                input.value = '';
            }, 800);
        }

        // Handle Escape key for modal
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // Added 2024-10-05: Drag and Drop Workflow Builder JavaScript
        // MOCK DATA - Replace in production
        // TODO: Connect to API endpoint /api/workflows

        const stepTypes = [
            // Input & Data Collection
            { id: 'form-input', name: 'Form Submission', icon: 'fa-file-alt', color: 'from-blue-400 to-cyan-500', category: 'input', description: 'Collect data via forms' },
            { id: 'document-upload', name: 'Document Upload', icon: 'fa-cloud-upload-alt', color: 'from-blue-500 to-blue-600', category: 'input', description: 'Upload required documents' },
            { id: 'data-entry', name: 'Manual Data Entry', icon: 'fa-keyboard', color: 'from-cyan-500 to-teal-500', category: 'input', description: 'Manual information input' },
            { id: 'api-input', name: 'API Data Fetch', icon: 'fa-plug', color: 'from-indigo-500 to-blue-500', category: 'input', description: 'Retrieve data from external API' },
            { id: 'validation', name: 'Data Validation', icon: 'fa-check-circle', color: 'from-green-400 to-emerald-500', category: 'validation', description: 'Validate data accuracy' },
            { id: 'compliance-check', name: 'Compliance Check', icon: 'fa-shield-alt', color: 'from-green-500 to-green-600', category: 'validation', description: 'Verify regulatory compliance' },
            { id: 'duplicate-check', name: 'Duplicate Detection', icon: 'fa-copy', color: 'from-teal-500 to-green-500', category: 'validation', description: 'Check for duplicates' },
            { id: 'background-check', name: 'Background Verification', icon: 'fa-user-shield', color: 'from-emerald-500 to-teal-600', category: 'validation', description: 'FBI/CJIS background check' },
            { id: 'auto-route', name: 'Auto-Route', icon: 'fa-route', color: 'from-purple-400 to-purple-500', category: 'routing', description: 'Automatically route by rules' },
            { id: 'assignment', name: 'Task Assignment', icon: 'fa-user-tag', color: 'from-purple-500 to-purple-600', category: 'routing', description: 'Assign to user or team' },
            { id: 'load-balance', name: 'Load Balancing', icon: 'fa-balance-scale', color: 'from-violet-500 to-purple-500', category: 'routing', description: 'Distribute workload evenly' },
            { id: 'single-approval', name: 'Single Approval', icon: 'fa-user-check', color: 'from-pink-400 to-rose-500', category: 'approval', description: 'One person approval' },
            { id: 'multi-approval', name: 'Multi-Level Approval', icon: 'fa-users-cog', color: 'from-pink-500 to-pink-600', category: 'approval', description: 'Sequential approvals' },
            { id: 'parallel-approval', name: 'Parallel Approval', icon: 'fa-project-diagram', color: 'from-rose-500 to-pink-600', category: 'approval', description: 'Simultaneous approvals' },
            { id: 'conditional-approval', name: 'Conditional Approval', icon: 'fa-filter', color: 'from-fuchsia-500 to-pink-500', category: 'approval', description: 'Approval based on criteria' },
            { id: 'if-then', name: 'If/Then Logic', icon: 'fa-code-branch', color: 'from-amber-400 to-orange-500', category: 'logic', description: 'Conditional branching' },
            { id: 'threshold-check', name: 'Threshold Check', icon: 'fa-chart-line', color: 'from-yellow-500 to-amber-600', category: 'logic', description: 'Compare against threshold' },
            { id: 'scoring', name: 'Risk Scoring', icon: 'fa-calculator', color: 'from-orange-500 to-red-500', category: 'logic', description: 'Calculate risk score' },
            { id: 'ai-decision', name: 'AI Decision', icon: 'fa-brain', color: 'from-indigo-400 to-purple-500', category: 'logic', description: 'AI-powered decision' },
            { id: 'email', name: 'Email Notification', icon: 'fa-envelope', color: 'from-sky-400 to-blue-500', category: 'notification', description: 'Send email alerts' },
            { id: 'sms', name: 'SMS Alert', icon: 'fa-mobile-alt', color: 'from-blue-500 to-indigo-500', category: 'notification', description: 'Send text message' },
            { id: 'push', name: 'Push Notification', icon: 'fa-bell', color: 'from-cyan-500 to-blue-600', category: 'notification', description: 'Mobile push notification' },
            { id: 'slack', name: 'Slack Message', icon: 'fa-slack', color: 'from-teal-500 to-cyan-500', category: 'notification', description: 'Post to Slack channel' },
            { id: 'timer', name: 'Wait Timer', icon: 'fa-hourglass-half', color: 'from-slate-400 to-gray-500', category: 'timing', description: 'Pause for specified time' },
            { id: 'deadline', name: 'Set Deadline', icon: 'fa-calendar-alt', color: 'from-gray-500 to-slate-600', category: 'timing', description: 'Define due date' },
            { id: 'escalation', name: 'Auto-Escalation', icon: 'fa-level-up-alt', color: 'from-orange-400 to-red-500', category: 'timing', description: 'Escalate if overdue' },
            { id: 'reminder', name: 'Reminder', icon: 'fa-clock', color: 'from-yellow-400 to-orange-500', category: 'timing', description: 'Send reminder alerts' },
            { id: 'database-write', name: 'Save to Database', icon: 'fa-database', color: 'from-emerald-400 to-green-500', category: 'data', description: 'Store in database' },
            { id: 'update-record', name: 'Update Record', icon: 'fa-edit', color: 'from-green-500 to-teal-500', category: 'data', description: 'Modify existing data' },
            { id: 'archive', name: 'Archive Data', icon: 'fa-archive', color: 'from-teal-500 to-cyan-600', category: 'data', description: 'Move to archive' },
            { id: 'export', name: 'Export Data', icon: 'fa-download', color: 'from-blue-500 to-indigo-500', category: 'data', description: 'Export to file' },
            { id: 'api-call', name: 'API Request', icon: 'fa-exchange-alt', color: 'from-violet-400 to-purple-500', category: 'integration', description: 'Call external API' },
            { id: 'webhook', name: 'Webhook Trigger', icon: 'fa-link', color: 'from-purple-500 to-fuchsia-500', category: 'integration', description: 'Trigger webhook event' },
            { id: 'ftp-upload', name: 'FTP Transfer', icon: 'fa-server', color: 'from-indigo-500 to-violet-500', category: 'integration', description: 'Transfer via FTP' },
            { id: 'fedram-sync', name: 'FedRAMP Sync', icon: 'fa-sync', color: 'from-blue-600 to-indigo-600', category: 'integration', description: 'Sync with FedRAMP system' },
            { id: 'generate-report', name: 'Generate Report', icon: 'fa-file-pdf', color: 'from-red-400 to-pink-500', category: 'completion', description: 'Create PDF report' },
            { id: 'audit-log', name: 'Audit Trail', icon: 'fa-history', color: 'from-slate-500 to-gray-600', category: 'completion', description: 'Log audit trail' },
            { id: 'completion', name: 'Mark Complete', icon: 'fa-flag-checkered', color: 'from-green-500 to-emerald-600', category: 'completion', description: 'Workflow completion' },
            { id: 'close-ticket', name: 'Close Ticket', icon: 'fa-check-double', color: 'from-teal-500 to-green-600', category: 'completion', description: 'Close and archive' }
        ];

        let currentWorkflow = [];
        let savedWorkflowsList = [];

        function initializeStepLibrary() {
            console.log('initializeStepLibrary called');
            const library = document.getElementById('stepLibrary');
            if (!library) {
                console.error('stepLibrary element not found!');
                return;
            }

            console.log('stepLibrary element found, initializing with', stepTypes.length, 'step types');

            const categories = {
                'input': { name: 'Input & Collection', icon: 'fa-inbox', color: 'from-blue-500 to-cyan-500' },
                'validation': { name: 'Validation & Compliance', icon: 'fa-check-circle', color: 'from-green-500 to-emerald-500' },
                'routing': { name: 'Routing & Assignment', icon: 'fa-route', color: 'from-purple-500 to-violet-500' },
                'approval': { name: 'Approvals & Reviews', icon: 'fa-user-check', color: 'from-pink-500 to-rose-500' },
                'logic': { name: 'Decision Logic', icon: 'fa-brain', color: 'from-amber-500 to-orange-500' },
                'notification': { name: 'Notifications', icon: 'fa-bell', color: 'from-sky-500 to-blue-500' },
                'timing': { name: 'Time-based Actions', icon: 'fa-clock', color: 'from-gray-500 to-slate-500' },
                'data': { name: 'Data Operations', icon: 'fa-database', color: 'from-teal-500 to-cyan-500' },
                'integration': { name: 'Integration & External', icon: 'fa-plug', color: 'from-violet-500 to-purple-500' },
                'completion': { name: 'Completion & Reports', icon: 'fa-flag-checkered', color: 'from-emerald-500 to-green-500' }
            };

            let html = '';
            Object.entries(categories).forEach(([catKey, catData]) => {
                const categorySteps = stepTypes.filter(s => s.category === catKey);
                if (categorySteps.length > 0) {
                    html += `<div class="mb-4"><div class="flex items-center gap-2 mb-2 px-2"><div class="w-6 h-6 rounded-lg bg-gradient-to-r ${catData.color} flex items-center justify-center flex-shrink-0"><i class="fas ${catData.icon} text-white text-xs"></i></div><h4 class="text-xs font-bold text-white/80 uppercase tracking-wide">${catData.name}</h4></div><div class="space-y-1">${categorySteps.map(step => `<div class="workflow-step glass rounded-lg p-2 flex items-center gap-2 group hover:bg-white/20 cursor-move" draggable="true" data-step-id="${step.id}" role="button" tabindex="0" aria-label="Drag ${step.name} step"><div class="w-8 h-8 rounded-lg bg-gradient-to-r ${step.color} flex items-center justify-center flex-shrink-0 shadow-lg"><i class="fas ${step.icon} text-white text-sm"></i></div><div class="flex-1 min-w-0"><div class="text-white font-medium text-sm truncate">${step.name}</div><div class="text-white/50 text-xs truncate">${step.description}</div></div><i class="fas fa-grip-vertical text-white/30 group-hover:text-white/60 transition-all"></i></div>`).join('')}</div></div>`;
                }
            });
            library.innerHTML = html;

            console.log('Step library HTML populated, found', document.querySelectorAll('.workflow-step').length, 'workflow steps');

            document.querySelectorAll('.workflow-step').forEach(step => {
                step.addEventListener('dragstart', (e) => { e.currentTarget.classList.add('dragging'); e.dataTransfer.effectAllowed = 'copy'; e.dataTransfer.setData('stepId', e.currentTarget.dataset.stepId); });
                step.addEventListener('dragend', (e) => e.currentTarget.classList.remove('dragging'));
                step.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); addStepToWorkflow(e.currentTarget.dataset.stepId); } });
            });

            const dropZone = document.getElementById('dropZone');
            if (dropZone) {
                dropZone.addEventListener('dragover', (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'copy'; dropZone.classList.add('drag-over'); });
                dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
                dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('drag-over'); const stepId = e.dataTransfer.getData('stepId'); if (stepId) addStepToWorkflow(stepId); });
            }

            const clearBtn = document.getElementById('clearBtn');
            const saveBtn = document.getElementById('saveBtn');
            const generateBtn = document.getElementById('generateBtn');
            const confirmSave = document.getElementById('confirmSave');
            const cancelSave = document.getElementById('cancelSave');

            if (clearBtn) clearBtn.addEventListener('click', () => { if (currentWorkflow.length === 0) return; if (confirm('Clear all steps?')) { currentWorkflow = []; renderWorkflow(); } });
            if (saveBtn) saveBtn.addEventListener('click', () => { if (currentWorkflow.length === 0) { showStatus('error', 'Add at least one step to save'); return; } document.getElementById('workflowName').value = ''; document.getElementById('saveModal').classList.remove('hidden'); delete document.getElementById('saveModal').dataset.editId; });
            if (confirmSave) confirmSave.addEventListener('click', () => { const workflowName = document.getElementById('workflowName').value.trim(); if (!workflowName) { showStatus('error', 'Please enter a workflow name'); return; } const modal = document.getElementById('saveModal'); const editId = modal.dataset.editId; if (editId) { const workflow = savedWorkflowsList.find(w => w.id == editId); if (workflow) { workflow.name = workflowName; workflow.steps = [...currentWorkflow]; workflow.updatedAt = new Date().toISOString(); showStatus('success', `Workflow "${workflowName}" updated!`); } } else { const workflow = { id: Date.now(), name: workflowName, steps: [...currentWorkflow], createdAt: new Date().toISOString() }; savedWorkflowsList.push(workflow); showStatus('success', `Workflow "${workflowName}" saved!`); } renderSavedWorkflows(); modal.classList.add('hidden'); });
            if (cancelSave) cancelSave.addEventListener('click', () => { document.getElementById('saveModal').classList.add('hidden'); delete document.getElementById('saveModal').dataset.editId; });
            if (generateBtn) generateBtn.addEventListener('click', () => { const input = document.getElementById('aiWorkflowInput').value.trim(); if (!input) { showStatus('error', 'Please describe your workflow'); return; } showStatus('loading', 'AI is generating your workflow...'); setTimeout(() => { const generatedSteps = parseWorkflowFromText(input); currentWorkflow = generatedSteps; renderWorkflow(); showStatus('success', `Generated ${generatedSteps.length} workflow steps!`); }, 1500); });
        }

        function addStepToWorkflow(stepId) {
            const stepType = stepTypes.find(s => s.id === stepId);
            if (!stepType) return;
            currentWorkflow.push({ id: Date.now(), typeId: stepId, name: stepType.name, icon: stepType.icon, color: stepType.color });
            renderWorkflow();
        }

        function renderWorkflow() {
            const container = document.getElementById('workflowStepsCanvas');
            const emptyState = document.getElementById('emptyState');
            if (!container || !emptyState) return;

            if (currentWorkflow.length === 0) { emptyState.classList.remove('hidden'); container.innerHTML = ''; return; }
            emptyState.classList.add('hidden');
            container.innerHTML = currentWorkflow.map((step, index) => `<div class="glass rounded-lg p-4 flex items-center gap-4" role="listitem"><div class="text-white/50 font-bold">${index + 1}</div><div class="w-10 h-10 rounded-lg bg-gradient-to-r ${step.color} flex items-center justify-center flex-shrink-0"><i class="fas ${step.icon} text-white"></i></div><div class="flex-1"><div class="text-white font-medium">${step.name}</div></div><button class="text-red-400 hover:text-red-300 transition-all p-2" onclick="removeStep(${step.id})" aria-label="Remove ${step.name} step"><i class="fas fa-times"></i></button></div>`).join('');
        }

        function removeStep(stepId) { currentWorkflow = currentWorkflow.filter(s => s.id !== stepId); renderWorkflow(); }

        function showStatus(type, message) {
            const statusDiv = document.getElementById('aiStatus');
            if (!statusDiv) return;
            statusDiv.classList.remove('hidden');
            const colors = { loading: 'bg-blue-500/20 text-blue-300 border-blue-500/30', success: 'bg-green-500/20 text-green-300 border-green-500/30', error: 'bg-red-500/20 text-red-300 border-red-500/30' };
            const icons = { loading: 'fa-spinner fa-spin', success: 'fa-check-circle', error: 'fa-exclamation-circle' };
            statusDiv.className = `mt-4 p-3 rounded-lg border ${colors[type]}`;
            statusDiv.innerHTML = `<i class="fas ${icons[type]} mr-2"></i>${message}`;
            if (type !== 'loading') setTimeout(() => statusDiv.classList.add('hidden'), 3000);
        }

        function renderSavedWorkflows() {
            const container = document.getElementById('savedWorkflows');
            if (!container) return;
            if (savedWorkflowsList.length === 0) { container.innerHTML = '<div class="text-white/50 text-sm text-center py-4">No saved workflows yet</div>'; return; }
            container.innerHTML = savedWorkflowsList.map(workflow => `<div class="saved-workflow-card w-full glass rounded-lg p-3 hover:bg-white/10 transition-all"><div class="flex items-center justify-between"><button class="flex-1 text-left" onclick="loadWorkflow(${workflow.id})" aria-label="Load ${workflow.name} workflow"><div class="text-white font-medium">${workflow.name}</div><div class="text-white/50 text-xs">${workflow.steps.length} steps</div></button><div class="flex gap-2 ml-3"><button class="action-btn p-2 rounded-lg bg-blue-500/20 hover:bg-blue-500/40 text-blue-300 transition-all" onclick="editWorkflow(${workflow.id})" aria-label="Edit workflow" title="Edit"><i class="fas fa-edit text-sm"></i></button><button class="action-btn p-2 rounded-lg bg-green-500/20 hover:bg-green-500/40 text-green-300 transition-all" onclick="duplicateWorkflow(${workflow.id})" aria-label="Duplicate workflow" title="Duplicate"><i class="fas fa-copy text-sm"></i></button><button class="action-btn p-2 rounded-lg bg-red-500/20 hover:bg-red-500/40 text-red-300 transition-all" onclick="deleteWorkflow(${workflow.id})" aria-label="Delete workflow" title="Delete"><i class="fas fa-trash text-sm"></i></button></div></div></div>`).join('');
        }

        function loadWorkflow(id) { const workflow = savedWorkflowsList.find(w => w.id === id); if (workflow) { currentWorkflow = [...workflow.steps]; renderWorkflow(); showStatus('success', `Loaded "${workflow.name}"`); } }
        function editWorkflow(id) { const workflow = savedWorkflowsList.find(w => w.id === id); if (workflow) { currentWorkflow = [...workflow.steps]; renderWorkflow(); document.getElementById('workflowName').value = workflow.name; document.getElementById('saveModal').classList.remove('hidden'); document.getElementById('saveModal').dataset.editId = id; showStatus('success', `Editing "${workflow.name}"`); } }
        function duplicateWorkflow(id) { const workflow = savedWorkflowsList.find(w => w.id === id); if (workflow) { const duplicatedWorkflow = { id: Date.now(), name: `${workflow.name} (Copy)`, steps: workflow.steps.map(step => ({ ...step, id: Date.now() + Math.random() })) }; savedWorkflowsList.push(duplicatedWorkflow); renderSavedWorkflows(); showStatus('success', `Duplicated "${workflow.name}"`); } }
        function deleteWorkflow(id) { const workflow = savedWorkflowsList.find(w => w.id === id); if (workflow) { if (confirm(`Delete workflow "${workflow.name}"? This cannot be undone.`)) { savedWorkflowsList = savedWorkflowsList.filter(w => w.id !== id); renderSavedWorkflows(); showStatus('success', `Deleted "${workflow.name}"`); } } }

        function parseWorkflowFromText(text) {
            const lower = text.toLowerCase(); const steps = [];
            if (lower.includes('form') || lower.includes('application') || lower.includes('submit')) steps.push(createStepFromType('form-input'));
            if (lower.includes('upload') || lower.includes('document') || lower.includes('attach') || lower.includes('file')) steps.push(createStepFromType('document-upload'));
            if (lower.includes('validat') || lower.includes('check data') || lower.includes('verify data')) steps.push(createStepFromType('validation'));
            if (lower.includes('complian') || lower.includes('regulation') || lower.includes('fedramp') || lower.includes('fisma') || lower.includes('cjis')) steps.push(createStepFromType('compliance-check'));
            if (lower.includes('background') || lower.includes('fbi') || lower.includes('criminal') || lower.includes('security clearance')) steps.push(createStepFromType('background-check'));
            if (lower.includes('assign to') || lower.includes('assign user') || lower.includes('assign team') || lower.includes('assign department')) steps.push(createStepFromType('assignment'));
            if (lower.includes('single approval') || lower.includes('one approval') || (lower.includes('approval') && !lower.includes('multi') && !lower.includes('parallel'))) steps.push(createStepFromType('single-approval'));
            if (lower.includes('multi') && lower.includes('approval') || lower.includes('sequential') || lower.includes('chain of approval')) steps.push(createStepFromType('multi-approval'));
            if (lower.includes('parallel approval') || lower.includes('simultaneous approval') || lower.includes('concurrent approval')) steps.push(createStepFromType('parallel-approval'));
            if (lower.includes('conditional approval') || lower.includes('approval if') || lower.includes('approval based on') || lower.match(/approval.*\$\d+/) || lower.match(/if.*\$\d+.*approval/)) steps.push(createStepFromType('conditional-approval'));
            if (lower.includes('email') || lower.includes('send notification') || lower.includes('notify via email')) steps.push(createStepFromType('email'));
            if (lower.includes('sms') || lower.includes('text message') || lower.includes('text alert') || lower.includes('mobile message')) steps.push(createStepFromType('sms'));
            if (lower.includes('escalat') || lower.includes('overdue') || lower.includes('no response') || lower.match(/after \d+ (hour|day|week)/i)) steps.push(createStepFromType('escalation'));
            if (lower.includes('save') || lower.includes('store') || lower.includes('database') || lower.includes('persist')) steps.push(createStepFromType('database-write'));
            if (lower.includes('report') || lower.includes('pdf') || lower.includes('generate document')) steps.push(createStepFromType('generate-report'));
            if (lower.includes('audit') || lower.includes('trail') || lower.includes('log') || lower.includes('track changes')) steps.push(createStepFromType('audit-log'));
            if (!steps.find(s => s.typeId === 'close-ticket' || s.typeId === 'completion')) steps.push(createStepFromType('completion'));
            if (steps.length === 0) { steps.push(createStepFromType('form-input')); steps.push(createStepFromType('validation')); steps.push(createStepFromType('single-approval')); steps.push(createStepFromType('email')); steps.push(createStepFromType('completion')); }
            return steps;
        }

        function createStepFromType(typeId) { const stepType = stepTypes.find(s => s.id === typeId); return { id: Date.now() + Math.random(), typeId: typeId, name: stepType.name, icon: stepType.icon, color: stepType.color }; }

        // Initialize workflow builder when workflows tab is shown
        let workflowBuilderInitialized = false;

        function initializeWorkflowBuilder() {
            if (workflowBuilderInitialized) return;
            workflowBuilderInitialized = true;

            console.log('Initializing workflow builder...');

            // Small delay to ensure DOM is ready
            setTimeout(() => {
                initializeStepLibrary();
            }, 100);
        }

        // Override switchTab to initialize workflow builder when needed
        const originalSwitchTab = switchTab;
        switchTab = function(tabName) {
            originalSwitchTab(tabName);
            if (tabName === 'workflows') {
                console.log('Workflows tab clicked, initializing...');
                initializeWorkflowBuilder();
            }
        };

        // Also initialize if workflows tab is already visible on page load
        document.addEventListener('DOMContentLoaded', function() {
            const workflowsContent = document.getElementById('workflows-content');
            if (workflowsContent && workflowsContent.style.display !== 'none') {
                initializeWorkflowBuilder();
            }
        });

        // ===== PREDICTIVE ANALYTICS DASHBOARD =====
        // Added 2024-12-09: Predictive Analytics Dashboard
        // MOCK DATA - Replace in production
        // TODO: Connect to AI/ML API endpoints

        let predictiveHistoricalData = [];
        let predictiveForecastData = [];

        function initializePredictiveAnalytics() {
            // Generate 6 months of historical data + 30 days forecast
            predictiveHistoricalData = [];
            predictiveForecastData = [];

            // Generate historical data (180 days)
            for (let i = 180; i >= 0; i--) {
                const baseValue = 250;
                const seasonalEffect = Math.sin(i / 30) * 50;
                const randomVariation = (Math.random() - 0.5) * 40;
                const value = Math.max(150, Math.floor(baseValue + seasonalEffect + randomVariation));

                predictiveHistoricalData.push({
                    date: new Date(Date.now() - i * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    cases: value
                });
            }

            // Generate forecast data (30 days)
            for (let i = 1; i <= 30; i++) {
                const baseValue = 270;
                const seasonalEffect = Math.sin(i / 30) * 55;
                const trendEffect = i * 2;
                const value = Math.floor(baseValue + seasonalEffect + trendEffect);

                predictiveForecastData.push({
                    date: new Date(Date.now() + i * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    cases: value,
                    confidence: Math.max(70, 90 - i)
                });
            }

            // Initialize all components
            renderPredictiveForecastChart();
            renderPredictiveResourceRecommendations();
            renderPredictiveAnomalyAlerts();
            initializePredictiveScenarioPlanning();
        }

        // Render forecast chart
        function renderPredictiveForecastChart() {
            const chart = document.getElementById('forecastChart');
            if (!chart) return;

            const lastDays = predictiveHistoricalData.slice(-15);
            const allData = [...lastDays, ...predictiveForecastData.slice(0, 15)];
            const maxValue = Math.max(...allData.map(d => d.cases));

            chart.innerHTML = allData.map((day, index) => {
                const height = (day.cases / maxValue) * 100;
                const isHistorical = index < 15;
                const isAnomaly = day.cases > 320 || day.cases < 200;

                let gradient = isHistorical
                    ? 'from-blue-400 to-cyan-500'
                    : 'from-purple-400 to-pink-500';

                if (isAnomaly) gradient = 'from-yellow-400 to-orange-500';

                return `
                    <div
                        class="forecast-bar flex-1 bg-gradient-to-t ${gradient} rounded-t cursor-pointer hover:opacity-80 transition-all"
                        style="height: ${height}%; animation-delay: ${index * 50}ms"
                        data-cases="${day.cases}"
                        data-date="${day.date}"
                        data-confidence="${day.confidence || 100}"
                        onmouseenter="showPredictiveTooltip(event, this)"
                        onmouseleave="hidePredictiveTooltip()">
                    </div>
                `;
            }).join('');
        }

        // Tooltip functions for predictive analytics
        function showPredictiveTooltip(event, element) {
            const tooltip = document.getElementById('predictiveTooltip');
            if (!tooltip) return;

            const cases = element.dataset.cases;
            const date = element.dataset.date;
            const confidence = element.dataset.confidence;

            tooltip.innerHTML = `
                <strong>${new Date(date).toLocaleDateString()}</strong><br>
                Cases: ${cases}<br>
                ${confidence < 100 ? `Confidence: ${confidence}%` : 'Historical Data'}
            `;

            tooltip.style.left = event.pageX + 10 + 'px';
            tooltip.style.top = event.pageY - 50 + 'px';
            tooltip.classList.add('show');
        }

        function hidePredictiveTooltip() {
            const tooltip = document.getElementById('predictiveTooltip');
            if (tooltip) tooltip.classList.remove('show');
        }

        // Resource recommendations
        const predictiveRecommendations = [
            {
                department: 'Permit Processing',
                current: 12,
                recommended: 15,
                impact: '+18% throughput',
                priority: 'high'
            },
            {
                department: 'Compliance Review',
                current: 8,
                recommended: 10,
                impact: '+12% efficiency',
                priority: 'medium'
            },
            {
                department: 'Public Services',
                current: 20,
                recommended: 18,
                impact: '-5% cost',
                priority: 'low'
            }
        ];

        function renderPredictiveResourceRecommendations() {
            const container = document.getElementById('resourceRecommendations');
            if (!container) return;

            container.innerHTML = predictiveRecommendations.map(rec => {
                const priorityColors = {
                    high: 'border-red-500/50 bg-red-500/10',
                    medium: 'border-yellow-500/50 bg-yellow-500/10',
                    low: 'border-green-500/50 bg-green-500/10'
                };

                const change = rec.recommended - rec.current;
                const changeText = change > 0 ? `+${change}` : change;
                const changeColor = change > 0 ? 'text-green-400' : 'text-red-400';

                return `
                    <div class="p-4 border rounded-lg ${priorityColors[rec.priority]}">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-white font-medium">${rec.department}</span>
                            <span class="text-xs px-2 py-1 rounded-full bg-white/10 text-white/70">${rec.priority.toUpperCase()}</span>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <div>
                                <span class="text-white/70">Current:</span>
                                <span class="text-white ml-2">${rec.current} staff</span>
                            </div>
                            <div>
                                <i class="fas fa-arrow-right text-white/50 mx-2"></i>
                            </div>
                            <div>
                                <span class="text-white/70">Recommended:</span>
                                <span class="text-white ml-2">${rec.recommended} staff</span>
                            </div>
                        </div>
                        <div class="mt-2 text-xs ${changeColor}">
                            <i class="fas fa-chart-line mr-1"></i>${rec.impact}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Anomaly alerts
        const predictiveAnomalies = [
            {
                type: 'Workload Spike',
                description: 'Permit applications up 45% week-over-week',
                severity: 'critical',
                time: '2 hours ago',
                department: 'Building Permits'
            },
            {
                type: 'Processing Delay',
                description: 'Average processing time increased by 28%',
                severity: 'warning',
                time: '5 hours ago',
                department: 'Tax Services'
            },
            {
                type: 'Resource Underutilization',
                description: 'Staff capacity at 42% in evening shift',
                severity: 'info',
                time: '1 day ago',
                department: 'Public Works'
            }
        ];

        function renderPredictiveAnomalyAlerts() {
            const container = document.getElementById('anomalyAlerts');
            if (!container) return;

            container.innerHTML = predictiveAnomalies.map(alert => {
                const severityConfig = {
                    critical: { color: 'red', icon: 'fa-exclamation-circle', pulse: true },
                    warning: { color: 'yellow', icon: 'fa-exclamation-triangle', pulse: false },
                    info: { color: 'blue', icon: 'fa-info-circle', pulse: false }
                };

                const config = severityConfig[alert.severity];

                return `
                    <div class="p-4 border border-${config.color}-500/30 bg-${config.color}-500/10 rounded-lg">
                        <div class="flex items-start gap-3">
                            <div class="w-8 h-8 rounded-full bg-${config.color}-500/20 flex items-center justify-center flex-shrink-0 ${config.pulse ? 'anomaly-pulse' : ''}">
                                <i class="fas ${config.icon} text-${config.color}-400"></i>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="text-white font-medium text-sm">${alert.type}</span>
                                    <span class="text-xs text-white/50">${alert.time}</span>
                                </div>
                                <p class="text-sm text-white/70 mb-2">${alert.description}</p>
                                <div class="flex items-center gap-2 text-xs text-white/50">
                                    <i class="fas fa-building"></i>
                                    <span>${alert.department}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Scenario planning
        function initializePredictiveScenarioPlanning() {
            const staffingSlider = document.getElementById('staffingSlider');
            const volumeSlider = document.getElementById('volumeSlider');
            const efficiencySlider = document.getElementById('efficiencySlider');
            const staffingValue = document.getElementById('staffingValue');
            const volumeValue = document.getElementById('volumeValue');
            const efficiencyValue = document.getElementById('efficiencyValue');
            const runScenarioBtn = document.getElementById('runScenarioBtn');
            const resetScenariosBtn = document.getElementById('resetScenariosBtn');
            const exportForecastBtn = document.getElementById('exportForecastBtn');
            const applyRecommendationsBtn = document.getElementById('applyRecommendationsBtn');

            if (!staffingSlider || !volumeSlider || !efficiencySlider) return;

            // Update slider values
            staffingSlider.addEventListener('input', (e) => {
                if (staffingValue) staffingValue.textContent = e.target.value + '%';
            });

            volumeSlider.addEventListener('input', (e) => {
                if (volumeValue) volumeValue.textContent = e.target.value + '%';
            });

            efficiencySlider.addEventListener('input', (e) => {
                if (efficiencyValue) efficiencyValue.textContent = e.target.value + '%';
            });

            // Run scenario analysis
            if (runScenarioBtn) {
                runScenarioBtn.addEventListener('click', () => {
                    const staffingLevel = parseInt(staffingSlider.value);
                    const volumeLevel = parseInt(volumeSlider.value);
                    const efficiencyLevel = parseInt(efficiencySlider.value);

                    // Calculate predicted outcomes
                    const baseProcessingTime = 2.4;
                    const baseUtilization = 78;
                    const baseBacklog = 45;

                    const processingTime = (baseProcessingTime * (100 / efficiencyLevel) * (volumeLevel / 100) * (100 / staffingLevel)).toFixed(1);
                    const utilization = Math.min(100, Math.floor(baseUtilization * (volumeLevel / 100) * (100 / staffingLevel)));
                    const backlog = Math.max(0, Math.floor(baseBacklog * (volumeLevel / 100) * (100 / staffingLevel) * (100 / efficiencyLevel)));
                    const cost = Math.floor((staffingLevel - 100) * 1000);

                    const processingChange = Math.floor(((processingTime - baseProcessingTime) / baseProcessingTime) * 100);
                    const utilizationChange = utilization - baseUtilization;
                    const backlogChange = backlog - baseBacklog;

                    const scenarioResults = document.getElementById('scenarioResults');
                    if (scenarioResults) {
                        scenarioResults.innerHTML = `
                            <div class="flex items-center justify-between p-3 bg-blue-500/10 rounded-lg">
                                <div>
                                    <div class="text-white/70 text-sm">Average Processing Time</div>
                                    <div class="text-2xl font-bold text-white mt-1">${processingTime} days</div>
                                </div>
                                <div class="${processingChange < 0 ? 'text-green-400' : 'text-red-400'}">
                                    <i class="fas fa-arrow-${processingChange < 0 ? 'down' : 'up'}"></i> ${Math.abs(processingChange)}%
                                </div>
                            </div>

                            <div class="flex items-center justify-between p-3 bg-purple-500/10 rounded-lg">
                                <div>
                                    <div class="text-white/70 text-sm">Capacity Utilization</div>
                                    <div class="text-2xl font-bold text-white mt-1">${utilization}%</div>
                                </div>
                                <div class="${utilizationChange === 0 ? 'text-white/50' : utilizationChange > 0 ? 'text-yellow-400' : 'text-green-400'}">
                                    <i class="fas fa-${utilizationChange === 0 ? 'minus' : utilizationChange > 0 ? 'arrow-up' : 'arrow-down'}"></i> ${Math.abs(utilizationChange)}%
                                </div>
                            </div>

                            <div class="flex items-center justify-between p-3 bg-green-500/10 rounded-lg">
                                <div>
                                    <div class="text-white/70 text-sm">Backlog Reduction</div>
                                    <div class="text-2xl font-bold text-white mt-1">${backlog}%</div>
                                </div>
                                <div class="${backlogChange > 0 ? 'text-red-400' : 'text-green-400'}">
                                    <i class="fas fa-arrow-${backlogChange > 0 ? 'up' : 'down'}"></i> ${Math.abs(backlogChange)}%
                                </div>
                            </div>

                            <div class="flex items-center justify-between p-3 bg-red-500/10 rounded-lg">
                                <div>
                                    <div class="text-white/70 text-sm">Resource Cost Impact</div>
                                    <div class="text-2xl font-bold text-white mt-1">${cost >= 0 ? '+' : ''}$${Math.abs(cost).toLocaleString()}</div>
                                </div>
                                <div class="${cost === 0 ? 'text-white/50' : cost > 0 ? 'text-red-400' : 'text-green-400'}">
                                    <i class="fas fa-${cost === 0 ? 'minus' : cost > 0 ? 'arrow-up' : 'arrow-down'}"></i> ${staffingLevel - 100}%
                                </div>
                            </div>
                        `;
                    }
                });

                // Initialize scenario results with default values
                runScenarioBtn.click();
            }

            // Reset scenarios
            if (resetScenariosBtn) {
                resetScenariosBtn.addEventListener('click', () => {
                    staffingSlider.value = 100;
                    volumeSlider.value = 100;
                    efficiencySlider.value = 100;

                    if (staffingValue) staffingValue.textContent = '100%';
                    if (volumeValue) volumeValue.textContent = '100%';
                    if (efficiencyValue) efficiencyValue.textContent = '100%';

                    if (runScenarioBtn) runScenarioBtn.click();
                });
            }

            // Export functionality
            if (exportForecastBtn) {
                exportForecastBtn.addEventListener('click', () => {
                    const data = {
                        historical: predictiveHistoricalData,
                        forecast: predictiveForecastData,
                        exportedAt: new Date().toISOString(),
                        mlConfidence: 87
                    };

                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `forecast-data-${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    URL.revokeObjectURL(url);

                    alert('Forecast data exported successfully!');
                });
            }

            // Apply recommendations
            if (applyRecommendationsBtn) {
                applyRecommendationsBtn.addEventListener('click', () => {
                    alert('Resource recommendations applied! Staff assignments will be updated in the next scheduling cycle.');
                });
            }
        }
        // ===== END PREDICTIVE ANALYTICS DASHBOARD =====

        // ===== BLOCKCHAIN AUDIT TRAIL =====
        // Added 2024-12-09: Blockchain Audit Trail
        // MOCK DATA - Replace in production
        // TODO: Connect to blockchain API endpoint

        let blockchain = [];
        let blockIdCounter = 1;

        // Initialize Blockchain Audit Trail
        function initializeBlockchain() {
            const container = document.getElementById('blockchainAuditTrail');
            if (!container) return;

            container.innerHTML = getBlockchainHTML();
            addBlockchainModals();
            initializeBlockchainData();
        }

        // Get Blockchain HTML
        function getBlockchainHTML() {
            return `
                <div class="glass rounded-xl p-6 mb-6">
                    <div class="flex items-center justify-between mb-6 flex-wrap gap-4">
                        <h2 class="text-2xl font-bold flex items-center gap-2">
                            <i class="fas fa-cube text-blue-400"></i>
                            Blockchain Audit Trail
                        </h2>
                        <div class="flex items-center gap-3 flex-wrap">
                            <div class="px-4 py-2 bg-green-500/20 border border-green-500/40 rounded-lg">
                                <span class="text-green-400 text-sm">
                                    <i class="fas fa-check-circle mr-2"></i>
                                    <span id="blockCount">0</span> Blocks
                                </span>
                            </div>
                            <button id="exportAuditBtn" class="px-4 py-2 bg-gradient-to-r from-green-500 to-blue-600 rounded-lg font-medium hover:shadow-lg transition-all">
                                <i class="fas fa-download mr-2"></i>Export
                            </button>
                            <button id="shareAuditBtn" class="px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-600 rounded-lg font-medium hover:shadow-lg transition-all">
                                <i class="fas fa-share-alt mr-2"></i>Share
                            </button>
                            <button id="createBlockBtn" class="px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg font-medium hover:shadow-lg transition-all neon-blue">
                                <i class="fas fa-plus mr-2"></i>Create Block
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto scrollbar-thin pb-4">
                        <div id="blocksList" class="flex gap-10 min-w-max py-4"></div>
                    </div>
                </div>
                <div class="glass rounded-xl p-6">
                    <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
                        <i class="fas fa-file-contract text-blue-400"></i>
                        Smart Contract Status
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="smartContractsGrid"></div>
                </div>
            `;
        }

        // Add Blockchain Modals
        function addBlockchainModals() {
            if (document.getElementById('blockModal')) return;
            document.body.insertAdjacentHTML('beforeend', `
                <div id="blockModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden items-center justify-center">
                    <div class="glass rounded-xl p-8 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto scrollbar-thin">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-2xl font-bold">Block Details</h2>
                            <button onclick="closeBlockModal()" class="text-white/70 hover:text-white transition-all"><i class="fas fa-times text-2xl"></i></button>
                        </div>
                        <div id="blockModalContent"></div>
                    </div>
                </div>
                <div id="exportModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden items-center justify-center">
                    <div class="glass rounded-xl p-8 max-w-xl w-full mx-4">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-2xl font-bold flex items-center gap-2"><i class="fas fa-download text-green-400"></i>Export Audit Trail</h2>
                            <button onclick="closeExportModal()" class="text-white/70 hover:text-white transition-all"><i class="fas fa-times text-2xl"></i></button>
                        </div>
                        <div class="space-y-6">
                            <div><label class="text-white/70 text-sm mb-2 block">Export Format</label>
                                <select id="exportFormat" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white focus:outline-none focus:border-blue-400">
                                    <option value="json">JSON (Complete Data)</option>
                                    <option value="csv">CSV (Spreadsheet)</option>
                                    <option value="xml">XML (Structured)</option>
                                </select>
                            </div>
                            <button onclick="confirmExport()" class="w-full px-4 py-3 bg-gradient-to-r from-green-500 to-blue-600 rounded-lg font-medium hover:shadow-lg transition-all">
                                <i class="fas fa-download mr-2"></i>Export Audit Trail
                            </button>
                        </div>
                    </div>
                </div>
                <div id="shareModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden items-center justify-center">
                    <div class="glass rounded-xl p-8 max-w-xl w-full mx-4">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-2xl font-bold flex items-center gap-2"><i class="fas fa-share-alt text-purple-400"></i>Share Audit Trail</h2>
                            <button onclick="closeShareModal()" class="text-white/70 hover:text-white transition-all"><i class="fas fa-times text-2xl"></i></button>
                        </div>
                        <div class="space-y-6">
                            <div><label class="text-white/70 text-sm mb-2 block">Link Expiration</label>
                                <select id="shareExpiration" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white focus:outline-none focus:border-blue-400">
                                    <option value="1h">1 Hour</option>
                                    <option value="24h">24 Hours</option>
                                    <option value="7d">7 Days</option>
                                    <option value="30d">30 Days</option>
                                </select>
                            </div>
                            <div id="generatedLinkContainer" class="hidden">
                                <div class="p-4 bg-black/30 rounded-lg border border-green-500/30">
                                    <div class="font-mono text-sm text-green-400 break-all mb-3" id="generatedLink"></div>
                                    <button onclick="copyShareLink()" class="w-full px-4 py-2 bg-blue-500/20 border border-blue-500/40 rounded-lg text-blue-300 hover:bg-blue-500/30 transition-all">
                                        <i class="fas fa-copy mr-2"></i>Copy Link
                                    </button>
                                </div>
                            </div>
                            <button onclick="generateShareLink()" class="w-full px-4 py-3 bg-gradient-to-r from-purple-500 to-pink-600 rounded-lg font-medium hover:shadow-lg transition-all">
                                <i class="fas fa-link mr-2"></i>Generate Secure Link
                            </button>
                        </div>
                    </div>
                </div>
            `);
        }

        // Initialize blockchain data
        async function initializeBlockchainData() {
            const genesisBlock = await createBlockchainBlock({type: 'genesis', department: 'System', action: 'Blockchain Initialized', data: {message: 'Genesis Block'}});
            blockchain.push(genesisBlock);

            const samples = [
                {type: 'document_submit', department: 'Building Permits', action: 'Permit Application Submitted', data: {permitId: 'BP-2024-1847'}},
                {type: 'approval', department: 'EPA', action: 'Environmental Impact Approved', data: {projectId: 'ENV-2024-432'}},
                {type: 'status_update', department: 'Tax Services', action: 'Tax Return Processed', data: {returnId: 'TAX-2024-8923'}}
            ];

            for (const data of samples) {
                blockchain.push(await createBlockchainBlock(data));
            }

            renderBlockchain();
            updateBlockCount();
            initializeSmartContracts();
            attachBlockchainEventListeners();
        }

        async function createBlockchainBlock(data) {
            const previousBlock = blockchain[blockchain.length - 1];
            const block = {
                index: blockIdCounter++,
                timestamp: new Date().toISOString(),
                type: data.type,
                department: data.department,
                action: data.action,
                data: data.data,
                previousHash: previousBlock ? previousBlock.hash : '0'.repeat(64),
                nonce: Math.floor(Math.random() * 1000000)
            };
            block.hash = await generateBlockHash(block);
            return block;
        }

        async function generateBlockHash(data) {
            const encoder = new TextEncoder();
            const dataBuffer = encoder.encode(JSON.stringify(data));
            const hashBuffer = await crypto.subtle.digest('SHA-256', dataBuffer);
            return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function renderBlockchain() {
            const container = document.getElementById('blocksList');
            if (!container) return;
            container.innerHTML = blockchain.map((block, index) => {
                const color = {genesis: 'purple', document_submit: 'blue', approval: 'green', rejection: 'red', status_update: 'yellow'}[block.type] || 'blue';
                return `
                    <div class="blockchain-block glass rounded-xl p-6 min-w-[280px] neon-${color} block-creating" onclick="showBlockchainDetails(${index})">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-cube text-${color}-400 text-2xl"></i>
                                <span class="font-bold text-lg">Block #${block.index}</span>
                            </div>
                            <span class="text-xs px-2 py-1 bg-${color}-500/20 rounded-full text-${color}-300">${block.type.toUpperCase()}</span>
                        </div>
                        <div class="space-y-3">
                            <div><div class="text-white/50 text-xs mb-1">Department</div><div class="text-white font-medium">${block.department}</div></div>
                            <div><div class="text-white/50 text-xs mb-1">Action</div><div class="text-white text-sm">${block.action}</div></div>
                            <div><div class="text-white/50 text-xs mb-1">Hash</div><div class="font-mono text-xs text-blue-300 truncate">${block.hash.substring(0, 16)}...</div></div>
                            <div><div class="text-white/50 text-xs mb-1">Timestamp</div><div class="text-white/70 text-xs">${new Date(block.timestamp).toLocaleString()}</div></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showBlockchainDetails(index) {
            const block = blockchain[index];
            document.getElementById('blockModalContent').innerHTML = `
                <div class="space-y-4">
                    <div class="p-4 bg-blue-500/10 border border-blue-500/30 rounded-lg">
                        <div class="text-white/70 text-sm mb-1">Block Index</div>
                        <div class="text-2xl font-bold text-white">#${block.index}</div>
                    </div>
                    <div><div class="text-white/70 text-sm mb-2">Department</div><div class="text-white font-medium">${block.department}</div></div>
                    <div><div class="text-white/70 text-sm mb-2">Action</div><div class="text-white">${block.action}</div></div>
                    <div><div class="text-white/70 text-sm mb-2">Transaction Data</div><div class="p-4 bg-black/30 rounded-lg font-mono text-sm text-green-400">${JSON.stringify(block.data, null, 2)}</div></div>
                    <div><div class="text-white/70 text-sm mb-2">Block Hash</div><div class="p-3 bg-black/30 rounded-lg font-mono text-xs text-blue-300 break-all">${block.hash}</div></div>
                    <div><div class="text-white/70 text-sm mb-2">Previous Hash</div><div class="p-3 bg-black/30 rounded-lg font-mono text-xs text-purple-300 break-all">${block.previousHash}</div></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><div class="text-white/70 text-sm mb-1">Timestamp</div><div class="text-white">${new Date(block.timestamp).toLocaleString()}</div></div>
                        <div><div class="text-white/70 text-sm mb-1">Nonce</div><div class="text-white font-mono">${block.nonce}</div></div>
                    </div>
                </div>
            `;
            document.getElementById('blockModal').classList.remove('hidden');
            document.getElementById('blockModal').classList.add('flex');
        }

        function closeBlockModal() { document.getElementById('blockModal')?.classList.add('hidden'); document.getElementById('blockModal')?.classList.remove('flex'); }
        function closeExportModal() { document.getElementById('exportModal')?.classList.add('hidden'); document.getElementById('exportModal')?.classList.remove('flex'); }
        function closeShareModal() { document.getElementById('shareModal')?.classList.add('hidden'); document.getElementById('shareModal')?.classList.remove('flex'); }

        function confirmExport() {
            const format = document.getElementById('exportFormat').value;
            const exportData = {exportDate: new Date().toISOString(), totalBlocks: blockchain.length, blocks: blockchain};
            const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `blockchain-audit-${new Date().toISOString().split('T')[0]}.${format}`;
            a.click();
            URL.revokeObjectURL(url);
            closeExportModal();
            alert('Audit trail exported successfully!');
        }

        function generateShareLink() {
            const token = Array.from({length: 32}, () => Math.floor(Math.random() * 16).toString(16)).join('');
            document.getElementById('generatedLink').textContent = `https://govflow.audit/share/${token}`;
            document.getElementById('generatedLinkContainer').classList.remove('hidden');
        }

        function copyShareLink() {
            navigator.clipboard.writeText(document.getElementById('generatedLink').textContent);
            alert('Link copied to clipboard!');
        }

        function updateBlockCount() {
            const el = document.getElementById('blockCount');
            if (el) el.textContent = blockchain.length;
        }

        function initializeSmartContracts() {
            const grid = document.getElementById('smartContractsGrid');
            if (!grid) return;
            const contracts = [
                {name: 'Permit Auto-Approval', status: 'active', executions: 847, icon: 'fa-file-contract', color: 'green'},
                {name: 'Tax Filing Validator', status: 'active', executions: 1243, icon: 'fa-calculator', color: 'blue'},
                {name: 'Compliance Checker', status: 'pending', executions: 432, icon: 'fa-shield-alt', color: 'yellow'}
            ];
            grid.innerHTML = contracts.map(c => `
                <div class="glass-dark rounded-xl p-6 contract-status">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-${c.color}-500/20 rounded-lg flex items-center justify-center"><i class="fas ${c.icon} text-${c.color}-400 text-xl"></i></div>
                        <span class="px-3 py-1 bg-${c.color}-500/20 border border-${c.color}-500/40 rounded-full text-${c.color}-400 text-xs">${c.status.toUpperCase()}</span>
                    </div>
                    <h3 class="font-bold text-white mb-2">${c.name}</h3>
                    <div class="text-sm text-white/70">Executions: <span class="text-white font-medium">${c.executions.toLocaleString()}</span></div>
                </div>
            `).join('');
        }

        function attachBlockchainEventListeners() {
            document.getElementById('createBlockBtn')?.addEventListener('click', async () => {
                blockchain.push(await createBlockchainBlock({type: 'document_submit', department: 'Building Permits', action: 'Document Submitted', data: {id: `DOC-${Date.now()}`}}));
                renderBlockchain();
                updateBlockCount();
                alert('New block created!');
            });
            document.getElementById('exportAuditBtn')?.addEventListener('click', () => {
                document.getElementById('exportModal')?.classList.remove('hidden');
                document.getElementById('exportModal')?.classList.add('flex');
            });
            document.getElementById('shareAuditBtn')?.addEventListener('click', () => {
                document.getElementById('shareModal')?.classList.remove('hidden');
                document.getElementById('shareModal')?.classList.add('flex');
            });
        }
        // ===== END BLOCKCHAIN AUDIT TRAIL =====

        // ===== QUANTUM-READY SECURITY MODULE =====
        // Added 2025-10-07: Quantum-Ready Security Module
        // MOCK DATA - Replace in production
        // TODO: Connect to quantum security API endpoint /api/quantum-security
        // TODO: Implement real encryption/decryption with post-quantum libraries (liboqs, Kyber)
        // SECURITY TODO: Validate all user inputs
        // TODO: Add authentication for admin access only
        // TODO: Integrate with HSM for key management

        function initializeQuantumSecurity() {
            const container = document.getElementById('quantumSecurityModule');
            if (!container) return;

            container.innerHTML = getQuantumSecurityHTML();
            createQuantumParticles();
            calculateQuantumSecurityScore();
            updateQDayCountdown();

            // Update countdown every minute
            setInterval(updateQDayCountdown, 60000);
        }

        function getQuantumSecurityHTML() {
            return `
                <!-- Quantum particles background -->
                <div id="quantumParticles" class="fixed inset-0 pointer-events-none overflow-hidden z-0"></div>

                <div class="relative z-10">
                    <!-- Header -->
                    <div class="glass rounded-xl p-6 mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h2 class="text-3xl font-bold text-white mb-2">🔐 Quantum-Ready Security Module</h2>
                                <p class="text-white/70">Post-Quantum Cryptography Protection</p>
                            </div>
                            <div class="text-right">
                                <div class="text-xl font-bold text-purple-400">Security Score</div>
                                <div id="quantumSecurityScore" class="text-4xl font-bold text-white">0</div>
                                <div class="text-sm text-white/60">out of 100</div>
                            </div>
                        </div>

                        <!-- Status indicators -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div class="text-center p-3 rounded-lg bg-white/5">
                                <div class="text-white/70 text-sm mb-1">Encryption Status</div>
                                <div class="text-green-400 font-bold">✓ Active</div>
                            </div>
                            <div class="text-center p-3 rounded-lg bg-white/5">
                                <div class="text-white/70 text-sm mb-1">Quantum Readiness</div>
                                <div class="text-yellow-400 font-bold">⚠ Transitioning</div>
                            </div>
                            <div class="text-center p-3 rounded-lg bg-white/5">
                                <div class="text-white/70 text-sm mb-1">Keys Managed</div>
                                <div class="text-white font-bold">1,247</div>
                            </div>
                            <div class="text-center p-3 rounded-lg bg-white/5">
                                <div class="text-white/70 text-sm mb-1">Time to Q-Day</div>
                                <div id="qDayCountdown" class="text-purple-400 font-bold">~8 years</div>
                            </div>
                        </div>
                    </div>

                    <!-- Encryption Dashboard -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <!-- Current Encryption -->
                        <div class="glass rounded-xl p-6">
                            <h3 class="text-xl font-bold text-white mb-4">📊 Current Encryption</h3>
                            <div class="space-y-4">
                                <div>
                                    <div class="flex justify-between mb-2">
                                        <span class="text-white/80">RSA-2048</span>
                                        <span class="text-yellow-400">Classical</span>
                                    </div>
                                    <div class="quantum-strength-bar">
                                        <div class="quantum-strength-fill bg-gradient-to-r from-yellow-500 to-orange-500" style="width: 45%"></div>
                                    </div>
                                    <div class="text-xs text-white/60 mt-1">Vulnerable to quantum attacks (~2030)</div>
                                </div>
                                <div>
                                    <div class="flex justify-between mb-2">
                                        <span class="text-white/80">AES-256</span>
                                        <span class="text-green-400">Quantum-Resistant</span>
                                    </div>
                                    <div class="quantum-strength-bar">
                                        <div class="quantum-strength-fill bg-gradient-to-r from-green-500 to-emerald-500" style="width: 85%"></div>
                                    </div>
                                    <div class="text-xs text-white/60 mt-1">Secure with increased key size</div>
                                </div>
                                <div>
                                    <div class="flex justify-between mb-2">
                                        <span class="text-white/80">ECDSA P-256</span>
                                        <span class="text-red-400">At Risk</span>
                                    </div>
                                    <div class="quantum-strength-bar">
                                        <div class="quantum-strength-fill bg-gradient-to-r from-red-500 to-pink-500" style="width: 30%"></div>
                                    </div>
                                    <div class="text-xs text-white/60 mt-1">Highly vulnerable to Shor's algorithm</div>
                                </div>
                            </div>
                        </div>

                        <!-- Post-Quantum Encryption -->
                        <div class="glass rounded-xl p-6">
                            <h3 class="text-xl font-bold text-white mb-4">🛡️ Post-Quantum Encryption</h3>
                            <div class="space-y-4">
                                <div>
                                    <div class="flex justify-between mb-2">
                                        <span class="text-white/80">CRYSTALS-Kyber</span>
                                        <span class="quantum-cert-badge text-white text-xs px-2 py-1 rounded">NIST Approved</span>
                                    </div>
                                    <div class="quantum-strength-bar">
                                        <div class="quantum-strength-fill bg-gradient-to-r from-purple-500 to-indigo-500" style="width: 95%"></div>
                                    </div>
                                    <div class="text-xs text-white/60 mt-1">Lattice-based key encapsulation</div>
                                </div>
                                <div>
                                    <div class="flex justify-between mb-2">
                                        <span class="text-white/80">CRYSTALS-Dilithium</span>
                                        <span class="quantum-cert-badge text-white text-xs px-2 py-1 rounded">NIST Approved</span>
                                    </div>
                                    <div class="quantum-strength-bar">
                                        <div class="quantum-strength-fill bg-gradient-to-r from-blue-500 to-cyan-500" style="width: 93%"></div>
                                    </div>
                                    <div class="text-xs text-white/60 mt-1">Digital signatures for authentication</div>
                                </div>
                                <div>
                                    <div class="flex justify-between mb-2">
                                        <span class="text-white/80">SPHINCS+</span>
                                        <span class="quantum-cert-badge text-white text-xs px-2 py-1 rounded">NIST Approved</span>
                                    </div>
                                    <div class="quantum-strength-bar">
                                        <div class="quantum-strength-fill bg-gradient-to-r from-indigo-500 to-purple-500" style="width: 90%"></div>
                                    </div>
                                    <div class="text-xs text-white/60 mt-1">Hash-based stateless signatures</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Visual Comparison: Classical vs Quantum -->
                    <div class="glass rounded-xl p-6 mb-6">
                        <h3 class="text-xl font-bold text-white mb-4">⚔️ Encryption Strength Comparison</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 quantum-vs-divider">
                            <!-- Classical -->
                            <div>
                                <h4 class="text-lg font-bold text-yellow-400 mb-4">Classical Encryption</h4>
                                <div class="space-y-3">
                                    <div class="p-3 rounded-lg bg-white/5">
                                        <div class="font-bold text-white mb-1">RSA-2048</div>
                                        <div class="text-sm text-white/70">Breaking time (classical): 1 billion years</div>
                                        <div class="text-sm text-red-400">Breaking time (quantum): ~8 hours</div>
                                    </div>
                                    <div class="p-3 rounded-lg bg-white/5">
                                        <div class="font-bold text-white mb-1">ECC P-256</div>
                                        <div class="text-sm text-white/70">Breaking time (classical): 10 trillion years</div>
                                        <div class="text-sm text-red-400">Breaking time (quantum): ~10 minutes</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Quantum-Resistant -->
                            <div>
                                <h4 class="text-lg font-bold text-purple-400 mb-4">Post-Quantum Encryption</h4>
                                <div class="space-y-3">
                                    <div class="p-3 rounded-lg bg-white/5">
                                        <div class="font-bold text-white mb-1">CRYSTALS-Kyber</div>
                                        <div class="text-sm text-white/70">Breaking time (classical): ∞ (computationally infeasible)</div>
                                        <div class="text-sm text-green-400">Breaking time (quantum): >1 million years</div>
                                    </div>
                                    <div class="p-3 rounded-lg bg-white/5">
                                        <div class="font-bold text-white mb-1">CRYSTALS-Dilithium</div>
                                        <div class="text-sm text-white/70">Breaking time (classical): ∞ (computationally infeasible)</div>
                                        <div class="text-sm text-green-400">Breaking time (quantum): >10 million years</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quantum Threat Timeline -->
                    <div class="glass rounded-xl p-6 mb-6">
                        <h3 class="text-xl font-bold text-white mb-4">⏱️ Quantum Threat Timeline</h3>
                        <div class="relative">
                            <div class="absolute left-0 top-0 bottom-0 w-1 bg-gradient-to-b from-green-500 via-yellow-500 to-red-500"></div>
                            <div class="ml-8 space-y-6">
                                <div class="quantum-timeline-point">
                                    <div class="text-green-400 font-bold mb-1">2024 - Today</div>
                                    <div class="text-white/80">Classical encryption still secure</div>
                                    <div class="text-sm text-white/60">Current systems operational</div>
                                </div>
                                <div class="quantum-timeline-point">
                                    <div class="text-yellow-400 font-bold mb-1">2028 - Early Quantum</div>
                                    <div class="text-white/80">50-100 qubit quantum computers</div>
                                    <div class="text-sm text-white/60">Can break some classical encryption</div>
                                </div>
                                <div class="quantum-timeline-point">
                                    <div class="text-orange-400 font-bold mb-1">2030 - Q-Day Approaching</div>
                                    <div class="text-white/80">1000+ qubit quantum computers</div>
                                    <div class="text-sm text-white/60">RSA-2048 and ECC vulnerable</div>
                                </div>
                                <div class="quantum-timeline-point quantum-threat-indicator">
                                    <div class="text-red-400 font-bold mb-1">2032+ - Q-Day</div>
                                    <div class="text-white/80">Cryptographically relevant quantum computer</div>
                                    <div class="text-sm text-white/60">All classical encryption broken</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Key Management Interface -->
                    <div class="glass rounded-xl p-6 mb-6">
                        <h3 class="text-xl font-bold text-white mb-4">🔑 Key Management & Rotation</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="font-bold text-white/90 mb-3">Active Keys</h4>
                                <div class="space-y-3">
                                    <div class="p-3 rounded-lg bg-white/5 border-l-4 border-green-500">
                                        <div class="flex justify-between items-start mb-2">
                                            <div>
                                                <div class="font-bold text-white">Primary RSA Key</div>
                                                <div class="text-xs text-white/60">ID: RSA-2024-001</div>
                                            </div>
                                            <span class="text-xs bg-green-500/20 text-green-400 px-2 py-1 rounded">Active</span>
                                        </div>
                                        <div class="text-sm text-white/70">Next rotation: 45 days</div>
                                        <div class="mt-2 h-2 bg-white/10 rounded-full overflow-hidden">
                                            <div class="h-full bg-green-500" style="width: 65%"></div>
                                        </div>
                                    </div>
                                    <div class="p-3 rounded-lg bg-white/5 border-l-4 border-purple-500">
                                        <div class="flex justify-between items-start mb-2">
                                            <div>
                                                <div class="font-bold text-white">Kyber-1024 Key</div>
                                                <div class="text-xs text-white/60">ID: KYBER-2024-003</div>
                                            </div>
                                            <span class="text-xs bg-purple-500/20 text-purple-400 px-2 py-1 rounded">Quantum-Safe</span>
                                        </div>
                                        <div class="text-sm text-white/70">Next rotation: 89 days</div>
                                        <div class="mt-2 h-2 bg-white/10 rounded-full overflow-hidden">
                                            <div class="h-full bg-purple-500" style="width: 35%"></div>
                                        </div>
                                    </div>
                                    <div class="p-3 rounded-lg bg-white/5 border-l-4 border-yellow-500">
                                        <div class="flex justify-between items-start mb-2">
                                            <div>
                                                <div class="font-bold text-white">Certificate Authority</div>
                                                <div class="text-xs text-white/60">ID: CA-2024-ROOT</div>
                                            </div>
                                            <span class="text-xs bg-yellow-500/20 text-yellow-400 px-2 py-1 rounded">Expiring Soon</span>
                                        </div>
                                        <div class="text-sm text-white/70">Expires: 12 days</div>
                                        <div class="mt-2 h-2 bg-white/10 rounded-full overflow-hidden">
                                            <div class="h-full bg-yellow-500" style="width: 90%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <h4 class="font-bold text-white/90 mb-3">Rotation Schedule</h4>
                                <div class="space-y-3">
                                    <div class="p-3 rounded-lg bg-white/5">
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="text-white/80">Automatic Rotation</span>
                                            <div class="w-12 h-6 bg-purple-600 rounded-full relative">
                                                <div class="absolute left-1 top-1 bg-white w-4 h-4 rounded-full translate-x-6 transition-transform"></div>
                                            </div>
                                        </div>
                                        <div class="text-sm text-white/60">Keys rotate every 90 days</div>
                                    </div>
                                    <div class="p-3 rounded-lg bg-white/5">
                                        <div class="font-bold text-white mb-2">Upcoming Rotations</div>
                                        <div class="space-y-2 text-sm">
                                            <div class="flex justify-between text-white/70">
                                                <span>API Gateway Keys</span>
                                                <span class="text-green-400">3 days</span>
                                            </div>
                                            <div class="flex justify-between text-white/70">
                                                <span>Database Encryption</span>
                                                <span class="text-yellow-400">18 days</span>
                                            </div>
                                            <div class="flex justify-between text-white/70">
                                                <span>SSL/TLS Certificates</span>
                                                <span class="text-orange-400">45 days</span>
                                            </div>
                                        </div>
                                    </div>
                                    <button onclick="scheduleManualRotation()" class="w-full px-4 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-bold transition-colors">
                                        Schedule Manual Rotation
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Migration Planner -->
                    <div class="glass rounded-xl p-6 mb-6">
                        <h3 class="text-xl font-bold text-white mb-4">🚀 Migration Planner</h3>
                        <div class="mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-white/80">Migration Progress</span>
                                <span class="text-purple-400 font-bold">37% Complete</span>
                            </div>
                            <div class="h-4 bg-white/10 rounded-full overflow-hidden">
                                <div class="h-full bg-gradient-to-r from-purple-600 to-blue-600" style="width: 37%"></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div class="p-4 rounded-lg bg-green-500/10 border border-green-500/30">
                                <div class="text-2xl font-bold text-green-400 mb-1">23</div>
                                <div class="text-sm text-white/70">Systems Migrated</div>
                            </div>
                            <div class="p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/30">
                                <div class="text-2xl font-bold text-yellow-400 mb-1">15</div>
                                <div class="text-sm text-white/70">In Progress</div>
                            </div>
                            <div class="p-4 rounded-lg bg-purple-500/10 border border-purple-500/30">
                                <div class="text-2xl font-bold text-purple-400 mb-1">24</div>
                                <div class="text-sm text-white/70">Pending</div>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <div class="p-4 rounded-lg bg-white/5">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="font-bold text-white">Phase 1: API Gateway</div>
                                    <span class="text-green-400">✓ Complete</span>
                                </div>
                                <div class="text-sm text-white/60">Migrated to hybrid RSA/Kyber encryption</div>
                            </div>
                            <div class="p-4 rounded-lg bg-white/5 border-l-4 border-yellow-500">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="font-bold text-white">Phase 2: Database Layer</div>
                                    <span class="text-yellow-400">⏳ In Progress</span>
                                </div>
                                <div class="text-sm text-white/60">Implementing AES-256 with increased key size</div>
                                <div class="mt-2 h-2 bg-white/10 rounded-full overflow-hidden">
                                    <div class="h-full bg-yellow-500" style="width: 60%"></div>
                                </div>
                            </div>
                            <div class="p-4 rounded-lg bg-white/5">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="font-bold text-white">Phase 3: Authentication</div>
                                    <span class="text-white/50">⏸ Pending</span>
                                </div>
                                <div class="text-sm text-white/60">Replace ECDSA with Dilithium signatures</div>
                            </div>
                        </div>
                    </div>

                    <!-- Security Score Calculator -->
                    <div class="glass rounded-xl p-6 mb-6">
                        <h3 class="text-xl font-bold text-white mb-4">🎯 Security Score Calculator</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-white/80 mb-2">Data Sensitivity Level</label>
                                <select id="quantumSensitivityLevel" class="w-full px-4 py-3 rounded-lg bg-white/10 text-white border border-white/20 focus:border-purple-500 focus:outline-none" onchange="calculateQuantumSecurityScore()">
                                    <option value="public">Public (Level 1)</option>
                                    <option value="internal">Internal (Level 2)</option>
                                    <option value="confidential" selected>Confidential (Level 3)</option>
                                    <option value="secret">Secret (Level 4)</option>
                                    <option value="topsecret">Top Secret (Level 5)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-white/80 mb-2">Encryption Type</label>
                                <select id="quantumEncryptionType" class="w-full px-4 py-3 rounded-lg bg-white/10 text-white border border-white/20 focus:border-purple-500 focus:outline-none" onchange="calculateQuantumSecurityScore()">
                                    <option value="none">No Encryption</option>
                                    <option value="rsa2048">RSA-2048 (Classical)</option>
                                    <option value="aes256">AES-256 (Symmetric)</option>
                                    <option value="hybrid" selected>Hybrid (RSA + Post-Quantum)</option>
                                    <option value="fullpq">Full Post-Quantum</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-6 p-6 rounded-lg bg-gradient-to-r from-purple-500/20 to-blue-500/20 border border-purple-500/30">
                            <div class="text-center">
                                <div class="text-white/70 mb-2">Calculated Security Score</div>
                                <div id="quantumCalculatedScore" class="text-5xl font-bold text-white mb-2">72</div>
                                <div id="quantumScoreRating" class="text-purple-400 font-bold">Good - Quantum-Aware</div>
                            </div>
                            <div id="quantumScoreRecommendation" class="mt-4 p-4 rounded-lg bg-white/10 text-white/80 text-sm">
                                Your current configuration provides good protection. Consider upgrading to full post-quantum encryption for top secret data.
                            </div>
                        </div>
                    </div>

                    <!-- Encryption Decision Tree -->
                    <div class="glass rounded-xl p-6 mb-6">
                        <h3 class="text-xl font-bold text-white mb-4">🌳 Encryption Decision Tree</h3>
                        <div class="space-y-4">
                            <div class="quantum-decision-node p-4 rounded-lg bg-white/5 border border-white/20" onclick="toggleQuantumDecisionBranch('quantum-data-type')">
                                <div class="font-bold text-white mb-2">1. What type of data are you protecting?</div>
                                <div id="quantum-data-type" class="hidden mt-3 pl-4 border-l-2 border-purple-500 space-y-2">
                                    <div class="quantum-decision-node p-3 rounded-lg bg-purple-500/10" onclick="event.stopPropagation(); toggleQuantumDecisionBranch('quantum-data-at-rest')">
                                        <div class="text-white/90">📁 Data at Rest</div>
                                    </div>
                                    <div class="quantum-decision-node p-3 rounded-lg bg-blue-500/10" onclick="event.stopPropagation(); toggleQuantumDecisionBranch('quantum-data-in-transit')">
                                        <div class="text-white/90">🔄 Data in Transit</div>
                                    </div>
                                    <div class="quantum-decision-node p-3 rounded-lg bg-green-500/10" onclick="event.stopPropagation(); toggleQuantumDecisionBranch('quantum-data-in-use')">
                                        <div class="text-white/90">⚡ Data in Use</div>
                                    </div>
                                </div>
                            </div>
                            <div id="quantum-data-at-rest" class="hidden quantum-decision-node p-4 rounded-lg bg-purple-500/10 border border-purple-500/30">
                                <div class="font-bold text-white mb-2">Data at Rest Protection</div>
                                <div class="text-white/80 text-sm mb-3">Recommended: AES-256-GCM or ChaCha20-Poly1305</div>
                                <div class="p-3 rounded-lg bg-white/10">
                                    <div class="text-white/70 text-sm">✓ Use symmetric encryption for stored data</div>
                                    <div class="text-white/70 text-sm">✓ Implement at-rest encryption for databases</div>
                                    <div class="text-white/70 text-sm">✓ Consider hardware security modules (HSMs)</div>
                                </div>
                            </div>
                            <div id="quantum-data-in-transit" class="hidden quantum-decision-node p-4 rounded-lg bg-blue-500/10 border border-blue-500/30">
                                <div class="font-bold text-white mb-2">Data in Transit Protection</div>
                                <div class="text-white/80 text-sm mb-3">Recommended: TLS 1.3 with Post-Quantum KEM</div>
                                <div class="p-3 rounded-lg bg-white/10">
                                    <div class="text-white/70 text-sm">✓ Use hybrid key exchange (ECDHE + Kyber)</div>
                                    <div class="text-white/70 text-sm">✓ Enable perfect forward secrecy</div>
                                    <div class="text-white/70 text-sm">✓ Implement certificate pinning</div>
                                </div>
                            </div>
                            <div id="quantum-data-in-use" class="hidden quantum-decision-node p-4 rounded-lg bg-green-500/10 border border-green-500/30">
                                <div class="font-bold text-white mb-2">Data in Use Protection</div>
                                <div class="text-white/80 text-sm mb-3">Recommended: Homomorphic Encryption or TEE</div>
                                <div class="p-3 rounded-lg bg-white/10">
                                    <div class="text-white/70 text-sm">✓ Consider trusted execution environments</div>
                                    <div class="text-white/70 text-sm">✓ Explore fully homomorphic encryption</div>
                                    <div class="text-white/70 text-sm">✓ Implement secure enclaves (Intel SGX, AMD SEV)</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Encryption/Decryption Visualization -->
                    <div class="glass rounded-xl p-6 mb-6">
                        <h3 class="text-xl font-bold text-white mb-4">🔬 Encryption Visualization</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="font-bold text-white/90 mb-3">Input Message</h4>
                                <textarea id="quantumPlaintext" class="w-full px-4 py-3 rounded-lg bg-white/10 text-white border border-white/20 focus:border-purple-500 focus:outline-none font-mono" rows="4" placeholder="Enter your message...">Confidential government data for Q-Day protection</textarea>
                                <div class="mt-3 flex gap-3">
                                    <button onclick="simulateQuantumEncryption()" class="flex-1 px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-bold transition-colors">
                                        🔒 Encrypt (Kyber)
                                    </button>
                                    <button onclick="simulateQuantumDecryption()" class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold transition-colors">
                                        🔓 Decrypt
                                    </button>
                                </div>
                            </div>
                            <div>
                                <h4 class="font-bold text-white/90 mb-3">Encrypted Output</h4>
                                <div id="quantumCiphertext" class="w-full px-4 py-3 rounded-lg bg-black/30 text-green-400 border border-green-500/30 font-mono text-sm h-32 overflow-auto quantum-encryption-demo">
                                    [Click encrypt to see ciphertext]
                                </div>
                                <div class="mt-3 p-3 rounded-lg bg-white/5">
                                    <div class="text-white/70 text-sm">
                                        <span class="font-bold">Algorithm:</span> <span id="quantumCurrentAlgorithm">CRYSTALS-Kyber-1024</span>
                                    </div>
                                    <div class="text-white/70 text-sm">
                                        <span class="font-bold">Key Size:</span> <span id="quantumKeySize">3168 bytes</span>
                                    </div>
                                    <div class="text-white/70 text-sm">
                                        <span class="font-bold">Security Level:</span> <span id="quantumSecurityLevel" class="text-purple-400">NIST Level 5</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Educational Content -->
                    <div class="glass rounded-xl p-6 mb-6">
                        <h3 class="text-xl font-bold text-white mb-4">📚 Understanding Quantum Threats</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="p-4 rounded-lg bg-white/5">
                                <div class="text-3xl mb-3">⚛️</div>
                                <div class="font-bold text-white mb-2">What is Q-Day?</div>
                                <div class="text-white/70 text-sm">
                                    Q-Day is the point when quantum computers become powerful enough to break current encryption standards, threatening data security worldwide.
                                </div>
                            </div>
                            <div class="p-4 rounded-lg bg-white/5">
                                <div class="text-3xl mb-3">🧮</div>
                                <div class="font-bold text-white mb-2">Shor's Algorithm</div>
                                <div class="text-white/70 text-sm">
                                    Quantum algorithm that can factor large numbers exponentially faster, breaking RSA and ECC encryption that protects most of today's data.
                                </div>
                            </div>
                            <div class="p-4 rounded-lg bg-white/5">
                                <div class="text-3xl mb-3">🔐</div>
                                <div class="font-bold text-white mb-2">Harvest Now, Decrypt Later</div>
                                <div class="text-white/70 text-sm">
                                    Adversaries collect encrypted data today to decrypt later with quantum computers, making immediate action critical.
                                </div>
                            </div>
                        </div>
                        <div class="mt-6 p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/30">
                            <div class="flex items-start gap-3">
                                <div class="text-2xl">⚠️</div>
                                <div>
                                    <div class="font-bold text-yellow-400 mb-1">Why Act Now?</div>
                                    <div class="text-white/80 text-sm">
                                        Data encrypted today with classical methods may only have 8-10 years of protection. Government agencies recommend transitioning to post-quantum cryptography immediately to protect sensitive data with long-term value.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Compliance & Certifications -->
                    <div class="glass rounded-xl p-6 mb-6">
                        <h3 class="text-xl font-bold text-white mb-4">✅ Compliance & Certifications</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="p-4 rounded-lg bg-gradient-to-br from-purple-500/20 to-blue-500/20 border border-purple-500/30 text-center">
                                <div class="text-2xl mb-2">🏛️</div>
                                <div class="font-bold text-white text-sm">NIST PQC</div>
                                <div class="text-xs text-white/60">Approved</div>
                            </div>
                            <div class="p-4 rounded-lg bg-gradient-to-br from-green-500/20 to-emerald-500/20 border border-green-500/30 text-center">
                                <div class="text-2xl mb-2">🔒</div>
                                <div class="font-bold text-white text-sm">FIPS 140-3</div>
                                <div class="text-xs text-white/60">Certified</div>
                            </div>
                            <div class="p-4 rounded-lg bg-gradient-to-br from-blue-500/20 to-cyan-500/20 border border-blue-500/30 text-center">
                                <div class="text-2xl mb-2">☁️</div>
                                <div class="font-bold text-white text-sm">FedRAMP</div>
                                <div class="text-xs text-white/60">High Impact</div>
                            </div>
                            <div class="p-4 rounded-lg bg-gradient-to-br from-indigo-500/20 to-purple-500/20 border border-indigo-500/30 text-center">
                                <div class="text-2xl mb-2">🛡️</div>
                                <div class="font-bold text-white text-sm">CISA PQC</div>
                                <div class="text-xs text-white/60">Compliant</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Create quantum particles animation
        function createQuantumParticles() {
            const container = document.getElementById('quantumParticles');
            if (!container) return;

            container.innerHTML = '';
            for (let i = 0; i < 30; i++) {
                const particle = document.createElement('div');
                particle.className = 'quantum-particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 3 + 's';
                particle.style.animationDuration = (2 + Math.random() * 2) + 's';
                container.appendChild(particle);
            }
        }

        // Calculate quantum security score
        function calculateQuantumSecurityScore() {
            const sensitivity = document.getElementById('quantumSensitivityLevel')?.value || 'confidential';
            const encryption = document.getElementById('quantumEncryptionType')?.value || 'hybrid';

            const sensitivityScores = {
                'public': 20,
                'internal': 40,
                'confidential': 60,
                'secret': 80,
                'topsecret': 100
            };

            const encryptionScores = {
                'none': 0,
                'rsa2048': 40,
                'aes256': 70,
                'hybrid': 85,
                'fullpq': 100
            };

            const sensitivityScore = sensitivityScores[sensitivity] || 0;
            const encryptionScore = encryptionScores[encryption] || 0;

            // Calculate weighted score
            const finalScore = Math.round((encryptionScore * 0.7) + (sensitivityScore * 0.3));

            // Update UI
            const scoreElement = document.getElementById('quantumCalculatedScore');
            const headerScoreElement = document.getElementById('quantumSecurityScore');
            if (scoreElement) scoreElement.textContent = finalScore;
            if (headerScoreElement) headerScoreElement.textContent = finalScore;

            // Update rating
            let rating = '';
            let recommendation = '';

            if (finalScore >= 90) {
                rating = 'Excellent - Quantum-Ready';
                recommendation = 'Your configuration provides excellent quantum-resistant protection. Continue monitoring for NIST updates.';
            } else if (finalScore >= 75) {
                rating = 'Good - Quantum-Aware';
                recommendation = 'Your current configuration provides good protection. Consider upgrading to full post-quantum encryption for maximum security.';
            } else if (finalScore >= 50) {
                rating = 'Fair - Needs Improvement';
                recommendation = 'Your configuration has vulnerabilities. Upgrade to hybrid or post-quantum encryption immediately.';
            } else if (finalScore >= 30) {
                rating = 'Poor - At Risk';
                recommendation = 'Critical: Your data is at significant risk. Implement post-quantum encryption as soon as possible.';
            } else {
                rating = 'Critical - Immediate Action Required';
                recommendation = 'URGENT: Your data has no quantum protection. Implement encryption immediately to prevent future data breaches.';
            }

            const ratingElement = document.getElementById('quantumScoreRating');
            const recommendationElement = document.getElementById('quantumScoreRecommendation');
            if (ratingElement) ratingElement.textContent = rating;
            if (recommendationElement) recommendationElement.textContent = recommendation;
        }

        // Simulate quantum encryption
        function simulateQuantumEncryption() {
            const plaintext = document.getElementById('quantumPlaintext')?.value;
            if (!plaintext) {
                alert('Please enter a message to encrypt');
                return;
            }

            // Simulate encryption process
            const encrypted = btoa(plaintext)
                .split('')
                .map(c => String.fromCharCode(c.charCodeAt(0) + Math.floor(Math.random() * 10)))
                .join('')
                .match(/.{1,64}/g)
                .join('\n');

            const ciphertextElement = document.getElementById('quantumCiphertext');
            if (ciphertextElement) {
                ciphertextElement.textContent = encrypted;
                ciphertextElement.classList.add('quantum-encryption-flow');
                setTimeout(() => {
                    ciphertextElement.classList.remove('quantum-encryption-flow');
                }, 2000);
            }
        }

        // Simulate quantum decryption
        function simulateQuantumDecryption() {
            const plaintext = document.getElementById('quantumPlaintext')?.value;
            const ciphertextElement = document.getElementById('quantumCiphertext');
            if (ciphertextElement) {
                ciphertextElement.textContent = plaintext || '[No ciphertext to decrypt]';
            }
        }

        // Toggle decision tree branches
        function toggleQuantumDecisionBranch(id) {
            const element = document.getElementById(id);
            if (element) {
                element.classList.toggle('hidden');
            }
        }

        // Update Q-Day countdown
        function updateQDayCountdown() {
            const qDay = new Date('2032-01-01');
            const now = new Date();
            const years = Math.floor((qDay - now) / (1000 * 60 * 60 * 24 * 365));
            const countdownElement = document.getElementById('qDayCountdown');
            if (countdownElement) {
                countdownElement.textContent = `~${years} years`;
            }
        }

        // Schedule manual rotation
        function scheduleManualRotation() {
            alert('Manual key rotation scheduled. This would open a detailed rotation scheduling interface in production.');
        }
        // ===== END QUANTUM-READY SECURITY MODULE =====

        // ===== COLLABORATIVE WORKFLOW CANVAS =====
        let workflowCanvasState = {
            zoom: 1,
            panX: 0,
            panY: 0,
            mode: 'select',
            selectedNode: null,
            nodes: [],
            connections: [],
            isPanning: false,
            startPan: { x: 0, y: 0 }
        };

        // Switch between Simple and Advanced workflow modes
        function switchWorkflowMode(mode) {
            const simpleMode = document.getElementById('simpleWorkflowMode');
            const advancedMode = document.getElementById('advancedWorkflowMode');
            const simpleBtn = document.getElementById('simpleWorkflowBtn');
            const advancedBtn = document.getElementById('advancedWorkflowBtn');
            const description = document.getElementById('workflowModeDescription');

            if (mode === 'simple') {
                simpleMode.style.display = 'block';
                advancedMode.style.display = 'none';
                simpleBtn.className = 'px-4 py-2 rounded-lg text-sm font-medium transition-all bg-gradient-to-r from-blue-500 to-purple-600 text-white';
                advancedBtn.className = 'px-4 py-2 rounded-lg text-sm font-medium transition-all text-white/70 hover:text-white';
                description.textContent = 'Use AI to describe your workflow';
            } else {
                simpleMode.style.display = 'none';
                advancedMode.style.display = 'block';
                simpleBtn.className = 'px-4 py-2 rounded-lg text-sm font-medium transition-all text-white/70 hover:text-white';
                advancedBtn.className = 'px-4 py-2 rounded-lg text-sm font-medium transition-all bg-gradient-to-r from-blue-500 to-purple-600 text-white';
                description.textContent = 'Drag and drop to build complex workflows';

                // Initialize advanced canvas on first load
                if (advancedMode.innerHTML.trim() === '<!-- Canvas content will be inserted here -->') {
                    initializeAdvancedCanvas();
                }
            }
        }

        // Initialize the Advanced Workflow Canvas
        function initializeAdvancedCanvas() {
            const advancedMode = document.getElementById('advancedWorkflowMode');

            advancedMode.innerHTML = `
                <!-- Toolbar -->
                <div style="display: flex; gap: 8px; padding: 12px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; margin-bottom: 12px;">
                    <button class="workflow-toolbar-btn active" onclick="setCanvasMode('select')">
                        ✋ Select
                    </button>
                    <button class="workflow-toolbar-btn" onclick="setCanvasMode('pan')">
                        🖐️ Pan
                    </button>
                    <button class="workflow-toolbar-btn" onclick="toggleCanvasStepLibrary()">
                        📚 Steps
                    </button>
                    <button class="workflow-toolbar-btn" onclick="showCanvasVersionHistory()">
                        🕐 History
                    </button>
                    <button class="workflow-toolbar-btn" onclick="showCanvasTemplateMarketplace()">
                        🏪 Templates
                    </button>
                    <button class="workflow-toolbar-btn" onclick="toggleCanvasPreviewMode()">
                        ▶️ Preview
                    </button>
                    <div style="flex: 1;"></div>
                    <button class="workflow-toolbar-btn" onclick="exportCanvasWorkflow('json')">
                        💾 Export JSON
                    </button>
                    <button class="workflow-toolbar-btn" onclick="exportCanvasWorkflow('pdf')">
                        📄 Export PDF
                    </button>
                    <div style="display: flex; align-items: center; gap: 8px; margin-left: 16px;">
                        <span style="color: rgba(255,255,255,0.7); font-size: 0.875rem;">Collaborators:</span>
                        <div style="background: #3b82f6; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; color: white; border: 2px solid white;" title="You">JD</div>
                        <div style="background: #10b981; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; color: white; border: 2px solid white;" title="Sarah Chen - Online">SC</div>
                        <div style="background: #8b5cf6; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; color: white; border: 2px solid white;" title="Mike Torres - Online">MT</div>
                    </div>
                </div>

                <!-- Main Canvas Container -->
                <div id="canvasWorkflowContainer" style="position: relative; width: 100%; height: calc(100vh - 300px); overflow: hidden; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); border-radius: 8px; cursor: grab;">
                    <div id="canvasWorkflowGrid" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px); background-size: 20px 20px;"></div>

                    <!-- Step Library Panel -->
                    <div class="glass" id="canvasStepLibraryPanel" style="position: absolute; left: 20px; top: 20px; width: 220px; max-height: calc(100vh - 400px); overflow-y: auto; border-radius: 8px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.2);">
                        <div style="padding: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                            <h3 style="font-weight: bold; color: white;">Step Library</h3>
                            <p style="font-size: 0.75rem; color: rgba(255, 255, 255, 0.6); margin-top: 4px;">Drag to canvas</p>
                        </div>
                        <div style="padding: 8px;">
                            <div class="canvas-step-item" draggable="true" data-type="approval" ondragstart="handleCanvasDragStart(event)" style="background: linear-gradient(135deg, #3b82f6, #2563eb); padding: 12px; margin-bottom: 8px; border-radius: 6px; cursor: grab; transition: all 0.2s ease; border: 1px solid transparent;">
                                <div style="font-weight: bold; color: white; font-size: 0.875rem; pointer-events: none;">✓ Approval</div>
                                <div style="font-size: 0.75rem; color: rgba(255, 255, 255, 0.8); pointer-events: none;">Manager review</div>
                            </div>
                            <div class="canvas-step-item" draggable="true" data-type="notification" ondragstart="handleCanvasDragStart(event)" style="background: linear-gradient(135deg, #10b981, #059669); padding: 12px; margin-bottom: 8px; border-radius: 6px; cursor: grab; transition: all 0.2s ease; border: 1px solid transparent;">
                                <div style="font-weight: bold; color: white; font-size: 0.875rem; pointer-events: none;">📧 Notification</div>
                                <div style="font-size: 0.75rem; color: rgba(255, 255, 255, 0.8); pointer-events: none;">Send email/SMS</div>
                            </div>
                            <div class="canvas-step-item" draggable="true" data-type="calculation" ondragstart="handleCanvasDragStart(event)" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); padding: 12px; margin-bottom: 8px; border-radius: 6px; cursor: grab; transition: all 0.2s ease; border: 1px solid transparent;">
                                <div style="font-weight: bold; color: white; font-size: 0.875rem; pointer-events: none;">🔢 Calculation</div>
                                <div style="font-size: 0.75rem; color: rgba(255, 255, 255, 0.8); pointer-events: none;">Process data</div>
                            </div>
                            <div class="canvas-step-item" draggable="true" data-type="condition" ondragstart="handleCanvasDragStart(event)" style="background: linear-gradient(135deg, #f59e0b, #d97706); padding: 12px; margin-bottom: 8px; border-radius: 6px; cursor: grab; transition: all 0.2s ease; border: 1px solid transparent;">
                                <div style="font-weight: bold; color: white; font-size: 0.875rem; pointer-events: none;">🔀 Condition</div>
                                <div style="font-size: 0.75rem; color: rgba(255, 255, 255, 0.8); pointer-events: none;">If/then logic</div>
                            </div>
                            <div class="canvas-step-item" draggable="true" data-type="action" ondragstart="handleCanvasDragStart(event)" style="background: linear-gradient(135deg, #ef4444, #dc2626); padding: 12px; margin-bottom: 8px; border-radius: 6px; cursor: grab; transition: all 0.2s ease; border: 1px solid transparent;">
                                <div style="font-weight: bold; color: white; font-size: 0.875rem; pointer-events: none;">⚡ Action</div>
                                <div style="font-size: 0.75rem; color: rgba(255, 255, 255, 0.8); pointer-events: none;">Trigger event</div>
                            </div>
                        </div>
                    </div>

                    <!-- Collaboration Cursors -->
                    <div id="canvasCollaborationCursors"></div>

                    <!-- Minimap -->
                    <div style="position: absolute; bottom: 20px; right: 20px; width: 200px; height: 150px; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; overflow: hidden;">
                        <canvas id="canvasMinimapCanvas" width="200" height="150"></canvas>
                        <div id="canvasMinimapViewport" style="position: absolute; border: 2px solid #3b82f6; background: rgba(59, 130, 246, 0.1);"></div>
                    </div>

                    <!-- Zoom Controls -->
                    <div style="position: absolute; bottom: 20px; left: 20px; display: flex; gap: 8px;">
                        <button onclick="canvasZoomIn()" style="width: 40px; height: 40px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease;">+</button>
                        <span style="width: auto; padding: 0 12px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: white; display: flex; align-items: center; justify-content: center;">
                            <span id="canvasZoomLevel">100%</span>
                        </span>
                        <button onclick="canvasZoomOut()" style="width: 40px; height: 40px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease;">-</button>
                        <button onclick="canvasResetZoom()" style="width: 40px; height: 40px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease;">⟲</button>
                    </div>
                </div>

                <style>
                    .workflow-toolbar-btn {
                        padding: 8px 16px;
                        background: rgba(255, 255, 255, 0.1);
                        border: 1px solid rgba(255, 255, 255, 0.2);
                        border-radius: 6px;
                        color: white;
                        cursor: pointer;
                        transition: all 0.2s ease;
                    }
                    .workflow-toolbar-btn:hover {
                        background: rgba(255, 255, 255, 0.2);
                        border-color: rgba(255, 255, 255, 0.3);
                    }
                    .workflow-toolbar-btn.active {
                        background: rgba(59, 130, 246, 0.3);
                        border-color: #3b82f6;
                    }
                    .canvas-workflow-node {
                        position: absolute;
                        min-width: 180px;
                        padding: 16px;
                        border-radius: 8px;
                        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                        cursor: move;
                        transition: all 0.2s ease;
                        z-index: 10;
                    }
                    .canvas-workflow-node:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
                    }
                    .canvas-workflow-node.selected {
                        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
                    }
                    .canvas-node-approval {
                        background: linear-gradient(135deg, #3b82f6, #2563eb);
                    }
                    .canvas-node-notification {
                        background: linear-gradient(135deg, #10b981, #059669);
                    }
                    .canvas-node-calculation {
                        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
                    }
                    .canvas-node-condition {
                        background: linear-gradient(135deg, #f59e0b, #d97706);
                    }
                    .canvas-node-action {
                        background: linear-gradient(135deg, #ef4444, #dc2626);
                    }
                    .canvas-step-item:hover {
                        border-color: rgba(255, 255, 255, 0.3) !important;
                        transform: translateX(4px);
                    }
                    .canvas-collab-cursor {
                        position: absolute;
                        pointer-events: none;
                        z-index: 1000;
                        transition: all 0.1s ease;
                    }
                    .canvas-cursor-pointer {
                        width: 0;
                        height: 0;
                        border-left: 8px solid;
                        border-top: 8px solid transparent;
                        border-bottom: 8px solid transparent;
                    }
                    .canvas-cursor-label {
                        position: absolute;
                        top: 16px;
                        left: 8px;
                        padding: 2px 8px;
                        border-radius: 4px;
                        font-size: 11px;
                        white-space: nowrap;
                        color: white;
                    }
                </style>
            `;

            setTimeout(() => {
                loadCanvasSampleWorkflow();
                simulateCanvasCollaborators();
                setupCanvasEvents();
            }, 100);
        }

        const canvasSampleNodes = [
            { id: 1, type: 'approval', x: 300, y: 200, title: 'Manager Approval', data: { approver: 'Department Head' } },
            { id: 2, type: 'notification', x: 550, y: 200, title: 'Send Email', data: { recipient: 'Applicant' } },
            { id: 3, type: 'condition', x: 300, y: 350, title: 'Check Amount', data: { threshold: 1000 } },
            { id: 4, type: 'calculation', x: 550, y: 350, title: 'Calculate Fee', data: { formula: 'amount * 0.05' } }
        ];

        function loadCanvasSampleWorkflow() {
            const canvas = document.getElementById('canvasWorkflowContainer');
            if (!canvas) return;

            canvasSampleNodes.forEach(node => {
                createCanvasWorkflowNode(node);
            });

            setTimeout(() => {
                createCanvasConnection(1, 2);
                createCanvasConnection(1, 3);
                createCanvasConnection(3, 4);
            }, 100);
        }

        function createCanvasWorkflowNode(nodeData) {
            const canvas = document.getElementById('canvasWorkflowContainer');
            if (!canvas) return;

            const node = document.createElement('div');
            node.className = `canvas-workflow-node canvas-node-${nodeData.type}`;
            node.id = `canvas-node-${nodeData.id}`;
            node.style.left = nodeData.x + 'px';
            node.style.top = nodeData.y + 'px';

            node.innerHTML = `
                <div style="font-weight: bold; color: white; margin-bottom: 4px;">${nodeData.title}</div>
                <div style="font-size: 0.75rem; color: rgba(255, 255, 255, 0.8);">${getCanvasNodeTypeLabel(nodeData.type)}</div>
                <div style="margin-top: 8px; display: flex; align-items: center; justify-content: space-between;">
                    <button onclick="addCanvasComment(${nodeData.id})" style="font-size: 0.75rem; color: rgba(255, 255, 255, 0.6); background: none; border: none; cursor: pointer;">
                        💬 Comment
                    </button>
                    <button onclick="deleteCanvasNode(${nodeData.id})" style="font-size: 0.75rem; color: rgba(255, 255, 255, 0.6); background: none; border: none; cursor: pointer;">
                        🗑️
                    </button>
                </div>
            `;

            node.addEventListener('click', (e) => selectCanvasNode(nodeData.id, e));
            makeCanvasNodeDraggable(node, nodeData);

            canvas.appendChild(node);
            workflowCanvasState.nodes.push(nodeData);
        }

        function makeCanvasNodeDraggable(node, nodeData) {
            let isDragging = false;
            let startX, startY, initialLeft, initialTop;

            node.addEventListener('mousedown', (e) => {
                if (workflowCanvasState.mode !== 'select' || e.target.tagName === 'BUTTON') return;
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                initialLeft = parseInt(node.style.left) || 0;
                initialTop = parseInt(node.style.top) || 0;
                node.style.cursor = 'grabbing';
                e.stopPropagation();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                const deltaX = (e.clientX - startX) / workflowCanvasState.zoom;
                const deltaY = (e.clientY - startY) / workflowCanvasState.zoom;
                const newLeft = initialLeft + deltaX;
                const newTop = initialTop + deltaY;
                node.style.left = newLeft + 'px';
                node.style.top = newTop + 'px';
                nodeData.x = newLeft;
                nodeData.y = newTop;
                updateCanvasNodeConnections(nodeData.id);
            });

            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    node.style.cursor = 'move';
                }
            });
        }

        function createCanvasConnection(fromId, toId) {
            const fromNode = document.getElementById(`canvas-node-${fromId}`);
            const toNode = document.getElementById(`canvas-node-${toId}`);
            if (!fromNode || !toNode) return;

            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.style.position = 'absolute';
            svg.style.pointerEvents = 'none';
            svg.style.zIndex = '0';

            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            updateCanvasConnectionLine(line, fromNode, toNode);

            svg.appendChild(line);
            document.getElementById('canvasWorkflowContainer').appendChild(svg);

            workflowCanvasState.connections.push({ from: fromId, to: toId, element: svg, line: line });
        }

        function updateCanvasConnectionLine(line, fromNode, toNode) {
            if (!fromNode || !toNode || !line) return;

            const container = document.getElementById('canvasWorkflowContainer');
            if (!container) return;

            const fromRect = fromNode.getBoundingClientRect();
            const toRect = toNode.getBoundingClientRect();
            const containerRect = container.getBoundingClientRect();

            const x1 = fromRect.right - containerRect.left;
            const y1 = fromRect.top + fromRect.height / 2 - containerRect.top;
            const x2 = toRect.left - containerRect.left;
            const y2 = toRect.top + toRect.height / 2 - containerRect.top;

            line.setAttribute('x1', x1);
            line.setAttribute('y1', y1);
            line.setAttribute('x2', x2);
            line.setAttribute('y2', y2);
            line.setAttribute('stroke', '#3b82f6');
            line.setAttribute('stroke-width', '2');
            line.setAttribute('stroke-dasharray', '5,5');

            const svg = line.parentElement;
            if (!svg) return;

            const minX = Math.min(x1, x2);
            const minY = Math.min(y1, y2);
            const width = Math.abs(x2 - x1);
            const height = Math.abs(y2 - y1);

            svg.style.left = minX + 'px';
            svg.style.top = minY + 'px';
            svg.setAttribute('width', width);
            svg.setAttribute('height', height);
        }

        function updateCanvasNodeConnections(nodeId) {
            workflowCanvasState.connections.forEach(conn => {
                if (conn.from === nodeId || conn.to === nodeId) {
                    const fromNode = document.getElementById(`canvas-node-${conn.from}`);
                    const toNode = document.getElementById(`canvas-node-${conn.to}`);
                    updateCanvasConnectionLine(conn.line, fromNode, toNode);
                }
            });
        }

        function getCanvasNodeTypeLabel(type) {
            const labels = {
                approval: 'Requires approval',
                notification: 'Send notification',
                calculation: 'Process data',
                condition: 'Conditional logic',
                action: 'Execute action'
            };
            return labels[type] || type;
        }

        function simulateCanvasCollaborators() {
            const cursorsContainer = document.getElementById('canvasCollaborationCursors');
            if (!cursorsContainer) return;

            const users = [
                { name: 'Sarah Chen', color: '#10b981', x: 400, y: 300, baseX: 400, baseY: 300 },
                { name: 'Mike Torres', color: '#8b5cf6', x: 600, y: 250, baseX: 600, baseY: 250 }
            ];

            users.forEach((user) => {
                const cursor = document.createElement('div');
                cursor.className = 'canvas-collab-cursor';
                cursor.innerHTML = `
                    <div class="canvas-cursor-pointer" style="border-left-color: ${user.color};"></div>
                    <div class="canvas-cursor-label" style="background: ${user.color};">${user.name}</div>
                `;
                cursor.style.left = user.x + 'px';
                cursor.style.top = user.y + 'px';
                cursorsContainer.appendChild(cursor);

                setInterval(() => {
                    const newX = user.baseX + (Math.random() - 0.5) * 50;
                    const newY = user.baseY + (Math.random() - 0.5) * 50;
                    cursor.style.left = newX + 'px';
                    cursor.style.top = newY + 'px';
                }, 5000);
            });
        }

        function setupCanvasEvents() {
            const container = document.getElementById('canvasWorkflowContainer');
            if (!container) return;

            container.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'copy';
            });

            container.addEventListener('drop', (e) => {
                e.preventDefault();
                const stepType = e.dataTransfer.getData('stepType');
                if (stepType) {
                    const rect = container.getBoundingClientRect();
                    const x = e.clientX - rect.left - workflowCanvasState.panX;
                    const y = e.clientY - rect.top - workflowCanvasState.panY;

                    const newNode = {
                        id: Date.now(),
                        type: stepType,
                        x: x / workflowCanvasState.zoom,
                        y: y / workflowCanvasState.zoom,
                        title: getCanvasNodeTitle(stepType),
                        data: {}
                    };

                    createCanvasWorkflowNode(newNode);
                }

                document.querySelectorAll('.canvas-step-item').forEach(item => {
                    item.style.opacity = '1';
                });
            });
        }

        function handleCanvasDragStart(e) {
            const type = e.target.getAttribute('data-type');
            e.dataTransfer.setData('stepType', type);
            e.dataTransfer.effectAllowed = 'copy';
            e.target.style.opacity = '0.5';
        }

        function getCanvasNodeTitle(type) {
            const titles = {
                approval: 'New Approval',
                notification: 'New Notification',
                calculation: 'New Calculation',
                condition: 'New Condition',
                action: 'New Action'
            };
            return titles[type] || 'New Step';
        }

        function selectCanvasNode(id, event) {
            event.stopPropagation();
            document.querySelectorAll('.canvas-workflow-node').forEach(n => n.classList.remove('selected'));
            const node = document.getElementById(`canvas-node-${id}`);
            if (node) node.classList.add('selected');
            workflowCanvasState.selectedNode = id;
        }

        function deleteCanvasNode(id) {
            if (confirm('Delete this workflow step?')) {
                const node = document.getElementById(`canvas-node-${id}`);
                if (node) node.remove();
                workflowCanvasState.nodes = workflowCanvasState.nodes.filter(n => n.id !== id);
            }
        }

        function addCanvasComment(nodeId) {
            alert(`💬 Comment on Node ${nodeId}\n\n[In production, this would open a comment thread]\n\nSample comments:\n• "Should we add a timeout here?" - Sarah\n• "Approved, looks good!" - Mike\n• "Changed threshold to 1000" - You`);
        }

        function setCanvasMode(mode) {
            workflowCanvasState.mode = mode;
            document.querySelectorAll('.workflow-toolbar-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        function canvasZoomIn() {
            workflowCanvasState.zoom = Math.min(3, workflowCanvasState.zoom * 1.2);
            updateCanvasZoomDisplay();
        }

        function canvasZoomOut() {
            workflowCanvasState.zoom = Math.max(0.1, workflowCanvasState.zoom / 1.2);
            updateCanvasZoomDisplay();
        }

        function canvasResetZoom() {
            workflowCanvasState.zoom = 1;
            workflowCanvasState.panX = 0;
            workflowCanvasState.panY = 0;
            updateCanvasZoomDisplay();
        }

        function updateCanvasZoomDisplay() {
            const zoomEl = document.getElementById('canvasZoomLevel');
            if (zoomEl) {
                zoomEl.textContent = Math.round(workflowCanvasState.zoom * 100) + '%';
            }
        }

        function toggleCanvasStepLibrary() {
            const library = document.getElementById('canvasStepLibraryPanel');
            if (library) {
                library.style.display = library.style.display === 'none' ? 'block' : 'none';
            }
        }

        function showCanvasVersionHistory() {
            alert('📜 Version History\n\nv2.3 - Current (2 hours ago - Sarah Chen)\nUpdated approval flow\n\nv2.2 (1 day ago - Mike Torres)\nAdded notification step\n\nv2.1 (3 days ago - You)\nFixed condition logic\n\n[In production, this would show a detailed version history modal]');
        }

        function showCanvasTemplateMarketplace() {
            alert('🏪 Template Marketplace\n\nAvailable Templates:\n• Permit Approval (★4.8, 245 uses)\n• Invoice Processing (★4.9, 892 uses)\n• Onboarding (★4.7, 567 uses)\n• Incident Response (★5.0, 178 uses)\n• Report Generation (★4.6, 423 uses)\n• Data Sync (★4.5, 334 uses)\n\n[In production, this would show a full template marketplace modal]');
        }

        function toggleCanvasPreviewMode() {
            alert('▶️ Preview Mode\n\nSimulating workflow execution...\n\n1. Manager Approval (2s)\n2. Send Email Notification (1s)\n3. Check Amount Condition (1s)\n4. Calculate Fee (1s)\n\nTotal execution time: ~5 seconds\n\n[In production, this would show live step-by-step execution]');
        }

        function exportCanvasWorkflow(format) {
            if (format === 'json') {
                const data = JSON.stringify({
                    nodes: workflowCanvasState.nodes,
                    connections: workflowCanvasState.connections.map(c => ({ from: c.from, to: c.to })),
                    version: '2.3',
                    metadata: { created: new Date().toISOString(), author: 'GovFlow User' }
                }, null, 2);
                alert('📥 Export to JSON\n\nWorkflow exported successfully!\n\n' + data.substring(0, 200) + '...\n\n[In production, this would download a JSON file]');
            } else if (format === 'pdf') {
                alert('📄 Export to PDF\n\nGenerating visual diagram...\n\n✓ Canvas captured\n✓ Nodes rendered\n✓ Connections drawn\n✓ Metadata included\n\n[In production, this would generate and download a PDF]');
            }
        }
        // ===== END COLLABORATIVE WORKFLOW CANVAS =====

        // ===== DOCUMENT PROCESSING CENTER - Added 2025-10-18 =====
        // SECURITY TODO: Implement document storage with AES-256 encryption at rest (CJIS requirement)
        // SECURITY TODO: Add role-based access control (RBAC) for CJIS compliance
        // TODO: Integrate with audit logging system - all actions must be logged (CJIS requirement)
        // SECURITY TODO: Implement session timeout (15 minutes per CJIS standards)
        // SECURITY TODO: Add two-factor authentication for document access
        // SECURITY TODO: Encrypt all data in transit with TLS 1.2+ (CJIS requirement)
        // TODO: Connect to real document processing API endpoint /api/documents/queue
        // TODO: Implement PII masking/redaction features for sensitive fields

        // MOCK DATA - Replace in production
        const MOCK_DOC_PROCESSING_DATA = {
            high: [
                {
                    id: 'DOC-2024-001847',
                    filename: 'BuildingPermit_SmithConstruction.pdf',
                    type: 'Building Permit Application',
                    uploadedBy: 'John Smith',
                    uploadDate: '2024-10-18T09:23:00Z',
                    confidence: 68,
                    priority: 'high',
                    fields: [
                        { name: 'Owner Name', value: 'John Smith', confidence: 94, status: 'approved' },
                        { name: 'Property Address', value: '742 Evergreen Terrace', confidence: 89, status: 'approved' },
                        { name: 'Project Description', value: '[unclear]', confidence: 42, status: 'rejected', note: 'Handwriting illegible' },
                        { name: 'Contractor License', value: 'IL-CON-8472', confidence: 78, status: 'pending' },
                        { name: 'Estimated Cost', value: '$45,000', confidence: 91, status: 'approved' },
                        { name: 'Start Date', value: '11/01/2024', confidence: 55, status: 'rejected', note: 'Date format unclear' }
                    ]
                },
                {
                    id: 'DOC-2024-001852',
                    filename: 'PoliceReport_TrafficIncident.pdf',
                    type: 'Police Report',
                    uploadedBy: 'Officer Williams',
                    uploadDate: '2024-10-18T10:15:00Z',
                    confidence: 65,
                    priority: 'high',
                    fields: [
                        { name: 'Incident Date', value: '10/17/2024', confidence: 92, status: 'approved' },
                        { name: 'Location', value: 'Main St & Oak Ave', confidence: 88, status: 'approved' },
                        { name: 'License Plate', value: 'ABC [smudged]', confidence: 48, status: 'rejected', note: 'Partially obscured' },
                        { name: 'Driver Name', value: 'Jane Doe', confidence: 73, status: 'pending' },
                        { name: 'Insurance Policy', value: '[illegible]', confidence: 32, status: 'rejected', note: 'Poor scan quality' }
                    ]
                }
            ],
            medium: [
                {
                    id: 'DOC-2024-001849',
                    filename: 'TaxAppeal_Johnson.pdf',
                    type: 'Property Tax Appeal',
                    uploadedBy: 'Mary Johnson',
                    uploadDate: '2024-10-18T09:45:00Z',
                    confidence: 82,
                    priority: 'medium'
                },
                {
                    id: 'DOC-2024-001850',
                    filename: 'BusinessLicense_GreenCafe.pdf',
                    type: 'Business License Application',
                    uploadedBy: 'Sarah Green',
                    uploadDate: '2024-10-18T10:02:00Z',
                    confidence: 78,
                    priority: 'medium'
                }
            ],
            auto: [
                {
                    id: 'DOC-2024-001851',
                    filename: 'ParkingPermit_Downtown.pdf',
                    type: 'Parking Permit',
                    uploadedBy: 'Mike Davis',
                    uploadDate: '2024-10-18T10:08:00Z',
                    confidence: 97,
                    priority: 'auto'
                },
                {
                    id: 'DOC-2024-001853',
                    filename: 'WaterBill_Payment.pdf',
                    type: 'Utility Bill',
                    uploadedBy: 'System Auto-Upload',
                    uploadDate: '2024-10-18T10:30:00Z',
                    confidence: 99,
                    priority: 'auto'
                }
            ]
        };

        function openDocQueue(priority) {
            // CJIS AUDIT LOG - Log queue access
            console.log(`AUDIT: User accessed ${priority} priority document queue at ${new Date().toISOString()}`);

            const docs = MOCK_DOC_PROCESSING_DATA[priority] || [];

            let docList = docs.map(doc => {
                const confidenceColor = doc.confidence >= 85 ? '🟢' : doc.confidence >= 70 ? '🟡' : '🔴';
                return `${confidenceColor} ${doc.filename}\n   Type: ${doc.type}\n   Confidence: ${doc.confidence}%\n   Uploaded: ${new Date(doc.uploadDate).toLocaleString()}`;
            }).join('\n\n');

            const priorityLabel = priority === 'high' ? 'High Priority (< 70%)' :
                                priority === 'medium' ? 'Medium Priority (70-85%)' :
                                'Auto-Processed (> 85%)';

            alert(`📋 ${priorityLabel} Queue\n\n${docs.length} documents\n\n${docList}\n\n[In production, this would open a detailed queue management interface with document review capabilities]`);

            // TODO: Open modal with full queue interface
            // TODO: Connect to API endpoint /api/documents/queue?priority=${priority}
        }

        function showBatchUpload() {
            alert('📤 Batch Document Upload\n\nThis feature allows you to upload multiple documents at once for processing.\n\n• Drag and drop up to 50 files\n• Automatic document type detection\n• Priority routing based on confidence\n• Real-time processing status\n\n[In production, this would open a batch upload interface with drag-and-drop support and progress tracking]\n\nTODO: Implement batch upload modal');

            // TODO: Show batch upload modal
            // TODO: Connect to API endpoint /api/documents/batch-upload
            console.log('TODO: Implement batch upload UI');
        }

        function exportDocProcessingReport() {
            const reportData = {
                generatedAt: new Date().toISOString(),
                totalProcessed: 2847,
                accuracyRate: 94.7,
                avgProcessingTime: 2.3,
                queues: {
                    high: MOCK_DOC_PROCESSING_DATA.high.length,
                    medium: MOCK_DOC_PROCESSING_DATA.medium.length,
                    auto: MOCK_DOC_PROCESSING_DATA.auto.length
                }
            };

            console.log(`AUDIT: User exported document processing report at ${new Date().toISOString()}`);
            alert('📊 Export Processing Report\n\nGenerating comprehensive report...\n\n' +
                  `• Total Processed: ${reportData.totalProcessed}\n` +
                  `• Accuracy: ${reportData.accuracyRate}%\n` +
                  `• Avg Time: ${reportData.avgProcessingTime}s\n` +
                  `• Time Saved: 142 hours\n\n` +
                  `Queues:\n` +
                  `• High Priority: ${reportData.queues.high}\n` +
                  `• Medium Priority: ${reportData.queues.medium}\n` +
                  `• Auto-Processed: ${reportData.queues.auto}\n\n` +
                  `[In production, this would generate and download a comprehensive PDF/CSV report]\n\n` +
                  `TODO: Generate PDF/CSV export`);

            // TODO: Generate and download report
            // TODO: POST to /api/reports/document-processing
            console.log('TODO: POST to /api/reports/generate', reportData);
        }

        function configureDocProcessing() {
            alert('⚙️ Document Processing Settings\n\nConfigure OCR and automation parameters:\n\n' +
                  '• Confidence thresholds (High/Medium/Auto)\n' +
                  '• Auto-approval rules\n' +
                  '• Field validation patterns\n' +
                  '• Document type templates\n' +
                  '• Quality control settings\n' +
                  '• PII detection sensitivity\n' +
                  '• Duplicate detection rules\n\n' +
                  '[In production, this would open a comprehensive settings interface]\n\n' +
                  'TODO: Implement settings configuration UI');

            // TODO: Show settings modal
            // TODO: Connect to API endpoint /api/documents/settings
            console.log('TODO: Implement settings configuration UI');
        }

        function enterDocTrainingMode() {
            console.log(`AUDIT: User entered AI training mode at ${new Date().toISOString()}`);
            alert('🧠 AI Training Mode\n\nTrain the document processing AI:\n\n' +
                  '• Upload sample documents\n' +
                  '• Correct field extractions\n' +
                  '• Define new document types\n' +
                  '• Improve accuracy over time\n' +
                  '• Export trained models\n' +
                  '• Review training history\n\n' +
                  '[In production, this would open an interactive AI training interface with document annotation tools]\n\n' +
                  'TODO: Implement AI training interface');

            // TODO: Show training interface
            // TODO: Connect to API endpoint /api/documents/training
            console.log('TODO: Implement AI training UI');
        }
        // ===== END DOCUMENT PROCESSING CENTER =====
    </script>
</body>
</html>